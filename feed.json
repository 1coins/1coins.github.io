{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "乾元",
  "home_page_url": "https://1coins.github.io/",
  "feed_url": "https://1coins.github.io/feed.json",
  "description": "乾元 - 念念不忘，必有回响。",
  "items": [
    {
      "title": "Docker 镜像与容器",
      "url": "https://1coins.github.io/article/docker/docker-image-and-container.html",
      "id": "https://1coins.github.io/article/docker/docker-image-and-container.html",
      "summary": "Docker概述 基本介绍 Docker是一个开源的应用容器引擎，基于Go语言并遵从Apache2.0协议开源。 Docker可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的Linux机器上，也可以实现虚拟化。 容器是完全使用沙箱机制，相互之间不会有任何接口（类似iPhone的app）,更重要的是容器性能开销极低。",
      "content_html": "<h1> Docker概述</h1>\n<h2> 基本介绍</h2>\n<p><code>Docker</code>是一个开源的应用容器引擎，基于<code>Go</code>语言并遵从<code>Apache2.0</code>协议开源。</p>\n<p><code>Docker</code>可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的<code>Linux</code>机器上，也可以实现虚拟化。</p>\n<p>容器是完全使用沙箱机制，相互之间不会有任何接口（类似<code>iPhone</code>的<code>app</code>）,更重要的是容器性能开销极低。</p>\n<p><code>Docker</code>从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>17.03</mn></mrow><annotation encoding=\"application/x-tex\">17.03</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">17.03</span></span></span></span> 版本之后分为<code>CE</code>（<code>Community Edition</code>：社区版） 和<code>EE</code>（<code>Enterprise Edition</code>：企业版），一般用社区版就可以了。</p>\n<p><a href=\"https://docs.docker.com/\" target=\"_blank\" rel=\"noopener noreferrer\">官网</a>：<code>https://docs.docker.com/</code>。</p>\n<h2> 应用场景</h2>\n<ul>\n<li><code>Web</code>应用的自动化打包和发布</li>\n<li>自动化测试和持续集成、发布</li>\n<li>在服务型环境中部署和调整数据库或其他的后台应用</li>\n<li>从头编译或者扩展现有的<code>OpenShift</code>或<code>Cloud Foundry</code>平台来搭建自己的<code>PaaS</code>环境</li>\n</ul>\n<h2> Docker 的优势</h2>\n<p><code>Docker</code>是一个用于开发，交付和运行应用程序的开放平台。</p>\n<p><code>Docker</code>能够将应用程序与基础架构分开，从而可以快速交付软件；借助<code>Docker</code>，可以与管理应用程序相同的方式来管理基础架构；通过利用<code>Docker</code>的方法来快速交付，测试和部署代码，可以大大减少编写代码和在生产环境中运行代码之间的延迟。</p>\n<ol>\n<li>\n<p>快速，一致地交付您的应用程序。</p>\n<p><code>Docker</code>允许开发人员使用提供的应用程序或服务的本地容器在标准化环境中工作，从而简化了开发的生命周期。</p>\n<p>容器非常适合持续集成和持续交付（<code>CI / CD</code>）工作流程，考虑以下示例方案：</p>\n<ul>\n<li>开发人员在本地编写代码，并使用 Docker 容器与同事共享他们的工作。他们使用<code>Docker</code>将其应用程序推送到测试环境中，并执行自动或手动测试</li>\n<li>当开发人员发现错误时，他们可以在开发环境中对其进行修复，然后将其重新部署到测试环境中，以进行测试和验证</li>\n<li>测试完成后，将修补程序推送给生产环境，就像将更新的镜像推送到生产环境一样简单</li>\n</ul>\n</li>\n<li>\n<p>响应式部署和扩展</p>\n<ul>\n<li><code>Docker</code>是基于容器的平台，允许高度可移植的工作负载</li>\n<li><code>Docker</code>容器可以在开发人员的本机上，数据中心的物理或虚拟机上，云服务上或混合环境中运行</li>\n<li><code>Docker</code>的可移植性和轻量级的特性，还可以轻松地完成动态管理的工作负担，并根据业务需求指示，实时扩展或拆除应用程序和服务</li>\n</ul>\n</li>\n<li>\n<p>在同一硬件上运行多工作负载</p>\n<ul>\n<li><code>Docker</code>轻巧快速。它为基于虚拟机管理程序的虚拟机提供了可行、经济、高效的替代方案，因此您可以利用更多的计算能力来实现业务目标</li>\n<li><code>Docker</code>非常适合于高密度环境以及中小型部署，可以用更少的资源做更多的事情</li>\n</ul>\n</li>\n</ol>\n<h1> 虚拟化技术和容器化技术</h1>\n<h2> 容器化技术</h2>\n<h3> 容器官方解释</h3>\n<p>一句话概括容器：容器就是将软件打包成标准化单元，以用于开发、交付和部署。</p>\n<ul>\n<li>容器镜像是轻量的、可执行的独立软件包，包含软件运行所需的所有内容：代码、运行时环境、系统工具、系统库和设置</li>\n<li>容器化软件适用于基于<code>Linux</code>和<code>Windows</code>的应用，在任何环境中都能够始终如一地运行</li>\n<li>容器赋予了软件独立性，使其免受外在环境差异（例如，开发和预演环境的差异）的影响，从而有助于减少团队间在相同基础设施上运行不同软件时的冲突</li>\n</ul>\n<h3> 容器通俗解释</h3>\n<p>容器化技术不是模拟的一个完整的操作系统。</p>\n<p>通俗地描述容器，容器就是一个存放东西的地方，就像书包可以装各种文具、衣柜可以放各种衣服、鞋架可以放各种鞋子一样。现在所说的容器存放的东西可能更偏向于应用比如网站、程序甚至是系统环境。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-container.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 虚拟化技术</h2>\n<p><code>Docker</code>容器虚拟化技术为基础的软件，什么是虚拟化技术呢？</p>\n<p>简单的说，虚拟化技术可以这样定义：</p>\n<blockquote>\n<p>虚拟化技术是一种资源管理技术，是将计算机的各种实体资源（<code>CPU</code>、内存、磁盘空间、网络适配器等），予以抽象、转换后呈现出来并可供分割、组合为一个或多个电脑配置环境。由此，打破实体结构间的不可切割的障碍，使用户可以比原本的配置更好的方式来应用这些电脑硬件资源。这些资源的新虚拟部分是不受现有资源的架设方式，地域或物理配置所限制。一般所指的虚拟化资源包括计算能力和数据存储。</p>\n</blockquote>\n<p>虚拟化技术特点：</p>\n<ol>\n<li>资源占用多</li>\n<li>冗余步骤多</li>\n<li>启动很慢</li>\n</ol>\n<h2> Docker 基于 LXC 虚拟容器技术</h2>\n<p><code>Docker</code>技术是基于<code>LXC</code>（<code>Linux container</code>：<code>Linux</code>容器）虚拟容器技术的。</p>\n<blockquote>\n<p><code>LXC</code>，其名称来自<code>Linux</code>软件容器（<code>Linux Containers</code>）的缩写，一种操作系统层虚拟化（<code>Operating system–level virtualization</code>）技术，为<code>Linux</code>内核容器功能的一个用户空间接口。它将应用软件系统打包成一个软件容器（<code>Container</code>），内含应用软件本身的代码，以及所需要的操作系统核心和库。通过统一的名字空间和共用<code>API</code>来分配不同软件容器的可用硬件资源，创造出应用程序的独立沙箱运行环境，使得<code>Linux</code>用户可以容易的创建和管理系统或应用容器。</p>\n</blockquote>\n<p><code>LXC</code>技术主要是借助<code>Linux</code>内核中提供的<code>CGroup</code>功能和<code>namespace</code>来实现的，通过<code>LXC</code>可以为软件提供一个独立的操作系统运行环境。</p>\n<p><code>Docker</code>和虚拟机的不同：</p>\n<ol>\n<li>传统虚拟机，虚拟出硬件，运行一个完整的操作系统，然后在这个系统上安装和运行软件</li>\n<li><code>Docker</code>容器内的应用直接运行在宿主机的内容，容器是没有自己的内核的，也没有虚拟硬件</li>\n<li>每个容器都是相互隔离的，每个容器都有属于自己的文件系统，互不影响</li>\n</ol>\n<h3> cgroup 和 namespace</h3>\n<h4> 介绍</h4>\n<ul>\n<li><code>namespace</code>是<code>Linux</code>内核用来隔离内核资源的方式，通过<code>namespace</code>可以让一些进程只能看到与自己相关的一部分资源，而另外一些进程也只能看到与它们自己相关的资源，这两拨进程根本就感觉不到对方的存在。具体的实现方式是把一个或多个进程的相关资源指定在同一个<code>namespace</code>中；<code>Linux namespaces</code>是对全局系统资源的一种封装隔离，使得处于不同<code>namespace</code>的进程拥有独立的全局系统资源，改变一个<code>namespace</code>中的系统资源只会影响当前 <code>namespace</code>里的进程，对其他<code>namespace</code>中的进程没有影响</li>\n<li><code>CGroup</code>是<code>Control Groups</code>的缩写，是<code>Linux</code>内核提供的一种可以限制、记录、隔离进程组 （<code>process groups</code>）所使用的物力资源（如<code>cpu</code>、<code>memory</code>、<code>i/o</code>等）的机制</li>\n</ul>\n<h4> 对比</h4>\n<p>两者都是将进程进行分组，但是两者的作用还是有本质区别。</p>\n<p><code>namespace</code>是为了隔离进程组之间的资源，而<code>cgroup</code>是为了对一组进程进行统一的资源监控和限制。</p>\n<h3> 容器化的好处</h3>\n<ol>\n<li>\n<p>应用更快速的交互和部署</p>\n<ul>\n<li>传统：一堆帮助文档，安装程序</li>\n<li><code>Docker</code>：打包镜像发布测试，一键运行</li>\n</ul>\n</li>\n<li>\n<p>更便捷的升级和扩容<br>\n使用<code>Docker</code>之后，项目打包为一个镜像，部署应用就像搭积木一样</p>\n</li>\n<li>\n<p>更简单的系统运维<br>\n在容器化之后，开发、测试环境都是高度统一的</p>\n</li>\n<li>\n<p>更高效的计算资源利用<br>\n<code>Docker</code>是内核级别的虚拟化，可以在一个物理机上运行很多的容器实例，服务器的性能可以被压榨到极致</p>\n</li>\n</ol>\n<h1> Docker 基本组成</h1>\n<p><code>Docker</code>中有非常重要的三个基本概念，理解了这三个概念，就理解了<code>Docker</code>的整个生命周期。</p>\n<ul>\n<li>\n<p>镜像（<code>Image</code>）<br>\n<code>Docker</code>镜像就好比是一个模板，可以通过这个模板来创建容器服务，运行<code>tomcat</code>镜像 ===&gt; <code>tomcat01</code>容器提供<code>web</code>服务器服务</p>\n</li>\n<li>\n<p>容器（<code>Container</code>）<br>\n<code>Docker</code>利用容器技术，独立运行一个或者一组通过镜像创建的应用</p>\n</li>\n<li>\n<p>仓库（<code>Repository</code>）</p>\n<ul>\n<li>仓库就是存放镜像的地方</li>\n<li>仓库分为公有仓库（<code>Docker Hub</code>）和私有仓库</li>\n</ul>\n</li>\n</ul>\n<h1> Docker 的安装与卸载</h1>\n<h2> 安装</h2>\n<ol>\n<li>\n<p>查看系统内核和系统信息</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>卸载旧版本</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>下载依赖安装包</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>配置镜像仓库</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>更新<code>yum</code>软件包</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>下载<code>Docker</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>一般情况下安装社区版</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>启动<code>Docker</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>Docker</code>的<code>HelloWorld</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h2> 卸载</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> Docker 容器运行流程和原理</h2>\n<h3> 运行流程</h3>\n<p>启动一个容器，<code>Docker</code>的运行流程如下图：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-run-process.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 底层原理</h2>\n<p><code>Docker</code>是一个<code>Client-Server</code>结构的系统，<code>Docker</code>的守护进程运行在主机上，通过<code>Socker</code>从客户端访问！<code>Docker Server</code>接收到<code>Docker-Client</code>的指令，就会执行这个指令！</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-underly-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> Docker 整体架构</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-overall-framework.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>Docker</code>为什么比<code>VM Ware</code>快？</p>\n<ol>\n<li><code>Docker</code>比虚拟机更少的抽象层</li>\n<li><code>Docker</code>利用宿主机的内核，<code>VM</code>需要的是<code>Guest OS</code></li>\n</ol>\n<p><code>Docker</code>新建一个容器的时候，不需要像虚拟机一样重新加载一个操作系统内核，直接利用宿主机的操作系统，而虚拟机是需要加载<code>Guest OS</code>。</p>\n<p><code>Docker</code>和<code>VM</code>的对比如下：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Docker 容器</th>\n<th>LXC</th>\n<th>VM</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>虚拟化类型</td>\n<td><code>OS</code>虚拟化</td>\n<td><code>OS</code>虚拟化</td>\n<td>硬件虚拟化</td>\n</tr>\n<tr>\n<td>性能</td>\n<td>物理机性能</td>\n<td>物理机性能</td>\n<td><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>5</mn><mi mathvariant=\"normal\">%</mi><mo>−</mo><mn>20</mn><mi mathvariant=\"normal\">%</mi></mrow><annotation encoding=\"application/x-tex\">5 \\%-20 \\%</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5%</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8056em;vertical-align:-0.0556em;\"></span><span class=\"mord\">20%</span></span></span></span>损耗</td>\n</tr>\n<tr>\n<td>隔离性</td>\n<td><code>NS</code>隔离</td>\n<td><code>NS</code>隔离</td>\n<td>强</td>\n</tr>\n<tr>\n<td><code>Qos</code></td>\n<td><code>Cgroup</code>弱</td>\n<td><code>Cgroup</code>弱</td>\n<td>强</td>\n</tr>\n<tr>\n<td>安全性</td>\n<td>中</td>\n<td>差</td>\n<td>强</td>\n</tr>\n<tr>\n<td><code>GuestOS</code></td>\n<td>只支持<code>Linux</code></td>\n<td>只支持<code>Linux</code></td>\n<td>全部</td>\n</tr>\n</tbody>\n</table>\n<h1> 配置阿里云镜像</h1>\n<ol>\n<li>\n<p>进入阿里云官网，搜索容器镜像服务</p>\n</li>\n<li>\n<p>执行命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h1> Docker 常用命令</h1>\n<h2> 基础命令</h2>\n<ol>\n<li>\n<p>查看<code>Docker</code>的版本信息：<code>docker version</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查看<code>Docker</code>的系统信息，包括镜像和容器的数量：<code>docker info</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>帮助命令（可查看可选的参数）：<code>docker 命令 --help</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<p>命令<a href=\"https://docs.docker.com/engine/reference/commandline/docker/\" target=\"_blank\" rel=\"noopener noreferrer\">帮助文档</a>：<code>https://docs.docker.com/engine/reference/commandline/docker/</code>。</p>\n<h2> 镜像命令</h2>\n<h3> 查看本地主机的所有镜像</h3>\n<p><code>docker images</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>列表参数介绍：</p>\n<ul>\n<li><code>REPOSITORY</code>： 镜像的仓库源</li>\n<li><code>TAG</code>：镜像的标签</li>\n<li><code>IMAGE ID</code>：镜像的<code>id</code></li>\n<li><code>CREATED</code>：镜像的创建时间</li>\n<li><code>SIZE</code>：镜像的大小</li>\n</ul>\n<p>可选参数：</p>\n<ul>\n<li><code>-a/--all</code>：列出所有镜像</li>\n<li><code>-q/--quiet</code>：只显示镜像的<code>id</code></li>\n</ul>\n<h3> 搜索镜像</h3>\n<p><code>docker search</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>可选参数：</p>\n<ul>\n<li>\n<p><code>-f, --filter filter</code>：根据提供的条件过滤输出</p>\n<ul>\n<li>\n<p>搜索收藏数大于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3000</mn></mrow><annotation encoding=\"application/x-tex\">3000</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">3000</span></span></span></span> 的镜像</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p><code>--format string</code>：使用<code>Go</code>模板的漂亮打印搜索</p>\n</li>\n<li>\n<p><code>--limit int</code>：最大搜索结果数量（默认为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>25</mn></mrow><annotation encoding=\"application/x-tex\">25</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">25</span></span></span></span>）</p>\n</li>\n<li>\n<p><code>--no-trunc</code>：不截断输出</p>\n</li>\n</ul>\n<h3> 下载镜像</h3>\n<p><code>docker pull 镜像名[:tag]</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 删除镜像</h3>\n<p><code>docker rmi</code></p>\n<ol>\n<li>\n<p>查看镜像</p>\n<ul>\n<li>\n<p>查看全部镜像</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查看全部镜像（只显示<code>id</code>）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>删除镜像</p>\n<ul>\n<li>\n<p>删除指定的镜像<code>id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除多个镜像<code>id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除全部的镜像<code>id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n</ol>\n<h2> 容器命令</h2>\n<h3> 运行容器</h3>\n<p><code>docker run [可选参数] image</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>参数说明：</p>\n<ul>\n<li>\n<p><code>--name=\"名字\"</code>：指定容器名字</p>\n</li>\n<li>\n<p><code>-d</code>：后台方式运行</p>\n</li>\n<li>\n<p><code>-it</code>：使用交互方式运行,进入容器查看内容</p>\n</li>\n<li>\n<p><code>-p</code>：指定容器的端口</p>\n<ul>\n<li>\n<p><code>-p ip:主机端口:容器端口</code>： 配置主机端口映射到容器端口</p>\n<ul>\n<li>简化版：<code>-p 主机端口:容器端口</code>或<code>-p 容器端口</code></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><code>-P</code>：随机指定端口（大写的<code>P</code>）</p>\n</li>\n</ul>\n<h3> 进入容器</h3>\n<p><code>docker run</code></p>\n<p><code>docker run -it [容器ID] /bin/bash</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 退出容器</h3>\n<ul>\n<li>\n<p><code>exit</code>：停止并退出容器（后台方式运行则仅退出）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>Ctrl+P+Q</code>：不停止容器，直接退出</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 列出容器</h3>\n<p><code>docker ps</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>参数说明：</p>\n<ul>\n<li><code>-a</code>：列出所有容器的运行记录</li>\n<li><code>-n=?</code>：显示最近创建的<code>n</code>个容器</li>\n<li><code>-q</code>：只显示容器的编号</li>\n</ul>\n<h3> 删除容器</h3>\n<p><code>docker rm</code></p>\n<ul>\n<li>\n<p>删除指定的容器，不能删除正在运行的容器，强制删除使用<code>rm -f</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除所有的容器</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除所有的容器</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h4> 启动和重启容器命令</h4>\n<ul>\n<li>\n<p>启动容器：<code>docker start 容器id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重启容器：<code>docker restart 容器id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>停止当前运行的容器：<code>docker stop 容器id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>强制停止当前容器：<code>docker kill 容器id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 其他命令</h2>\n<h3> 查看日志</h3>\n<p><code>docker logs</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>常用：</p>\n<ul>\n<li>\n<p><code>docker logs -tf 容器id</code></p>\n</li>\n<li>\n<p><code>docker logs --tail number 容器id</code></p>\n<ul>\n<li><code>num</code>为要显示的日志条数</li>\n</ul>\n</li>\n</ul>\n<p><code>Docker</code>容器后台运行必须要有一个前台的进程，否则会自动停止；编写<code>shell</code>脚本循环执行，使<code>centos</code>容器保持运行状态。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 查看容器中进程信息</h3>\n<p><code>docker top</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 查看容器的元数据</h3>\n<p><code>docker inspect 容器id</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 进入当前正在运行的容器</h4>\n<ol>\n<li>\n<p><code>docker exec</code>：进入容器后开启一个新的终端，可以在里面操作</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>docker attach</code>：进入容器正在执行的终端，不会启动新的进程</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h3> 拷贝容器文件到主机</h3>\n<p><code>docker cp 容器id:容器内路径 目的主机路径</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 常用命令小结</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-commands-diagram.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-commands-summary.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> Docker 图形化管理工具</h2>\n<h3> Docker UI</h3>\n<ol>\n<li>\n<p>查找</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>下载</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>运行</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>测试<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-ui.png\" alt=\"\" loading=\"lazy\"></p>\n</li>\n</ol>\n<h3> Shipyard</h3>\n<h3> Portainer</h3>\n<ol>\n<li>\n<p>查找</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>下载</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>运行</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>测试</p>\n<ol>\n<li>第一次登录设置<code>admin</code>用户的密码<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-portainer-pass.png\" alt=\"\" loading=\"lazy\"></li>\n<li>如果是阿里云服务器记得设置安全组，选择连接本地的<code>Docker</code><br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-portainer-connect.png\" alt=\"\" loading=\"lazy\"></li>\n</ol>\n</li>\n</ol>\n<h2> Docker 镜像详解</h2>\n<h3> 什么是镜像</h3>\n<p>镜像是一种轻量级、可执行的独立软件包，用来打包软件运行环境和基于运行环境开发的软件，它包含运行某个软件所需要的所有内容，包括代码，运行时（一个程序在运行或者在被执行的依赖）、库，环境变量和配置文件。</p>\n<h3> UnionFS（联合文件系统）</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-union-fs-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-union-fs-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ul>\n<li>联合文件系统（<code>UnionFS</code>）是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以将不同目录挂载到同一个虚拟文件系统下。联合文件系统是<code>Docker</code>镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</li>\n<li>特性：一次同时加载多个文件系统，但从外面看起来只能看到一个文件系统。联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</li>\n</ul>\n<h3> 镜像加载原理</h3>\n<p><code>Docker</code>的镜像实际由一层一层的文件系统组成：</p>\n<ul>\n<li><code>bootfs</code>（<code>boot file system</code>）主要包含<code>bootloader</code>和<code>kernel</code>；<code>bootloader</code>主要是引导加载<code>kernel</code>，完成后整个内核就都在内存中了，此时内存的使用权已由<code>bootfs</code>转交给内核，系统卸载<code>bootfs</code>，可以被不同的<code>Linux</code>发行版公用。</li>\n<li><code>rootfs</code>（<code>root file system</code>），包含典型<code>Linux</code>系统中的<code>/dev</code>，<code>/proc</code>，<code>/bin</code>，<code>/etc</code>等标准目录和文件；<code>rootfs</code>就是各种不同操作系统发行版（<code>Ubuntu</code>，<code>Centos</code>等）。因为底层直接用<code>Host</code>的<code>kernel</code>，<code>rootfs</code>只包含最基本的命令，工具和程序就可以了。</li>\n</ul>\n<h3> 分层理解</h3>\n<p>所有的<code>Docker</code>镜像都起始于一个基础镜像层，当进行修改或增加新的内容时，就会在当前镜像层之上，创建新的容器层。</p>\n<p>容器在启动时会在镜像最外层上建立一层可读写的容器层（<code>R/W</code>），而镜像层是只读的（<code>R/O</code>）。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-layer.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>查看镜像分层的方式可以通过<code>docker image inspect</code>命令：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>这里指示了分层信息：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>举一个简单的例子，加入基于<code>Ubuntu Linux 16.04</code>创建一个新的镜像，这就是新镜像的第一层；如果在该镜像中添加<code>Python</code>包，就会在基础镜像层之上创建第二个镜像层；如果继续添加一个安全补丁，就会创建第三个镜像层。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-image-package-layer.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>在添加额外镜像层的同时，镜像始终保持是当前所有镜像的组合。下图举了一个简单的例子，每个镜像层包含三个文件，而镜像包含了来自两个镜像层的六个文件。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-image-layer.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>这种情况下，上层镜像层中的文件覆盖了底层镜像层中的文件，这样就使得文件的更新版本作为一个新镜像层添加到镜像当中。</p>\n<p><code>Docker</code>通过存储引擎（新版本采用快照机制）的方式来实现镜像层堆栈，并保证多镜像层对外展示为统一的文件系统。</p>\n<p><code>Linux</code>上可用的存储引擎有<code>AUFS</code>、<code>Overlay2</code>、<code>Device Mapper</code>、<code>Btrfs</code>以及<code>ZFS</code>。顾名思义，每种存储引擎都基于<code>Linux</code>中对应的文件系统或者块设备技术，并且每种存储引擎都有其独有的性能特点。</p>\n<p><code>Docker</code>在<code>Windows</code>上仅支持<code>windowsfilter</code>一种存储引擎，该引擎基于<code>NTFS</code>文件系统之上实现了分层和<code>CoW</code>。</p>\n<p>下图展示了与系统显示相同的三层镜像，所有镜像层堆叠并合并，对外提供统一的视图。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-image-merge-view.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>Docker</code>镜像都是只读的，当容器启动时，一个新的可写层被加载到镜像的底部，这一层就是通常说的容器层，容器层之下都叫镜像层。</p>\n<h3> 提交镜像</h3>\n<p>使用<code>docker commit</code>命令提交容器成为一个新的版本，<code>docker commit -m=“提交的描述信息”  -a=\"作者\" 容器id 目标镜像名:[TAG]</code>。</p>\n<p>由于默认的<code>Tomcat</code>镜像的<code>webapps</code>文件夹中没有任何内容，需要从<code>webapps.dist</code>中拷贝文件到<code>webapps</code>文件夹。下面自行制作镜像：就是从<code>webapps.dist</code>中拷贝文件到<code>webapps</code>文件夹下，并提交该镜像作为一个新的镜像。使得该镜像默认的<code>webapps</code>文件夹下就有文件。具体命令如下：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>参数说明：</p>\n<ul>\n<li><code>-m</code>：提交的描述信息</li>\n<li><code>-a</code>：作者</li>\n<li><code>:[TAG]</code>：版本号</li>\n</ul>\n<h1> 常见容器部署</h1>\n<h2> Nginx</h2>\n<ol>\n<li>\n<p>查找</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>下载</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>启动</p>\n<ul>\n<li><code>-d</code>：后台运行</li>\n<li><code>--name</code>：给容器命名</li>\n<li><code>-p 3334:80</code>：将宿主机的端口 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3334</mn></mrow><annotation encoding=\"application/x-tex\">3334</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">3334</span></span></span></span> 映射到该容器的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">80</span></span></span></span> 端口</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-container-portmap.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n<li>\n<p>配置文件<br>\n进入容器，自定义配置文件</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>访问测试</p>\n<ul>\n<li>\n<p>本地主机访问测试，<code>curl</code>命令发起请求，如果使用阿里云服务器需要设置安全组</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>浏览器访问<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-nginx-view.png\" alt=\"\" loading=\"lazy\"></p>\n</li>\n</ul>\n</li>\n</ol>\n<h2> Tomcat</h2>\n<ol>\n<li>\n<p>查找</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>下载</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>启动</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>进入容器</p>\n<ul>\n<li>容器中的命令少了</li>\n<li>阿里云镜像默认下载的是最小的镜像，保证最小的运行环境</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>访问测试</p>\n<ul>\n<li>\n<p>本地主机访问测试，<code>curl</code>命令发起请求，如果使用阿里云服务器需要设置安全组</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>浏览器访问<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-tomcat-view.png\" alt=\"\" loading=\"lazy\"></p>\n</li>\n</ul>\n</li>\n</ol>\n<h2> ElasticSearch</h2>\n<ol>\n<li>\n<p>查找</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>下载</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>运行</p>\n<ol>\n<li>\n<p>添加 <code>-e ES_JAVA_OPTS=\"-Xms128m -Xmx512m\"</code> 配置<code>ElasticSearch</code>的虚拟机占用的内存大小</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>docker stats</code>：查看资源占用情况</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>\n<p>进入容器</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>访问</p>\n<ul>\n<li>\n<p>本地主机访问测试，<code>curl</code>命令发起请求，如果使用阿里云服务器需要设置安全组</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>浏览器访问<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-elasticsearch-view.png\" alt=\"\" loading=\"lazy\"></p>\n</li>\n</ul>\n</li>\n</ol>\n<p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/docker-image-and-container/docker-container.png",
      "date_published": "2023-10-20T00:00:00.000Z",
      "date_modified": "2023-10-22T09:37:28.585Z",
      "authors": [],
      "tags": [
        "Docker"
      ]
    },
    {
      "title": "RabbitMQ 概述",
      "url": "https://1coins.github.io/article/rabbitmq/rabbitmq-introduction.html",
      "id": "https://1coins.github.io/article/rabbitmq/rabbitmq-introduction.html",
      "summary": "MQ 的相关概念 什么是 MQ MQ(message queue)，从字面意思上看，本质是个队列，FIFO先入先出，只不过队列中存放的内容是message而已，还是一种跨进程的通信机制，用于上下游传递消息。 在互联网架构中，MQ是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了MQ之后，消息发送上游只需要依赖MQ，不用依赖其他服务。 为什么要用 MQ",
      "content_html": "<h1> MQ 的相关概念</h1>\n<h2> 什么是 MQ</h2>\n<p><code>MQ(message queue)</code>，从字面意思上看，本质是个队列，<code>FIFO</code>先入先出，只不过队列中存放的内容是<code>message</code>而已，还是一种跨进程的通信机制，用于上下游传递消息。</p>\n<p>在互联网架构中，<code>MQ</code>是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了<code>MQ</code>之后，消息发送上游只需要依赖<code>MQ</code>，不用依赖其他服务。</p>\n<h2> 为什么要用 MQ</h2>\n<h3> 流量消峰</h3>\n<p>举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段下单一秒后就能返回结果；但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。</p>\n<p>使用消息队列做缓冲，可以取消这个限制，把一秒内下的订单分散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好。</p>\n<h3> 应用解耦</h3>\n<p>以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统；用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。</p>\n<p>当转变成基于消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复；在这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成；当物流系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/application-decouple.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 异步处理</h3>\n<p>有些服务间调用是异步的，例如<code>A</code>调用<code>B</code>，<code>B</code>需要花费很长时间执行，但是<code>A</code>需要知道<code>B</code>什么时候可以执行完，以前一般有两种方式，<code>A</code>过一段时间去调用<code>B</code>的查询<code>api</code>查询。或者<code>A</code>提供一个<code>callback api</code>，<code>B</code>执行完之后调用<code>api</code>通知<code>A</code>服务。</p>\n<p>但这两种方式都不是很优雅，使用消息总线，可以很方便解决这个问题。</p>\n<p><code>A</code>调用<code>B</code>服务后，只需要监听<code>B</code>处理完成的消息，当<code>B</code>处理完成后，会发送一条消息给<code>MQ</code>，<code>MQ</code>会将此消息转发给<code>A</code>服务；这样<code>A</code>服务既不用循环调用<code>B</code>的查询<code>api</code>，也不用提供<code>callback api</code>。同样<code>B</code>服务也不用做这些操作，<code>A</code>服务还能及时的得到异步处理成功的消息。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/asynchronous-process.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> MQ 的分类</h2>\n<ol>\n<li>\n<p><code>ActiveMQ</code></p>\n<ul>\n<li>优点：单机吞吐量万级，时效性<code>ms</code>级，可用性高，基于主从架构实现高可用性，消息可靠性较低的概率丢失数据</li>\n<li>缺点：官方社区现在对<code>ActiveMQ 5.x</code>维护越来越少，高吞吐量场景较少使用</li>\n</ul>\n</li>\n<li>\n<p><code>Kafka</code><br>\n大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开<code>Kafka</code>，这款为大数据而生的消息中间件，以其百万级<code>TPS</code>的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存储的过程中发挥着举足轻重的作用。目前已经被<code>LinkedIn</code>，<code>Uber</code>,<code> Twitter</code>, <code>Netflix</code>等大公司所采纳。</p>\n<ul>\n<li>优点：性能卓越，单机写入<code>TPS</code>约在百万条/秒，最大的优点，就是吞吐量高；时效性<code>ms</code>级可用性非常高，<code>kafka</code>是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用，消费者采用<code>Pull</code>方式获取消息，消息有序，通过控制能够保证所有消息被消费且仅被消费一次；有优秀的第三方<code>Kafka Web</code>管理界面<code>Kafka-Manager</code>；在日志领域比较成熟，被多家公司和多个开源项目使用</li>\n<li><code>Kafka</code>单机超过 64 个队列/分区，<code>Load</code>会发生明显的飙高现象，队列越多，<code>load</code>越高，发送消息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；支持消息顺序，但是一台代理宕机后，就会产生消息乱序，社区更新较慢</li>\n<li>功能支持：功能较为简单，主要支持简单的<code>MQ</code>功能，在大数据领域的实时计算以及日志采集被大规模使用</li>\n</ul>\n</li>\n<li>\n<p><code>RocketMQ</code><br>\n<code>RocketMQ</code>出自阿里巴巴的开源产品，用<code>Java</code>语言实现，在设计时参考了<code>Kafka</code>，并做出了自己的一些改进。被阿里巴巴广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，<code>binglog</code>分发等场景。</p>\n<ul>\n<li>优点：单机吞吐量十万级,可用性非常高，分布式架构，消息可以做到零丢失，<code>MQ</code>功能较为完善，还是分布式的，扩展性好，支持 10 亿级别的消息堆积，不会因为堆积导致性能下降，源码是<code>Java</code>，可以阅读源码，定制自己公司的<code>MQ</code></li>\n<li>缺点：支持的客户端语言不多，目前是<code>Java</code>及<code>C++</code>，其中<code>C++</code>不成熟；社区活跃度一般，没有在<code>MQ</code>核心中去实现<code>JMS</code>等接口，有些系统要迁移需要修改大量代码</li>\n</ul>\n</li>\n<li>\n<p><code>RabbitMQ</code><br>\n2007 年发布，是一个在<code>AMQP</code>（高级消息队列协议）基础上完成的，可复用的企业消息系统，是当前最主流的消息中间件之一。</p>\n<ul>\n<li>优点：由于<code>erlang</code>语言的高并发特性，性能较好；吞吐量到万级，<code>MQ</code>功能比较完备，健壮、稳定、易用、跨平台、支持多种语言：<code>Python</code>、<code>Ruby</code>、<code>.NET</code>、<code>Java</code>、<code>JMS</code>、<code>C</code>、<code>PHP</code>、<code>ActionScript</code>、<code>XMPP</code>、<code>STOMP</code>等，支持<code>AJAX</code>文档齐全；开源提供的管理界面非常棒，用起来很好用，社区活跃度高；<a href=\"https://www.rabbitmq.com/news.html\" target=\"_blank\" rel=\"noopener noreferrer\">更新频率相当高</a></li>\n<li>缺点：商业版需要收费，学习成本较高</li>\n</ul>\n</li>\n</ol>\n<h2> MQ 的选择</h2>\n<ol>\n<li><code>Kafka</code><br>\n<code>Kafka</code>主要特点是基于<code>Pull</code>的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输，适合产生大量数据的互联网服务的数据收集业务。大型公司建议可以选用，如果有日志采集功能，肯定是首选<code>Kafka</code>了。</li>\n<li><code>RocketMQ</code><br>\n天生为金融互联网领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况；<code>RoketMQ</code>在稳定性上可能更值得信赖，这些业务场景在阿里双 11 已经经历了多次考验，如果业务有上述并发场景，建议可以选择 <code>RocketMQ</code></li>\n<li><code>RabbitMQ</code><br>\n结合<code>erlang</code>语言本身的并发优势，性能好时效性微秒级，社区活跃度也比较高，管理界面用起来十分方便，如果数据量没有那么大，中小型公司优先选择功能比较完备的<code>RabbitMQ</code></li>\n</ol>\n<h1> RabbitMQ</h1>\n<h2> RabbitMQ 的概念</h2>\n<p><code>RabbitMQ</code>是一个消息中间件：它接受并转发消息，可以把它当做一个快递站点，当要发送一个包裹时，把包裹放到快递站，快递员最终会把快递送到收件人那里；按照这种逻辑，<code>RabbitMQ</code>是一个快递站，一个快递员帮你传递快件；<code>RabbitMQ</code>与快递站的主要区别在于，它不处理快件而是接收，存储和转发消息数据。</p>\n<h2> 四大核心概念</h2>\n<ul>\n<li>生产者：产生数据发送消息的程序是生产者</li>\n<li>交换机：交换机是<code>RabbitMQ</code>非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定</li>\n<li>队列：队列是<code>RabbitMQ</code>内部使用的一种数据结构，尽管消息流经<code>RabbitMQ</code>和应用程序，但它们只能存储在队列中；队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区；许多生产者可以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据；这就是使用队列的方式</li>\n<li>消费者：消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序；请注意生产者，消费者和消息中间件很多时候并不在同一机器上，同一个应用程序既可以是生产者又是可以是消费者</li>\n</ul>\n<h2> 名词介绍</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/rabbitmq-operate-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ul>\n<li><code>Broker</code>：接收和分发消息的应用，<code>RabbitMQ Server</code>就是<code>Message Broker</code></li>\n<li><code>Virtual host</code>：出于多租户和安全因素设计的，把<code>AMQP</code>的基本组件划分到一个虚拟的分组中，类似于网络中的<code>namespace</code>概念；当多个不同的用户使用同一个<code>RabbitMQ Server</code>提供的服务时，可以划分出多个<code>vhost</code>，每个用户在自己的<code>vhost</code>创建<code>exchange／queue</code>等</li>\n<li><code>Connection</code>：<code>publisher／consumer</code>和<code>broker</code>之间的<code>TCP</code>连接</li>\n<li><code>Channel</code>：如果每一次访问<code>RabbitMQ</code>都建立一个<code>Connection</code>，在消息量大的时候建立<code>TCP Connection</code>的开销将是巨大的，效率也较低；<code>Channel</code>是在<code>connection</code>内部建立的逻辑连接，如果应用程序支持多线程，通常每个<code>thread</code>创建单独的<code>channel</code>进行通讯，<code>AMQP method</code>包含了<code>channel id</code>帮助客户端和<code>message broker</code>识别<code>channel</code>，所以<code>channel</code>之间是完全隔离的；<code>Channel</code>作为轻量级的<code>Connection</code>极大减少了操作系统建立<code>TCP connection</code>的开销</li>\n<li><code>Exchange</code>：<code>message</code>到达<code>broker</code>的第一站，根据分发规则，匹配查询表中的<code>routing key</code>，分发消息到<code>queue</code>中去；常用的类型有：<code>direct (point-to-point)</code>，<code>topic (publish-subscribe) and fanout(multicast)</code></li>\n<li><code>Queue</code>：消息最终被送到这里等待<code>consumer</code>取走</li>\n<li><code>Binding</code>：<code>exchange</code>和<code>queue</code>之间的虚拟连接，<code>binding</code>中可以包含<code>routing key</code>，<code>Binding</code>信息被保存到<code>exchange</code>中的查询表中，用于<code>message</code>的分发依据</li>\n</ul>\n<h2> 安装</h2>\n<ol>\n<li>\n<p><a href=\"https://www.rabbitmq.com/download.html\" target=\"_blank\" rel=\"noopener noreferrer\">官网地址</a></p>\n</li>\n<li>\n<p>文件上传<br>\n<code>erlang</code>和<code>RabbitMQ</code>上传到<code>/usr/local/software</code>目录下（如果没有<code>software</code>需要自己创建）。</p>\n</li>\n<li>\n<p>安装文件（分别按照以下顺序安装）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>安装依赖问题：</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p><code>https://pkgs.org/</code>搜索<code>libcrypto.so.10()(64bit)</code></p>\n</li>\n<li>\n<p>常用命令（按照以下顺序执行）</p>\n<ol>\n<li>\n<p>添加开机启动<code>RabbitMQ</code>服务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>启动服务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查看服务状态</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>停止服务（选择执行）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>开启<code>Web</code>管理插件（停止服务后执行）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>如果报错：</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>修改<code>/etc/hosts</code>，添加上</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>用默认账号密码（<code>guest</code>）访问地址<code>http://192.168.30.129:15672/</code>出现权限问题。</p>\n</li>\n</ol>\n</li>\n<li>\n<p>添加一个新的用户</p>\n<ul>\n<li>\n<p>创建账号</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设置用户角色</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设置用户权限</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>当前用户和角色</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>再次利用<code>admin</code>用户登录</p>\n</li>\n<li>\n<p>重置命令</p>\n<ul>\n<li>\n<p>关闭应用的命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>清除的命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重新启动命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n</ol>\n<h1> Hello World</h1>\n<p>在这一部分中，将用<code>Java</code>编写两个程序。发送单个消息的生产者和接收消息并打印出来的消费者。将介绍<code>Java API</code>中的一些细节。</p>\n<p>在下图中，<code>P</code>是生产者，<code>C</code>是我们的消费者。中间的框是一个<code>RabbitMQ</code>队列代表使用者保留的消息缓冲区。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/hello-word.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 依赖</h2>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 消息生产者</h2>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 消息消费者</h2>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> Work Queues</h1>\n<p>工作队列（又称任务队列）的主要思想是避免立即执行资源密集型任务，而不得不等待它完成。</p>\n<p>相反安排任务在之后执行，把任务封装为消息并将其发送到队列；在后台运行的工作进程将弹出任务并最终执行作业，当有多个工作线程时，这些工作线程将一起处理这些任务。</p>\n<h2> 轮训分发消息</h2>\n<p>在这个案例中会启动两个工作线程，一个消息发送线程，来看看他们两个工作线程是如何工作的。</p>\n<h3> 抽取工具类</h3>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 启动两个工作线程</h3>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/\\rabbitmq-introduction/start-two-work-thread-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/start-two-work-thread-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 启动一个发送线程</h3>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 结果展示</h3>\n<p>通过程序执行发现生产者总共发送 4 个消息，消费者 1 和消费者 2 分别分得两个消息，并且是按照有序的一个接收一次消息。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/turn-distribute-message-result.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 消息应答</h2>\n<h3> 概念</h3>\n<p>消费者完成一个任务可能需要一段时间，如果其中一个消费者处理一个长的任务并仅只完成了部分突然它挂掉了，会发生什么情况</p>\n<p>。<code>RabbitMQ</code>一旦向消费者传递了一条消息，便立即将该消息标记为删除；在这种情况下，突然有个消费者挂掉了，将丢失正在处理的消息，以及后续发送给该消费这的消息，因为它无法接收到。</p>\n<p>为了保证消息在发送过程中不丢失，<code>RabbitMQ</code>引入消息应答机制，消息应答就是：消费者在接收到消息并且处理该消息之后，告诉<code>RabbitMQ</code>它已经处理了，<code>RabbitMQ</code>可以把该消息删除了。</p>\n<h3> 自动应答</h3>\n<p>消息发送后立即被认为已经传送成功，这种模式需要在<strong>高吞吐量和数据传输安全性方面做权衡</strong>，因为这种模式如果消息在接收到之前，消费者那边出现连接或者<code>channel</code>关闭，那么消息就丢失了，当然另一方面这种模式消费者那边可以传递过载的消息，<strong>没有对传递的消息数量进行限制</strong>，当然这样有可能使得消费者这边由于接收太多还来不及处理的消息，导致这些消息的积压，最终使得内存耗尽，最终这些消费者线程被操作系统杀死，所以这种模式<strong>仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下使用</strong>。</p>\n<h3> 消息应答的方法</h3>\n<ul>\n<li>\n<p><code>Channel.basicAck</code>：用于肯定确认</p>\n<ul>\n<li><code>RabbitMQ</code>已知道该消息并且成功的处理消息，可以将其丢弃了</li>\n</ul>\n</li>\n<li>\n<p><code>Channel.basicNack</code>：用于否定确认</p>\n</li>\n<li>\n<p><code>Channel.basicReject</code>：用于否定确认</p>\n<ul>\n<li>与<code>Channel.basicNack</code>相比少一个参数<code>Multiple</code></li>\n<li>不处理该消息了直接拒绝，可以将其丢弃了</li>\n</ul>\n</li>\n</ul>\n<p>不处理该消息了直接拒绝，可以将其丢弃了。</p>\n<h3> Multiple 的解释</h3>\n<p>手动应答的好处是可以批量应答并且减少网络拥堵。</p>\n<p><code>multiple</code>的<code>true</code>和<code>false</code>代表不同意思：</p>\n<ul>\n<li>\n<p><code>true</code>代表批量应答<code>channel</code>上未应答的消息</p>\n<ul>\n<li>比如说<code>channel</code>上有传送<code>tag</code>的消息是 5、6、7、8，当前<code>tag</code>是 8，那么此时 5-8 的这些还未应答的消息都会被确认收到消息应答</li>\n</ul>\n</li>\n<li>\n<p><code>false</code>同上面相比只会应答<code>tag=8</code>的消息，5、6、7 这三个消息依然不会被确认收到消息应答</p>\n</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/multiple-true-false.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 消息自动重新入队</h3>\n<p>如果消费者由于某些原因失去连接（其通道已关闭，连接已关闭或<code>TCP</code>连接丢失），导致消息未发送<code>ACK</code>确认，<code>RabbitMQ</code>将了解到消息未完全处理，并将对其重新排队；如果此时其他消费者可以处理，它将很快将其重新分发给另一个消费者；这样，即使某个消费者偶尔死亡，也可以确保不会丢失任何消息。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/message-automatically-re-enlists.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 消息手动应答代码</h3>\n<p>默认消息采用的是自动应答，所以我们要想实现消息消费过程中不丢失，需要把自动应答改为手动应答。</p>\n<ul>\n<li>\n<p>生产者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>消费者</p>\n<ol>\n<li>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>\n<p>睡眠工具类</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 手动应答效果演示</h3>\n<p>正常情况下消息发送方发送两个消息<code>C1</code>和<code>C2</code>分别接收到消息并进行处理：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/manual-response-effect-demonstration-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>在发送者发送消息<code>dd</code>，发出消息之后的把<code>C2</code>消费者停掉，按理说该<code>C2</code>来处理该消息，但是由于它处理时间较长，在还未处理完，也就是说<code>C2</code>还没有执行<code>ack</code>代码的时候，<code>C2</code>被停掉了，此时会看到消息被<code>C1</code>接收到了，说明消息<code>dd</code>被重新入队，然后分配给能处理消息的<code>C1</code>处理了。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/manual-response-effect-demonstration-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> RabbitMQ 持久化</h2>\n<h3> 概念</h3>\n<p>刚刚已经看到了如何处理任务不丢失的情况，但是如何保障当<code>RabbitMQ</code>服务停掉以后消息生产者发送过来的消息不丢失？</p>\n<p>默认情况下<code>RabbitMQ</code>退出或由于某种原因崩溃时，它忽视队列和消息，除非告知它不要这样做。</p>\n<p>确保消息不会丢失需要做两件事：将队列和消息都标记为持久化。</p>\n<h3> 队列如何实现持久化</h3>\n<p>之前创建的队列都是非持久化的，<code>RabbitMQ</code>如果重启的话，该队列就会被删除掉，如果要队列实现持久化，需要在声明队列的时候把<code>durable</code>参数设置为持久化。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>但是需要注意的就是如果之前声明的队列不是持久化的，需要把原先队列先删除，或者重新创建一个持久化的队列，不然就会出现错误：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>以下为控制台中持久化与非持久化队列的<code>UI</code>显示区：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/persistent-queue-console-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/persistent-queue-console-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>这个时候即使重启<code>RabbitMQ</code>，队列也依然存在。</p>\n<h3> 消息实现持久化</h3>\n<p>要想让消息实现持久化需要在消息生产者修改代码，添加属性<code>MessageProperties.PERSISTENT_TEXT_PLAIN</code>。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>将消息标记为持久化并不能完全保证不会丢失消息，尽管它告诉<code>RabbitMQ</code>将消息保存到磁盘，但是这里依然存在当消息刚准备存储在磁盘但还没有存储完的时候，消息还在缓存的一个间隔点。此时并没有真正写入磁盘，持久性保证并不强，但是对于简单任务队列而言，这已经绰绰有余了，如果需要更强有力的持久化策略，可以参考后边的发布确认章节。</p>\n<h3> 不公平分发</h3>\n<p>在最开始的时候，学习到<code>RabbitMQ</code>分发消息采用的轮训分发，但是在某种场景下这种策略并不是很好，比方说有两个消费者在处理任务，其中有个消费者 1 处理任务的速度非常快，而另外一个消费者 2 处理速度却很慢，这个时候还是采用轮训分发的话就会到这处理速度快的这个消费者很大一部分时间处于空闲状态，而处理慢的那个消费者一直在干活，这种分配方式在这种情况下其实就不太好，但是<code>RabbitMQ</code>并不知道这种情况，它依然很公平的进行分发。</p>\n<p>为了避免这种情况，可以设置参数<code>channel.basicQos(1);</code>。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>意思就是如果这个任务还没有处理完或者还没有应答，就先别分配，因为目前只能处理一个任务，然后<code>RabbitMQ</code>就会把该任务分配给没有那么忙的那个空闲消费者，当然如果所有的消费者都没有完成手上任务，队列还在不停的添加新任务，队列有可能就会遇到队列被撑满的情况，这个时候就只能添加新的<code>worker</code>或者改变其他存储任务的策略。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/unfair-distribution-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/unfair-distribution-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 预取值</h3>\n<p>本身消息的发送就是异步发送的，所以在任何时候，<code>channel</code>上肯定不止只有一个消息；另外来自消费者的手动确认本质上也是异步的。因此这里就存在一个未确认的消息缓冲区，希望开发人员能<strong>限制此缓冲区的大小，以避免缓冲区里面无限制的未确认消息问题</strong>。</p>\n<p>这个时候就可以通过使用<code>basic.qos</code>方法设置<strong>预取计数值</strong>来完成，该值<strong>定义通道上允许的未确认消息的最大数量</strong>；一旦数量达到配置的数量，<code>RabbitMQ</code>将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认。</p>\n<p>例如，假设在通道上有未确认的消息 5、6、7、8，并且通道的预取计数设置为 4，此时<code>RabbitMQ</code>将不会在该通道上再传递任何消息，除非至少有一个未应答的消息被<code>ack</code>，比方说<code>tag=6</code>这个消息刚刚被确认<code>ACK</code>，<code>RabbitMQ</code>将会感知这个情况到并再发送一条消息。</p>\n<p>消息应答和<code>QoS</code>预取值对用户吞吐量有重大影响。通常，增加预取将提高向消费者传递消息的速度；<strong>虽然自动应答传输消息速率是最佳的，但是，在这种情况下已传递但尚未处理的消息的数量也会增加，从而增加了消费者的</strong>**<code>RAM</code>****消耗（随机存取存储器）**。</p>\n<p>应该小心使用具有无限预处理的自动确认模式或手动确认模式，消费者消费了大量的消息如果没有确认的话，会导致消费者连接节点的内存消耗变大，所以找到合适的预取值是一个反复试验的过程，不同的负载该值取值也不同，100 到 300 范围内的值通常可提供最佳的吞吐量，并且不会给消费者带来太大的风险。</p>\n<p>预取值为 1 是最保守的。当然这将使吞吐量变得很低，特别是消费者连接延迟很严重的情况下，特别是在消费者连接等待时间较长的环境中，对于大多数应用来说，稍微高一点的值将是最佳的。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/prefetch-the-value-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/prefetch-the-value-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>W2</code>消费能力差，当发送 7 条数据，<code>W2</code>预取值为 5 的情况下，信道中会堆积 5 条消息：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/prefetch-the-value-3.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-introduction/application-decouple.png",
      "date_published": "2023-10-11T00:00:00.000Z",
      "date_modified": "2023-10-14T08:58:25.000Z",
      "authors": [],
      "tags": [
        "RabbitMQ"
      ]
    },
    {
      "title": "发布确认与交换机",
      "url": "https://1coins.github.io/article/rabbitmq/rabbitmq-release-confirme-and-switch.html",
      "id": "https://1coins.github.io/article/rabbitmq/rabbitmq-release-confirme-and-switch.html",
      "summary": "发布确认 发布确认原理 生产者将信道设置成confirm模式，一旦信道进入confirm模式，所有在该信道上面发布的消息都将会被指派一个唯一的ID（从 1 开始），一旦消息被投递到所有匹配的队列之后，broker就会发送一个确认给生产者（包含消息的唯一ID），这就使得生产者知道消息已经正确到达目的队列了；如果消息和队列是可持久化的，那么确认消息会在将消息写入磁盘之后发出，broker回传给生产者的确认消息中delivery-tag域包含了确认消息的序列号，此外broker也可以设basic.ack 的multiple域，表示到这个序列号之前的所有消息都已经得到了处理。",
      "content_html": "<h1> 发布确认</h1>\n<h2> 发布确认原理</h2>\n<p>生产者将信道设置成<code>confirm</code>模式，一旦信道进入<code>confirm</code>模式，所有在该信道上面发布的消息都将会被指派一个唯一的<code>ID</code>（从 1 开始），一旦消息被投递到所有匹配的队列之后，<code>broker</code>就会发送一个确认给生产者（包含消息的唯一<code>ID</code>），这就使得生产者知道消息已经正确到达目的队列了；如果消息和队列是可持久化的，那么确认消息会在将消息写入磁盘之后发出，<code>broker</code>回传给生产者的确认消息中<code>delivery-tag</code>域包含了确认消息的序列号，此外<code>broker</code>也可以设<code>basic.ack</code> 的<code>multiple</code>域，表示到这个序列号之前的所有消息都已经得到了处理。</p>\n<p><code>confirm</code>模式最大的好处在于他是异步的，一旦发布一条消息，生产者应用程序就可以在等信道返回确认的同时继续发送下一条消息，当消息最终得到确认之后，生产者应用便可以通过回调方法来处理该确认消息，如果<code>RabbitMQ</code>因为自身内部错误导致消息丢失，就会发送一条<code>nack</code>消息，生产者应用程序同样可以在回调方法中处理该<code>nack</code>消息。</p>\n<h2> 发布确认的策略</h2>\n<h3> 开启发布确认的方法</h3>\n<p>发布确认默认是没有开启的，如果要开启需要调用方法<code>confirmSelect</code>，每当你要想使用发布确认，都需要在<code>channel</code>上调用该方法。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 单个确认发布</h3>\n<p>这是一种简单的确认方式，它是一种同步确认发布的方式，也就是发布一个消息之后只有它被确认发布，后续的消息才能继续发布，<code>waitForConfirmsOrDie(long)</code>这个方法只有在消息被确认的时候才返回，如果在指定时间范围内这个消息没有被确认那么它将抛出异常。</p>\n<p>这种确认方式有一个最大的缺点就是:发布速度特别的慢，因为如果没有确认发布的消息就会阻塞所有后续消息的发布，这种方式最多提供每秒不超过数百条发布消息的吞吐量，当然对于某些应用程序来说这可能已经足够了。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 批量确认发布</h3>\n<p>上面那种方式非常慢，与单个等待确认消息相比，先发布一批消息然后一起确认可以极大地提高吞吐量；当然这种方式的缺点就是：当发生故障导致发布出现问题时，不知道是哪个消息出现问题了，必须将整个批处理保存在内存中，以记录重要的信息而后重新发布消息；当然这种方案仍然是同步的，也一样阻塞消息的发布。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 异步确认发布</h3>\n<p>异步确认虽然编程逻辑比上两个要复杂，但是性价比最高，无论是可靠性还是效率都没得说，它是利用回调函数来达到消息可靠性传递的，这个中间件也是通过函数回调来保证是否投递成功，下面就来详细讲解异步确认是怎么实现的。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/asynchronous-confirme-release.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 如何处理异步未确认消息</h3>\n<p>最好的解决的解决方案就是把未确认的消息放到一个基于内存的能被发布线程访问的队列，比如说用<code>ConcurrentLinkedQueue</code>这个队列在<code>confirm callbacks</code>与发布线程之间进行消息的传递。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 以上 3 种发布确认速度对比</h3>\n<ul>\n<li>单独发布消息<br>\n同步等待确认，简单，但吞吐量非常有限。</li>\n<li>批量发布消息<br>\n批量同步等待确认，简单，合理的吞吐量，一旦出现问题但很难推断出是那条消息出现了问题。</li>\n<li>异步处理<br>\n最佳性能和资源使用，在出现错误的情况下可以很好地控制，但是实现起来稍微难些。</li>\n</ul>\n<h1> 交换机</h1>\n<p>在上一节中创建了一个工作队列。</p>\n<p>假设的是工作队列背后，每个任务都恰好交付给一个消费者（工作进程），在这一部分将做一些完全不同的事情：将消息传达给多个消费者。这种模式称为“发布/订阅”。</p>\n<p>为了说明这种模式，将构建一个简单的日志系统，它由两个程序组成：第一个程序将发出日志消息，第二个程序是消费者。</p>\n<p>启动两个消费者，其中一个消费者接收到消息后把日志存储在磁盘，另外一个消费者接收到消息后把消息打印在屏幕上，事实上第一个程序发出的日志消息将广播给所有消费者。</p>\n<h2> Exchanges</h2>\n<h3> Exchanges 概念</h3>\n<p><code>RabbitMQ</code>消息传递模型的核心思想是：生产者生产的消息从不会直接发送到队列；实际上，通常生产者甚至都不知道这些消息传递传递到了哪些队列中。</p>\n<p>相反，生产者只能将消息发送到交换机（<code>Exchange</code>），交换机工作的内容非常简单，一方面它接收来自生产者的消息，另一方面将它们推入队列；交换机必须确切知道如何处理收到的消息，是应该把这些消息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们，这就的由交换机的类型来决定。</p>\n<h3> Exchanges 的类型</h3>\n<p>总共有以下类型：</p>\n<ul>\n<li>直接（<code>direct</code>）</li>\n<li>主题（<code>topic</code>）</li>\n<li>标题（<code>headers</code>）</li>\n<li>扇出（<code>fanout</code>）</li>\n</ul>\n<h3> 无名 Exchange</h3>\n<p>在前面部分对<code>Exchange</code>一无所知，但仍然能够将消息发送到队列。之前能实现的原因是因为使用的是默认交换，通过空字符串（<code>\"\"</code>）进行标识。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>第一个参数是交换机的名称。空字符串表示默认或无名称交换机：消息能路由发送到队列中其实是由<code>routingKey(bindingkey)</code>绑定<code>key</code>指定的，如果它存在的话。</p>\n<h2> 临时队列</h2>\n<p>之前使用的是具有特定名称的队列（<code>hello</code>和<code>ack_queue</code>）。队列的名称至关重要——需要指定消费者去消费哪个队列的消息。</p>\n<p>每当连接到<code>Rabbit</code>时，都需要一个全新的空队列，为此可以创建一个具有随机名称的队列，或者能让服务器选择一个随机队列名称那就更好了，其次一旦断开了消费者的连接，队列将被自动删除。</p>\n<p>创建临时队列的方式如下：</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>创建出来之后长成这样：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/temporary-queue.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 绑定（bindings）</h2>\n<p>什么是<code>bingding</code>呢，<code>binding</code>其实是<code>exchange</code>和<code>queue</code>之间的桥梁，它告诉我们<code>exchange</code>和那个队列进行了绑定关系。比如说下面这张图告诉我们的就是<code>X</code>与<code>Q1</code>和<code>Q2</code>进行了绑定。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/queue-binding-exchange.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> Fanout</h2>\n<h3> Fanout 介绍</h3>\n<p><code>Fanout</code>这种类型非常简单。正如从名称中猜到的那样，它是将接收到的所有消息广播到它知道的所有队列中。</p>\n<p>系统中默认有些<code>exchange</code>类型：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/default-fanout.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> Fanout 实战</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/fanout-lloog-binding-example-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>Logs</code>和临时队列的绑定关系如下图：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/fanout-lloog-binding-example-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ul>\n<li>\n<p><code>Receive01</code>将接收到的消息打印在控制台</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>Receive02</code>将接收到的消息存储在磁盘</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>EmitLog</code>发送消息给两个消费者接收</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> Direct Exchange</h2>\n<h3> 回顾</h3>\n<p>在上一节中构建了一个简单的日志记录系统，能够向许多接收者广播日志消息；在本节我们向其中添加一些特别的功能：比方说只让某个消费者订阅发布的部分消息，例如只把严重错误消息定向存储到日志文件（以节省磁盘空间），同时仍然能够在控制台上打印所有日志消息。</p>\n<p>再次来回顾一下什么是<code>bindings</code>，绑定是交换机和队列之间的桥梁关系。也可以这么理解：队列只对它绑定的交换机的消息感兴趣。</p>\n<p>绑定用参数：<code>routingKey</code>来表示，也可称该参数为<code>binding key</code>，创建绑定用代码：<code>channel.queueBind(queueName, EXCHANGE_NAME, \"routingKey\");</code>，绑定之后的意义由其交换类型决定。</p>\n<h3> Direct Exchange 介绍</h3>\n<p>上一节中的日志系统将所有消息广播给所有消费者，对此想做一些改变，例如希望将日志消息写入磁盘的程序仅接收严重错误（<code>errros</code>），而不存储那些警告（<code>warning</code>）或信息（<code>info</code>）日志消息避免浪费磁盘空间。</p>\n<p><code>Fanout</code>这种交换类型并不能带来很大的灵活性——它只能进行无意识的广播，在这里将使用<code>direct</code>这种类型来进行替换，这种类型的工作方式是，消息只去到它绑定的<code>routingKey</code>队列中去。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/direct-log-binding.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>在上面这张图中，可以看到<code>X</code>绑定了两个队列，绑定类型是<code>direct</code>。队列<code>Q1</code>绑定键为<code>orange</code>，队列<code>Q2</code>绑定键有两个：一个绑定键为<code>black</code>，另一个绑定键为<code>green</code>。</p>\n<p>在这种绑定情况下，生产者发布消息到<code>exchange</code>上，绑定键为<code>orange</code>的消息会被发布到队列<code>Q1</code>。绑定键为<code>black</code>和<code>green</code>的消息会被发布到队列<code>Q2</code>，其他消息类型的消息将被丢弃。</p>\n<h3> 多重绑定</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/direct-binding-more.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>当然如果<code>exchange</code>的绑定类型是<code>direct</code>，但是它绑定的多个队列的<code>key</code>如果都相同，在这种情况下虽然绑定类型是<code>direct</code>，但是它表现的就和<code>fanout</code>有点类似了，就跟广播差不多，如上图所示。</p>\n<h3> 实战</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/direct-binding-example-1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/direct-binding-example-2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ul>\n<li>\n<p>消费者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>生产者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> Topics</h2>\n<h3> 之前类型的问题</h3>\n<p>在上一个小节中改进了日志记录系统，没有使用只能进行随意广播的<code>fanout</code>交换机，而是使用了<code>direct</code>交换机，从而有能实现有选择性地接收日志。</p>\n<p>尽管使用<code>direct</code>交换机改进了系统，但是它仍然存在局限性：比方说想接收的日志类型有<code>info.base</code>和<code>info.advantage</code>，某个队列只想<code>info.base</code>的消息，那这个时候<code>direct</code>就办不到了。这个时候就只能使用<code>topic</code>类型。</p>\n<h3> Topic 的要求</h3>\n<p>发送到类型是<code>topic</code>，交换机的消息的<code>routing_key</code>不能随意写，必须满足一定的要求，它必须是一个单词列表，以点号分隔开，这些单词可以是任意单词，比如说：<code>stock.usd.nyse</code>，<code>nyse.vmw</code>，<code>quick.orange.rabbit</code>这种类型的。当然这个单词列表最多不能超过 255 个字节。</p>\n<p>在这个规则列表中，其中有两个替换符是需要注意的：</p>\n<ul>\n<li><code>*</code>（星号）可以代替一个单词</li>\n<li><code>#</code>（井号）可以替代零个或多个单词</li>\n</ul>\n<h3> Topic 匹配案例</h3>\n<p>下图绑定关系如下：</p>\n<ul>\n<li>\n<p><code>Q1</code>绑定的是</p>\n<ul>\n<li>中间带<code>orange</code>带 3 个单词的字符串（<code>*.orange.*</code>）</li>\n</ul>\n</li>\n<li>\n<p><code>Q2</code>绑定的是</p>\n<ul>\n<li>最后一个单词是<code>rabbit</code>的 3 个单词（<code>*.*.rabbit</code>）</li>\n<li>第一个单词是<code>lazy</code>的多个单词（<code>lazy.#</code>）</li>\n</ul>\n</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/topic-match.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>上图是一个队列绑定关系图，来看看他们之间数据接收情况是怎么样的：</p>\n<ul>\n<li><code>quick.orange.rabbit</code>被队列<code>Q1</code>、<code>Q2</code>接收到</li>\n<li><code>lazy.orange.elephant</code>被队列<code>Q1</code>、<code>Q2</code>接收到</li>\n<li><code>quick.orange.fox</code>被队列<code>Q1</code>接收到</li>\n<li><code>lazy.brown.fox</code>被队列<code>Q2</code>接收到</li>\n<li><code>lazy.pink.rabbit</code>虽然满足两个绑定但只被队列<code>Q2</code>接收一次</li>\n<li><code>quick.brown.fox</code>不匹配任何绑定不会被任何队列接收到会被丢弃</li>\n<li><code>quick.orange.male.rabbit</code>是四个单词不匹配任何绑定会被丢弃</li>\n<li><code>lazy.orange.male.rabbit</code>是四个单词但匹配<code>Q2</code></li>\n</ul>\n<p>当队列绑定关系是下列这种情况时需要引起注意：</p>\n<ul>\n<li><strong>当一个队列绑定键是</strong>**<code>#</code><strong><strong>，那么这个队列将接收所有数据，就有点像</strong></strong><code>fanout</code>**<strong>了</strong></li>\n<li><strong>如果队列绑定键当中没有</strong>**<code>#</code><strong><strong>和</strong></strong><code>*</code><strong><strong>出现，那么该队列绑定类型就是</strong></strong><code>direct</code>**<strong>了</strong></li>\n</ul>\n<p><strong>如果队列绑定键当中没有</strong>**<code>#</code><strong><strong>和</strong></strong><code>*</code><strong><strong>出现，那么该队列绑定类型就是</strong></strong><code>direct</code>**<strong>了</strong></p>\n<h3> 实战</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/topic-match-example.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ul>\n<li>\n<p>消费者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>生产者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h1> 发布确认高级</h1>\n<p>在生产环境中由于一些不明原因，会导致<code>RabbitMQ</code>重启，在<code>RabbitMQ</code>重启期间生产者消息投递失败，导致消息丢失，需要手动处理和恢复。</p>\n<p>那么，如何才能进行<code>RabbitMQ</code>的消息可靠投递呢？特别是在这样比较极端的情况，<code>RabbitMQ</code>集群不可用的时候，无法投递的消息该如何处理呢？</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 发布确认 SpringBoot 版本</h2>\n<h3> 确认机制方案</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/release-coonfirme-scheme.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 代码架构图</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/release-coonfirme-code-framework.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 配置</h3>\n<ul>\n<li>\n<p>配置文件<br>\n在配置文件当中需要添加：</p>\n<div class=\"language-properties line-numbers-mode\" data-ext=\"properties\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ul>\n<li>\n<p><code>NONE</code>：禁用发布确认模式，是默认值</p>\n</li>\n<li>\n<p><code>CORRELATED</code>：发布消息成功到交换器后会触发回调方法</p>\n</li>\n<li>\n<p><code>SIMPLE</code>：经测试有两种效果</p>\n<ul>\n<li>效果和<code>CORRELATED</code>值一样会触发回调方法</li>\n<li>在发布消息成功后使用<code>rabbitTemplate</code>调用<code>waitForConfirms</code>或<code>waitForConfirmsOrDie</code>方法等待<code>broker</code>节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是<code>waitForConfirmsOrDie</code>方法如果返回<code>false</code>则会关闭<code>channel</code>，则接下来无法发送消息到<code>broker</code></li>\n</ul>\n</li>\n</ul>\n<div class=\"language-properties line-numbers-mode\" data-ext=\"properties\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>配置类</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>消息生产者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>回调接口</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>消息消费者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 结果分析</h3>\n<p>访问：<a href=\"http://127.0.0.1:8080/confirm/sendMessage/111\" target=\"_blank\" rel=\"noopener noreferrer\">127.0.0.1:8080/confirm/sendMessage/111</a></p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/release-coonfirme-result.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>可以看到，发送了两条消息，第一条消息的<code>RoutingKey</code>为<code>key1</code>，第二条消息的<code>RoutingKey</code>为<code>key2</code>，两条消息都成功被交换机接收，也收到了交换机的确认回调，但消费者只收到了一条消息，第二条消息因为交换机没有和队列绑定，也没有其它队列能接收这个消息，所以第二条消息被直接丢弃了。</p>\n<h2> 回退消息</h2>\n<h3> Mandatory 参数</h3>\n<p><strong>在仅开启了生产者确认机制的情况下，交换机接收到消息后，会直接给消息生产者发送确认消息，如果发现该消息不可路由，那么消息会被直接丢弃，此时生产者是不知道消息被丢弃这个事件的。</strong></p>\n<p>那么如何处理无法被路由的消息？最起码通知生产者一声，让它自己处理，通过设置<code>mandatory</code>参数可以在当消息传递过程中不可达目的地时将消息返回给生产者。</p>\n<ul>\n<li>\n<p>消息生产者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>回调接口</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 结果分析</h3>\n<p>访问：<a href=\"http://127.0.0.1:8080/confirm/sendMessage\" target=\"_blank\" rel=\"noopener noreferrer\">127.0.0.1:8080/confirm/sendMessage</a></p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/returned-message-result.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 备份交换机</h2>\n<p>有了<code>mandatory</code>参数和回退消息，获得了对无法投递消息的感知能力，有机会在生产者的消息无法被投递时发现并处理；但有时候并不知道该如何处理这些无法路由的消息，最多打个日志，然后触发报警，再来手动处理。</p>\n<p>而通过日志来处理这些无法路由的消息是很不优雅的做法，特别是当生产者所在的服务有多台机器的时候，手动复制日志会更加麻烦而且容易出错；而且设置<code>mandatory</code>参数会增加生产者的复杂性，需要添加处理这些被退回的消息的逻辑。如果既不想丢失消息，又不想增加生产者的复杂性，该怎么做呢？</p>\n<p>前面在设置死信队列的文章中，提到过可以为队列设置死信交换机来存储那些处理失败的消息，可是这些不可路由消息根本没有机会进入到队列，因此无法使用死信队列来保存消息。</p>\n<p>在<code>RabbitMQ</code>中，有一种备份交换机的机制存在，可以很好的应对这个问题。</p>\n<p>什么是备份交换机呢？</p>\n<p>备份交换机可以理解为<code>RabbitMQ</code>中交换机的“备胎”，当为某一个交换机声明一个对应的备份交换机时，就是为它创建一个备胎，当交换机接收到一条不可路由消息时，将会把这条消息转发到备份交换机中，由备份交换机来进行转发和处理。</p>\n<p>通常备份交换机的类型为<code>Fanout</code>，这样就能把所有消息都投递到与其绑定的队列中，然后在备份交换机下绑定一个队列，这样所有那些原交换机无法被路由的消息，就会都进入这个队列了。</p>\n<p>当然，还可以建立一个报警队列，用独立的消费者来进行监测和报警。</p>\n<h3> 代码架构图</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/backup-exchange-code-framework.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 配置</h3>\n<ul>\n<li>\n<p>配置类</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>报警消费者</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 测试注意事项</h3>\n<p>重新启动项目的时候需要把原来的<code>confirm.exchange</code>删除，因为修改了其绑定属性，不然报以下错：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 结果分析</h3>\n<p>访问：<a href=\"http://127.0.0.1:8080/confirm/sendMessage/111\" target=\"_blank\" rel=\"noopener noreferrer\">127.0.0.1:8080/confirm/sendMessage/111</a></p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/backup-exchange-result.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>mandatory</code>参数与备份交换机可以一起使用的时候，如果两者同时开启，消息究竟何去何从？谁优先级高，经过上面结果显示答案是备份交换机优先级高。</p>\n<p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/rabbitmq-release-confirme-and-switch/asynchronous-confirme-release.png",
      "date_published": "2023-10-15T00:00:00.000Z",
      "date_modified": "2023-10-14T08:58:25.000Z",
      "authors": [],
      "tags": [
        "RabbitMQ"
      ]
    },
    {
      "title": "Redis 企业级解决方案",
      "url": "https://1coins.github.io/article/redis/redis-enterprise-solutions.html",
      "id": "https://1coins.github.io/article/redis/redis-enterprise-solutions.html",
      "summary": "缓存预热 宕机 服务器启动后迅速宕机。 问题排查 请求数量较高 主从之间数据吞吐量较大，数据同步操作频度较高 解决方案 前置准备工作： 日常例行统计数据访问记录，统计访问频度较高的热点数据 利用LRU数据删除策略，构建数据留存队列。例如：storm与kafka配合 准备工作： 将统计结果中的数据分类，根据级别，redis优先加载级别较高的热点数据 利用分布式多服务器同时进行数据读取，提速数据加载过程 热点数据主从同时预热",
      "content_html": "<h1> 缓存预热</h1>\n<h2> 宕机</h2>\n<p>服务器启动后迅速宕机。</p>\n<h2> 问题排查</h2>\n<ol>\n<li>请求数量较高</li>\n<li>主从之间数据吞吐量较大，数据同步操作频度较高</li>\n</ol>\n<h2> 解决方案</h2>\n<p>前置准备工作：</p>\n<ol>\n<li>日常例行统计数据访问记录，统计访问频度较高的热点数据</li>\n<li>利用<code>LRU</code>数据删除策略，构建数据留存队列。例如：<code>storm</code>与<code>kafka</code>配合</li>\n</ol>\n<p>准备工作：</p>\n<ol>\n<li>将统计结果中的数据分类，根据级别，<code>redis</code>优先加载级别较高的热点数据</li>\n<li>利用分布式多服务器同时进行数据读取，提速数据加载过程</li>\n<li>热点数据主从同时预热</li>\n</ol>\n<p>实施：</p>\n<ol>\n<li>使用脚本程序固定触发数据预热过程</li>\n<li>如果条件允许，使用<code>CDN</code>（内容分发网络），效果会更好</li>\n</ol>\n<h2> 总结</h2>\n<p>缓存预热就是系统启动前，提前将相关的缓存数据直接加载到缓存系统；避免在用户请求的时候，先查询数据库，然后再将数据缓存的问题！用户直接查询事先被预热的缓存数据！</p>\n<h1> 缓存雪崩</h1>\n<h2> 数据库服务器崩溃</h2>\n<ol>\n<li>系统平稳运行过程中，忽然数据库连接量激增</li>\n<li>应用服务器无法及时处理请求</li>\n<li>大量 408，500 错误页面出现</li>\n<li>客户反复刷新页面获取数据</li>\n<li>数据库崩溃</li>\n<li>应用服务器崩溃</li>\n<li>重启应用服务器无效</li>\n<li><code>Redis</code>服务器崩溃</li>\n<li><code>Redis</code>集群崩溃</li>\n<li>重启数据库后再次被瞬间流量放倒</li>\n</ol>\n<h2> 问题排查</h2>\n<ol>\n<li>在一个<strong>较短</strong>的时间内，缓存中<strong>较多</strong>的<code>key</code><strong>集中过期</strong></li>\n<li>此周期内请求访问过期的数据，<code>Redis</code>未命中，<code>Redis</code>向数据库获取数据</li>\n<li>数据库同时接收到大量的请求无法及时处理</li>\n<li><code>Redis</code>大量请求被积压，开始出现超时现象</li>\n<li>数据库流量激增，数据库崩溃</li>\n<li>重启后仍然面对缓存中无数据可用</li>\n<li><code>Redis</code>服务器资源被严重占用，<code>Redis</code>服务器崩溃</li>\n<li><code>Redis</code>集群呈现崩塌，集群瓦解</li>\n<li>应用服务器无法及时得到数据响应请求，来自客户端的请求数量越来越多，应用服务器崩溃</li>\n<li>应用服务器，<code>Redis</code>，数据库全部重启，效果不理想</li>\n</ol>\n<h2> 问题分析</h2>\n<ul>\n<li>短时间范围内</li>\n<li>大量<code>key</code>集中过期</li>\n</ul>\n<h2> 解决方案（道）</h2>\n<ol>\n<li>\n<p>更多的页面静态化处理</p>\n</li>\n<li>\n<p>构建多级缓存架构：<code>Nginx</code>缓存 + <code>Redis</code>缓存 + <code>Ehcache</code>缓存</p>\n</li>\n<li>\n<p>检测<code>MySql</code>严重耗时业务进行优化：对数据库的瓶颈排查：例如超时查询、耗时较高事务等</p>\n</li>\n<li>\n<p>灾难预警机制<br>\n监控<code>Redis</code>服务器性能指标：</p>\n<ul>\n<li><code>CPU</code>占用、<code>CPU</code>使用率</li>\n<li>内存容量</li>\n<li>查询平均响应时间</li>\n<li>线程数</li>\n</ul>\n</li>\n<li>\n<p>限流、降级：短时间范围内牺牲一些客户体验，限制一部分请求访问，降低应用服务器压力，待业务低速运转后再逐步放开访问</p>\n</li>\n</ol>\n<h2> 解决方案（术）</h2>\n<ol>\n<li>\n<p><code>LRU</code>与<code>LFU</code>切换</p>\n</li>\n<li>\n<p>数据有效期策略调整</p>\n<ul>\n<li>根据业务数据有效期进行分类错峰，<code>A</code>类 90 分钟，<code>B</code>类 80 分钟，<code>C</code>类 70 分钟</li>\n<li>过期时间使用<strong>固定时间+随机值</strong>的形式，稀释集中到期的<code>key</code>的数量</li>\n</ul>\n</li>\n<li>\n<p>超热数据使用永久<code>key</code></p>\n</li>\n<li>\n<p>定期维护（自动+人工）：对即将过期数据做访问量分析，确认是否延时，配合访问量统计，做热点数据的延时</p>\n</li>\n<li>\n<p>加锁，<strong>慎用</strong>！</p>\n</li>\n</ol>\n<h2> 总结</h2>\n<p>缓存雪崩就是瞬间过期数据量太大，导致对数据库服务器造成压力。如能够有效避免过期时间集中，可以有效解决雪崩现象的出现（约 40%），配合其他策略一起使用，并监控服务器的运行数据，根据运行记录做快速调整。</p>\n<h1> 缓存击穿</h1>\n<h2> 数据库服务器崩溃</h2>\n<ol>\n<li>系统平稳运行过程中</li>\n<li>数据库连接量瞬间激增</li>\n<li><code>Redis</code>服务器无大量<code>key</code>过期</li>\n<li><code>Redis</code>内存平稳，无波动</li>\n<li><code>Redis</code>服务器<code>CPU</code>正常</li>\n<li>数据库崩溃</li>\n</ol>\n<h2> 问题排查</h2>\n<ol>\n<li><code>Redis</code>中某个<code>key</code>过期，该<code>key</code>访问量巨大</li>\n<li>多个数据请求从服务器直接压到<code>Redis</code>后，均未命中</li>\n<li><code>Redis</code>在短时间内发起了大量对数据库中同一数据的访问</li>\n</ol>\n<h2> 问题分析</h2>\n<ul>\n<li>单个<code>key</code>高热数据</li>\n<li><code>key</code>过期</li>\n</ul>\n<h2> 解决方案（术）</h2>\n<ol>\n<li>预先设定：以电商为例，每个商家根据店铺等级，指定若干款主打商品，在购物节期间，加大此类信息<code>key</code>的过期时长<br>\n注意：购物节不仅仅指当天，以及后续若干天，访问峰值呈现逐渐降低的趋势</li>\n<li>现场调整：监控访问量，对自然流量激增的数据延长过期时间或设置为永久性<code>key</code></li>\n<li>后台刷新数据：启动定时任务，高峰期来临之前，刷新数据有效期，确保不丢失</li>\n<li>二级缓存：设置不同的失效时间，保障不会被同时淘汰就行</li>\n<li>加锁：分布式锁，防止被击穿，但是要注意也是性能瓶颈，<strong>慎重</strong>！</li>\n</ol>\n<h2> 总结</h2>\n<p>缓存击穿就是单个高热数据过期的瞬间，数据访问量较大，未命中<code>Redis</code>后，发起了大量对同一数据的数据库访问，导致对数据库服务器造成压力；应对策略应该在业务数据分析与预防方面进行，配合运行监控测试与即时调整策略，毕竟单个<code>key</code>的过期监控难度较高，配合雪崩处理策略即可。</p>\n<h1> 缓存穿透</h1>\n<h2> 数据库服务器崩溃</h2>\n<ol>\n<li>系统平稳运行过程中</li>\n<li>应用服务器流量随时间增量较大</li>\n<li><code>Redis</code>服务器命中率随时间逐步降低</li>\n<li><code>Redis</code>内存平稳，内存无压力</li>\n<li><code>Redis</code>服务器<code>CPU</code>占用激增</li>\n<li>数据库服务器压力激增</li>\n<li>数据库崩溃</li>\n</ol>\n<h2> 问题排查</h2>\n<ol>\n<li><code>Redis</code>中大面积出现未命中</li>\n<li>出现非正常<code>URL</code>访问</li>\n</ol>\n<h2> 问题分析</h2>\n<ul>\n<li>获取的数据在数据库中也不存在，数据库查询未得到对应数据</li>\n<li><code>Redis</code>获取到<code>null</code>数据未进行持久化，直接返回</li>\n<li>下次此类数据到达重复上述过程</li>\n<li>出现黑客攻击服务器</li>\n</ul>\n<h2> 解决方案（术）</h2>\n<ol>\n<li>\n<p>缓存<code>null</code>：对查询结果为<code>null</code>的数据进行缓存（长期使用，定期清理），设定短时限，例如 30~60 秒，最高 5 分钟</p>\n</li>\n<li>\n<p>白名单策略</p>\n<ul>\n<li>提前预热各种分类数据<code>id</code>对应的<code>bitmaps</code>，<code>id</code>作为<code>bitmaps</code>的<code>offset</code>，相当于设置了数据白名单；当加载正常数据时，放行，加载异常数据时直接拦截（效率偏低）</li>\n<li>使用布隆过滤器（有关布隆过滤器的命中问题对当前状况可以忽略）</li>\n</ul>\n</li>\n<li>\n<p>实施监控：实时监控<code>redis</code>命中率（业务正常范围时，通常会有一个波动值）与<code>null</code>数据的占比</p>\n<ul>\n<li>非活动时段波动：通常检测 3~5 倍，超过 5 倍纳入重点排查对象</li>\n<li>活动时段波动：通常检测 10~50 倍，超过 50 倍纳入重点排查对象</li>\n</ul>\n<p>根据倍数不同，启动不同的排查流程。然后使用黑名单进行防控（运营）</p>\n</li>\n<li>\n<p><code>key</code>加密：问题出现后，临时启动防灾业务<code>key</code>，对<code>key</code>进行业务层传输加密服务，设定校验程序，过来的<code>key</code>校验。例如每天随机分配 60 个加密串，挑选 2 到 3 个，混淆到页面数据<code>id</code>中，发现访问<code>key</code>不满足规则，驳回数据访问。</p>\n</li>\n</ol>\n<h2> 总结</h2>\n<p>缓存击穿访问了不存在的数据，跳过了合法数据的<code>redis</code>数据缓存阶段，每次访问数据库，导致对数据库服务器造成压力；通常此类数据的出现量是一个较低的值，当出现此类情况以毒攻毒，并及时**报警；**应对策略应该在临时预案防范方面多做文章。</p>\n<p>无论是黑名单还是白名单，都是对整体系统的压力，警报解除后尽快移除。</p>\n<h1> 性能指标监控</h1>\n<h2> 监控指标</h2>\n<ul>\n<li>性能指标：<code>Performance</code></li>\n<li>内存指标：<code>Memory</code></li>\n<li>基本活动指标：<code>Basic activity</code></li>\n<li>持久性指标：<code>Persistence</code></li>\n<li>错误指标：<code>Error</code></li>\n</ul>\n<h3> 性能指标：Performance</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>latency</code></td>\n<td><code>Redis</code>响应一个请求的时间</td>\n</tr>\n<tr>\n<td><code>instantaneous_ops_per_sec</code></td>\n<td>平均每秒处理请求总数</td>\n</tr>\n<tr>\n<td><code>hit rate (calculated)</code></td>\n<td>缓存命中率（计算出来的）</td>\n</tr>\n</tbody>\n</table>\n<h3> 内存指标：Memory</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>used_memory</code></td>\n<td>已使用内存</td>\n</tr>\n<tr>\n<td><code>mem_fragmentation_ratio</code></td>\n<td>内存碎片率</td>\n</tr>\n<tr>\n<td><code>evicted_keys</code></td>\n<td>由于最大内存限制被移除的<code>key</code>的数量</td>\n</tr>\n<tr>\n<td><code>blocked_clients</code></td>\n<td>由于<code>BLPOP, BRPOP, or BRPOPLPUSH</code>而被阻塞的客户端</td>\n</tr>\n</tbody>\n</table>\n<h3> 基本活动指标：Basic activity</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>connected_clients</code></td>\n<td>客户端连接数</td>\n</tr>\n<tr>\n<td><code>connected_slaves</code></td>\n<td><code>Slave</code>数量</td>\n</tr>\n<tr>\n<td><code>master_last_io_seconds_ago</code></td>\n<td>最近一次主从交互之后的秒数</td>\n</tr>\n<tr>\n<td><code>keyspace</code></td>\n<td>数据库中的<code>key</code>值总数</td>\n</tr>\n</tbody>\n</table>\n<h3> 持久性指标：Persistence</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>rdb_last_save_time</code></td>\n<td>最后一次持久化保存到磁盘的时间戳</td>\n</tr>\n<tr>\n<td><code>rdb_changes_since_last_save</code></td>\n<td>自最后一次持久化以来数据库的更改数</td>\n</tr>\n</tbody>\n</table>\n<h3> 错误指标：Error</h3>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>rejected_connections</code></td>\n<td>由于到达<code>maxclient</code>限制而被拒绝的连接数</td>\n</tr>\n<tr>\n<td><code>keyspace_misses</code></td>\n<td><code>Key</code>值查找失败（没有命中）次数</td>\n</tr>\n<tr>\n<td><code>master_link_down_since_seconds</code></td>\n<td>主从断开的持续时间（以秒为单位）</td>\n</tr>\n</tbody>\n</table>\n<h2> 监控方式</h2>\n<ul>\n<li>\n<p>工具</p>\n<ul>\n<li><code>Cloud Insight Redis</code></li>\n<li><code>Prometheus</code></li>\n<li><code>Redis-stat</code></li>\n<li><code>Redis-faina</code></li>\n<li><code>RedisLive</code></li>\n<li><code>zabbix</code></li>\n</ul>\n</li>\n<li>\n<p>命令</p>\n<ul>\n<li>\n<p><code>benchmark</code></p>\n</li>\n<li>\n<p><code>redis cli</code></p>\n<ul>\n<li><code>monitor</code></li>\n<li><code>showlog</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3> benchmark</h3>\n<ul>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>范例 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>范例 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2</span></span></span></span></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>选项</th>\n<th>描述</th>\n<th>默认值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td><code>-h</code></td>\n<td>指定服务器主机名</td>\n<td>127.0.0.1</td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>-p</code></td>\n<td>指定服务器端口</td>\n<td>6379</td>\n</tr>\n<tr>\n<td>3</td>\n<td><code>-s</code></td>\n<td>指定服务器<code>socket</code></td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td><code>-c </code></td>\n<td>指定并发连接数</td>\n<td>50</td>\n</tr>\n<tr>\n<td>5</td>\n<td><code>-n</code></td>\n<td>指定请求数</td>\n<td>10000</td>\n</tr>\n<tr>\n<td>6</td>\n<td><code>-d</code></td>\n<td>以字节的形式指定<code>SET/GET</code>值的数据大小</td>\n<td>2</td>\n</tr>\n<tr>\n<td>7</td>\n<td><code>-k</code></td>\n<td><code>1 = keep alive,0 = reconnect</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>8</td>\n<td><code>-r</code></td>\n<td><code>SET/GET/INCR</code>使用随机<code>key</code>，<code>SADD</code>使用随机值</td>\n<td></td>\n</tr>\n<tr>\n<td>9</td>\n<td><code>-p</code></td>\n<td>通过管道传输<code>&lt;numreq&gt;</code>请求</td>\n<td>1</td>\n</tr>\n<tr>\n<td>10</td>\n<td><code>-q</code></td>\n<td>强制退出<code>redis</code>，仅显示<code>query/sec</code>值</td>\n<td></td>\n</tr>\n<tr>\n<td>11</td>\n<td><code>--csv</code></td>\n<td>以<code>CSV</code>格式输出</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td><code>-l</code></td>\n<td>生成循环，永久执行测试</td>\n<td></td>\n</tr>\n<tr>\n<td>13</td>\n<td><code>-t</code></td>\n<td>仅运行以逗号分隔的测试命令列表</td>\n<td></td>\n</tr>\n<tr>\n<td>14</td>\n<td><code>-I</code></td>\n<td><code>Idle</code>模式，仅打开<code>N</code>个<code>idle</code>连接并等待</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h3> monitor</h3>\n<ul>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> showlog</h3>\n<ul>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p><code>[operator]</code>：</p>\n<ul>\n<li><code>get</code>：获取慢查询日志</li>\n<li><code>len</code>：获取慢查询日志条目数</li>\n<li><code>reset</code>：重置慢查询日志</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>相关配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>‍</p>\n",
      "date_published": "2023-10-05T00:00:00.000Z",
      "date_modified": "2023-10-07T14:38:24.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Redis 主从复制",
      "url": "https://1coins.github.io/article/redis/redis-master-slave.html",
      "id": "https://1coins.github.io/article/redis/redis-master-slave.html",
      "summary": "主从复制简介 互联网“三高”架构 高并发 高性能 高可用 Redis 是否高可用 单机Redis的风险与问题： 问题 1：机器故障 现象：硬盘故障、系统崩溃 本质：数据丢失，很可能对业务造成灾难性打击 结论：基本上会放弃使用Redis 问题 2：容量瓶颈 现象：内存不足，从 16G 升级到 64G，从 64G 升级到 128G，无限升级内存 本质：穷，硬件条件跟不上 结论：放弃使用Redis",
      "content_html": "<h1> 主从复制简介</h1>\n<h2> 互联网“三高”架构</h2>\n<ul>\n<li>高并发</li>\n<li>高性能</li>\n<li>高可用</li>\n</ul>\n<h2> Redis 是否高可用</h2>\n<p><strong>单机<code>Redis</code>的风险与问题：</strong></p>\n<ul>\n<li>\n<p>问题 1：机器故障</p>\n<ul>\n<li>现象：硬盘故障、系统崩溃</li>\n<li>本质：数据丢失，很可能对业务造成灾难性打击</li>\n<li>结论：基本上会放弃使用<code>Redis</code></li>\n</ul>\n</li>\n<li>\n<p>问题 2：容量瓶颈</p>\n<ul>\n<li>现象：内存不足，从 16G 升级到 64G，从 64G 升级到 128G，无限升级内存</li>\n<li>本质：穷，硬件条件跟不上</li>\n<li>结论：放弃使用<code>Redis</code></li>\n</ul>\n</li>\n</ul>\n<p>结论：为了避免单点<code>Redis</code>服务器故障，准备多台服务器，互相连通。将数据复制多个副本保存在不同的服务器上，连接在一起，并保证数据是同步的。即使有其中一台服务器宕机，其他服务器依然可以继续提供服务，实现<code>Redis</code>的高可用，同时实现数据冗余备份。</p>\n<h2> 多台服务器连接方案</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/master-and-slave.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ul>\n<li>\n<p>提供数据方：<code>master</code></p>\n<ul>\n<li>主服务器、主节点、主库、主客户端</li>\n</ul>\n</li>\n<li>\n<p>接收数据方：<code>slave</code></p>\n<ul>\n<li>从服务器、从节点、从库、从客户端</li>\n</ul>\n</li>\n<li>\n<p>需要解决的问题：数据同步</p>\n</li>\n<li>\n<p>核心工作：<code>master</code>的数据复制到<code>slave</code>中</p>\n</li>\n</ul>\n<h2> 主从复制</h2>\n<p>主从复制即将<code>master</code>中的数据即时、有效的复制到<code>slave</code>中。</p>\n<p>特征：一个<code>master</code>可以拥有多个<code>slave</code>，一个<code>slave</code>只对应一个<code>master</code>。</p>\n<p>职责：</p>\n<ul>\n<li>\n<p><code>master</code></p>\n<ul>\n<li>写数据</li>\n<li>执行写操作时，将出现变化的数据自动同步到<code>slave</code></li>\n<li>读数据（可忽略）</li>\n</ul>\n</li>\n<li>\n<p><code>slave</code></p>\n<ul>\n<li>读数据</li>\n<li>写数据（禁止）</li>\n</ul>\n</li>\n</ul>\n<h2> 主从复制的作用</h2>\n<ul>\n<li>读写分离：<code>master</code>写、<code>slave</code>读，提高服务器的读写负载能力</li>\n<li>负载均衡：基于主从结构，配合读写分离，由<code>slave</code>分担<code>master</code>负载，并根据需求的变化，改变<code>slave</code>的数量，通过多个从节点分担数据读取负载，大大提高<code>Redis</code>服务器并发量与数据吞吐量</li>\n<li>故障恢复：当<code>master</code>出现问题时，由<code>slave</code>提供服务，实现快速的故障恢复</li>\n<li>数据冗余：实现数据热备份，是持久化之外的一种数据冗余方式</li>\n<li>高可用基石：基于主从复制，构建哨兵模式与集群，实现<code>Redis</code>的高可用方案</li>\n</ul>\n<h1> 主从复制工作流程</h1>\n<p>主从复制过程大体可以分为 3 个阶段：</p>\n<ol>\n<li>建立连接阶段（即准备阶段）</li>\n<li>数据同步阶段</li>\n<li>命令传播阶段</li>\n</ol>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/master-slave-operate-process1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/master-slave-operate-process2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 建立连接阶段</h2>\n<p>建立<code>slave</code>到<code>master</code>的连接，使<code>master</code>能够识别<code>slave</code>，并保存<code>slave</code>端口号。</p>\n<h3> 工作流程</h3>\n<ol>\n<li>设置<code>master</code>的地址和端口，保存<code>master</code>信息</li>\n<li>建立<code>socket</code>连接</li>\n<li>发送<code>ping</code>命令（定时器任务）</li>\n<li>身份验证</li>\n<li>发送<code>slave</code>端口信息</li>\n</ol>\n<p>至此，主从连接成功！</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/create-connection.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>状态：</p>\n<ul>\n<li><code>slave</code>：保存<code>master</code>的地址与端口</li>\n<li><code>master</code>：保存<code>slave</code>的端口</li>\n<li>总体：之间创建了连接的<code>socket</code></li>\n</ul>\n<h3> 主从连接（slave 连接 master）</h3>\n<ul>\n<li>\n<p>方式一：客户端发送命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ol>\n<li>\n<p><code>slave</code>客户端</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code>主机</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code>客户端</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave</code>客户端</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>\n<p>方式二：启动服务器参数</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ol>\n<li><code>slave</code>客户端</li>\n</ol>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ol start=\"2\">\n<li><code>master</code>客户端</li>\n</ol>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ol start=\"3\">\n<li><code>slave</code>客户端</li>\n</ol>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>方式三：服务器配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ol>\n<li><code>master</code>客户端</li>\n</ol>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ol start=\"2\">\n<li><code>slave</code>客户端</li>\n</ol>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave</code>系统信息</p>\n<ul>\n<li><code>master_link_down_since_seconds</code></li>\n<li><code>masterhost</code></li>\n<li><code>masterport</code></li>\n</ul>\n</li>\n<li>\n<p><code>master</code>系统信息</p>\n<ul>\n<li><code>slave_listening_port</code>（多个）</li>\n</ul>\n</li>\n</ul>\n<h3> 主从断开连接</h3>\n<ul>\n<li>\n<p>客户端发送命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>说明：<code>slave</code>断开连接后，不会删除已有数据，只是不再接受<code>master</code>发送的数据</p>\n</li>\n</ul>\n<h3> 授权访问</h3>\n<ul>\n<li>\n<p><code>master</code>客户端发送命令设置密码</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code>配置文件设置密码</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave</code>客户端发送命令设置密码</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave</code>配置文件设置密码</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave</code>启动服务器设置密码</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 数据同步阶段</h2>\n<p>在<code>slave</code>初次连接<code>master</code>后，复制<code>master</code>中的所有数据到<code>slave</code>，将<code>slave</code>的数据库状态更新成<code>master</code>当前的数据库状态。</p>\n<h3> 工作流程</h3>\n<ol>\n<li>请求同步数据</li>\n<li>创建<code>RDB</code>同步数据</li>\n<li>恢复<code>RDB</code>同步数据</li>\n<li>请求部分同步数据</li>\n<li>恢复部分同步数据</li>\n</ol>\n<p>至此，数据同步工作完成！</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/data-sync.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>状态：</p>\n<ul>\n<li><code>slave</code>：具有<code>master</code>端全部数据，包含<code>RDB</code>过程接收的数据</li>\n<li><code>master</code>：保存<code>slave</code>当前数据同步的位置</li>\n<li>总体：之间完成了数据克隆</li>\n</ul>\n<h3> 数据同步阶段 master 说明</h3>\n<ol>\n<li>\n<p>如果<code>master</code>数据量巨大，数据同步阶段应避开流量高峰期，避免造成<code>master</code>阻塞，影响业务正常执行</p>\n</li>\n<li>\n<p>复制缓冲区大小设定不合理，会导致数据溢出。如进行全量复制周期太长，进行部分复制时发现数据已经存在丢失的情况，必须进行第二次全量复制，致使<code>slave</code>陷入死循环状态</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code>单机内存占用主机内存的比例不应过大，建议使用 50% - 70% 的内存，留下 30% - 50% 的内存用于执行<code>bgsave</code>命令和创建复制缓冲区</p>\n</li>\n</ol>\n<h3> 数据同步阶段 slave 说明</h3>\n<ol>\n<li>\n<p>为避免<code>slave</code>进行全量复制、部分复制时服务器响应阻塞或数据不同步，建议关闭此期间的对外服务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>数据同步阶段，<code>master</code>发送给<code>slave</code>信息可以理解<code>master</code>是<code>slave</code>的一个客户端，主动向<code>slave</code>发送命令</p>\n</li>\n<li>\n<p>多个<code>slave</code>同时对<code>master</code>请求数据同步，<code>master</code>发送的<code>RDB</code>文件增多，会对带宽造成巨大冲击，如果<code>master</code>带宽不足，因此数据同步需要根据业务需求，适量错峰</p>\n</li>\n<li>\n<p><code>slave</code>过多时，建议调整拓扑结构，由一主多从结构变为树状结构，中间的节点既是<code>master</code>，也是<code>slave</code>；注意使用树状结构时，由于层级深度，导致深度越高的<code>slave</code>与最顶层<code>master</code>间数据同步延迟较大，数据一致性变差，应谨慎选择</p>\n</li>\n</ol>\n<h2> 命令传播阶段</h2>\n<p>当<code>master</code>数据库状态被修改后，导致主从服务器数据库状态不一致，此时需要让主从数据同步到一致的状态，同步的动作称为<strong>命令传播</strong>。</p>\n<p><code>master</code>将接收到的数据变更命令发送给<code>slave</code>，<code>slave</code>接收命令后执行命令。</p>\n<h3> 命令传播阶段的部分复制</h3>\n<ul>\n<li>\n<p>命令传播阶段出现了断网现象</p>\n<ul>\n<li>网络闪断闪连\t\t操作：忽略</li>\n<li>短时间网络中断\t操作：部分复制</li>\n<li>长时间网络中断\t操作：全量复制</li>\n</ul>\n</li>\n<li>\n<p>部分复制的三个核心要素</p>\n<ul>\n<li>服务器的运行<code>id(run id)</code></li>\n<li>主服务器的复制积压缓冲区</li>\n<li>主从服务器的复制偏移量</li>\n</ul>\n</li>\n</ul>\n<h3> 服务器运行 ID（RunID）</h3>\n<ul>\n<li>概念：服务器运行<code>ID</code>是每一台服务器每次运行的身份识别码，一台服务器多次运行可以生成多个运行<code>ID</code></li>\n<li>组成：运行<code>ID</code>由 40 位字符组成，是一个随机的十六进制字符。例如：<code>fdc9ff13b9bbaab28db42b3d50f852bb5e3fcdce</code></li>\n<li>作用：运行<code>ID</code>被用于在服务器间进行传输，识别身份。如果想两次操作均对同一台服务器进行，必须每次操作携带对应的运行<code>ID</code>，用于对方识别</li>\n<li>实现方式：运行<code>ID</code>在每台服务器启动时自动生成的，<code>master</code>在首次连接<code>slave</code>时，会将自己的运行<code>ID</code>发送给<code>slave</code>，<code>slave</code>保存此<code>ID</code>，通过<code>info server</code>命令，可以查看节点的<code>RunID</code></li>\n</ul>\n<h3> 复制缓冲区</h3>\n<p>复制缓冲区，又名复制积压缓冲区，是一个先进先出（<code>FIFO</code>）的队列，用于存储服务器执行过的命令，每次传播命令，<code>master</code>都会将传播的命令记录下来，并存储在复制缓冲区。</p>\n<p>复制缓冲区默认数据存储空间大小是 1M，由于存储空间大小是固定的，当入队元素的数量大于队列长度时，最先入队的元素会被弹出，而新元素会被放入队列。</p>\n<ul>\n<li>由来：每台服务器启动时，如果开启有<code>AOF</code>或被连接成为<code>master</code>节点，即创建复制缓冲区</li>\n<li>作用：用于保存<code>master</code>收到的所有指令（仅影响数据变更的指令，例如<code>set</code>，<code>select</code>）</li>\n<li>数据来源：当<code>master</code>接收到主客户端的指令时，除了将指令执行，会将该指令存储到缓冲区中</li>\n</ul>\n<h4> 复制缓冲区内部工作原理</h4>\n<p>组成：</p>\n<ul>\n<li>偏移量</li>\n<li>字节值</li>\n</ul>\n<p>工作原理：</p>\n<ul>\n<li>通过<code>offset</code>区分不同的<code>slave</code>当前数据传播的差异</li>\n<li><code>master</code>记录已发送的信息对应的<code>offset</code></li>\n<li><code>slave</code>记录已接收的信息对应的<code>offset</code></li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/copy-buffer-operate-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 主从服务器复制偏移量（offset）</h3>\n<p>是一个数字，描述复制缓冲区中的指令字节位置。</p>\n<p>分类：</p>\n<ul>\n<li><code>master</code>复制偏移量：记录发送给所有<code>slave</code>接收的指令字节对应的位置（多个）</li>\n<li><code>slave</code>复制偏移量：记录<code>slave</code>接收<code>master</code>发送过来的指令字节对应的位置（一个）</li>\n</ul>\n<p>数据来源：</p>\n<ul>\n<li><code>master</code>端：发送一次记录一次</li>\n<li><code>slave</code>端：接收一次记录一次</li>\n</ul>\n<p>作用：同步信息，比对<code>master</code>与<code>slave</code>的差异，当<code>slave</code>断线后，恢复数据使用</p>\n<h2> 数据同步+命令传播阶段工作流程</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/data-sync-and-command-propagation.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 心跳机制</h2>\n<p>进入命令传播阶段候，<code>master</code>与<code>slave</code>间需要进行信息交换，使用心跳机制进行维护，实现双方连接保持在线。</p>\n<p><code>master</code>心跳：</p>\n<ul>\n<li>指令：<code>ping</code></li>\n<li>周期：由<code>repl-ping-slave-period</code>决定，默认 10 秒</li>\n<li>作用：判断<code>slave</code>是否在线</li>\n<li>查询：<code>INFO replication</code>获取<code>slave</code>最后一次连接时间间隔，<code>lag</code>项维持在 0 或 1 视为正常</li>\n</ul>\n<p><code>slave</code>心跳：</p>\n<ul>\n<li>指令：<code>REPLCONF ACK {offset}</code></li>\n<li>周期：1 秒</li>\n<li>作用 1：汇报<code>slave</code>自己的复制偏移量，获取最新的数据变更指令</li>\n<li>作用 2：判断<code>master</code>是否在线</li>\n</ul>\n<h3> 心跳阶段注意事项</h3>\n<ul>\n<li>\n<p>当<code>slave</code>多数掉线，或延迟过高时，<code>master</code>为保障数据稳定性，将拒绝所有信息同步操作</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><code>slave</code>数量少于 2 个，或者所有<code>slave</code>的延迟都大于等于 10 秒时，强制关闭<code>master</code>写功能，停止数据同步。</p>\n</li>\n<li>\n<p><code>slave</code>数量由<code>slave</code>发送<code>REPLCONF ACK</code>命令做确认</p>\n</li>\n<li>\n<p><code>slave</code>延迟由<code>slave</code>发送<code>REPLCONF ACK</code>命令做确认</p>\n</li>\n</ul>\n<h2> 主从复制工作流程（完整）</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/master-slave-operate-process.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> 主从复制常见问题</h1>\n<h2> 频繁的全量复制</h2>\n<p>伴随着系统的运行，<code>master</code>的数据量会越来越大，一旦<code>master</code>重启，<code>runid</code>将发生变化，会导致全部<code>slave</code>的全量复制操作。</p>\n<p>内部优化调整方案：</p>\n<ol>\n<li>\n<p><code>master</code>内部创建<code>master_replid</code>变量，使用<code>runid</code>相同的策略生成，长度 41 位，并发送给所有<code>slave</code></p>\n</li>\n<li>\n<p>在<code>master</code>关闭时执行命令<code>shutdown save</code>，进行<code>RDB</code>持久化,将<code>runid</code>与<code>offset</code>保存到<code>RDB</code>文件中</p>\n<ul>\n<li><code>repl-id\t\trepl-offset</code></li>\n<li>通过<code>redis-check-rdb</code>命令可以查看该信息</li>\n</ul>\n</li>\n<li>\n<p><code>master</code>重启后加载<code>RDB</code>文件，恢复数据<br>\n重启后，将<code>RDB</code>文件中保存的<code>repl-id</code>与<code>repl-offset</code>加载到内存中</p>\n<ul>\n<li><code>master_repl_id = repl\t\tmaster_repl_offset = repl-offset</code></li>\n<li>通过<code>info</code>命令可以查看该信息</li>\n</ul>\n</li>\n</ol>\n<p>作用：本机保存上次<code>runid</code>，重启后恢复该值，使所有<code>slave</code>认为还是之前的<code>master</code>。</p>\n<p>总结：</p>\n<ul>\n<li>\n<p>问题现象：网络环境不佳，出现网络中断，<code>slave</code>不提供服务</p>\n</li>\n<li>\n<p>问题原因：复制缓冲区过小，断网后<code>slave</code>的<code>offset</code>越界，触发全量复制</p>\n</li>\n<li>\n<p>最终结果：<code>slave</code>反复进行全量复制</p>\n</li>\n<li>\n<p>解决方案：修改复制缓冲区大小</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>建议设置如下：</p>\n<ol>\n<li>测算从<code>master</code>到<code>slave</code>的重连平均时长<code>second</code></li>\n<li>获取<code>master</code>平均每秒产生写命令数据总量<code>write_size_per_second</code></li>\n<li>最优复制缓冲区空间 = <code>2 \\* second \\* write_size_per_second</code></li>\n</ol>\n</li>\n</ul>\n<h2> 频繁的网络中断</h2>\n<p>问题现象：<code>master</code>的<code>CPU</code>占用过高或<code>slave</code>频繁断开连接。</p>\n<p>问题原因：</p>\n<ul>\n<li><code>slave</code>每 1 秒发送<code>REPLCONF ACK</code>命令到<code>master</code></li>\n<li>当<code>slave</code>接到了慢查询时（<code>keys *</code>，<code>hgetall</code>等），会大量占用<code>CPU</code>性能</li>\n<li><code>master</code>每 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 秒调用复制定时函数<code>replicationCron()</code>，比对<code>slave</code>发现长时间没有进行响应</li>\n</ul>\n<p>最终结果：<code>master</code>各种资源（输出缓冲区、带宽、连接等）被严重占用。</p>\n<p>解决方案：</p>\n<ul>\n<li>\n<p>通过设置合理的超时时间，确认是否释放<code>slave</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>该参数定义了超时时间的阈值（默认 60 秒），超过该值，释放<code>slave</code>。</p>\n</li>\n</ul>\n<p>问题现象：<code>slave</code>与<code>master</code>连接断开。</p>\n<p>问题原因：</p>\n<ul>\n<li><code>master</code>发送<code>ping</code>指令频度较低</li>\n<li><code>master</code>设定超时时间较短</li>\n<li><code>ping</code>指令在网络中存在丢包</li>\n</ul>\n<p>解决方案：</p>\n<ul>\n<li>\n<p>提高<code>ping</code>指令发送的频度</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>超时时间<code>repl-time</code>的时间至少是<code>ping</code>指令频度的 5 到 10 倍，否则<code>slave</code>很容易判定超时。</p>\n<h2> 数据不一致</h2>\n<p>问题现象：多个<code>slave</code>获取相同数据不同步</p>\n<p>问题原因：网络信息不同步，数据发送有延迟</p>\n<p>解决方案：</p>\n<ul>\n<li>\n<p>优化主从间的网络环境，通常放置在同一个机房部署，如使用阿里云等云服务器时要注意此现象</p>\n</li>\n<li>\n<p>监控主从节点延迟（通过<code>offset</code>）判断，如果<code>slave</code>延迟过大，暂时屏蔽程序对该<code>slave</code>的数据访问</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>开启后仅响应<code>info</code>、<code>slaveof</code>等少数命令（慎用，除非对数据一致性要求很高）。</p>\n</li>\n</ul>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/redis-master-slave/master-and-slave.png",
      "date_published": "2023-10-01T00:00:00.000Z",
      "date_modified": "2023-10-07T14:38:24.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Redis 哨兵和集群",
      "url": "https://1coins.github.io/article/redis/redis-sentinel-and-cluster.html",
      "id": "https://1coins.github.io/article/redis/redis-sentinel-and-cluster.html",
      "summary": "哨兵模式 简介 主机宕机 操作： 关闭master和所有slave 找一个slave作为master 修改其他slave的配置，连接新的主 启动新的master与slave 全量复制 * N + 部分复制 * N 问题：",
      "content_html": "<h1> 哨兵模式</h1>\n<h2> 简介</h2>\n<h3> 主机宕机</h3>\n<p>操作：</p>\n<ul>\n<li>关闭<code>master</code>和所有<code>slave</code></li>\n<li>找一个<code>slave</code>作为<code>master</code></li>\n<li>修改其他<code>slave</code>的配置，连接新的主</li>\n<li>启动新的<code>master</code>与<code>slave</code></li>\n<li>全量复制 * N + 部分复制 * N</li>\n</ul>\n<p>问题：</p>\n<ul>\n<li>关闭期间的数据服务谁来承接？</li>\n<li>找一个主？怎么找法？</li>\n<li>修改配置后，原始的主恢复了怎么办？</li>\n</ul>\n<h3> 哨兵</h3>\n<p>哨兵（<code>sentinel</code>）是一个分布式系统，用于对主从结构中的每台服务器进行监控，当出现故障时通过投票机制选择新的<code>master</code>并将所有<code>slave</code>连接到新的<code>master</code>。</p>\n<h3> 哨兵的作用</h3>\n<ul>\n<li>\n<p>监控</p>\n<ul>\n<li>不断的检查<code>master</code>和<code>slave</code>是否正常运行。</li>\n<li><code>master</code>存活检测、<code>master</code>与<code>slave</code>运行情况检测</li>\n</ul>\n</li>\n<li>\n<p>通知（提醒）</p>\n<ul>\n<li>当被监控的服务器出现问题时，向其他（哨兵间，客户端）发送通知。</li>\n</ul>\n</li>\n<li>\n<p>自动故障转移</p>\n<ul>\n<li>断开<code>master</code>与<code>slave</code>连接，选取一个<code>slave</code>作为<code>master</code>，将其他<code>slave</code>连接到新的<code>master</code>，并告知客户端新的服务器地址</li>\n</ul>\n</li>\n</ul>\n<p>注意：</p>\n<ul>\n<li>哨兵也是一台<code>Redis</code>服务器，只是不提供数据服务</li>\n<li>通常哨兵配置数量为单数</li>\n</ul>\n<h2> 启用哨兵模式</h2>\n<h3> 配置哨兵</h3>\n<ul>\n<li>\n<p>配置一拖二的主从结构</p>\n</li>\n<li>\n<p>配置三个哨兵（配置相同，端口不同）</p>\n<ul>\n<li>参看<code>sentinel.conf</code></li>\n</ul>\n</li>\n<li>\n<p>启动哨兵</p>\n<div class=\"language-text line-numbers-mode\" data-ext=\"text\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<ol>\n<li>\n<p>配置哨兵 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>配置哨兵 2</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave1</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave2</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>哨兵 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>哨兵 2</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>哨兵 3</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>哨兵客户端 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code>客户端</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave</code>客户端</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code>宕机</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>哨兵选取新的<code>master</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">配置项</th>\n<th style=\"text-align:center\">范例</th>\n<th style=\"text-align:center\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">sentinel auth-pass &lt;服务器名称&gt; &lt;passward&gt;</td>\n<td style=\"text-align:center\">sentinel auth-pass mymaster itcast</td>\n<td style=\"text-align:center\">连接服务器口令</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sentinel down-after-milliseconds &lt;自定义服务名称&gt; &lt;主机地址&gt; &lt;端口&gt; &lt;主从服务器总量&gt;</td>\n<td style=\"text-align:center\">sentinel monitor mymaster 192.168.194.131 6381 1</td>\n<td style=\"text-align:center\">设置哨兵监听的主服务器信息，最后的参数决定了最终参与选举的服务器数量（-1）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sentinel down-after-milliseconds &lt;服务名称&gt; &lt;毫秒数（整数）&gt;</td>\n<td style=\"text-align:center\">sentinel down-after-milliseconds mymaster 3000</td>\n<td style=\"text-align:center\">指定哨兵在监控 Redis 服务时，判定服务器挂掉的时间周期，默认 30 秒（30000），也是主从切换的启动条件之一</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sentinel parallel-syncs &lt;服务名称&gt; &lt;服务器数（整数）&gt;</td>\n<td style=\"text-align:center\">sentinel parallel-syncs mymaster 1</td>\n<td style=\"text-align:center\">指定同时进行主从的 slave 数量，数值越大，要求网络资源越高，要求约小，同步时间约长</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sentinel failover-timeout &lt;服务名称&gt; &lt;毫秒数（整数）&gt;</td>\n<td style=\"text-align:center\">sentinel failover-timeout mymaster 9000</td>\n<td style=\"text-align:center\">指定出现故障后，故障切换的最大超时时间，超过该值，认定切换失败，默认3分钟</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sentinel notification-script &lt;服务名称&gt; &lt;脚本路径&gt;</td>\n<td style=\"text-align:center\"></td>\n<td style=\"text-align:center\">服务器无法正常联通时，设定的执行脚本，通常调试使用。</td>\n</tr>\n</tbody>\n</table>\n<h2> 哨兵工作原理</h2>\n<h3> 主从切换</h3>\n<p>哨兵在进行主从切换过程中经历三个阶段：</p>\n<ul>\n<li>监控</li>\n<li>通知</li>\n<li>故障转移</li>\n</ul>\n<h4> 监控阶段</h4>\n<p>用于同步各个节点的状态信息</p>\n<ul>\n<li>\n<p>获取各个<code>sentinel</code>的状态（是否在线）</p>\n</li>\n<li>\n<p>获取<code>master</code>的状态</p>\n<ul>\n<li>\n<p><code>master</code>属性</p>\n<ul>\n<li><code>runid</code></li>\n<li><code>role：master</code></li>\n</ul>\n</li>\n<li>\n<p>各个<code>slave</code>的详细信息</p>\n</li>\n</ul>\n</li>\n<li>\n<p>获取所有<code>slave</code>的状态（根据<code>master</code>中的<code>slave</code>信息）</p>\n<ul>\n<li>\n<p><code>slave</code>属性</p>\n<ul>\n<li><code>runid</code></li>\n<li><code>role：slave</code></li>\n<li><code>master_host、master_port</code></li>\n<li><code>offset</code></li>\n<li>……</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/monitor-phase.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h4> 通知阶段</h4>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/notice-phase.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h4> 故障转移阶段</h4>\n<h5> 主观下线与客观下线</h5>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/subjective-offline-and-objective-offline.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h5> 哨兵竞选</h5>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/sentinel-campaign.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h5> 选取备用 master</h5>\n<p>服务器列表中挑选备选<code>master</code>。</p>\n<p>挑选原则：</p>\n<ul>\n<li>\n<p>不在线的<code>OUT</code></p>\n</li>\n<li>\n<p>响应慢的<code>OUT</code></p>\n</li>\n<li>\n<p>与原<code>master</code>断开时间久的<code>OUT</code></p>\n</li>\n<li>\n<p>优先原则</p>\n<ul>\n<li>优先级</li>\n<li><code>offset</code></li>\n<li><code>runid</code></li>\n</ul>\n</li>\n<li>\n<p>发送指令（<code>sentinel</code>）</p>\n<ul>\n<li>向新的<code>master</code>发送<code>slaveof no one</code></li>\n<li>向其他<code>slave</code>发送<code>slaveof</code>新<code>masterIP</code>端口</li>\n</ul>\n</li>\n</ul>\n<h4> 总结</h4>\n<ul>\n<li>\n<p>监控</p>\n<ul>\n<li>同步信息</li>\n</ul>\n</li>\n<li>\n<p>通知</p>\n<ul>\n<li>保持联通</li>\n</ul>\n</li>\n<li>\n<p>故障转移</p>\n<ul>\n<li>发现问题</li>\n<li>竞选负责人</li>\n<li>优选新<code>master</code></li>\n<li>新<code>master</code>上任，其他<code>slave</code>切换<code>master</code>，原<code>master</code>作为<code>slave</code>故障回复后连接</li>\n</ul>\n</li>\n</ul>\n<h1> 集群</h1>\n<h2> 简介</h2>\n<h3> 现状问题</h3>\n<p>业务发展过程中遇到的峰值瓶颈：</p>\n<ul>\n<li><code>redis</code>提供的服务<code>OPS</code>可以达到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>10</mn></mrow><annotation encoding=\"application/x-tex\">10</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">10</span></span></span></span> 万/秒，当前业务<code>OPS</code>已经达到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>10</mn></mrow><annotation encoding=\"application/x-tex\">10</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">10</span></span></span></span> 万/秒</li>\n<li>内存单机容量达到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>256</mn><mi>G</mi></mrow><annotation encoding=\"application/x-tex\">256 G</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">256</span><span class=\"mord mathnormal\">G</span></span></span></span>，当前业务需求内存容量 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">1 T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">1</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span></li>\n<li>使用集群的方式可以快速解决上述问题</li>\n</ul>\n<h3> 集群架构</h3>\n<p>集群就是使用网络将若干台计算机联通起来，并提供统一的管理方式，使其对外呈现单机的服务效果。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/cluster-architecture.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 集群作用</h3>\n<ul>\n<li>分散单台服务器的访问压力，实现负载均衡</li>\n<li>分散单台服务器的存储压力，实现可扩展性</li>\n<li>降低单台服务器宕机带来的业务灾难</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/cluster-effect.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> 集群结构设计</h1>\n<h2> 数据存储设计</h2>\n<ul>\n<li>通过算法设计，计算出<code>key</code>应该保存的位置</li>\n<li>将所有的存储空间计划切割成 16384 份，每台主机保存一部分；每份代表的是一个存储空间（<strong>槽</strong>），不是一个<code>key</code>的保存空间</li>\n<li>将<code>key</code>按照计算出的保存位置放到对应的存储空间</li>\n<li>增强可扩展性，当有新的服务器加入事，原来的每个服务器取出自己的一部分槽给新的</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/data-storage-design1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/data-storage-design2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 集群内部通讯设计</h2>\n<ul>\n<li>各个数据库相互通信，保存各个库中槽的编号数据</li>\n<li>一次命中，直接返回</li>\n<li>一次未命中，告知具体位置</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/cluster-internal-communication-design.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 集群结构搭建</h2>\n<h3> 搭建方式</h3>\n<ul>\n<li>\n<p>原生安装（单条命令）</p>\n<ul>\n<li>配置服务器（3 主 3 从）</li>\n<li>建立通信（<code>Meet</code>）</li>\n<li>分槽（<code>Slot</code>）</li>\n<li>搭建主从（<code>master-slave</code>）</li>\n</ul>\n</li>\n<li>\n<p>工具安装（批处理）</p>\n</li>\n</ul>\n<h3> Cluster 配置</h3>\n<ul>\n<li>\n<p>添加节点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>cluster</code>配置文件名，该文件属于自动生成，仅用于快速查找文件并查询文件内容</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>节点服务响应超时时间，用于判定该节点是否下线或切换为从节点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master</code>连接的<code>slave</code>最小数量</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> Cluster 节点操作命令</h3>\n<ul>\n<li>\n<p>查看集群节点信息</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>进入一个从节点<code>Redis</code>，切换其主节点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>发现一个新节点，新增主节点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>忽略一个没有<code>solt</code>的节点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>手动故障转移</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> redis-trib 命令</h3>\n<ul>\n<li>\n<p>添加节点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除节点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重新分片</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<ol>\n<li>\n<p><code>cluster</code>配置</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master1</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master2</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master3</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave1</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave2</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave3</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>已开启的进程</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>安装<code>ruby</code>和<code>gem</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>开启集群 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>开启集群 2</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master1</code>存数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave1</code>取数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>slave1</code>宕机后重新上线</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master1</code>宕机</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>master1</code>重新上线</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/redis-sentinel-and-cluster/monitor-phase.png",
      "date_published": "2023-10-03T00:00:00.000Z",
      "date_modified": "2023-10-07T14:38:24.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Redis 事务和删除策略",
      "url": "https://1coins.github.io/article/redis/redis-transaction-and-delete-policy.html",
      "id": "https://1coins.github.io/article/redis/redis-transaction-and-delete-policy.html",
      "summary": "事务 简介 Redis执行指令过程中，多条连续执行的指令被干扰，打断，插队。 Redis事务就是一个命令执行的队列，将一系列预定义命令包装成一个整体（一个队列）。当执行时，一次性按照添加顺序依次执行，中间不会被打断或者干扰。 一个队列中，一次性、顺序性、排他性的执行一系列命令。 事务基本操作 开启事务 multi 作用 设定事务的开启位置，此指令执行后，后续的所有指令均加入到事务中 执行事务 exec 作用 设定事务的结束位置，同时执行事务。与multi成对出现，成对使用 取消事务 discard 作用 终止当前事务的定义，发生在multi之后，exec之前",
      "content_html": "<h1> 事务</h1>\n<h2> 简介</h2>\n<p><code>Redis</code>执行指令过程中，多条连续执行的指令被干扰，打断，插队。</p>\n<p><code>Redis</code>事务就是一个命令执行的队列，将一系列预定义命令包装成一个整体（一个队列）。当执行时，一次性按照添加顺序依次执行，中间不会被打断或者干扰。</p>\n<p>一个队列中，一次性、顺序性、排他性的执行一系列命令。</p>\n<h2> 事务基本操作</h2>\n<ul>\n<li>\n<p>开启事务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ul>\n<li>\n<p>作用</p>\n<ul>\n<li>设定事务的开启位置，此指令执行后，后续的所有指令均加入到事务中</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>执行事务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ul>\n<li>\n<p>作用</p>\n<ul>\n<li>设定事务的结束位置，同时执行事务。与<code>multi</code>成对出现，成对使用</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>取消事务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ul>\n<li>\n<p>作用</p>\n<ul>\n<li>终止当前事务的定义，发生在<code>multi</code>之后，<code>exec</code>之前</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>注意：加入事务的命令暂时进入到任务队列中，并没有立即执行，只有执行<code>exec</code>命令才开始执行。</p>\n<h3> 事务的工作流程</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-transaction-and-delete-policy/transaction-operate-process.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 事务注意事项</h3>\n<ul>\n<li>\n<p>语法错误（命令格式输入错误）</p>\n<ul>\n<li>\n<p>指命令书写格式有误</p>\n</li>\n<li>\n<p>处理结果</p>\n<ul>\n<li>如果定义的事务中所包含的命令存在语法错误，整体事务中所有命令均不会执行。包括那些语法正确的命令</li>\n</ul>\n</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>运行错误（命令执行出现错误）</p>\n<ul>\n<li>\n<p>指命令格式正确，但是无法正确的执行，例如对<code>list</code>进行<code>incr</code>操作</p>\n</li>\n<li>\n<p>处理结果</p>\n<ul>\n<li>能够正确运行的命令会执行，运行错误的命令不会被执行</li>\n</ul>\n</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>注意：已经执行完毕的命令对应的数据不会自动回滚，需要程序员自己在代码中实现回滚。</p>\n<h3> 手动事务回滚</h3>\n<ul>\n<li>\n<p>记录操作过程中被影响的数据之前的状态</p>\n<ul>\n<li>单数据：<code>string</code></li>\n<li>多数据：<code>hash</code>、<code>list</code>、<code>set</code>、<code>zset</code></li>\n</ul>\n</li>\n<li>\n<p>设置指令恢复所有的被修改的项</p>\n<ul>\n<li>单数据：直接<code>set</code>（注意周边属性，例如时效）</li>\n<li>多数据：修改对应值或整体克隆复制</li>\n</ul>\n</li>\n</ul>\n<h1> 锁</h1>\n<h2> 监视锁</h2>\n<h3> 业务场景</h3>\n<p>天猫双 11 热卖过程中，对已经售罄的货物追加补货，4 个业务员都有权限进行补货；补货的操作可能是一系列的操作，牵扯到多个连续操作，如何保障不会重复操作？</p>\n<h3> 业务分析</h3>\n<ul>\n<li>多个客户端有可能同时操作同一组数据，并且该数据一旦被操作修改后，将不适用于继续操作</li>\n<li>在操作之前锁定要操作的数据，一旦发生变化，终止当前操作</li>\n</ul>\n<h3> 解决方案</h3>\n<ul>\n<li>\n<p>对<code>key</code>添加监视锁，在执行<code>exec</code>前如果<code>key</code>发生了变化，终止事务执行</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>取消对所有<code>key</code>的监视</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<ol>\n<li>\n<p>客户端 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端 2</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h3> <strong>Tips 21</strong></h3>\n<p><code>Redis</code>应用基于状态控制的批量任务执行。</p>\n<h2> 分布式锁</h2>\n<h3> 业务场景</h3>\n<p>天猫双 11 热卖过程中，对已经售罄的货物追加补货，且补货完成，客户购买热情高涨，3 秒内将所有商品购买完毕；本次补货已经将库存全部清空，如何避免最后一件商品不被多人同时购买？【超卖问题】</p>\n<h3> 业务分析</h3>\n<ul>\n<li>使用<code>watch</code>监控一个<code>key</code>有没有改变已经不能解决问题，此处要监控的是具体数据</li>\n<li>虽然<code>Redis</code>是单线程的，但是多个客户端对同一数据同时进行操作时，如何避免不被同时修改？</li>\n</ul>\n<h3> 解决方案</h3>\n<ul>\n<li>\n<p>使用<code>setnx</code>设置一个公共锁</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>利用<code>setnx</code>命令的返回值特征，有值则返回设置失败，无值则返回设置成功</p>\n<ul>\n<li>对于返回设置成功的，拥有控制权，进行下一步的具体业务操作</li>\n<li>对于返回设置失败的，不具有控制权，排队或等待</li>\n</ul>\n<p>操作完毕通过<code>del</code>操作释放锁。</p>\n<ol>\n<li>\n<p>客户端 1</p>\n<div class=\"language-baah line-numbers-mode\" data-ext=\"baah\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端 2</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端 2</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<p>注意：上述解决方案是一种设计概念，依赖规范保障，具有风险性</p>\n<h3> Tips 22</h3>\n<p><code>Redis</code>应用基于分布式锁对应的场景控制。</p>\n<h2> 分布式锁改良</h2>\n<h3> 业务场景</h3>\n<p>依赖分布式锁的机制，某个用户操作时对应客户端宕机，且此时已经获取到锁，如何解决？</p>\n<h3> 业务分析</h3>\n<ul>\n<li>由于锁操作由用户控制加锁解锁，必定会存在加锁后未解锁的风险</li>\n<li>需要解锁操作不能仅依赖用户控制，系统级别要给出对应的保底处理方案</li>\n</ul>\n<h3> 解决方案</h3>\n<ul>\n<li>\n<p>使用<code>expire</code>为锁<code>key</code>添加时间限定，到时不释放，放弃锁</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<ol>\n<li>\n<p>客户端 1</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端 2</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<p>由于操作通常都是微秒或毫秒级，因此该锁定时间不宜设置过大，具体时间需要业务测试后确认：</p>\n<ul>\n<li>例如：持有锁的操作最长执行时间 127 ms，最短执行时间 7 ms。</li>\n<li>测试百万次最长执行时间对应命令的最大耗时，测试百万次网络延迟平均耗时</li>\n<li>锁时间设定推荐：最大耗时 * 120% + 平均网络延迟 * 110 %</li>\n<li>如果业务最大耗时 &lt;&lt; 网络平均延迟，通常为 2 个数量级，取其中单个耗时较长即可</li>\n</ul>\n<h1> 删除策略</h1>\n<h2> 过期数据</h2>\n<h3> Redis 中的数据特征</h3>\n<p><code>Redis</code>是一种内存级数据库，所有数据均存放在内存中，内存中的数据可以通过<code>TTL</code>指令获取其状态：</p>\n<ul>\n<li><code>XX</code>：具有时效性的数据</li>\n<li>-1：永久有效的数据</li>\n<li>-2：已经过期的数据或被删除的数据或未定义的数据</li>\n</ul>\n<p>过期数据就是那些曾经设置有有效期的数据到达了有效期最终留下的数据。</p>\n<h3> 数据删除策略</h3>\n<ul>\n<li>定时删除</li>\n<li>惰性删除</li>\n<li>定期删除</li>\n</ul>\n<h2> 数据删除策略</h2>\n<h3> 时效性数据的存储结构</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-transaction-and-delete-policy/time-sensitive-data-storage-structure.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 数据删除策略的目标</h3>\n<p>在内存占用与<code>CPU</code>占用之间寻找一种平衡，顾此失彼都会造成整体<code>Redis</code>性能的下降，甚至引发服务器宕机或内存泄露。</p>\n<h3> 定时删除</h3>\n<p>创建一个定时器，当<code>key</code>设置有过期时间，且过期时间到达时，由定时器任务立即执行对键的删除操作。</p>\n<ul>\n<li>优点：节约内存，到时就删除，快速释放掉不必要的内存占用</li>\n<li>缺点：<code>CPU</code>压力很大，无论<code>CPU</code>此时负载量多高，均占用<code>CPU</code>，会影响<code>Redis</code>服务器响应时间和指令吞吐量</li>\n</ul>\n<p>总结：用处理器性能换取存储空间（拿时间换空间）。</p>\n<h3> 惰性删除</h3>\n<p>数据到达过期时间，不做处理。等下次访问该数据时：如果未过期，返回数据；如果发现已过期，删除，返回不存在（<code>get</code>操作与<code>expireIfNeeded()</code>函数绑定，在获取数据前先使用<code>expireIfNeeded()</code>函数查询数据是否过期）。</p>\n<ul>\n<li>优点：节约<code>CPU</code>性能，发现必须删除的时候才删除</li>\n<li>缺点：内存压力很大，出现长期占用内存的数据</li>\n</ul>\n<p>总结：用存储空间换取处理器性能（拿时间换空间）。</p>\n<h3> 定期删除</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-transaction-and-delete-policy/delete-regularly.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ul>\n<li>\n<p><code>Redis</code>启动服务器初始化时，读取配置<code>server.hz</code>的值，默认为 10</p>\n</li>\n<li>\n<p>每秒钟执行<code>server.hz</code>次<code>serverCron()</code></p>\n<div class=\"language-chart line-numbers-mode\" data-ext=\"chart\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><strong>activeExpireCycle()</strong> 对每个<code>expires[\\*]</code>逐一进行检测，每次执行<code>250ms/server.hz</code></p>\n</li>\n<li>\n<p>对某个<code>expires[\\*]</code>检测时，随机挑选<code>W</code>个<code>key</code>检测</p>\n<ul>\n<li>如果<code>key</code>超时，删除<code>key</code></li>\n<li>如果一轮中删除的<code>key</code>的数量 &gt; <code>W \\* 25%</code>，循环该过程</li>\n<li>如果一轮中删除的<code>key</code>的数量 ≤ <code>W \\* 25%</code>，检查下一个<code>expires[\\*]</code>，0-15 循环（<code>expire</code>池有 16 个）</li>\n<li><code>W</code>取值 = <code>ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP</code>属性值</li>\n</ul>\n</li>\n<li>\n<p>参数<code>current_db</code>用于记录**<code>activeExpireCycle()</code>** 进入哪个<code>expires[\\*]</code>执行</p>\n</li>\n<li>\n<p>如果**<code>activeExpireCycle()</code>**执行时间到期，下次从<code>current_db</code>继续向下执行</p>\n</li>\n</ul>\n<p>周期性轮询<code>Redis</code>库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度。</p>\n<ul>\n<li>特点1：<code>CPU</code>性能占用设置有峰值，检测频度可自定义设置</li>\n<li>特点2：内存压力不是很大，长期占用内存的冷数据会被持续清理</li>\n</ul>\n<p>总结：周期性抽查存储空间（随机抽查，重点抽查）。</p>\n<h3> 删除策略比对</h3>\n<ul>\n<li>\n<p>定时删除</p>\n<ul>\n<li>节约内存，无占用</li>\n<li>不分时段占用<code>CPU</code>资源，频度高</li>\n<li>拿时间换空间</li>\n</ul>\n</li>\n<li>\n<p>惰性删除</p>\n<ul>\n<li>内存占用严重</li>\n<li>延时执行，<code>CPU</code>利用率高</li>\n<li>拿空间换时间</li>\n</ul>\n</li>\n<li>\n<p>定期删除</p>\n<ul>\n<li>内存定期随机清理</li>\n<li>每秒花费固定的<code>CPU</code>资源维护内存</li>\n<li>随机抽查，重点抽查</li>\n</ul>\n</li>\n</ul>\n<h1> 逐出算法</h1>\n<h2> 新数据进入检测</h2>\n<p>当新数据进入<code>Redis</code>时，如果内存不足怎么办？</p>\n<p><code>Redis</code>使用内存存储数据，在执行每一个命令前，会调用**<code>freeMemoryIfNeeded()</code><strong>检测内存是否充足。如果内存不满足新加入数据的最低存储要求，<code>Redis</code>要</strong>临时删除一些数据**（数据淘汰/数据逐出）为当前指令清理存储空间。清理数据的策略称为<strong>逐出算法</strong>。</p>\n<p>注意：逐出数据的过程不是 100 % 能够清理出足够的可使用的内存空间，如果不成功则反复执行。当对所有数据尝试完毕后，如果不能达到内存清理的要求，将出现<strong>错误信息</strong>。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h2> 影响数据逐出的相关配置</h2>\n<ul>\n<li>\n<p>最大可使用内存</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>占用物理内存的比例，默认值为 0，表示不限制；生产环境中根据需求设定，通常设置在 50% 以上。</p>\n</li>\n<li>\n<p>每次选取待删除数据的个数</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>选取数据时并不会全库扫描，导致严重的性能消耗，降低读写性能，因此采用随机获取数据的方式作为待检测删除数据</p>\n</li>\n<li>\n<p>删除策略</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>达到最大内存后的，对被挑选出来的数据进行删除的策略</p>\n<ul>\n<li>\n<p>检测易失数据（可能会过期的数据集<code>server.db[i].expires</code>）</p>\n<ol>\n<li><code>volatile-lru(Least Recently Used)</code>：挑选最近最少使用（最近没使用）的数据淘汰，<strong>建议使用</strong></li>\n<li><code>volatile-lfu(Least Frequently Used)</code>：挑选最近使用次数最少的数据淘汰</li>\n<li><code>volatile-ttl</code>：挑选将要过期的数据淘汰</li>\n<li><code>volatile-random</code>：任意选择数据淘汰</li>\n</ol>\n</li>\n<li>\n<p>检测全库数据（所有数据集<code>server.db[i].dict</code>）<br>\n5. <code>allkeys-lru</code>：挑选最近最少使用的数据淘汰<br>\n6. <code>allkeys-lfu</code>：挑选最近使用次数最少的数据淘汰<br>\n7. <code>allkeys-random</code>：任意选择数据淘汰</p>\n</li>\n<li>\n<p>放弃数据驱逐<br>8. <code>no-enviction</code>（驱逐）：禁止驱逐数据（<code>Redis4.0</code>中默认策略），会引发错误<code>OOM(Out Of Memory)</code><br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-transaction-and-delete-policy/lru-and-lfu.png\" alt=\"\" loading=\"lazy\"></p>\n</li>\n</ul>\n</li>\n</ul>\n<h2> 数据逐出策略配置依据</h2>\n<p>使用<code>INFO</code>命令输出监控信息，查询缓存<code>hit</code>（命中）和<code>miss</code>（丢失）的次数，根据业务需求调优<code>Redis</code>配置。</p>\n<p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/redis-transaction-and-delete-policy/transaction-operate-process.png",
      "date_published": "2023-09-30T00:00:00.000Z",
      "date_modified": "2023-10-07T14:38:24.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Redis 通用命令",
      "url": "https://1coins.github.io/article/redis/redis-command.html",
      "id": "https://1coins.github.io/article/redis/redis-command.html",
      "summary": "Key 通用指令 Key 特征 key是一个字符串，通过key获取Redis中保存的数据。 Key 应该设计那些操作？ 对于key自身状态的相关操作，例如：删除，判定存在，获取类型等 对于key有效性控制相关操作，例如：有效期设定，判定是否有效，有效状态的切换等 对于key快速查询操作，例如：按指定策略查询key",
      "content_html": "<h1> Key 通用指令</h1>\n<h2> Key 特征</h2>\n<p><code>key</code>是一个字符串，通过<code>key</code>获取<code>Redis</code>中保存的数据。</p>\n<h2> Key 应该设计那些操作？</h2>\n<ul>\n<li>对于<code>key</code>自身状态的相关操作，例如：删除，判定存在，获取类型等</li>\n<li>对于<code>key</code>有效性控制相关操作，例如：有效期设定，判定是否有效，有效状态的切换等</li>\n<li>对于<code>key</code>快速查询操作，例如：按指定策略查询<code>key</code></li>\n</ul>\n<h2> Key 基本操作</h2>\n<ul>\n<li>\n<p>删除指定<code>key</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取<code>key</code>是否存在</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取<code>key</code>的类型</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> Key 扩展操作（时效性控制）</h2>\n<ul>\n<li>\n<p>为指定<code>key</code>设置有效期</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取<code>key</code>有效时间</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>切换<code>key</code>从时效性转换为永久性</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> Key 扩展操作（查询模式）</h2>\n<ul>\n<li>\n<p>查询<code>key</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 查询模式规则</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> Key 其他操作</h2>\n<ul>\n<li>\n<p>为<code>key</code>改名</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>对所有<code>key</code>排序</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>其他<code>key</code>通用操作</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> 数据库通用操作</h1>\n<h2> Key 重复问题</h2>\n<ul>\n<li><code>key</code>是由程序员定义的</li>\n<li><code>Redis</code>在使用过程中，伴随着操作数据量的增加，会出现大量的数据以及对应的<code>key</code></li>\n<li>数据不区分种类，类别混杂在一起，极易出现重复或冲突</li>\n</ul>\n<h2> 解决方案</h2>\n<ul>\n<li><code>Redis</code>为每个服务器提供有 16 个数据库，编号从 0-15</li>\n<li>每个数据库之间的数据互相独立</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-command/redis-batabase.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> db 基本操作</h2>\n<ul>\n<li>\n<p>切换数据库</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>其他操作</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>数据移动</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>数据清除</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> 服务器基础配置</h1>\n<h2> 服务器端设定</h2>\n<ul>\n<li>\n<p>设置服务器以守护进程的方式运行</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>绑定主机地址</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设置服务器端口号</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设置数据库数量</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 日志配置</h2>\n<ul>\n<li>\n<p>设置服务器以指定日志记录级别</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>日志记录文件名</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>注意：日志级别开发期设置为<code>verbose</code>即可，生产环境中配置为<code>notice</code>，简化日志输出量，降低写日志<code>IO</code>的频度</p>\n<h2> 客户端配置</h2>\n<ul>\n<li>\n<p>设置同一时间最大客户端连接数，默认无限制。当客户端连接到达上限，<code>Redis</code>会关闭新的连接</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>客户端闲置等待最大时长，达到最大值后关闭连接。如需关闭该功能，设置为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span></span></span></span></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 多服务器快捷配置</h2>\n<ul>\n<li>\n<p>导入并加载指定配置文件信息，用于快速创建<code>redis</code>公共配置较多的<code>redis</code>实例配置文件，便于维护</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h1> Jedis</h1>\n<h2> 简介</h2>\n<ul>\n<li>\n<p><code>Java</code>语言连接<code>Redis</code>服务</p>\n<ul>\n<li><code>Jedis</code></li>\n<li><code>SpringData Redis</code></li>\n<li><code>Lettuce</code></li>\n</ul>\n</li>\n<li>\n<p><code>C</code>、<code>C++</code>、<code>C#</code>、<code>Erlang</code>、<code>Lua</code>、<code>Objective-C</code>、<code>Perl</code>、<code>PHP</code>、<code>Python</code>、<code>Ruby</code>、<code>Scala</code></p>\n</li>\n<li>\n<p>可视化连接<code>Redis</code>客户端</p>\n<ul>\n<li><code>Redis Desktop Manager</code></li>\n<li><code>Redis Client</code></li>\n<li><code>Redis Studio</code></li>\n</ul>\n</li>\n</ul>\n<h2> 准备工作</h2>\n<ul>\n<li>\n<p><code>jar</code>包导入</p>\n<ul>\n<li><a href=\"https://mvnrepository.com/artifact/redis.clients/jedis\" target=\"_blank\" rel=\"noopener noreferrer\">下载地址</a></li>\n</ul>\n</li>\n<li>\n<p>基于<code>maven</code></p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 客户端连接 Redis</h2>\n<ul>\n<li>\n<p>连接<code>Redis</code></p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>操作<code>Redis</code></p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>关闭<code>Redis</code>连接</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><a href=\"http://xetorthio.github.io/jedis/\" target=\"_blank\" rel=\"noopener noreferrer\">API文档</a></p>\n</li>\n</ul>\n<h2> 读写 Redis 数据</h2>\n<h3> 案例：服务调用次数控制</h3>\n<p>人工智能领域的语义识别与自动对话将是未来服务业机器人应答呼叫体系中的重要技术，百度自研用户评价语义识别服务，免费开放给企业试用，同时训练百度自己的模型。现对试用用户的使用行为进行限速，限制每个用户每分钟最多发起 10 次调用。</p>\n<h4> 案例要求</h4>\n<ol>\n<li>设定<code>A</code>、<code>B</code>、<code>C</code>三个用户</li>\n<li><code>A</code>用户限制 10 次/分调用，<code>B</code>用户限制 30 次/分调用，<code>C</code>用户不限制</li>\n</ol>\n<h4> 需求分析</h4>\n<ol>\n<li>设定一个服务方法，用于模拟实际业务调用的服务，内部采用打印模拟调用</li>\n<li>在业务调用前服务调用控制单元，内部使用<code>Redis</code>进行控制，参照之前的方案</li>\n<li>对调用超限使用异常进行控制，异常处理设定为打印提示信息</li>\n<li>主程序启动 3 个线程，分别表示 3 种不同用户的调用</li>\n</ol>\n<h4> 实现步骤</h4>\n<ol>\n<li>\n<p>设定业务方法</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设定多线类，模拟用户调用</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设计<code>Redis</code>控制方案</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设计启动主程序</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<p>后续 1：对业务控制方案进行改造，设定不同用户等级的判定</p>\n<p>后续 2：将不同用户等级对应的信息、限制次数等设定到<code>Redis</code>中，使用<code>hash</code>保存</p>\n<h2> 简易工具类开发</h2>\n<h3> 基于连接池获取</h3>\n<p><code>JedisPool</code>：<code>Jedis</code>提供的连接池技术。</p>\n<ul>\n<li><code>poolConfig</code>：连接池配置对象</li>\n<li><code>host</code>：<code>redis</code>服务地址</li>\n<li><code>port</code>：<code>redis</code>服务端口号</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 封装连接参数</h3>\n<p><code>jedis.properties</code>。</p>\n<div class=\"language-properties line-numbers-mode\" data-ext=\"properties\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 加载配置信息</h3>\n<p>静态代码块初始化资源。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 获取连接</h3>\n<p>对外访问接口，提供<code>Jedis</code>连接对象，连接从连接池获取。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> 可视化客户端</h1>\n<p><code>Redis Desktop Manager</code>。</p>\n<p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/redis-command/redis-batabase.png",
      "date_published": "2023-09-20T00:00:00.000Z",
      "date_modified": "2023-09-24T03:08:04.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Redis 数据类型",
      "url": "https://1coins.github.io/article/redis/redis-data-type.html",
      "id": "https://1coins.github.io/article/redis/redis-data-type.html",
      "summary": "Redis 数据类型的形成 作为缓存使用 原始业务功能设计 秒杀 618 活动 双十一活动 排队购票 运营平台监控到的突发高频访问数据 突发市政要闻，被强势关注围观 高频、复杂的统计数据 在线人数 投票排行榜 附加功能",
      "content_html": "<h1> Redis 数据类型的形成</h1>\n<h2> 作为缓存使用</h2>\n<ol>\n<li>\n<p>原始业务功能设计</p>\n<ul>\n<li>秒杀</li>\n<li>618 活动</li>\n<li>双十一活动</li>\n<li>排队购票</li>\n</ul>\n</li>\n<li>\n<p>运营平台监控到的突发高频访问数据</p>\n<ul>\n<li>突发市政要闻，被强势关注围观</li>\n</ul>\n</li>\n<li>\n<p>高频、复杂的统计数据</p>\n<ul>\n<li>在线人数</li>\n<li>投票排行榜</li>\n</ul>\n</li>\n</ol>\n<h2> 附加功能</h2>\n<p>系统功能优化或升级</p>\n<ul>\n<li>单服务器升级集群</li>\n<li><code>Session</code>管理</li>\n<li><code>Token</code>管理</li>\n</ul>\n<h1> Redis 数据类型（5 种常用）</h1>\n<ul>\n<li><code>string --&gt; String</code></li>\n<li><code>hash --&gt; Hashmap</code></li>\n<li><code>list --&gt; LinkList</code></li>\n<li><code>set --&gt; HashSet</code></li>\n<li><code>sorted_set --&gt; TreeSet</code></li>\n</ul>\n<h1> String</h1>\n<h2> 数据存储格式</h2>\n<ul>\n<li><code>Redis</code>自身是一个<code>Map</code>，其中所有的数据都是采用<code>key:value</code>的形式存储</li>\n<li>数据类型指的是存储的数据的类型，也就是<code>value</code>部分的类型，<code>key</code>部分永远都是字符串</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/redis-storage1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> <code>string</code>类型</h2>\n<ul>\n<li>\n<p>存储的数据：单个数据，最简单的数据存储类型，也是最常用的数据存储类型</p>\n</li>\n<li>\n<p>存储数据的格式：一个存储空间保存一个数据</p>\n</li>\n<li>\n<p>存储内容：通常使用字符串，如果字符串以整数的形式展示，可以作为数字操作使用</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/redis-storage2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n</ul>\n<h2> 基本操作</h2>\n<ul>\n<li>\n<p>添加/修改数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>添加/修改多个数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取多个数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取数据字符个数（字符串长度）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>追加信息到原始信息后部（如果原始信息存在就追加，否则新建）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 单数据操作与多数据操作的选择</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/string-set-mset.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 扩展操作</h2>\n<h3> 数据表主键不重复</h3>\n<h4> 业务场景</h4>\n<p>大型企业级应用中，分表操作是基本操作，使用多张表存储同类型数据，但是对应的主键<code>id</code>必须保证统一性，不能重复；<code>Oracle</code>数据库具有<code>sequence</code>设定，可以解决该问题，但是<code>MySql</code>数据库并不具有类似的机制，那么如何解决？</p>\n<h4> 解决方案</h4>\n<ul>\n<li>\n<p>设置数值数据增加指定范围的值</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设置数值数据减少指定范围的值</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<blockquote>\n<p>注：<code>increment</code>可正可负</p>\n</blockquote>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> <code>string</code>作为数值操作</h4>\n<ul>\n<li><code>string</code>在<code>Redis</code>内部存储默认就是一个字符串，当遇到增减类操作<code>incr</code>、<code>decr</code>时会转成数值型进行计算</li>\n<li><code>Redis</code>所有的操作都是原子性的，采用单线程处理所有业务，命令是一个一个执行的，因此无需考虑并发带来的数据影响。</li>\n</ul>\n<p>注意：<strong>按数值进行操作的数据，如果原始数据不能转成数值，或超过了</strong>**<code>Redis</code>****数值上线范围，将会报错；**<code>Java</code>中<code>long</code>型数据最大值，<code>Long.MAX_VALUE=9223372036854775807</code>。</p>\n<h4> Tips 1</h4>\n<ul>\n<li><code>Redis</code>用于控制数据库表主键<code>id</code>，为数据库表主键提供生成策略，保障数据库表的主键唯一性</li>\n<li>此方案适用于所有数据库，且支持数据库</li>\n</ul>\n<h3> 数据时效性设置</h3>\n<h4> 业务场景</h4>\n<p>场景一：“最强女生”，启动海选投票，只能通过微信投票，每个微信号每4个小时只能投 1 票。</p>\n<p>场景二：电商商家开启热门商品推荐，热门商品不能一直处于热门期，每种商品热门期维持 3 天，3 天后自动取消热门</p>\n<p>场景三：新闻网站会出现热点新闻，热点新闻最大的特征是对时效性，如何自动控制热点新闻的时效性</p>\n<h4> 解决方案</h4>\n<ul>\n<li>\n<p>设置数据具有指定的声明周期</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Tips 2</h4>\n<p><code>Redis</code>控制数据的生命周期，通过数据是否失效控制业务行为，适用于所有具有时效性限定控制的操作。</p>\n<h2> 注意事项</h2>\n<ul>\n<li>\n<p>数据操作不成功的反馈与数据正常操作之间的差异</p>\n<ol>\n<li>\n<p>表示运行结果是否成功</p>\n<ul>\n<li><code>(integer)0–&gt;false</code> 失败</li>\n<li><code>(integer)1–&gt;true</code> 成功</li>\n</ul>\n</li>\n<li>\n<p>表示运行结果值</p>\n<ul>\n<li><code>(integer)3–&gt;3</code> 3 个</li>\n<li><code>(integer)1–&gt;1</code> 1 个</li>\n</ul>\n</li>\n</ol>\n</li>\n<li>\n<p>数据未获取到</p>\n<ul>\n<li><code>(nil)</code>等同于<code>null</code></li>\n</ul>\n</li>\n<li>\n<p>数据最大存储量</p>\n<ul>\n<li>512 MB</li>\n</ul>\n</li>\n<li>\n<p>数值计算最大范围（<code>Java</code>中的<code>long</code>的最大值）</p>\n<ul>\n<li>92233720368547758</li>\n</ul>\n</li>\n</ul>\n<h2> 应用场景</h2>\n<h3> 微博主页显示粉丝数与微博数量</h3>\n<h4> 业务场景</h4>\n<p>主页高频访问信息显示控制，例如新浪微博大V主页显示粉丝数与微博数量。</p>\n<h4> 解决方案</h4>\n<ul>\n<li>\n<p>在<code>Redis</code>中为大 V 用户设定用户信息，以用户主键和属性值作为<code>key</code>，后台设定定时刷新策略即可</p>\n<ul>\n<li><code>[user]:[id]:3506728370:fans → 12210947</code></li>\n<li><code>user:id:3506728370:blogs → 6164</code></li>\n<li><code>user:id:3506728370:focuss → 83</code></li>\n</ul>\n</li>\n<li>\n<p>在<code>Redis</code>中以<code>json</code>格式存储大V用户信息，定时刷新（也可以使用<code>hash</code>类型）</p>\n<ul>\n<li><code>user:id:3506728370 → {\"id\":3506728370,\"name\":\"春晚\",\"fans\":12210862,\"blogs\":6164, \"focus\":83}</code></li>\n</ul>\n</li>\n</ul>\n<p>注：第二种方案中的数据不好修改</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Tips 3</h4>\n<p><code>Rredis</code>应用于各种结构型和非结构型高热度数据访问。</p>\n<h4> <code>key</code>的设置约定</h4>\n<p>数据库中的热点数据<code>key</code>命名惯例：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/hot-key-names.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> Hash</h1>\n<h2> 存储的困惑</h2>\n<p>对象类数据的存储如果具有较为频繁的更新需求操作会显得笨重：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/object-awalys-update.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> <code>hash</code>类型</h2>\n<ul>\n<li>新的存储需求：对一系列存储的数据进行编组，方便管理，典型应用---存储对象信息</li>\n<li>需要的内存结构：一个存储空间保存多少个键值对数据</li>\n<li><code>hash</code>类型：底层使用哈希表结构实现数据存储</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/redis-hash.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 基本操作</h2>\n<ul>\n<li>\n<p>添加/修改数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>添加/修改多个数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取多个数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取哈希表中字段的数量</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取哈希表中是否存在指定的字段</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 扩展操作</h2>\n<ul>\n<li>\n<p>获取哈希表中所有的字段名和字段值</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设置指定字段的数值数据增加指定范围的值</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 注意事项</h2>\n<ul>\n<li><code>hash</code>类型下的<code>value</code>只能存储字符串，不允许存储其他类型数据，不存在嵌套现象；如果数据未获取到，对应的值为（<code>nil</code>）</li>\n<li>每个<code>hash</code>可以存储 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">2^{32}-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">32</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 个键值对</li>\n<li><code>hash</code>类型十分贴近对象的数据存储形式，并且可以灵活添加删除对象属性；但<code>hash</code>设计初中不是为了存储大量对象而设计的，切记不可滥用，更不可以将<code>hash</code>作为对象列表使用</li>\n<li><code>hgetall</code>操作可以获取全部属性，如果内部<code>fiekd</code>过多，遍历整体数据效率就会很低，有可能成为数据访问瓶颈，用那个拿那个</li>\n</ul>\n<h2> 应用场景</h2>\n<h3> 购物车</h3>\n<h4> 业务场景</h4>\n<p>电商网站购物车设计与实现。</p>\n<h4> 业务分析</h4>\n<ul>\n<li>\n<p>仅分析购物车的<code>redis</code>存储模型<br>\n添加、浏览、更改数量、删除、清空</p>\n</li>\n<li>\n<p>购物车于数据库间持久化同步（不讨论）</p>\n</li>\n<li>\n<p>购物车于订单间关系（不讨论）</p>\n<ul>\n<li>提交购物车：读取数据生成订单</li>\n<li>商家临时价格调整：隶属于订单级别</li>\n</ul>\n</li>\n<li>\n<p>未登录用户购物车信息存储（不讨论）</p>\n<ul>\n<li><code>cookie</code>存储</li>\n</ul>\n</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/shopping-cart-data-structure.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h4> 解决方案</h4>\n<ul>\n<li>以客户<code>id</code>作为<code>key</code>，每位客户创建一个<code>hash</code>存储结构存储对应的购物车信息</li>\n<li>将商品编号作为<code>field</code>，购买数量作为<code>value</code>进行存储</li>\n<li>添加商品：追加全新的<code>field</code>与<code>value</code></li>\n<li>浏览：遍历<code>hash</code></li>\n<li>更改数量：自增/自减，设置<code>value</code>值</li>\n<li>删除商品：删除<code>field</code></li>\n<li>清空：删除<code>key</code></li>\n<li>此处仅讨论购物车中的模型设计</li>\n<li>购物车与数据库间持久化同步、购物车与订单间关系、未登录用户购物车信息存储不进行讨论</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 当前设计是否加速了购物车的呈现</h4>\n<p>当前仅仅是将数据存储到<code>redis</code>中，并没有起到加速的所用，因为商品信息还需要二次查询数据库。</p>\n<ul>\n<li>\n<p>每条购物车中的商品记录保存成两条<code>field</code></p>\n</li>\n<li>\n<p><code>field1</code>专用于保存购买数量</p>\n<ol>\n<li>命名格式：<code>商品id:nums</code></li>\n<li>保存数据：数值</li>\n</ol>\n</li>\n<li>\n<p><code>field2</code>专用于保存购物车中显示的信息，包含文字描述，图片地址，所属商家信息等</p>\n<ol>\n<li>命名格式：<code>商品id:info</code></li>\n<li>保存数据：<code>json</code></li>\n</ol>\n</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>可以看出来又具有了大量的信息重复，所以我们可以把<code>field2</code>的内容变成一个固定的<code>hash</code>，但是所有的商品信息都放在一个<code>hash</code>也很麻烦，可以用类别再做小的区分，让它们分散到不同的<code>hash</code>里。</p>\n<ul>\n<li>\n<p>修改数据，如果<code>fileld</code>有值就什么都不做，如果没有就加进去</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Tips 4</h4>\n<p><code>Redis</code>应用于购物车数据存储。</p>\n<h3> 抢购</h3>\n<h3> 业务场景</h3>\n<p>双十一活动日，销售手机充值卡的商家对移动、联通、电信的 30 元、50 元、100 元商品推出抢购活动，每种商品抢购上限 100。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/rush-to-purchase.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h4> 解决方案</h4>\n<ul>\n<li>以商家<code>id</code>作为<code>key</code></li>\n<li>将参与抢购的商品<code>id</code>作为<code>field</code></li>\n<li>将参与抢购的商品数量作为对应的<code>value</code></li>\n<li>抢购时使用降至的方式控制产品数量</li>\n<li>实际业务中还有超卖等实际问题，这里不做</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Tips 5</h4>\n<p><code>Redis</code>应用于抢购，限购类、限量发放优惠卷、激活码等业务的数据存储</p>\n<h3> <code>string</code>与<code>hash</code></h3>\n<h4> 业务场景</h4>\n<p><code>string</code>存储对象（<code>json</code>）与<code>hash</code>存储。</p>\n<h4> 解决方案</h4>\n<ul>\n<li><code>string</code>（<code>json</code>）讲究整体性，数据以整体操作，要么一次性更新，要么一次性获取，以读为主</li>\n<li><code>hash</code>以<code>filed</code>将属性隔离，以更新为主</li>\n<li>更新操作多用<code>hash</code>，把数据对外包装出去用<code>string</code></li>\n</ul>\n<h1> List 类型</h1>\n<ul>\n<li>数据存储需求：存储多个数据，并对数据进入存储空间的顺序进行区分</li>\n<li>需要的存储数据：一个存储空间保存多个数据，且通过数据可以体现进入顺序</li>\n<li><code>list</code>类型：保存多个数据，底层使用双向链表存储结构实现</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/list.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/redis-list.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 基本操作</h2>\n<ul>\n<li>\n<p>添加/修改数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除并移除数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 扩展操作</h2>\n<ul>\n<li>\n<p>规定时间内获取并移除数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>阻塞式获取，获取值如果还没有的时候可以等，如果有值就可以获取到。</p>\n<ul>\n<li>\n<p>移除指定数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 业务场景</h3>\n<p>微信朋友圈点赞，要求按照点赞顺序显示点赞好友信息，如果取消点赞，移除对应好友信息。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> Tips 6</h3>\n<ul>\n<li><code>redis</code>应用于具有操作线后顺序的数据控制</li>\n</ul>\n<h2> 注意事项</h2>\n<ul>\n<li><code>list</code>中保存的数据都是<code>string</code>类型的，数据总容量式有限的，最多 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">2^{32}-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">32</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 个元素（4294967295）</li>\n<li><code>list</code>具有索引的概念，但是操作数据时候通常以队列的形式进行入队出队操作，或以栈的形式进入栈出栈的操作</li>\n<li>获取全部数据操作结束索引设置为 -1</li>\n<li><code>list</code>可以对数据进行分页操作，通过第一页的信息来自<code>list</code>，第 2 页及更多的信息通过数据库的形式加载</li>\n</ul>\n<h2> 应用场景</h2>\n<h3> 业务场景</h3>\n<p><code>twitter</code>、新浪微博、腾讯微博中个人用于的关注列表需要按照用户的关注顺序进行展示，粉丝列表需要将最近关注的粉丝列在前面，新闻、资讯类网站如何将最新的新闻或资讯按照发生的事件顺序展示，企业运营过程中，系统将产生出大量的运营数据，如何保障堕胎服务器操作日志的统一顺序输出？</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/redis-list-sort.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 解决方案</h3>\n<ul>\n<li>依赖<code>list</code>的数据具有顺序的特征对信息进行管理</li>\n<li>使用队列模型解决多路信息汇总合并的问题</li>\n<li>使用栈模型解决最新消息的问题</li>\n</ul>\n<h3> Tips 7</h3>\n<p><code>Redis</code>应用于最新消息。</p>\n<h1> Set 类型</h1>\n<ul>\n<li>新的存储需求：存储大量的数据，在查询方面提供更高的效率</li>\n<li>需要的存储结构：能够保存大量的数据，高效的内部存储机制，便于查询</li>\n<li><code>set</code>类型：与<code>hash</code>存储结构完全相同，仅存储键，不存储值（<code>nil</code>），并且值式不允许重复的</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/redis-set.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 基本操作</h2>\n<ul>\n<li>\n<p>添加数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取全部数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取集合数据总量</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>判断集合中是否包含指定数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 扩展操作</h2>\n<h3> 业务场景</h3>\n<p>每位用户首次使用进入头条时候会设置 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn></mrow><annotation encoding=\"application/x-tex\">3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">3</span></span></span></span> 项爱好的内容，但是后期为了增加用户的活跃度，兴趣点，必须让用户对其他信息类别逐渐产生兴趣，增加客户留存度，如何实现？</p>\n<h3> 业务分析</h3>\n<ul>\n<li>系统分析出各个分类的最新或最热点信息条目并组织成<code>set</code>集合</li>\n<li>随机挑选其中部分信息</li>\n<li>配合用户关注信息分类中的热点信息组织展示的全信息集合</li>\n</ul>\n<h3> 解决方案</h3>\n<ul>\n<li>\n<p>随机获取集合中指定数量的数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>随机获取集合中的某个数据并将该数据移出集合</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> Tips 8</h3>\n<p><code>Redis</code>应用于随机推荐类信息检索，例如热点歌单推荐，热点新闻推荐，热点旅游线路，应用<code>APP</code>推荐，大 V 推荐等。</p>\n<h2> 扩展操作</h2>\n<h3> 业务场景</h3>\n<p>脉脉为了促进用户间的交流，保障业务成单率的提升，需要让每位用户拥有大量的好友，事实上职场新人不具有更多的职场好友，如何快速为用户积累更多的好友？</p>\n<p>新浪微博为了增加用户热度，提高用户留存性，需要微博用户在关注更多的人，以此获得更多的信息或热门话题，如何提高用户关注他人的总量？</p>\n<p><code>QQ</code>新用户入网年龄越来越低，这些用户的朋友圈交际圈非常小，往往集中在一所学校甚至一个班级中，如何帮助用户快速积累好友用户带来更多的活跃度？</p>\n<p>微信公众号是微信信息流通的渠道之一，增加用户关注的公众号成为提高用户活跃度的一种方式，如何帮助用户积累更多关注的公众号？</p>\n<p>美团外卖为了提升成单量，必须帮助用户挖掘美食需求，如何推荐给用户最适合自己的美</p>\n<h3> 解决方案</h3>\n<ul>\n<li>\n<p>求两个集合的交、并、差集</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>求两个集合的交、并、差集并存储到指定集合中</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>将指定数据从原始集合移动到目标集合中</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> Tips 9</h3>\n<ul>\n<li><code>Redis</code>应用于同类信息的关联搜索，二度关联搜索，深度关联搜索</li>\n<li>显示共同关注（一度）</li>\n<li>显示共同好友（一度）</li>\n<li>由用户<code>A</code>出发，获取到好友用户<code>B</code>的好友信息列表（一度）</li>\n<li>由用户<code>A</code>出发，获取到好友用户<code>B</code>的购物清单列表（二度）</li>\n<li>由用户<code>A</code>出发，获取到好友用户<code>B</code>的游戏充值列表（二度）</li>\n</ul>\n<h2> 注意事项</h2>\n<ul>\n<li><code>set</code>类型不允许数据重复，如果添加的数据在<code>set</code>中已经存在，将只保留一份</li>\n<li><code>set</code>虽然与<code>hash</code>的存储结构相同，但是无法启用<code>hash</code>中存储值的空间</li>\n</ul>\n<h2> 应用场景</h2>\n<h3> 权限校验</h3>\n<h4> 业务场景</h4>\n<p>集团公司共具有 12000 名员工，内部<code>OA</code>系统中具有 700 多个角色，3000 多个业务操作，23000 多种数据，每位员工具有一个或多个角色，如何快速进行业务操作的权限校验？</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/oa-authentication.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h4> 解决方案</h4>\n<ul>\n<li>依赖<code>set</code>集合数据不重复的特征，依赖<code>set</code>集合<code>hash</code>存储结构特征完成数据过滤与快速查询</li>\n<li>根据用户<code>id</code>获取用户所有角色</li>\n<li>根据用户所有角色获取用户所有操作权限放入<code>set</code>集合</li>\n<li>根据用户所有觉得获取用户所有数据全选放入<code>set</code>集合</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 校验工作</h4>\n<p><code>Redis</code>提供基础数据还是提供校验结果？</p>\n<p>一般只让<code>Redis</code>提供基础数据，将业务逻辑放在程序中</p>\n<h4> Tips 10</h4>\n<p><code>Redis</code>应用于同类型不重复数据的合并操作</p>\n<h3> 网站访问量统计</h3>\n<h4> 业务场景</h4>\n<p>公司对旗下新的网站做推广，统计网站的<code>PV</code>（访问量），<code>UV</code>（独立访客），<code>IP</code>（独立<code>IP</code>）。</p>\n<ul>\n<li><code>PV</code>：网站被访问次数，可通过刷新页面提高访问量</li>\n<li><code>UV</code>：网站被不同用户访问的次数，可通过<code>cookie</code>统计访问量，相同用户切换<code>IP</code>地址，<code>UV</code>不变</li>\n<li><code>IP</code>：网站被不同<code>IP</code>地址访问的总次数，可通过<code>IP</code>地址统计访问量，相同<code>IP</code>不同用户访问，<code>IP</code>不变</li>\n</ul>\n<h4> 解决方案</h4>\n<ul>\n<li>利用<code>set</code>集合的数据去重特征，记录各种访问数据</li>\n<li>建立<code>string</code>类型数据，利用<code>incr</code>统计日访问量（<code>PV</code>)</li>\n<li>建立<code>set</code>模型，记录不同<code>cookie</code>数量（<code>UV</code>)</li>\n<li>建立<code>set</code>模型，记录不用<code>IP</code>数量（<code>IP</code>)</li>\n</ul>\n<h4> Tips 11</h4>\n<p><code>Redis</code>应用于同类型数据的快速去重。</p>\n<h3> 网站黑白名单</h3>\n<h4> 业务场景</h4>\n<p><strong>黑名单</strong></p>\n<p>资讯类信息类网站追求高访问量，但是由于其信息的价值，往往容易被不法分子利用，通过爬虫技术，快速获取信息，个别特种行业网站信息通过爬虫获取分析后，可以转换成商业机密进行出售；例如第三方火车票、机票、酒店刷票代购软件，电商刷评论、刷好评。</p>\n<p>同时爬虫带来的伪流量也会给经营者带来错觉，产生错误的决策，有效避免网站被爬虫反复爬取成为每个网站都要考虑的基本问题。在基于技术层面区分出爬虫用户后，需要将此类用户进行有效的屏蔽，这就是<strong>黑名单</strong>的典型应用。</p>\n<p>PS：不是说爬虫一定做摧毁性的工作，有些小型网站需要爬虫为其带来一些流量。</p>\n<p><strong>白名单</strong></p>\n<p>对于安全性更高的应用访问，仅仅靠黑名单是不能解决安全问题的，此时需要设定可访问的用户群体，依赖<strong>白名单</strong>做更为苛刻的访问验证。</p>\n<h4> 解决方案</h4>\n<ul>\n<li>基于经营战略设定问题用户发现、鉴别规则</li>\n<li>周期性更行满足规则的用户黑名单，加入<code>set</code>集合</li>\n<li>用户行为信息达到后与黑名单进行比比对，确认行为去向</li>\n<li>黑名单过滤<code>IP</code>地址：应用于开放游客访问权限的信息源</li>\n<li>黑名单过滤设备信息：应用于限定访问设备的信息源</li>\n<li>黑名单过滤用户：应用于基于访问权限的信息源</li>\n</ul>\n<h4> Tips 12</h4>\n<p><code>Redis</code>应用于基于黑名单与白名单设定的服务控制。</p>\n<p>‍</p>\n<h1> Sorted_set（Zset）</h1>\n<ul>\n<li>新的存储需求：根据排序有利于数据的有效显示，需要提供一种可以根据自身特征进行排序的方式</li>\n<li>需要的存储结构：新的存储模型，可以保存可排序的数据</li>\n<li><code>sorted_set</code>类型：在<code>set</code>的存储结构基础上添加可排序字段</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/edis-sorted-set.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 基本操作</h2>\n<ul>\n<li>\n<p>添加数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取全部数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>按条件获取数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>条件删除</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p><strong>注意</strong>：</p>\n<ul>\n<li>\n<p><code>min</code>与<code>max</code>用于限定搜索查询的条件</p>\n</li>\n<li>\n<p><code>start</code>与<code>stop</code>用于限定查询范围，作用于索引，表示开始和结束索引</p>\n</li>\n<li>\n<p><code>offset</code>与<code>count</code>用于限定查询范围，作用于查询结果，表示开始位置和数据总量</p>\n</li>\n<li>\n<p>获取集合数据总量</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>集合交、并操作</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 扩展操作</h2>\n<h3> 排行榜</h3>\n<h4> 业务场景</h4>\n<ul>\n<li>票选广东十大杰出青年</li>\n<li>各类综艺选秀海选投票各类资源网站TOP10（电影，歌曲，文档，电商，游戏等）</li>\n<li>聊天室活跃度</li>\n<li>统计游戏好友亲密度</li>\n</ul>\n<h4> 业务分析</h4>\n<p>为所有参与排名的资源建立排序。</p>\n<h4> 解决方案</h4>\n<ul>\n<li>\n<p>获取数据对应的索引（排名）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>score</code>值获取与修改</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Tips 13</h4>\n<p><code>Redis</code>应用于计数器组合排序功能对应的排名。</p>\n<h2> 注意事项</h2>\n<ul>\n<li><code>score</code>保存的数据存储空间是 64 位，如果是整数范围是 -9007199254740992~9007199254740992</li>\n<li><code>score</code>保存的数据也可以是一个双精度的<code>double</code>值，基于双精度浮点数的特征，可能会丢失精度，使用时侯要慎重</li>\n<li><code>sorted_set</code>底层存储还是基于<code>set</code>结构的，因此数据不能重复，如果重复添加相同的数据，<code>score</code>值将被反复覆盖，保留最后一次修改的结果</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 应用场景</h2>\n<h3> 时效性任务管理</h3>\n<h4> 业务场景</h4>\n<p>基础服务+增值服务类网站会设定各位会员的试用，让用户充分体验会员优势。例如观影试用<code>VIP</code>、游戏<code>VIP</code>体验、云盘下载体验<code>VIP</code>、数据查看体验<code>VIP</code>。当<code>VIP</code>体验到期后，如果有效管理此类信息。即便对于正式<code>VIP</code>用户也存在对应的管理方式。</p>\n<p>网站会定期开启投票、讨论，限时进行，逾期作废。如何有效管理此类过期信息。</p>\n<h4> 解决方案</h4>\n<ul>\n<li>\n<p>对于基于时间线限定的任务处理，将处理时间记录位<code>score</code>值，利用排序功能区分处理的先后顺序</p>\n</li>\n<li>\n<p>记录下一个要处理的事件，当到期后处理对应的任务，移除<code>redis</code>中的记录，并记录下一个要处理的时间</p>\n</li>\n<li>\n<p>当新任务加入时，判定并更新当前下一个要处理的任务时间</p>\n</li>\n<li>\n<p>为提升<code>sorted_set</code>的性能，通常将任务根据特征存储成若干个<code>sorted_set</code>，例如 1 小时内，1 天内，年度等，操作时逐渐提升，将即将操作的若干个任务纳入到 1 小时内处理队列中</p>\n</li>\n<li>\n<p>获取当前系统时间</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Tips 14</h4>\n<p><code>Redis</code>应用于定时任务执行顺序管理或任务过期管理。</p>\n<h3> 带有权重的任务管理</h3>\n<h4> 业务场景</h4>\n<p>任务/消息权重设定应用：当任务或者消息待处理，形成了任务队列或消息队列时，对于高优先级的任务要保障对其优先处理，如何实现任务权重管理。</p>\n<h4> 解决方案</h4>\n<ul>\n<li>\n<p>对于带有权重的任务，优先处理权重高的任务，采用<code>score</code>记录权重即可<br>\n多条件任务权重设定：<br>\n如果权重条件过多时，需要对排序<code>score</code>值进行处理，保障<code>score</code>值能够兼容2条件或者多条件，例如外贸订单优先于国内订单，总裁订单优先于员工订单，经理订单优先于员工订单。</p>\n</li>\n<li>\n<p>因<code>score</code>长度受限，需要对数据进行截断处理，尤其是时间设置为小时或分钟级即可（折算后）</p>\n</li>\n<li>\n<p>先设定订单类别，后设定订单发起角色类别，整体<code>score</code>长度必须是统一的，不足位补 0，第一排序规则首位不得是 0</p>\n<ul>\n<li>例如外贸 101，国内 102，经理 004，员工 008</li>\n<li>员工下的外贸单<code>score</code>值为 101008（优先）</li>\n<li>经理下的国内单<code>score</code>值为 1020</li>\n</ul>\n</li>\n<li>\n<p>对于带有权重的任务，优先处理权重高的任务，采用<code>score</code>记录权重即可</p>\n</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Tips 15</h4>\n<p><code>Redis</code>应用于即时任务/消息队列执行管理。</p>\n<h1> Redis 数据类型综合实践案例</h1>\n<h2> 计数器</h2>\n<h3> 业务场景</h3>\n<p>人工智能领域的语义识别与自动对话将是未来服务业机器人应答呼叫体系中的重要技术，百度自研用户评价语义识别服务，免费开放给企业试用，同时训练百度自己的模型。现对试用用户的使用行为进行限速，限制每个用户每分钟最多发起 10 次。</p>\n<h3> 解决方案</h3>\n<ul>\n<li>设计计数器，记录调用次数，用于控制业务执行次数。以用户<code>id</code>作为<code>key</code>,使用此时作为<code>value</code></li>\n<li>在调用前获取次数，判断是否超过限定次数，不超过次数的情况下，每次调用计数 +1，业务调用失败，计数 -1</li>\n<li>为了计数器设置生命周期为指定周期，例如 1 秒/分钟，自动清空周期内使用次数</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/counter1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 解决方案改良</h3>\n<ul>\n<li>取消最大值的判定，利用<code>incr</code>操作超过最大值抛出异常的形式替代每次判断是否大于最大值</li>\n<li>判断是否为<code>nil</code>，如果是，设置为<code>Max-次数</code>，如果不是，计数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">+1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">+</span><span class=\"mord\">1</span></span></span></span>，业务调用失败，计数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">−</span><span class=\"mord\">1</span></span></span></span></li>\n<li>遇到异常即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>+</mo></mrow><annotation encoding=\"application/x-tex\">+</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord\">+</span></span></span></span> 操作超过上限，视为使用达到</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/counter2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> Tips 16</h3>\n<p><code>Redis</code>应用于限时按次结算的服务控制。</p>\n<h2> 微信会话</h2>\n<h3> 业务场景</h3>\n<p>使用微信的过程中，当微信接收消息后，会默认将最近接收的消息置顶，当多个好友及关注的订阅号同时发送消息时，该排序会不停的进行交替。同时还可以将重要的会话设置为置顶。一旦用户离线后，再次打开微信时，消息该按照什么样的顺序显示？</p>\n<h3> 业务分析</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/session-top.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 解决方案</h3>\n<ul>\n<li>依赖<code>list</code>的数据具有顺序的特征对消息进行管理，将<code>list</code>结构作为栈使用</li>\n<li>对指定与普通会话分别创建独立的<code>list</code>分别管理</li>\n<li>当某个<code>list</code>中接收到用户消息后，将消息发送方的<code>id</code>从<code>list</code>的一侧加入<code>list</code>（此处设定左侧）</li>\n<li>多个相同<code>id</code>发出的消息反复入栈会出现问题，在入栈之前无论是否具有当前<code>id</code>对应得消息，先删除对应<code>id</code></li>\n<li>推送消息时先推送顶置会话<code>list</code>，再推送普通会话<code>list</code>，推送完成的<code>list</code>清除所有数据</li>\n<li>消息的数量，也就是微信用户对话数量采用计数器的思想另行记录，伴随<code>list</code>操作同步更新</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> 解决方案列表</h1>\n<ul>\n<li><code>Tips 1</code>：<code>Redis</code>用于控制数据库表主键<code>id</code>，为数据库表主键提供生成策略，保障数据库表的主键唯一性</li>\n<li><code>Tips 2</code>：<code>Redis</code>控制数据的生命周期，通过数据是否失效控制业务行为，适用于所有具有时效性限定控制的操作</li>\n<li><code>Tips 3</code>：<code>Redis</code>应用于各种结构型和非结构型高热度数据访问加速</li>\n<li><code>Tips 4</code>：<code>Redis</code>应用于购物车数据存储设计</li>\n<li><code>Tips 5</code>：<code>Redis</code>应用于抢购，限购类、限量发放优惠卷、激活码等业务的数据存储设计</li>\n<li><code>Tips 6</code>：<code>Redis</code>应用于具有操作先后顺序的数据控制</li>\n<li><code>Tips 7</code>：<code>Redis</code>应用于最新消息展示</li>\n<li><code>Tips 8</code>：<code>Redis</code>应用于随机推荐类信息检索，例如热点歌单推荐，热点新闻推荐，热卖旅游线路，应用<code>APP</code>推荐，大V推荐等</li>\n<li><code>Tips 9</code>：<code>Redis</code>应用于同类信息的关联搜索，二度关联搜索，深度关联搜索</li>\n<li><code>Tips 10</code>：<code>Redis</code>应用于同类型不重复数据的合并、取交集操作</li>\n<li><code>Tips 11</code>：<code>Redis</code>应用于同类型数据的快速去重</li>\n<li><code>Tips 12</code>：<code>Redis</code>应用于基于黑名单与白名单设定的服务控制</li>\n<li><code>Tips 13</code>：<code>Redis</code>应用于计数器组合排序功能对应的排名</li>\n<li><code>Tips 14</code>：<code>Redis</code>应用于定时任务执行顺序管理或任务过期管理</li>\n<li><code>Tips 15</code>：<code>Redis</code>应用于及时任务/消息队列执行管理</li>\n<li><code>Tips 16</code>：<code>Redis</code>应用于按次结算的服务控制</li>\n<li><code>Tips 17</code>：<code>Redis</code>应用于基于时间顺序的数据操作，而不关注</li>\n</ul>\n<h1> 高级数据类型</h1>\n<h2> Bitmaps</h2>\n<p>并不是一个全新的数据类型，而是<code>String</code>中二进制位的操作<code>API</code>。</p>\n<h3> Bitmaps 类型的基础操作</h3>\n<ul>\n<li>\n<p>获取指定<code>key</code>对应偏移量上的<code>bit</code>值</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>设置指定<code>key</code>对应偏移量上的<code>bit</code>值，<code>value</code>只能是 1 或 0</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> Bitmaps 类型的扩展操作</h3>\n<h4> 业务场景</h4>\n<p>电影网站：</p>\n<ul>\n<li>统计每天某一部电影是否被点播</li>\n<li>统计每天有多少部电影被点播</li>\n<li>统计每周/月/年有多少部电影被点播</li>\n<li>统计年度哪部电影没有被点播</li>\n</ul>\n<h4> 业务分析</h4>\n<ul>\n<li>统计每天某一部电影是否被点播：如果某部电影被观看，就将二进制位设为 1，保存的<code>key</code>为当天的日期</li>\n<li>统计每天有多少部电影被点播：统计有多少个二进制位值为 1</li>\n<li>统计每周/月/年有多少部电影被点播：将每天保存的数据进行或操作，然后统计有多少个二进制位值为 1</li>\n<li>统计年度哪部电影没有被点播：将每天保存的数据进行或操作，然后统计有多少个二进制位值为 0</li>\n</ul>\n<h4> 扩展操作</h4>\n<ul>\n<li>\n<p>对指定<code>key</code>按位进行交、并、非、异或操作，并将结果保存到<code>destKey</code>中</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ul>\n<li><code>and</code>：交</li>\n<li><code>or</code>：并</li>\n<li><code>not</code>：非</li>\n<li><code>xor</code>：异或</li>\n</ul>\n</li>\n<li>\n<p>统计指定<code>key</code>中 1 的数量</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h4> Tips 18</h4>\n<p><code>Redis</code>应用于信息状态统计。</p>\n<h2> HyperLogLog</h2>\n<h3> 统计独立UV</h3>\n<ul>\n<li>\n<p>原始方案：<code>set</code></p>\n<ul>\n<li>存储每个用户的<code>id</code>（字符串）</li>\n</ul>\n</li>\n<li>\n<p>改进方案：<code>Bitmaps</code></p>\n<ul>\n<li>存储每个用户状态（<code>bit</code>）</li>\n</ul>\n</li>\n<li>\n<p>全新的方案：<code>Hyperloglog</code></p>\n</li>\n</ul>\n<h3> 基数</h3>\n<p>基数是数据集去重后元素个数，<code>HyperLogLog</code>是用来做基数统计的，运用了<code>LogLog</code>的算法。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/base-quota.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> HyperLogLog 类型的基本操作</h3>\n<ul>\n<li>\n<p>添加数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>统计数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>合并数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> Tips 19</h3>\n<p>**<code>redis</code>**<strong>应用于独立信息统计</strong></p>\n<h3> 相关说明</h3>\n<ul>\n<li>用于进行基数统计，不是集合，不保存数据，只记录数量而不是具体数据</li>\n<li>核心是基数估算算法，最终数值存在一定误差</li>\n<li>误差范围：基数估计的结果是一个带有 0.81% 标准错误的近似值</li>\n<li>耗空间极小，每个<code>hyperloglog key</code>占用了 12K 的内存用于标记基数</li>\n<li><code>pfadd</code>命令不是一次性分配 12K 内存使用，会随着基数的增加内存逐渐增大</li>\n<li><code>Pfmerge</code>命令合并后占用的存储空间为 12K，无论合并之前数据量多少</li>\n</ul>\n<h2> GEO</h2>\n<h3> GEO 类型的基本操作</h3>\n<ul>\n<li>\n<p>添加坐标点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取坐标点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>计算坐标点距离</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>添加坐标点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>获取坐标点</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>计算经纬度</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> Tips 20</h3>\n<p><code>Redis</code>应用于地理位置计算。</p>\n<p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/redis-data-type/redis-storage1.png",
      "date_published": "2023-09-15T00:00:00.000Z",
      "date_modified": "2023-09-24T03:08:04.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Redis 持久化",
      "url": "https://1coins.github.io/article/redis/redis-persistence.html",
      "id": "https://1coins.github.io/article/redis/redis-persistence.html",
      "summary": "简介 什么是持久化？ 利用永久性存储介质将数据进行保存，在特定的时间将保存的数据进行恢复的工作机制称为持久化。 为什么要进行持久化？ 防止数据的意外丢失，确保数据安全性 持久化过程保存什么？ RDB：将当前数据状态进行保存，快照形式，存储数据结果，存储格式简单，关注点在数据 AOF：将数据的操作过程进行保存，日志形式，存储操作过程，存储格式复杂，关注点在数据的操作过程",
      "content_html": "<h1> 简介</h1>\n<ul>\n<li>\n<p>什么是持久化？</p>\n<ul>\n<li>利用永久性存储介质将数据进行保存，在特定的时间将保存的数据进行恢复的工作机制称为持久化。</li>\n</ul>\n</li>\n<li>\n<p>为什么要进行持久化？</p>\n<ul>\n<li>防止数据的意外丢失，确保数据安全性</li>\n</ul>\n</li>\n<li>\n<p>持久化过程保存什么？</p>\n<ul>\n<li><code>RDB</code>：将当前数据状态进行保存，快照形式，存储数据结果，存储格式简单，关注点在数据</li>\n<li><code>AOF</code>：将数据的操作过程进行保存，日志形式，存储操作过程，存储格式复杂，关注点在数据的操作过程</li>\n</ul>\n</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/rdb-and-aof.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> RDB</h1>\n<h2> 启动方式</h2>\n<p>保存数据即是做一件事，也就是：谁，什么时间，干什么事情。</p>\n<h3> 命令执行</h3>\n<ul>\n<li>谁：<code>Redis</code>操作者（用户）</li>\n<li>什么时间：即时（随时进行）</li>\n<li>干什么事情：保存数据</li>\n</ul>\n<h4> save 指令</h4>\n<ul>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>作用</p>\n<ul>\n<li>手动执行一次保存操作</li>\n<li>数据默认保存在根目录下的<code>dump.rdb</code></li>\n</ul>\n</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> save 指令相关配置</h4>\n<p>配置文件即为<code>redis-6379.conf</code>。</p>\n<ul>\n<li>\n<p><code>dbfilename dump.rdb</code></p>\n<ul>\n<li>说明：设置本地数据库文件名，默认值为<code>dump.rdb</code></li>\n<li>经验：通常设置为<code>dump-端口号.rdb</code></li>\n</ul>\n</li>\n<li>\n<p><code>dir</code></p>\n<ul>\n<li>说明：设置存储<code>.rdb</code>文件的路径</li>\n<li>经验：通常设置成存储空间较大的目录中，目录名称<code>data</code></li>\n</ul>\n</li>\n<li>\n<p><code>rdbcompression yes</code></p>\n<ul>\n<li>说明：设置存储至本地数据库时是否压缩数据，默认为<code>yes</code>，采用<code>LZF</code>压缩</li>\n<li>经验：通常默认为开启状态，如果设置为<code>no</code>，可以节省<code>CPU</code>运行时间，但会使存储的文件变大（巨大）</li>\n</ul>\n</li>\n<li>\n<p><code>rdbchecksum yes</code></p>\n<ul>\n<li>说明：设置是否进行<code>RDB</code>文件格式校验，该校验过程在写文件和读文件过程均进行</li>\n<li>经验：通常默认为开启状态，如果设置为<code>no</code>，可以节约读写性过程约 10% 时间消耗，但是存储一定的数据损坏风险</li>\n</ul>\n</li>\n</ul>\n<h4> 数据恢复</h4>\n<p>使用<code>save</code>命令保存后，如果突然断电，会在重启时加载<code>.rdb</code>文件恢复数据。</p>\n<h4> save 指令工作原理</h4>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/save-operate-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>注意：<code>save</code>指令的执行会阻塞当前<code>Redis</code>服务器，直到当前<code>RDB</code>过程完成为止，有可能会造成长时间阻塞，线上环境不建议使用。</p>\n<h3> 后台执行</h3>\n<p>场景：数据量过大，单线程执行方式造成效率过低</p>\n<ul>\n<li>谁：<code>Redis</code>操作者（用户）发起指令；<code>Redis</code>服务器控制指令执行</li>\n<li>什么时间：即时（发起）；合理的时间（执行）</li>\n<li>干什么事情：保存</li>\n</ul>\n<h4> bgsave 指令</h4>\n<ul>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>作用</p>\n<ul>\n<li>手动启动后台保存操作，但不是立即执行</li>\n</ul>\n</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> bgsave 指令相关配置</h4>\n<ul>\n<li>\n<p><code>dbfilename dump.rdb</code></p>\n</li>\n<li>\n<p><code>dir</code></p>\n</li>\n<li>\n<p><code>rdbcompression yes</code></p>\n</li>\n<li>\n<p><code>rdbchecksum yes</code></p>\n</li>\n<li>\n<p><code>stop-writes-on-bgsave-error yes</code></p>\n<ul>\n<li>说明：后台存储过程中如果出现错误现象，是否停止保存操作</li>\n<li>经验：通常默认为开启状态</li>\n</ul>\n</li>\n</ul>\n<h4> bgsave 指令工作原理</h4>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/bgsave-operate-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>注意： <code>bgsave</code>命令是针对<code>save</code>阻塞问题做的优化；<code>Redis</code>内部所有涉及到<code>RDB</code>操作都采用<code>bgsave</code>的方式，<code>save</code>命令可以放弃使用。</p>\n<h3> 自动执行</h3>\n<p>场景：反复执行保存指令，忘记了怎么办？不知道数据产生了多少变化，何时保存？</p>\n<ul>\n<li>谁：<code>Redis</code>服务器发起指令（基于条件）</li>\n<li>什么时间：满足条件</li>\n<li>干什么事情：保存数据</li>\n</ul>\n<h4> save 配置</h4>\n<ul>\n<li>\n<p>配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>作用</p>\n<ul>\n<li>满足限定时间范围内<code>key</code>的变化数量达到指定数量即进行持久化</li>\n</ul>\n</li>\n<li>\n<p>参数</p>\n<ul>\n<li><code>second</code>：监控时间范围</li>\n<li><code>changes</code>：监控<code>key</code>的变化量</li>\n</ul>\n</li>\n<li>\n<p>位置</p>\n<ul>\n<li>在<code>conf</code>文件中进行配置</li>\n</ul>\n</li>\n<li>\n<p>范例</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h4> save 配置原理</h4>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/save-config-operate-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>注意：</p>\n<ul>\n<li><code>save</code>配置要根据实际业务情况进行设置，频度过高或过低都会出现性能问题，结果可能是灾难性的</li>\n<li><code>save</code>配置中对于<code>second</code>与<code>changes</code>设置通常具有互补对应关系，尽量不要设置成包含性关系</li>\n<li><code>save</code>配置启动后执行的是<code>bgsave</code>操作</li>\n</ul>\n<h3> 三种启动方式对比</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">方式</th>\n<th style=\"text-align:center\"><code>save</code>指令</th>\n<th style=\"text-align:center\"><code>bgsave</code>指令</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">读写</td>\n<td style=\"text-align:center\">同步</td>\n<td style=\"text-align:center\">异步</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">阻塞客户端指令</td>\n<td style=\"text-align:center\">是</td>\n<td style=\"text-align:center\">否</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">额外内存消耗</td>\n<td style=\"text-align:center\">否</td>\n<td style=\"text-align:center\">是</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">启动新进程</td>\n<td style=\"text-align:center\">否</td>\n<td style=\"text-align:center\">是</td>\n</tr>\n</tbody>\n</table>\n<h2> 特殊启动方式</h2>\n<ul>\n<li>\n<p>全量复制</p>\n<ul>\n<li>把一个<code>Redis</code>服务器中的数据复制给别人，要先存储才能复制，而且存储的是全数据，因此<code>RDB</code>是解决方案</li>\n<li>在主从复制中详细讲解</li>\n</ul>\n</li>\n<li>\n<p>服务器运行过程中重启</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>关闭服务器时指定保存数据</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>注意：默认情况下执行<code>shutdown</code>命令时，自动执行<code>bgsave</code>（如果没有开启<code>AOF</code>持久化功能）</p>\n<h3> RDB 优点</h3>\n<ul>\n<li><code>RDB</code>是一个紧凑压缩的二进制文件，存储效率较高</li>\n<li><code>RDB</code>内部存储的是<code>Redis</code>在某个时间点的数据快照，非常适合用于数据备份，全量复制等场景</li>\n<li><code>RDB</code>恢复数据的速度要比<code>AOF</code>快很多</li>\n<li>应用：服务器中每<code>X</code>小时执行<code>bgsave</code>备份，并将<code>RDB</code>文件拷贝到远程机器中，用于灾难恢复</li>\n</ul>\n<h3> RDB 缺点</h3>\n<ul>\n<li><code>RDB</code>方式无论是执行指令还是利用配置，无法做到实时持久化，具有较大的可能性丢失数据</li>\n<li><code>bgsave</code>指令每次运行要执行<code>fork</code>操作创建子进程，要牺牲掉一些性能</li>\n<li><code>Redis</code>的众多版本中未进行<code>RDB</code>文件格式的版本统一，有可能出现各版本服务之间数据格式无法兼容现象</li>\n</ul>\n<h1> AOF</h1>\n<h2> RDB 存储的弊端</h2>\n<ul>\n<li>\n<p>存储数据量较大，效率较低</p>\n<ul>\n<li>基于快照思想，每次读写都是全部数据，当数据量巨大时，效率非常低</li>\n</ul>\n</li>\n<li>\n<p>大数据量下的<code>IO</code>性能较低</p>\n</li>\n<li>\n<p>基于<code>fork</code>创建子进程，内存产生额外消耗</p>\n</li>\n<li>\n<p>宕机带来的数据丢失风险</p>\n</li>\n</ul>\n<h3> 解决思路</h3>\n<ul>\n<li>不写全数据，仅记录部分数据</li>\n<li>降低区分数据是否改变的难度，改记录数据为记录操作过程</li>\n<li>对所有操作均进行记录，排除丢失数据的风险</li>\n</ul>\n<h2> AOF 概念</h2>\n<ul>\n<li><code>AOF</code>（<code>append only file</code>）持久化：以独立日志的方式记录每次写命令，重启时再重新执行<code>AOF</code>文件中命令达到恢复数据的目的。与<code>RDB</code>相比可以简单描述为<strong>改记录数据为记录数据产生的过程</strong></li>\n<li><code>AOF</code>的主要作用是解决了数据持久化的实时性，目前已经是<code>Redis</code>持久化的主流方式</li>\n</ul>\n<h2> AOF 写数据过程</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/aof-rite-data-process.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>注意：将命令同步到<code>AOF</code>文件中时，需要明确一次写多少条数据、多久写一次数据等问题。</p>\n<h2> AOF 写数据三种策略（appendfsync）</h2>\n<ul>\n<li>\n<p><code>always</code>（每次）</p>\n<ul>\n<li>每次写入操作均同步到AOF文件中，<strong>数据零误差，性能较低</strong>，不建议使用</li>\n</ul>\n</li>\n<li>\n<p><code>everysec</code>（每秒）</p>\n<ul>\n<li>每秒将缓冲区中的指令同步到<code>AOF</code>文件中，<strong>数据准确性较高，性能较高</strong>，但在系统突然宕机的情况下丢失 1 秒内的数据，建议使用，也是默认配置</li>\n</ul>\n</li>\n<li>\n<p><code>no</code>（系统控制）</p>\n<ul>\n<li>由操作系统控制每次同步到<code>AOF</code>文件的周期，整体过程<strong>不可控</strong></li>\n</ul>\n</li>\n</ul>\n<h2> AOF 功能开启</h2>\n<ul>\n<li>\n<p>配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>作用</p>\n<ul>\n<li>是否开启AOF持久化功能，默认为不开启状态</li>\n</ul>\n</li>\n<li>\n<p>配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>作用</p>\n<ul>\n<li><code>AOF</code>写数据策略</li>\n</ul>\n</li>\n</ul>\n<h2> AOF 相关配置</h2>\n<ul>\n<li>\n<p>配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>作用</p>\n<ul>\n<li><code>AOF</code>持久化文件名，默认文件名为<code>appendonly.aof</code>，建议配置为<code>appendonly-端口号.aof</code></li>\n</ul>\n</li>\n<li>\n<p>配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>作用</p>\n<ul>\n<li>AOF持久化文件保存路径，与<code>RDB</code>持久化文件保持一致即可</li>\n</ul>\n</li>\n</ul>\n<h2> AOF 重写</h2>\n<p>随着命令不断写入<code>AOF</code>，文件会越来越大，为了解决这个问题，<code>Redis</code>引入了<code>AOF</code>重写机制压缩文件体积。<code>AOF</code>文件重写是将<code>Redis</code>进程内的数据转化为写命令同步到新<code>AOF</code>文件的过程。简单说就是<strong>将对同一个数据的若干个条命令执行结果转化成最终结果数据对应的指令进行记录</strong>。</p>\n<h3> AOF 重写作用</h3>\n<ul>\n<li>降低磁盘占用量，提高磁盘利用率</li>\n<li>提高持久化效率，降低持久化写时间，提高IO性能</li>\n<li>降低数据恢复用时，提高数据恢复效率</li>\n</ul>\n<h3> AOF 重写规则</h3>\n<ul>\n<li>进程内已超时的数据不再写入文件</li>\n<li>忽略无效指令，重写时使用进程内数据直接生成，这样新的<code>AOF</code>文件只保留最终数据的写入命令<br>\n如：<code>del key1</code>、 <code>hdel key2</code>、<code>srem key3</code>、<code>set key4 111</code>、<code>set key4 222</code>等</li>\n<li>对同一数据的多条写命令合并为一条命令。如：<code>lpush list1 a</code>、<code>lpush list1 b</code>、 <code>lpush list1 c</code>可以转化为：<code>lpush list1 a b c</code>。为防止数据量过大造成客户端缓冲区溢出，对<code>list</code>、<code>set</code>、<code>hash</code>、<code>zset</code>等类型，每条指令最多写入 64 个元素</li>\n</ul>\n<h3> AOF 重写方式</h3>\n<h4> 手动重写</h4>\n<ul>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h5> bgrewriteaof 指令工作原理</h5>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/bgrewriteaof-operate-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h4> 自动重写</h4>\n<ul>\n<li>\n<p>配置</p>\n<ul>\n<li>\n<p>自动重写触发条件设置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>自动重写触发比对参数（ 运行指令<code>info Persistence</code>获取具体信息 ）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>自动重写触发条件</p>\n<p class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.25em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>a</mi><mi>o</mi><mi>f</mi><mi mathvariant=\"normal\">_</mi><mi>c</mi><mi>u</mi><mi>r</mi><mi>r</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi mathvariant=\"normal\">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>&gt;</mo><mi>a</mi><mi>u</mi><mi>t</mi><mi>o</mi><mo>−</mo><mi>a</mi><mi>o</mi><mi>f</mi><mo>−</mo><mi>r</mi><mi>e</mi><mi>w</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo>−</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo>−</mo><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mfrac><mrow><mo stretchy=\"false\">(</mo><mi>a</mi><mi>o</mi><mi>f</mi><mi mathvariant=\"normal\">_</mi><mi>c</mi><mi>u</mi><mi>r</mi><mi>r</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi mathvariant=\"normal\">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>−</mo><mi>a</mi><mi>o</mi><mi>f</mi><mi mathvariant=\"normal\">_</mi><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi mathvariant=\"normal\">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mi>a</mi><mi>o</mi><mi>f</mi><mi mathvariant=\"normal\">_</mi><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi mathvariant=\"normal\">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>≥</mo><mi>a</mi><mi>u</mi><mi>t</mi><mi>o</mi><mo>−</mo><mi>a</mi><mi>o</mi><mi>f</mi><mo>−</mo><mi>r</mi><mi>e</mi><mi>w</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>e</mi><mo>−</mo><mi>p</mi><mi>e</mi><mi>r</mi><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>c</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>a</mi><mi>g</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\n\\begin{aligned}\naof\\_current\\_size &amp;&gt; auto-aof-rewrite-min-size size \\\\\n\\frac {(aof\\_current\\_size - aof\\_base\\_size)} {aof\\_base\\_size} &amp;\\ge auto-aof-rewrite-percentage percentage\n\\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:4.246em;vertical-align:-1.873em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.373em;\"><span style=\"top:-4.983em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">rre</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span></span></span><span style=\"top:-2.873em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.45em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">ba</span><span class=\"mord mathnormal\">se</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.7em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">rre</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">ba</span><span class=\"mord mathnormal\">se</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.996em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.873em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.373em;\"><span style=\"top:-4.983em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">re</span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">min</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">zes</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span></span></span><span style=\"top:-2.873em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≥</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">re</span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">erce</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">erce</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">e</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.873em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n</li>\n</ul>\n</li>\n</ul>\n<h3> AOF 重写流程</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/aof-rewrite-process1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/aof-rewrite-process2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>AOF</code>缓冲区同步文件策略，由参数<code>appendfsync</code>控制。</p>\n<p>系统调用<code>write</code>和<code>fsync</code>说明：</p>\n<ul>\n<li><code>write</code>操作会触发延迟写（<code>delayed write</code>）机制，<code>Linux</code>在内核提供页缓冲区用来提高硬盘<code>IO</code>性能；<code>write</code>操作在写入系统缓冲区后直接返回，同步硬盘操作依赖于系统调度机制，列如：缓冲区页空间写满或达到特定时间周期；同步文件之前，如果此时系统故障宕机，缓冲区内数据将丢失</li>\n<li><code>fsync</code>针对单个文件操作（比如<code>AOF</code>文件），做强制硬盘同步，<code>fsync</code>将阻塞直到写入硬盘完成后返回，保证了数据持久化</li>\n</ul>\n<p>除了<code>write</code>、<code>fsync</code>、<code>Linux</code>还提供了<code>sync</code>、<code>fdatasync</code>操作。</p>\n<h1> RDB 与 AOF 区别</h1>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">持久化方式</th>\n<th style=\"text-align:center\"><code>RDB</code></th>\n<th style=\"text-align:center\"><code>AOF</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">占用存储空间</td>\n<td style=\"text-align:center\">小（数据级：压缩）</td>\n<td style=\"text-align:center\">大（指令级：重写）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">存储速度</td>\n<td style=\"text-align:center\">慢</td>\n<td style=\"text-align:center\">快</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">恢复速度</td>\n<td style=\"text-align:center\">快</td>\n<td style=\"text-align:center\">慢</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">数据安全性</td>\n<td style=\"text-align:center\">会丢失数据</td>\n<td style=\"text-align:center\">依据策略决定</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">资源消耗</td>\n<td style=\"text-align:center\">高/重量级</td>\n<td style=\"text-align:center\">低/轻量级</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">启动优先级</td>\n<td style=\"text-align:center\">低</td>\n<td style=\"text-align:center\">高</td>\n</tr>\n</tbody>\n</table>\n<h2> RDB 与 AOF 的选择</h2>\n<ul>\n<li>\n<p>对数据非常敏感，建议使用默认的<code>AOF</code>持久化方案</p>\n<ul>\n<li><code>AOF</code>持久化策略使用<code>everysecond</code>，每秒钟<code>fsync</code>一次。该策略<code>redis</code>仍可以保持很好的处理性能，当出现问题时，最多丢失 0-1 秒内的数据。</li>\n<li>注意：由于<code>AOF</code>文件存储体积较大，且恢复速度较慢</li>\n</ul>\n</li>\n<li>\n<p>数据呈现阶段有效性，建议使用<code>RDB</code>持久化方案</p>\n<ul>\n<li>数据可以良好的做到阶段内无丢失（该阶段是开发者或运维人员手工维护的），且恢复速度较快，阶段点数据恢复通常采用<code>RDB</code>方案</li>\n<li>注意：利用<code>RDB</code>实现紧凑的数据持久化会使<code>Redis</code>降的很低，慎重</li>\n</ul>\n</li>\n<li>\n<p>综合比对</p>\n<ul>\n<li><code>RDB</code>与<code>AOF</code>的选择实际上是在做一种权衡，每种都有利有弊</li>\n<li>如不能承受数分钟以内的数据丢失，对业务数据非常敏感，选用<code>AOF</code></li>\n<li>如能承受数分钟以内的数据丢失，且追求大数据集的恢复速度，选用<code>RDB</code></li>\n<li>灾难恢复选用<code>RDB</code></li>\n<li>双保险策略，同时开启<code>RDB</code>和<code>AOF</code>，重启后，<code>Redis</code>优先使用<code>AOF</code>来恢复数据，降低丢失数据的量</li>\n</ul>\n</li>\n</ul>\n<h1> 持久化应用场景</h1>\n<ul>\n<li><s><code>Tips 1</code></s><s>：</s>~~<code>redis</code>~~<s>用于控制数据库表主键id，为数据库表主键提供生成策略，保障数据库表的主键唯一性</s></li>\n<li><s><code>Tips 3</code></s><s>：</s>~~<code>redis</code>~~<s>应用于各种结构型和非结构型高热度数据访问加速</s></li>\n<li><s><code>Tips 4</code></s><s>：</s>~~<code>redis</code>~~<s>应用于购物车数据存储设计</s></li>\n<li><code>Tips 5</code>：<code>redis</code>应用于抢购，限购类、限量发放优惠卷、激活码等业务的数据存储设计</li>\n<li><code>Tips 6</code>：<code>redis</code>应用于具有操作先后顺序的数据控制</li>\n<li><code>Tips 7</code>：<code>redis</code>应用于最新消息展示</li>\n<li><s><code>Tips 9</code></s><s>：</s>~~<code>redis</code>~~<s>应用于同类信息的关联搜索，二度关联搜索，深度关联搜索</s></li>\n<li><code>Tips 12</code>：<code>redis</code>应用于基于黑名单与白名单设定的服务控制</li>\n<li><code>Tips 13</code>：<code>redis</code>应用于计数器组合排序功能对应的排名</li>\n<li><code>Tips 15</code>：<code>redis</code>应用于即时任务/消息队列执行管理</li>\n<li><code>Tips 16</code>：<code>redis</code>应用于按次结算的服务控制</li>\n</ul>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/redis-persistence/rdb-and-aof.png",
      "date_published": "2023-09-24T00:00:00.000Z",
      "date_modified": "2023-09-24T03:08:04.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Redis 基础",
      "url": "https://1coins.github.io/article/redis/redis-base.html",
      "id": "https://1coins.github.io/article/redis/redis-base.html",
      "summary": "问题的抛出 出现的问题： 海量用户 高并发 罪魁祸首——关系型数据库： 性能瓶颈：磁盘IO性能低下 扩展瓶颈：数据关系复杂，扩展性差，不便于大规模集群 解决思路： 降低磁盘IO次数，越低越好： 内存存储 去除数据间的关系，越简单越好： 不存储关系，只存储数据 NoSql简介",
      "content_html": "<h1> 问题的抛出</h1>\n<p><strong>出现的问题：</strong></p>\n<ul>\n<li>海量用户</li>\n<li>高并发</li>\n</ul>\n<p><strong>罪魁祸首——关系型数据库：</strong></p>\n<ul>\n<li>性能瓶颈：磁盘IO性能低下</li>\n<li>扩展瓶颈：数据关系复杂，扩展性差，不便于大规模集群</li>\n</ul>\n<p><strong>解决思路：</strong></p>\n<ul>\n<li>降低磁盘IO次数，越低越好： 内存存储</li>\n<li>去除数据间的关系，越简单越好： 不存储关系，只存储数据</li>\n</ul>\n<h1> NoSql简介</h1>\n<p><code>NoSql</code>，即<code>Not-OnlySQL</code>（泛指非关系型的数据库），作为关系型数据库的补充，应用对于海量用户和海量数据前提吓得数据处理问题。</p>\n<p><strong>特征：</strong></p>\n<ul>\n<li>可扩容，可伸缩</li>\n<li>大数据量下得高性能</li>\n<li>灵活得数据模型</li>\n<li>高可用</li>\n</ul>\n<p><strong>常见</strong><code>NoSql</code><strong>数据库：</strong></p>\n<ul>\n<li>Redis</li>\n<li>MemCache</li>\n<li>HBase</li>\n<li>MongoDB</li>\n</ul>\n<h1> 解决方案</h1>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-base/redis-scene.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> Redis 简介</h1>\n<p>概念：<code>Redis(REmote DIctinary Server)</code>是用<code>C</code>语言开发的一个开源的高性能键值对（<code>key-value</code>）数据库。</p>\n<p>特征：</p>\n<ol>\n<li>数据间没有必然的关联关系</li>\n<li>内部采用单线程机制进行工作</li>\n<li>高性能；官方提供测试数据，50 个并发执行 100000 个请求，读的速度是 110000 次/s，写的速度是 81000 次/s</li>\n<li>多数据类型支持：<code>string</code>（字符串类型）、<code>list</code>（列表类型）、<code>hash</code>（散列类型）、<code>set</code>（集合类型）、<code>sorted_set</code>（有序集合类型）</li>\n<li>持久化支持，可以进行数据灾难恢复</li>\n</ol>\n<h1> Redis 应用</h1>\n<ul>\n<li>为热点数据加速查询（主要场景）、如热点商品、热点新闻、热点资讯、推广类等提高访问量信息等</li>\n<li>任务队列、如秒杀、抢购、购票等</li>\n<li>即时信息查询，如各位排行榜、各类网站访问统计、公交到站信息、在线人数信息（聊天室、网站）、设备信号等</li>\n<li>时效性信息控制，如验证码控制，投票控制等</li>\n<li>分布式数据共享，如分布式集群构架中的session分离</li>\n<li>消息队列</li>\n<li>分布式锁</li>\n</ul>\n<h1> Redis 基本操作</h1>\n<p>命令行模式工具使用：</p>\n<ul>\n<li>功能性命令</li>\n<li>清除屏幕信息</li>\n<li>帮助信息查阅</li>\n<li>退出指令</li>\n</ul>\n<h2> 信息添加</h2>\n<ul>\n<li>\n<p>功能：设置<code>key-value</code>数据</p>\n</li>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>范例</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 信息查询</h2>\n<ul>\n<li>\n<p>功能：根据<code>key</code>查询对应的<code>value</code>，如果不存在，返回空（<code>null</code>)</p>\n</li>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>范例</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>功能：清除屏幕中的信息</p>\n</li>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 帮助命令</h2>\n<ul>\n<li>\n<p>功能：获取命令帮助文档，获取组中所有命令信息名称</p>\n</li>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/redis-base/redis-command-help.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 退出客户端命令行模式</h2>\n<ul>\n<li>\n<p>功能：推出客户端</p>\n</li>\n<li>\n<p>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h1> Redis 部署</h1>\n<h2> 安装</h2>\n<h3> 从源代码（建议）</h3>\n<p>使用以下命令下载，提取和编译<code>Redis</code>：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 来自官方的 Ubuntu PPA</h3>\n<p>可以从<code>redislabs/redis</code>软件包存储库中安装<code>Redis</code>的最新稳定版本。将存储库添加到<code>apt</code>索引，对其进行更新并安装：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 启动服务</h2>\n<h3> 服务端</h3>\n<ul>\n<li>\n<p>直接启动</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>指定端口</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 客户端</h3>\n<ul>\n<li>\n<p>直接启动</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>指定端口</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 指定配置文件启动服务</h2>\n<h3> 生成配置文件</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 编辑 Redis 服务配置文件</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 启动 Redis 服务进程并指定配置文件</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 生成配置文件</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 编辑 redis 服务配置文件</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 启动 redis 服务进程并指定配置文件</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 安装Docker版</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li><code>$pwd</code>：代表当前目录</li>\n<li><code>-privileged=true</code>：容器内的<code>root</code>拥有真正<code>root</code>权限，否则容器内<code>root</code>只是外部普通用户权限</li>\n<li><code>-v</code>：指定数据卷绑定</li>\n<li><code>redis-server /usr/local/etc/redis/redis.conf</code>：指定配置文件启动<code>redis-server</code>进程</li>\n<li><code>-appendonly yes</code>：开启数据持久化</li>\n</ul>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>注意：不要配置<code>daemonize yes</code>，否则无法启动容器，启动后会立即停止。</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/redis-base/redis-scene.png",
      "date_published": "2023-09-10T00:00:00.000Z",
      "date_modified": "2023-09-24T03:08:04.000Z",
      "authors": [],
      "tags": [
        "Redis"
      ]
    },
    {
      "title": "Git 总结",
      "url": "https://1coins.github.io/article/git/git-summary.html",
      "id": "https://1coins.github.io/article/git/git-summary.html",
      "summary": "版本控制简介 版本控制 工程设计领域中使用版本控制管理工程蓝图的设计过程。在IT开发过程中也可以使用版本控制思想管理代码的版本迭代。 版本控制工具 集中式版本控制工具：CVS、SVN、VSS... 分布式版本控制工具：Git、Mercurial、Bazaar、Darcs…",
      "content_html": "<h1> 版本控制简介</h1>\n<h2> 版本控制</h2>\n<p>工程设计领域中使用版本控制管理工程蓝图的设计过程。在<code>IT</code>开发过程中也可以使用版本控制思想管理代码的版本迭代。</p>\n<h2> 版本控制工具</h2>\n<ul>\n<li>集中式版本控制工具：<code>CVS</code>、<code>SVN</code>、<code>VSS</code>...</li>\n<li>分布式版本控制工具：<code>Git</code>、<code>Mercurial</code>、<code>Bazaar</code>、<code>Darcs</code>…</li>\n</ul>\n<h2> 版本控制工具应该具备的功能</h2>\n<ul>\n<li>\n<p>协同修改</p>\n<p>多人并行不悖的修改服务器端的同一个文件。</p>\n</li>\n<li>\n<p>数据备份</p>\n<p>不仅保存目录和文件的当前状态，还能够保存每一个提交过的历史状态。</p>\n</li>\n<li>\n<p>版本管理</p>\n<p>在保存每一个版本的文件信息的时候要做到不保存重复数据，以节约存储空间，提高运行效率；这方面<code>SVN</code>采用的是增量式管理的方式，而<code>Git</code>采取了文件系统快照的方式。</p>\n</li>\n<li>\n<p>权限控制</p>\n<p>对团队中参与开发的人员进行权限控制；对团队外开发者贡献的代码进行审核（<code>Git</code>独有）。</p>\n</li>\n<li>\n<p>历史记录</p>\n<p>查看修改人、修改时间、修改内容、日志信息；将本地文件恢复到某一个历史状态。</p>\n</li>\n<li>\n<p>分支管理</p>\n<p>允许开发团队在工作过程中多条生产线同时推进任务，进一步提高效率。</p>\n</li>\n</ul>\n<h1> Git 简介</h1>\n<p><code>Git</code>是分布式版本控制系统，它没有中央服务器，每个人的电脑就是一个完整的版本库，这样，工作的时候就不需要联网了，因为版本都是在自己的电脑上。</p>\n<p>既然每个人的电脑都有一个完整的版本库，那多个人如何协作呢？比如说自己在电脑上改了文件A，其他人也在电脑上改了文件A，这时，只需把各自的修改推送给对方，就可以互相看到对方的修改了。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/distributed-version-control.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>仓库（版本库）：相当于一个专门用来存放代码的目录，这个目录里面的所有文件都可以<code>Git</code>管理，每个文件的增删改查都能被<code>Git</code>跟踪到。</p>\n<h2> Git 简史</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-history.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> Git 官网</h2>\n<p><a href=\"https://git-scm.com/\" target=\"_blank\" rel=\"noopener noreferrer\">官网地址</a></p>\n<h2> Git 优势</h2>\n<ul>\n<li>大部分操作在本地完成，不需要联网</li>\n<li>完整性保证</li>\n<li>尽可能添加数据而不是删除或修改数据</li>\n<li>分支操作非常快捷流畅</li>\n<li>与<code>Linux</code>命令全面兼容</li>\n</ul>\n<h2> Git 安装</h2>\n<ul>\n<li>安装到非中文没有空格的目录下</li>\n<li>建议用<code>VIM</code>编辑器</li>\n<li>完全不修改<code>path</code>变量，仅在<code>Git Bash</code>中使用<code>Git</code>：<code>Use Git from Git Bash only</code></li>\n<li><code>Use the OpenSSL library</code></li>\n<li>行末换行符转换方式，使用默认值：<code>Checkout Windows-style, commit Unix-style line endings</code></li>\n<li>执行<code>Git</code>命令的默认终端，使用默认值：<code>Use MinTTY</code></li>\n</ul>\n<h2> Git 结构</h2>\n<ul>\n<li><code>Git Repository</code>（<code>Git</code>仓库）：最终确定的文件保存到仓库，成为一个新的版本，并对他人可见</li>\n<li>暂存区：暂存已经修改的文件，最后统一提交到<code>Git</code>仓库中</li>\n<li>工作区（<code>Working Directoory</code>）：添加、编辑、修改文件等动作</li>\n</ul>\n<h2> Git 和代码托管中心</h2>\n<p>代码托管中心的任务：维护远程库</p>\n<ul>\n<li>\n<p>局域网环境下</p>\n<ul>\n<li>GitLab 服务器</li>\n</ul>\n</li>\n<li>\n<p>外网环境下</p>\n<ul>\n<li>GitHub</li>\n<li>码云</li>\n</ul>\n</li>\n</ul>\n<h3> 本地库和远程库</h3>\n<h4> 团队内部协作</h4>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-within-team.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h4> 跨团队协作</h4>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-across-team.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> Git 工作流程</h2>\n<ol>\n<li>从远程仓库中克隆<code>Git</code>资源作为本地仓库</li>\n<li>从本地仓库中<code>checkout</code>代码然后进行代码修改</li>\n<li>在提交前先将代码提交到暂存区</li>\n<li>提交修改。提交到本地仓库。本地仓库中保存修改的各个历史版本</li>\n<li>在修改完成后，需要和团队成员共享代码时，可以将代码<code>push</code>到远程仓库</li>\n</ol>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-common-command-flow.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> Git 操作</h1>\n<h2> 本地库初始化</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>注意：<code>.git</code>目录中存放的是本地库相关的子目录和文件，不要删除，也不要胡乱修改。</p>\n<h2> 设置签名</h2>\n<ul>\n<li>\n<p>形式</p>\n<ul>\n<li>用户名：<code>tom</code></li>\n<li><code>Email</code>地址：<code>goodMorning@atguigu.com</code></li>\n</ul>\n</li>\n<li>\n<p>作用：区分不同开发人员的身份</p>\n</li>\n<li>\n<p>辨析：这里设置的签名和登录远程库（代码托管中心）的账号、密码没有任何关系</p>\n</li>\n<li>\n<p>命令</p>\n<ul>\n<li>\n<p>项目级别/仓库级别：仅在当前本地库范围内有效。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>信息保存位置：<code>./.git/config</code>文件。</p>\n</li>\n<li>\n<p>系统用户级别：登录当前操作系统的用户范围</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>信息保存位置：<code>~/.gitconfig</code>文件。</p>\n</li>\n</ul>\n</li>\n<li>\n<p>级别优先级</p>\n<ul>\n<li>就近原则： 项目级别优先于系统用户级别， 二者都有时采用项目级别的签名</li>\n<li>如果只有系统用户级别的签名，就以系统用户级别的签名为准</li>\n<li>不允许二者都没有</li>\n</ul>\n</li>\n</ul>\n<h2> 状态查看</h2>\n<p>查看工作区、暂存区状态</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h2> 添加</h2>\n<p>将工作区的“新建/修改”添加到暂存区</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 提交</h2>\n<p>将暂存区的内容提交到本地库</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h2> 查看历史记录</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>多屏显示控制方式：</p>\n<ul>\n<li>空格向下翻页</li>\n<li><code>b</code>向上翻页</li>\n<li><code>q</code>退出</li>\n</ul>\n<h2> 前进后退</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li>\n<p>基于索引值操作[<strong>推荐</strong>]</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>使用<code>^</code>符号：只能后退</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>注：一个<code>^</code>表示后退一步，<code>n</code>个表示后退<code>n</code>步</p>\n</li>\n<li>\n<p>使用<code>~</code>符号：只能后退</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>注：表示后退<code>n</code>步</p>\n</li>\n</ul>\n<h3> reset 命令的三个参数对比</h3>\n<ul>\n<li>\n<p><code>--soft</code>参数</p>\n<ul>\n<li>仅仅在本地库移动<code>HEAD</code>指针</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-reset-soft.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n<li>\n<p><code>--mixed</code>参数</p>\n<ul>\n<li>在本地库移动<code>HEAD</code>指针</li>\n<li>重置暂存区</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-reset-mixed.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n<li>\n<p><code>--hard</code>参数</p>\n<ul>\n<li>在本地库移动<code>HEAD</code>指针</li>\n<li>重置暂存区</li>\n<li>重置工作区</li>\n</ul>\n</li>\n</ul>\n<h2> 删除文件并找回</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li>\n<p>前提：删除前，文件存在时的状态提交到了本地库。</p>\n</li>\n<li>\n<p>操作：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ul>\n<li>\n<p>删除操作已经提交到本地库：指针位置指向历史记录</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除操作尚未提交到本地库：指针位置使用<code>HEAD</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n</ul>\n<h2> 比较文件差异</h2>\n<ul>\n<li>\n<p>将工作区中的文件和暂存区进行比较</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>将工作区中的文件和本地库历史记录比较</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>不带文件名比较多个文件</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 分支操作</h2>\n<h3> 什么是分支</h3>\n<p>在版本控制过程中，使用多条线同时推进多个任务。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-branch.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 分支的好处</h3>\n<ul>\n<li>同时并行推进多个功能开发，提高开发效率</li>\n<li>各个分支在开发过程中，如果某一个分支开发失败，不会对其他分支有任何影响，将失败的分支删除重新开始即可</li>\n</ul>\n<h3> 创建分支</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 查看分支</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 切换分支</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 合并分支</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ol>\n<li>\n<p>切换到接受修改的分支（被合并，增加新内容）上</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>执行<code>merge</code>命令</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>解决冲突</p>\n<ul>\n<li>\n<p>冲突的表现</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>冲突的解决</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ol>\n<li>\n<p>编辑文件，删除特殊符号</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>把文件修改到满意的程度，保存退出</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>git add [文件名]</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>git commit -m \"日志信息\"</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>此时<code>commit</code>一定不能带具体文件名</p>\n</li>\n</ol>\n</li>\n</ul>\n</li>\n</ol>\n<h1> Git 基本原理</h1>\n<h2> 哈希</h2>\n<p>哈希是一个系列的加密算法， 各个不同的哈希算法虽然加密强度不同， 但是有以下几个共同点：</p>\n<ol>\n<li>不管输入数据的数据量有多大， 输入同一个哈希算法， 得到的加密结果长度固定</li>\n<li>哈希算法确定，输入数据确定，输出数据能够保证不变</li>\n<li>哈希算法确定，输入数据有变化，输出数据一定有变化，而且通常变化很大</li>\n<li>哈希算法不可逆</li>\n</ol>\n<p><code>Git</code>底层采用的是<code>SHA-1</code>算法。</p>\n<p>哈希算法可以被用来验证文件，原理如下图所示：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-hash-sha1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>Git</code>就是靠这种机制来从根本上保证数据完整性的。</p>\n<h2> Git 保存版本的机制</h2>\n<h3> 集中式版本控制工具的文件管理机制</h3>\n<p>以文件变更列表的方式存储信息，这类系统将它们保存的信息看作是一组基本文件和每个文件随时间逐步累积的差异。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/file-management-mechanism-of-centralized-version-control.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> Git 的文件管理机制</h3>\n<p><code>Git</code>把数据看作是小型文件系统的一组快照，每次提交更新时<code>Git</code>都会对当前的全部文件制作一个快照并保存这个快照的索引；为了高效，如果文件没有修改，<code>Git</code>不再重新存储该文件，而是只保留一个链接指向之前存储的文件；所以<code>Git</code>的工作方式可以称之为快照流。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-file-management-mechanism.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> Git 文件管理机制细节</h3>\n<ul>\n<li><code>Git</code>的提交对象<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-file-management-mechanism-commit1.png\" alt=\"\" loading=\"lazy\"></li>\n<li>提交对象及其父对象形成的链条<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-file-management-mechanism-commit2.png\" alt=\"\" loading=\"lazy\"></li>\n</ul>\n<h2> Git 分支管理机制</h2>\n<h3> 创建分支</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-create-branch.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 切换分支</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-checkout-branch1.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-checkout-branch2.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-checkout-branch3.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/git-checkout-branch4.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> GitHub</h1>\n<h2> 账号信息</h2>\n<p><a href=\"\"><code>GitHub</code></a> <a href=\"https://github.com/\" target=\"_blank\" rel=\"noopener noreferrer\">首页</a>就是注册页面。</p>\n<h2> 创建远程库</h2>\n<p>个人主页<code>New Repositories</code>。</p>\n<h2> 创建远程库地址别名</h2>\n<ul>\n<li>\n<p>查看当前所有远程地址别名</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>创建远程库地址别名</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 推送</h2>\n<p>开发修改完把本地库的文件推送到远程仓库，前提是提交到了本地库才可以推送。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h2> 克隆</h2>\n<p>完整的把远程库克隆到本地，克隆下来后不要在主分支里面做开发。</p>\n<p><code>clone</code>进行一次从无到有的过程，更新用<code>pull</code>。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：</p>\n<ul>\n<li>完整的把远程库下载到本地</li>\n<li>创建<code>origin</code>远程地址别名</li>\n<li>初始化本地库</li>\n</ul>\n<h2> 团队成员邀请</h2>\n<p><code>Repositories</code> -&gt;<code>Setting</code>-&gt;<code>Colllaboators</code>-&gt;<code>Add collaborator</code>-&gt;<code>Copy invite link</code>。</p>\n<p>把自己的邀请链接发送给其他人，其他人登录自己的<code>GitHub</code>账号，访问邀请链接。</p>\n<h2> 拉取</h2>\n<p><code>pull=fetch+merge</code></p>\n<ul>\n<li><code>fetch</code>只是抓取远程库，不会修改本地，想要查看可以<code>git checkout origin/master</code></li>\n<li>将<code>fetch</code>和<code>merge</code>分开来做，可以更方便，先将远程库抓取，查看之后再合并，合并使用<code>git merge origin/master</code></li>\n<li>直接使用<code>pull</code>可能会在其中的<code>merge</code>操作发生冲突</li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 解决冲突</h2>\n<p><code>A</code>和<code>B</code>原本都是同样的文件，<code>A</code>修改后推送到<code>GitHub</code>上，<code>B</code>再修改后推送就不允许了。</p>\n<ul>\n<li>\n<p>要点</p>\n<ul>\n<li>如果不是基于<code>GitHub</code>远程库的最新版所做的修改，不能推送，必须先拉取</li>\n<li>拉取下来后如果进入冲突状态，则按照“分支冲突解决”操作解决即可</li>\n<li>解决冲突后的提交是不能带文件名的</li>\n</ul>\n</li>\n<li>\n<p>类比</p>\n<ul>\n<li>债权人：老王</li>\n<li>债务人：小刘</li>\n<li>老王说 10 天后归还，小刘接受，双方达成一致</li>\n<li>老王媳妇说 5 天后归还，小刘不能接受，老王媳妇需要找老王确认后再执行</li>\n</ul>\n</li>\n</ul>\n<h2> 跨团队协作</h2>\n<ol>\n<li>\n<p><code>Fork</code></p>\n<p>自己<code>Fork</code>其他人的仓库</p>\n</li>\n<li>\n<p>自己本地修改，然后推送到远程</p>\n</li>\n<li>\n<p>自己<code>Pull Request</code>-&gt;<code>Create pull request</code></p>\n</li>\n<li>\n<p>对话</p>\n<p>他人和自己对话，询问代码详情。</p>\n</li>\n<li>\n<p>他人审核代码</p>\n</li>\n<li>\n<p>他人合并代码<code>Merge pull request</code>-&gt;<code>Commit merge</code></p>\n</li>\n<li>\n<p>将远程库修改拉取到本地</p>\n</li>\n</ol>\n<h2> SSH 登录</h2>\n<p>缺点：每台电脑只能登陆一个账号。</p>\n<ol>\n<li>\n<p>进入当前用户的家目录</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>删除 <code>.ssh</code> 目录</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>运行命令生成 <code>.ssh</code> 密钥目录</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>进入 <code>.ssh</code> 目录查看文件列表</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查看 <code>id_rsa.pub</code> 文件内容</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>复制 <code>id_rsa.pub</code> 文件内容， 登录 <code>GitHub</code>，点击用户头像 →<code>Settings</code>→<code>SSH and GPG keys</code></p>\n</li>\n<li>\n<p><code>New SSH Key</code></p>\n</li>\n<li>\n<p>输入复制的密钥信息</p>\n</li>\n<li>\n<p>回到 <code>Git bash</code> 创建远程地址别名</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>推送文件进行测试</p>\n</li>\n</ol>\n<h1> Git 工作流</h1>\n<p>在项目开发过程中使用<code>Git</code>的方式。</p>\n<h2> 分类</h2>\n<h3> 集中式工作流</h3>\n<p>像<code>SVN</code>一样，集中式工作流以中央仓库作为项目所有修改的单点实体，所有修改都提交到<code>Master</code>这个分支上。</p>\n<p>这种方式与<code>SVN</code>的主要区别就是开发人员有本地库。</p>\n<p>这种方式<code>Git</code>很多特性并没有用到。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/centralized-workflow.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> GitFlow 工作流</h3>\n<p><code>Gitflow</code>工作流通过为功能开发、发布准备和维护设立了独立的分支，让发布迭代过程更流畅。严格的分支模型也为大型项目提供了一些非常必要的结构。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/gitflow-workflow.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> Forking 工作流</h1>\n<p><code>Forking</code>工作流是在<code>GitFlow</code>基础上，充分利用了<code>Git</code>的<code>Fork</code>和<code>pull request</code>的功能以达到代码审核的目的。 更适合安全可靠地管理大团队的开发者， 而且能接受不信任贡献者的提交。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/forking-workflow.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> GitFlow 工作流详解</h2>\n<h3> 分支种类</h3>\n<ul>\n<li>\n<p>主干分支<code>master</code></p>\n<p>主要负责管理正在运行的生产环境代码。 永远保持与正在运行的生产环境完全一致。</p>\n</li>\n<li>\n<p>开发分支<code>develop</code></p>\n<p>主要负责管理正在开发过程中的代码，一般情况下应该是最新的代码。</p>\n</li>\n<li>\n<p><code>bug</code>修理分支<code>hotfix</code></p>\n<p>主要负责管理生产环境下出现的紧急修复的代码；从主干分支分出，修理完毕并测试上线后，并回主干分支；并回后，视情况可以删除该分支。</p>\n</li>\n<li>\n<p>准生产分支（预发布分支）<code>release</code></p>\n<p>较大的版本上线前， 会从开发分支中分出准生产分支， 进行最后阶段的集成测试；该版本上线后，会合并到主干分支。生产环境运行一段阶段较稳定后可以视情况删除。</p>\n</li>\n<li>\n<p>功能分支<code>feature</code></p>\n<p>为了不影响较短周期的开发工作， 一般把中长期开发模块， 会从开发分支中独立出来；开发完成后会合并到开发分支。</p>\n</li>\n</ul>\n<h3> GitFlow 工作流举例</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/gitflow-workfllow-example.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 分支实战</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/gitflow-branch-example.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> GitLab 服务器</h1>\n<h2> 官网</h2>\n<ul>\n<li><a href=\"https://about.gitlab.com/\" target=\"_blank\" rel=\"noopener noreferrer\">首页</a></li>\n<li><a href=\"https://about.gitlab.com/installation/\" target=\"_blank\" rel=\"noopener noreferrer\">安装说明</a></li>\n</ul>\n<h2> 安装</h2>\n<p><a href=\"https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-10.8.2-ce.0.el7.x86_64.rpm\" target=\"_blank\" rel=\"noopener noreferrer\">下载地址</a>。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><code>yum</code>安装<code>gitlab-ee</code>（或<code>ce</code>）时，需要联网下载安装文件，非常耗时，所以应提前把所需<code>RPM</code>包下载并安装好。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>步骤完成后重启。</p>\n<h2> GitLab 服务操作</h2>\n<ul>\n<li>\n<p>初始化配置<code>GitLab</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>启动<code>GitLab</code>服务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>停止<code>GitLab</code>服务</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> 浏览器访问</h2>\n<p>访问<code>Linux</code>服务器<code>IP</code>地址即可，如果想访问<code>EXTERNAL_URL</code>指定的域名还需要配置域名服务器或本地<code>hosts</code> 文件。</p>\n<p>初次登录时需要为<code>GitLab</code>的<code>root</code>用户设置密码：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/gitllab-page.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>应该会需要停止防火墙服务：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/git-summary/distributed-version-control.png",
      "date_published": "2023-08-16T00:00:00.000Z",
      "date_modified": "2023-08-27T07:08:54.000Z",
      "authors": [],
      "tags": [
        "Git"
      ]
    },
    {
      "title": "MarkDdown 链接小卡片",
      "url": "https://1coins.github.io/article/markdown/markdown-shields.html",
      "id": "https://1coins.github.io/article/markdown/markdown-shields.html",
      "summary": "提醒：需要会写基本的Markdown语法（当然，如果只想学会链接小卡片的话会写图片和链接的语法就可以了）。 什么是链接小卡片 实际上叫badge，翻译过来是徽标的意思。 因为我每次用这个都是用作链接，而它长得有点像小卡片，所以贴心地起名叫“链接小卡片”。 使用方法 链接小卡片本质上是借助 https://img.shields.io/ 这个网站来实现的图片，所以会用到Markdown图片语法，如果想做成链接，还需用到 Markdown 链接语法。",
      "content_html": "<p>提醒：需要会写基本的<code>Markdown</code>语法（当然，如果只想学会链接小卡片的话会写图片和链接的语法就可以了）。</p>\n<h1> 什么是链接小卡片</h1>\n<p>实际上叫<code>badge</code>，翻译过来是徽标的意思。</p>\n<p>因为我每次用这个都是用作链接，而它长得有点像小卡片，所以贴心地起名叫“链接小卡片”。</p>\n<h1> 使用方法</h1>\n<p>链接小卡片本质上是借助 <img src=\"https://img.shields.io/badge/Shields.io-八月?color=222&amp;logo=shieldsdotio\" alt=\"\" loading=\"lazy\"><a href=\"https://img.shields.io/\" target=\"_blank\" rel=\"noopener noreferrer\">https://img.shields.io/</a> 这个网站来实现的图片，所以会用到<code>Markdown</code>图片语法，如果想做成链接，还需用到 Markdown 链接语法。</p>\n<p>所有参数值未加特殊说明均不可省略！</p>\n<p>由于是通过其他网站实现显示图片，所以要想正常显示，必须确保有网。</p>\n<h2> 单内容链接小卡片</h2>\n<p>我把只有一个内容项的称为<strong>单内容链接小卡片</strong>。</p>\n<h3> 语法</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 示例</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/乾元-1coins?color=000000\" alt=\"\" loading=\"lazy\"></p>\n<h3> 注意事项</h3>\n<ul>\n<li>使用时替换语法代码部分中的汉字内容即可</li>\n<li>颜色值可省略（从<code>?</code>开始省略）</li>\n<li>颜色值均指背景颜色，字体颜色会自动调整，无法自定义字体颜色</li>\n<li>颜色值若使用 16 进制，不要加<code>#</code>号</li>\n<li>默认的颜色是：<img src=\"https://img.shields.io/badge/绿的-未央\" alt=\"\" loading=\"lazy\"></li>\n<li>防伪值只是我是这么叫的，因为它不会显示</li>\n<li>只要出现防伪值，防伪值均不可省略，下同</li>\n</ul>\n<h2> 双内容链接小卡片</h2>\n<p>我把有两个内容项的称为<strong>双内容链接小卡片</strong>。</p>\n<h3> 语法</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 示例</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/乾元-1coins-fff\" alt=\"\" loading=\"lazy\"></p>\n<h3> 注意事项</h3>\n<ul>\n<li>所有内容均不可省略，包括颜色值</li>\n<li>这里的颜色值只能修改<strong>后内容</strong>的颜色值</li>\n</ul>\n<h2> 图标链接小卡片</h2>\n<p>我把带有小图标的称为<strong>图标链接小卡片</strong>。</p>\n<p>图标链接小卡片又分为<strong>内置图标链接小卡片</strong>和<strong>自定义图标链接小卡片</strong>。</p>\n<h3> 内置图标链接小卡片</h3>\n<p>内置图标可以直接使用。所有内置图标可以在这里找到（点击传送）：<img src=\"https://img.shields.io/badge/Simple Icons-八月?color=222&amp;logo=simpleicons\" alt=\"\" loading=\"lazy\"><a href=\"https://simpleicons.org/\" target=\"_blank\" rel=\"noopener noreferrer\">https://simpleicons.org/</a></p>\n<h4> 语法</h4>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 示例</h4>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>效果：</p>\n<ol>\n<li>单内容：<img src=\"https://img.shields.io/badge/QQ-乾元?color=4ab7f5&amp;logo=tencentqq\" alt=\"\" loading=\"lazy\"></li>\n<li>双内容：<img src=\"https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple\" alt=\"\" loading=\"lazy\"></li>\n</ol>\n<h4> 修改内置图标颜色</h4>\n<ul>\n<li>部分内置图标默认是白色的，比如上面的示例</li>\n<li>部分内置图标默认自带颜色，比如：<img src=\"https://img.shields.io/badge/WeChat-八月?color=fff&amp;logo=wechat\" alt=\"\" loading=\"lazy\"> 和 <img src=\"https://img.shields.io/badge/支付宝-八月?color=fff&amp;logo=alipay\" alt=\"\" loading=\"lazy\"></li>\n<li>哪些默认带颜色，哪些默认不带，需要自己试</li>\n<li>内置图标的颜色可以修改</li>\n</ul>\n<h5> 语法</h5>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h5> 示例</h5>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>效果：</p>\n<ol>\n<li>单内容：<img src=\"https://img.shields.io/badge/QQ-乾元?color=fff&amp;logo=tencentqq&amp;logoColor=4ab7f5\" alt=\"\" loading=\"lazy\"></li>\n<li>双内容：<img src=\"https://img.shields.io/badge/macOS-10.13+-367aff?logo=apple\" alt=\"\" loading=\"lazy\"></li>\n</ol>\n<h4> 自定义图标链接小卡片</h4>\n<p>自定义图标需将图片转换成<code>Base64</code>编码（这样的工具很多），同时需要原图片的长和宽均 ≥ 14px。</p>\n<h5> 语法</h5>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h5> 示例</h5>\n<p>我把自己的头像转换成了<code>Base64</code>编码作为示例，不过编码太长了，放进来严重影响性能，所以就省略不放了。</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>效果：</p>\n<ol>\n<li>单内容：<img src=\"https://img.shields.io/badge/乾元-1coins?color=fff&amp;logo=data:image/png;base64,AAA...A==\" alt=\"\" loading=\"lazy\"></li>\n<li>双内容：<img src=\"https://img.shields.io/badge/乾元-1coins-fff?color=fff&amp;logo=data:image/jpg;base64,9j\" alt=\"\" loading=\"lazy\"></li>\n</ol>\n<h2> 双内容自定义颜色</h2>\n<p>前面提及双内容链接小卡片的语法和示例中可修改的颜色值都只能修改后内容的颜色。</p>\n<p>本小节将演示如何分别控制双内容的颜色。</p>\n<h3> 语法</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 示例</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/macOS-乾元?label=AppStore&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore\" alt=\"\" loading=\"lazy\"></p>\n<h3> 注意事项</h3>\n<ul>\n<li>注意图片语法链接中的“前内容”跑到后面去了，“后内容”跑到前面去了，不要搞反了</li>\n<li>如果要加上图标，比如上面的示例，直接在图片语法链接末尾加上<code>&amp;logo=图标名</code>即可，注意<code>&amp;</code>不要忘了</li>\n<li>如果还要修改图标颜色，再继续在链接末尾继续加上<code>&amp;logoColor=图标颜色值</code>即可</li>\n</ul>\n<h2> 增加超链接</h2>\n<p>链接小卡片是可以点的，这是因为在<code>Markdown</code>图片语法外层又套娃了一层超链接语法。</p>\n<h3> 语法</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 示例</h3>\n<p>就是把<code>§ 2.1 ~ § 2.4</code>学到的放在超链接语法的<code>[]</code>里就行。</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/乾元-1coins?color=fff&amp;logo=data:image/png;base64,AAA...A==\" alt=\"\" loading=\"lazy\"><a href=\"https://1coins.github.io/\" target=\"_blank\" rel=\"noopener noreferrer\">https://1coins.github.io/</a></p>\n<h3> 注意事项</h3>\n<ul>\n<li>注意图片语法链接中的“前内容”跑到后面去了，“后内容”跑到前面去了，不要搞反了</li>\n<li>如果要加上图标，比如上面的示例，直接在图片语法链接末尾加上<code>&amp;logo=图标名</code>即可，注意<code>&amp;</code>不要忘了</li>\n<li>如果还要修改图标颜色，再继续在链接末尾继续加上<code>&amp;logoColor=图标颜色值</code>即可</li>\n</ul>\n<p>其他的可以自行尝试。</p>\n<h2> 样式</h2>\n<p>有五种样式可供选择。</p>\n<h3> 立体胶质圆角矩形</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/style=plastic-乾元?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=plastic\" alt=\"\" loading=\"lazy\"></p>\n<h3> 扁平圆角矩形（默认）</h3>\n<p>如果什么都不加，默认就相当于<code>&amp;style=flat</code>。</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/style=flat-乾元?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat\" alt=\"\" loading=\"lazy\"></p>\n<h3> 扁平直角矩形</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/style=flat--square-乾元?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=flat-square\" alt=\"\" loading=\"lazy\"></p>\n<h3> 大扁平圆角矩形 - 字母全大写</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/style=for--the--badge-乾元?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=for-the-badge\" alt=\"\" loading=\"lazy\"></p>\n<h3> GitHub 交流样式</h3>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/style=social-乾元?label=Git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git&amp;style=social\" alt=\"\" loading=\"lazy\"></p>\n<h2> 动态内容</h2>\n<p>动态内容即显示的内容为可变的，主要用于<code>GitHub</code>等网站的某些数据显示。</p>\n<p>这里的动态内容只介绍与<code>GitHub</code>相关的一部分，想了解更多可以去官网查询。</p>\n<p>以<code>Linux</code>之父林纳斯·托瓦斯的<code>Linux</code>源代码仓库<code>torvalds/linux</code>为示例。</p>\n<h3> Watch</h3>\n<p>语法：</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>示例：</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/github/watchers/torvalds/linux?style=social&amp;label=Watch\" alt=\"\" loading=\"lazy\"></p>\n<h3> Star</h3>\n<p>语法：</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>示例：</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/github/stars/torvalds/linux?style=social&amp;label=star\" alt=\"\" loading=\"lazy\"></p>\n<h3> Fork</h3>\n<p>语法：</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>示例：</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/github/forks/torvalds/linux?style=social&amp;label=Fork\" alt=\"\" loading=\"lazy\"></p>\n<p>其他的可以自行尝试。</p>\n<h1> 特殊符号问题</h1>\n<p>有时候需要空格或者其他的特殊符号，直接打在链接里可能会导致结果不符合预期。</p>\n<p>解决方法其实很简单，就是把特殊符号转换成<code>url</code>编码即可。</p>\n<h2> 空格示例</h2>\n<p>之前<code>App Store</code>那个示例中是没有空格的，现在添加空格（空格的<code>url</code>编码是<code>%20</code>）：</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/macOS-乾元?label=App Store&amp;colorA=fff&amp;colorB=367aff&amp;logo=appstore\" alt=\"\" loading=\"lazy\"></p>\n<h2> 短横 - 符号示例</h2>\n<p>短横符号<code>-</code>比较特殊，它没有<code>url</code>编码，或者说它的<code>url</code>编码就是它本身。 要想在小卡片中显示它也很简单，写两遍就行。</p>\n<div class=\"language-markdown line-numbers-mode\" data-ext=\"md\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>效果：<img src=\"https://img.shields.io/badge/----everything--is--local-乾元?label=git&amp;colorA=fff&amp;colorB=f14d28&amp;logo=git\" alt=\"\" loading=\"lazy\"></p>\n",
      "image": "https://img.shields.io/badge/Shields.io-八月?color=222&logo=shieldsdotio",
      "date_published": "2023-08-23T00:00:00.000Z",
      "date_modified": "2023-08-27T07:08:54.000Z",
      "authors": [],
      "tags": [
        "MarkDdown"
      ]
    },
    {
      "title": "MyCat 总结",
      "url": "https://1coins.github.io/article/mycat/mycat-summary.html",
      "id": "https://1coins.github.io/article/mycat/mycat-summary.html",
      "summary": "MyCat 概述 MyCat 是什么 官网。 MyCat 是数据库中间件。 数据库中间件 中间件：是一类连接软件组件和应用的计算机软件，以便于软件各部件之间的沟通。例如Tomcat是Web中间件。 数据库中间件：连接Java应用程序和数据库。 为什么要用 MyCat",
      "content_html": "<h1> MyCat 概述</h1>\n<h2> MyCat 是什么</h2>\n<p><a href=\"http://www.mycat.io/\" target=\"_blank\" rel=\"noopener noreferrer\">官网</a>。</p>\n<p>MyCat 是数据库中间件。</p>\n<h3> 数据库中间件</h3>\n<p>中间件：是一类连接软件组件和应用的计算机软件，以便于软件各部件之间的沟通。例如<code>Tomcat</code>是<code>Web</code>中间件。<br>\n数据库中间件：连接<code>Java</code>应用程序和数据库。</p>\n<h3> 为什么要用 MyCat</h3>\n<ol>\n<li><code>Java</code>与数据库紧耦合</li>\n<li>高访问量高并发对数据库的压力</li>\n<li>读写请求数据不一致</li>\n</ol>\n<h3> 数据库中间件对比</h3>\n<ul>\n<li><code>Cobar</code>属于阿里<code>B2B</code>事业群，始于 2008 年，在阿里服役 3 年多，接管 3000+ 个<code>MySql</code>数据库的<code>schema</code>，集群日处理在线<code>SQL</code>请求 50 亿次以上；由于<code>Cobar</code>发起人的离职，<code>Cobar</code>停止维护</li>\n<li><code>MyCat</code>是开源社区在阿里<code>Cobar</code>基础上进行二次开发，解决了<code>Cobar</code>存在的问题，并且加入了许多新的功能，青出于蓝而胜于蓝</li>\n<li><code>OneProxy</code>基于<code>MySql</code>官方的<code>Proxy</code>思想利用<code>C</code>进行开发的，<code>OneProxy</code>是一款商业收费的中间件，舍弃了一些功能，专注在性能和稳定性上</li>\n<li><code>KingShard</code>由小团队用<code>Go</code>语言开发，还需要发展，需要不断完善</li>\n<li><code>Vitess</code>是<code>Youtube</code>生产在使用，架构很复杂，不支持<code>MySQL</code>原生协议，使用需要大量改造成本</li>\n<li><code>Atlas</code>是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>360</mn></mrow><annotation encoding=\"application/x-tex\">360</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">360</span></span></span></span> 团队基于<code>MySql Proxy</code>改写，功能还需完善，高并发下不稳定</li>\n<li><code>MaxScale</code>是<code>MariaDB</code>（<code>MySq</code>原作者维护的一个版本） 研发的中间件</li>\n<li><code>MySqRoute</code>是<code>MySql</code>官方<code>Oracle</code>公司发布的中间件</li>\n</ul>\n<h2> MyCat 能做什么</h2>\n<h3> 读写分离</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/read-write-separation.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 数据分片</h3>\n<ul>\n<li>垂直拆分（分库）</li>\n<li>水平拆分（分表）</li>\n<li>垂直+水平拆分（分库分表）</li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/data-fragmentation.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 多数据源整合</h3>\n<p>![](<a href=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/integration-of-multiple-data\" target=\"_blank\" rel=\"noopener noreferrer\">https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/integration-of-multiple-data</a> -sources.png)</p>\n<h1> MyCat 原理</h1>\n<p><code>MyCAT</code>的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的<code>SQL</code>语句，首先对<code>SQL</code><br>语句做了一些特定的分析，如分片分析、路由分析、读写分离分析、缓存分析等，然后将此<code>SQL</code> 发<br>往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/mycat-principle.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>这种方式把数据库的分布式从代码中解耦出来，程序员察觉不出来后台使用<code>MyCat</code>还是<code>MySql</code>。</p>\n<h1> MyCat 安装启动</h1>\n<h2> 安装</h2>\n<ol>\n<li>解压后即可使用\n<ul>\n<li>解压缩文件拷贝到<code>linux</code>下的<code>/usr/local</code>文件夹中</li>\n</ul>\n</li>\n<li>三个配置文件\n<ul>\n<li><code>schema.xml</code>：定义逻辑库，表、分片节点等内容</li>\n<li><code>rule.xml</code>：定义分片规则</li>\n<li><code>server.xml</code>：定义用户以及系统相关变量，如端口等</li>\n</ul>\n</li>\n</ol>\n<h2> 启动</h2>\n<ol>\n<li>\n<p>修改配置文件<code>server.xml</code><br>\n修改用户信息，与<code>MySql</code>区分，如下：</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>修改配置文件<code>schema.xml</code><br>\n删除标签间的表信息，<code>&lt;dataNode&gt;</code>标签只留一个，<code>&lt;dataHost&gt;</code>标签只留一个，<code>&lt;wirteHost&gt;&lt;readHost&gt;</code>只留一对</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>验证数据库访问情况<br>\n<code>MyCat</code>作为数据库中间件要和数据库部署在不同机器上，所以要验证远程访问情况。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>如无法访问，则关闭防火墙或开启 3306 端口</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>启动程序</p>\n<ul>\n<li>控制台启动 ：去<code>mycat/bin</code>目录下执行<code>./mycat console</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>后台启动 ：去<code>mycat/bin</code>目录下<code>./mycat start</code></li>\n</ul>\n<p>为了能第一时间看到启动日志，方便定位问题，选择控制台启动。</p>\n</li>\n<li>\n<p>启动时可能出现报错</p>\n<ul>\n<li>如果无法启动，可能没有安装<code>JDK</code>环境</li>\n<li>如果操作系统是<code>CentOS6.8</code>，可能会出现域名解析失败错误，可以按照以下步骤解决\n<ol>\n<li>用<code>vi</code>修改<code>/etc/hosts</code>文件，在 <a href=\"127.0.0.1\">127.0.0.1</a> 后面增加自己的机器名<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>修改后重新启动网络服务<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n</ul>\n</li>\n</ol>\n<h2> 登录</h2>\n<ol>\n<li>登录后台管理窗口<br>\n此登录方式用于管理维护<code>MyCat</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>登录数据窗口<br>\n此登录方式用于通过<code>MyCat</code>查询数据，选择这种方式访问<code>MyCat</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h1> MyCat 实例</h1>\n<h2> 读写分离</h2>\n<p>通过<code>MyCaT</code>和<code>MySql</code>的主从复制配合搭建数据库的读写分离，实现<code>MySql</code>的高可用性。将搭建一主一从、双主双从两种读写分离模式。</p>\n<h3> 一主一从</h3>\n<p>一个主机用于处理所有写请求，一台从机负责所有读请求，架构图如下：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/one-master-one-slave.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ol>\n<li>\n<p>搭建<code>MySql</code>数据库主从复制</p>\n<ol>\n<li>\n<p><code>MySql</code>主从复制原理<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/mysql-master-slave-principle.png\" alt=\"\" loading=\"lazy\"></p>\n</li>\n<li>\n<p>主机配置（<a href=\"192.168.30.134\">192.168.30.134</a>）<br>\n修改配置文件：<code>vim /etc/my.cnf</code>。</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><code>binlog</code>日志三种格式：</p>\n<ul>\n<li><code>Statement</code>：每一条会修改数据的<code>sql</code>都会记录在<code>binlog</code>中\n<ul>\n<li>\n<p>优点：</p>\n<ul>\n<li>不需要记录每一行的变化，减少了<code>binlog</code>日志量，节约了<code>IO</code>，提高性能</li>\n<li>相比<code>row</code>能节约多少性能与日志量，这个取决于应用的<code>SQL</code>情况，正常同一条记录修改或者插入<code>row</code>格式所产生的日志量还小于<code>Statement</code>产生的日志量，但是考虑到如果带条件的<code>update</code>操作，以及整表删除，<code>alter</code>表等操作，<code>ROW</code>格式会产生大量日志，因此在考虑是否使用<code>ROW</code>格式日志时应该跟据应用的实际情况，其所产生的日志量会增加多少，以及带来的<code>IO</code>性能问题</li>\n</ul>\n</li>\n<li>\n<p>缺点：</p>\n<ul>\n<li>由于记录的只是执行语句，为了这些语句能在<code>slave</code>上正确运行，因此还必须记录每条语句在执行的时候的一些相关信息，以保证所有语句能在<code>slave</code>得到和<code>master</code>端执行时候相同的结果</li>\n<li>另外<code>MySsql</code>的复制，像一些特定函数功能，<code>slave</code>可与<code>master</code>上要保持一致会有很多相关问题（如<code>sleep()</code>函数，<code>last_insert_id()</code>，以及<code>user-defined functions(udf)</code>会出现问题）</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>Row</code>：不记录<code>sql</code>语句上下文相关信息，仅保存哪条记录被修改\n<ul>\n<li>优点：<code>binlog</code>中可以不记录执行的<code>sql</code>语句的上下文相关的信息，仅需要记录那一条记录被修改成什么了；所以<code>ROW-level</code>的日志内容会非常清楚的记录下每一行数据修改的细节，而且不会出现某些特定情况下的存储过程，或<code>function</code>，以及<code>trigger</code>的调用和触发无法被正确复制的问题。</li>\n<li>缺点：所有的执行的语句当记录到日志中的时候，都将以每行记录的修改来记录，这样可能会产生大量的日志内容；比如一条<code>update</code>语句，修改多条记录，则<code>binlog</code>中每一条修改都会有记录，这样造成<code>binlog</code>日志量会很大，特别是当执行<code>alter table</code>之类的语句的时候，由于表结构修改，每条记录都发生改变，那么该表每一条记录都会记录到日志中。</li>\n</ul>\n</li>\n<li><code>Mixedlevel</code>：是以上两种<code>level</code>的混合使用\n<ul>\n<li>一般的语句修改使用<code>Statment</code>格式保存<code>binlog</code>，如一些函数，<code>Statement</code>无法完成主从复制的操作，则采用<code>ROW</code>格式保存<code>binlog</code>；<code>MySql</code>会根据执行的每一条具体的<code>sql</code>语句来区分对待记录的日志形式，也就是在<code>Statement</code>和<code>Row</code>之间选择一种，新版本的<code>MySql</code>中对<code>ROW-level</code>模式也被做了优化，并不是所有的修改都会以<code>ROW-level</code>来记录，像遇到表结构变更的时候就会以<code>Statement</code>模式来记录；至于<code>update</code>或者<code>delete</code>等修改数据的语句，还是会记录所有行的变更。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>从机配置（<a href=\"192.168.30.130\">192.168.30.130</a>）<br>\n修改配置文件：<code>vim /etc/my.cnf</code>。</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>主机、从机重启<code>MySQL</code>服务</p>\n</li>\n<li>\n<p>主机从机都关闭防火墙</p>\n</li>\n<li>\n<p>在主机上建立帐户并授权<code>slave</code></p>\n<ul>\n<li>在主机<code>MySql</code>里执行授权命令<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>查询<code>master</code>的状态<br>\n记录下<code>File</code>和<code>Position</code>的值，执行完此步骤后不要再操作主服务器<code>MySql</code>，防止主服务器状态值变化。<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>在从机上配置需要复制的主机</p>\n<ul>\n<li>\n<p>复制主机</p>\n<ul>\n<li>复制主机的命令<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>输入<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>启动从服务器复制功能</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查看从服务器状态</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>下面两个参数都是Yes，则说明主从配置成功：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>主机新建库、新建表、<code>insert</code>记录，从机复制</p>\n<ul>\n<li>主机<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>从机<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>如何停止从服务复制功能</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>如何重新配置主从</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>\n<p>修改<code>MyCat</code>的配置文件<code>schema.xml</code><br>\n修改的<code>balance</code>属性，通过此属性配置读写分离的类型。负载均衡类型，目前的取值有 4 种：</p>\n<ol>\n<li><code>balance=\"0\"</code>：不开启读写分离机制，所有读操作都发送到当前可用的<code>writeHost</code>上</li>\n<li><code>balance=\"1\"</code>：全部的<code>readHost</code>与<code>stand by writeHost</code>参与<code>select</code>语句的负载均衡，简单的说，当双主双从模式（<code>M1-&gt;S1</code>，<code>M2-&gt;S2</code>，并且<code>M1</code>与<code>M2</code>互为主备），正常情况下，<code>M2</code>、<code>S1</code>、<code>S2</code>都参与<code>select</code>语句的负载均衡</li>\n<li><code>balance=\"2\"</code>：所有读操作都随机的在<code>writeHost</code>、<code>readhost</code>上分发</li>\n<li><code>balance=\"3\"</code>：所有读请求随机的分发到<code>readhost</code>执行，<code>writerHost</code>不负担读压力</li>\n</ol>\n<p>为了能看到读写分离的效果，把<code>balance</code>设置成 2，会在两个主机间切换查询：</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>启动<code>MyCat</code></p>\n</li>\n<li>\n<p>验证读写分离</p>\n<ul>\n<li>在写主机数据库表<code>mytbl</code>中插入带系统变量数据，造成主从数据不一致<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在<code>MyCat</code>里查询<code>mytbl</code>表，可以看到查询语句在主从两个主机间切换<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n</ol>\n<h3> 双主双从</h3>\n<p>一个主机<code>M1</code>用于处理所有写请求，它的从机<code>S1</code>和另一台主机<code>M2</code>还有它的从机<code>S2</code>负责所有读请<br>\n求。当<code>M1</code>主机宕机后，<code>M2</code>主机负责写请求，<code>M1</code>、<code>M2</code>互为备机。</p>\n<p>架构图如下：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/two-master-two-slave.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<table>\n<thead>\n<tr>\n<th>编号</th>\n<th>角色</th>\n<th>IP</th>\n<th>机器名</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>M1</td>\n<td>192.168.30.134</td>\n<td>centos02.02</td>\n</tr>\n<tr>\n<td>2</td>\n<td>S1</td>\n<td>192.168.30.130</td>\n<td>centos03.03</td>\n</tr>\n<tr>\n<td>3</td>\n<td>M2</td>\n<td>192.168.30.129</td>\n<td>centos01.01</td>\n</tr>\n<tr>\n<td>4</td>\n<td>S2</td>\n<td>192.168.30.131</td>\n<td>cdntos04.04</td>\n</tr>\n</tbody>\n</table>\n<ol>\n<li>\n<p>搭建<code>MySql</code>数据库主从复制（双主双从）</p>\n<ol>\n<li>\n<p>双主机配置<br>\n修改配置文件：<code>vim /etc/my.cnf</code>。</p>\n<ul>\n<li><code>M1</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li><code>M2</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>双主机配置<br>\n修改配置文件：<code>vim /etc/my.cnf</code>。</p>\n<ul>\n<li><code>S1</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li><code>S2</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>双主机、双从机重启<code>MySql</code>服务</p>\n</li>\n<li>\n<p>主机从机都关闭防火墙</p>\n</li>\n<li>\n<p>在两台主机上建立帐户并授权<code>slave</code></p>\n<ul>\n<li>在主机<code>MySql</code>里执行授权命令<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>查询<code>M1</code>的状态<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>查询<code>M2</code>的状态<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>分别记录下<code>File</code>和<code>Position</code>的值，执行完此步骤后不要再操作主服务器<code>MySql</code>，防止主服务器状态值变化</p>\n</li>\n<li>\n<p>在从机上配置需要复制的主机<br>\n<code>S1</code>复制<code>M1</code>，<code>S2</code>复制<code>M2</code>。</p>\n<ul>\n<li>复制主机的命令<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>启动两台从服务器复制功能<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>查看从服务器状态<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>下面两个参数都是<code>Yes</code>，则说明主从配置成功！</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>两个主机互相复制<br>\n<code>M2</code>复制<code>M1</code>，<code>M1</code>复制<code>M2</code>，如上。</p>\n</li>\n<li>\n<p><code>M1</code>主机新建库、新建表、<code>insert</code>记录，<code>M2</code>和<code>S1</code>、<code>S2</code>复制</p>\n</li>\n<li>\n<p>停止从服务复制功能</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重新配置主从</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>\n<p>修改<code>Mycat</code>的配置文件<code>schema.xml</code><br>\n修改的<code>balance</code>属性，通过此属性配置读写分离的类型，为了双主双从读写分离<code>balance</code>设置为 1。</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li><code>writeType=\"0\"</code>：所有写操作发送到配置的第一个<code>writeHost</code>，第一个挂了切到还生存的第二个</li>\n<li><code>writeType=\"1\"</code>，所有写操作都随机的发送到配置的<code>writeHost</code>，1.5 以后废弃不推荐</li>\n<li><code>writeHost</code>，重新启动后以切换后的为准，切换记录在配置文件中：<code>dnindex.properties</code></li>\n<li><code>switchType=\"1\"</code>\n<ul>\n<li>1 ：默认值，自动切换</li>\n<li>-1 ：不自动切换</li>\n<li>2 ：基于<code>MySql</code>主从同步的状态决定是否切换</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>启动<code>MyCat</code></p>\n</li>\n<li>\n<p>验证读写分离</p>\n<ul>\n<li>在写主机<code>M1</code>数据库表<code>mytbl</code>中插入带系统变量数据，造成主从数据不一致<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>在<code>MyCat</code>里查询<code>mytbl</code>表，可以看到查询语句在<code>M2(centos01)</code>、<code>S1(centos03)</code>、<code>S2(centos04)</code>主从三个主机间切换</li>\n</ul>\n</li>\n<li>\n<p>抗风险能力</p>\n<ol>\n<li>停止数据库<code>M1</code></li>\n<li>在<code>MyCat</code>里插入数据依然成功，<code>M2</code>自动切换为写主机<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>启动数据库<code>M1</code></li>\n<li>在<code>MyCat</code>里查询<code>mytbl</code>表,可以看到查询语句在<code>M1(centos02)</code>、<code>S1(centos03)</code>、<code>S2(centos04)</code>主从三个主机间切换</li>\n</ol>\n<p><code>M1</code>、<code>M2</code>互做备机，负责写的主机宕机，备机切换负责写操作，保证数据库读写分离高可用性。</p>\n</li>\n</ol>\n<h2> 垂直拆分——分库</h2>\n<p>一个数据库由很多表的构成，每个表对应着不同的业务，垂直切分是指按照业务将表进行分类，<br>分布到不同 的数据库上面，这样也就将数据或者说压力分担到不同的库上面，如下图：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/vertical-shard.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>系统被切分成了，用户，订单交易，支付几个模块。</p>\n<h3> 如何划分表</h3>\n<p>问题：在两台主机上的两个数据库中的表，能否关联查询？</p>\n<p>答案：不可以关联查询。</p>\n<p>分库的原则：有紧密关联关系的表应该在一个库里，相互没有关联关系的表可以分到不同的库里。</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>以上四个表如何分库？</p>\n<p>客户表分在一个数据库，另外三张都需要关联查询，分在另外一个数据库。</p>\n<h3> 实现分库</h3>\n<ol>\n<li>修改<code>schema.xml</code>配置文件<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>新增两个空白库<br>\n分库操作不是在原来的老数据库上进行操作，需要准备两台机器分别安装新的数据库，在数据节点<code>dn1</code>、<code>dn2</code>上分别创建数据库<code>orders</code>。<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>启动<code>MyCat</code></li>\n<li>访问<code>MyCat</code>进行分库\n<ol>\n<li>访问<code>MyCat</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>切换到<code>TESTDB</code></li>\n<li>创建 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn></mrow><annotation encoding=\"application/x-tex\">4</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span></span></span></span> 张表</li>\n<li>在<code>dn1</code>和<code>dn2</code>上查看表信息，可以看到成功分库</li>\n</ol>\n</li>\n</ol>\n<h2> 水平拆分——分表</h2>\n<p>相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分散到多个库之中，每个表中包含一部分数据。简单来说，可以将数据的水平切分理解为是按照数据行的切分，就是将表中的某些行切分到一个数据库，而另外的某些行又切分到其他的数据库中，如图：</p>\n<p>![](<a href=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/horizontal\" target=\"_blank\" rel=\"noopener noreferrer\">https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/horizontal</a> -shard.png)</p>\n<h3> 实现分表</h3>\n<ol>\n<li>选择要拆分的表<br>\n<code>MySql</code>单表存储数据条数是有瓶颈的，单表达到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1000</mn></mrow><annotation encoding=\"application/x-tex\">1000</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1000</span></span></span></span> 万条数据就达到了瓶颈，会影响查询效率，需要进行水平拆分（分表）进行优化。<br><code>orders</code>、<code>orders_detail</code>都已经达到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>600</mn></mrow><annotation encoding=\"application/x-tex\">600</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">600</span></span></span></span> 万行数据，需要进行分表优化。</li>\n<li>分表字段<br>\n以<code>orders</code>表为例，可以根据不同自字段进行分表\n<table>\n<thead>\n<tr>\n<th>编号</th>\n<th>分表字段</th>\n<th>效果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td><code>id</code>（主键、或创建时间）</td>\n<td>查询订单注重时效，历史订单被查询的次数少，如此分片会造成一个节点访问多，一个访问少，不平均。</td>\n</tr>\n<tr>\n<td>2</td>\n<td><code>customer_id</code>（客户<code>id</code>）</td>\n<td>根据客户<code>id</code>去分，两个节点访问平均，一个客户的所有订单都在同一个节点</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>修改配置文件<code>schema.xml</code><br>\n为<code>orders</code>表设置数据节点为<code>dn1</code>、<code>dn2</code>，并指定分片规则为<code>mod_rule</code>（自定义的名字）<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>修改配置文件<code>rule.xml</code><br>\n在<code>rule</code>配置文件里新增分片规则<code>mod_rule</code>，并指定规则适用字段为<code>customer_id</code>，还有选择分片算法<code>mod-long</code>（对字段求模运算），<code>customer_id</code>对两个节点求模，根据结果分片，配置算法<code>mod-long</code>参数<code>count</code>为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2</span></span></span></span>，分成两个节点。<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在数据节点<code>dn2</code>上建<code>orders</code>表</li>\n<li>重启<code>MyCat</code>，让配置生效</li>\n<li>访问<code>MyCat</code>实现分片\n<ul>\n<li>在<code>MyCat</code>里向<code>orders</code>表插入数据，<code>INSERT</code>字段不能省略<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在<code>MyCat</code>、<code>dn1</code>、<code>dn2</code>中查看<code>orders</code>表数据，分表成功</li>\n</ul>\n</li>\n</ol>\n<h3> Mycat 分片后的 join 查询</h3>\n<p><code>orders</code>订单表已经进行分表操作了，和它关联的<code>orders_detail</code>订单详情表如何进行<code>join</code>查询。</p>\n<p>对<code>orders_detail</code>也要进行分片操作。</p>\n<p><code>Join</code>的原理如下图：</p>\n<p>![](<a href=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/mycat-join-horizontal\" target=\"_blank\" rel=\"noopener noreferrer\">https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/mycat-join-horizontal</a> -shard.png)</p>\n<ol>\n<li>\n<p><code>ER</code>表<br>\n<code>MyCat</code>借鉴了<code>NewSql</code>领域的新秀<code>Foundation DB</code>的设计思路，<code>Foundation DB</code>创新性的提<br>出了<code>Table Group</code>的概念，其将子表的存储位置依赖于主表，并且物理上紧邻存放，因此彻底解决了<code>Join</code>的效率和性能问题；根据这一思路，提出了基于<code>E-R</code>关系的数据分片策略，子表的记录与所关联的父表记录存放在同一个数据分片上。</p>\n<ol>\n<li>修改<code>schema.xml</code>配置文件<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在<code>dn2</code>创建<code>orders_detail</code>表</li>\n<li>重启<code>MyCat</code></li>\n<li>访问<code>MyCat</code>向<code>orders_detail</code>表插入数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在<code>MyCat</code>、<code>dn1</code>、<code>dn2</code>中运行两个表<code>join</code>语句<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>\n<p>全局表<br>\n在分片的情况下，当业务表因为规模而进行分片以后，业务表与这些附属的字典表之间的关联，<br>\n就成了比较 棘手的问题，考虑到字典表具有以下几个特性：</p>\n<ul>\n<li>变动不频繁</li>\n<li>数据量总体变化不大</li>\n<li>数据规模不大，很少有超过数十万条记录</li>\n</ul>\n<p>鉴于此，<code>MyCat</code>定义了一种特殊的表，称之为“全局表”，全局表具有以下特性：</p>\n<ul>\n<li>全局表的插入、更新操作会实时在所有节点上执行，保持各个分片的数据一致性</li>\n<li>全局表的查询操作，只从一个节点获取</li>\n<li>全局表可以跟任何一个表进行<code>Join</code>操作</li>\n</ul>\n<p>将字典表或者符合字典表特性的一些表定义为全局表，则从另外一个方面，很好的解决了数据<code>Join</code>的难题。通过全局表+基于<code>E-R</code>关系的分片策略，<code>MyCat</code>可以满足 80 % 以上的企业应用开发。</p>\n<ol>\n<li>修改<code>schema.xml</code>配置文件<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在<code>dn2</code>创建<code>dict_order_type</code>表</li>\n<li>重启<code>MyCat</code></li>\n<li>访问<code>MyCat</code>向<code>dict_order_type</code>表插入数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在<code>MyCat</code>、<code>dn1</code>、<code>dn2</code>中查询表数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n</ol>\n<h3> 常用分片规则</h3>\n<ol>\n<li>取模<br>\n此规则为对分片字段求摸运算。也是水平分表最常用规则。在<strong>实现分表</strong>中，<code>orders</code>表采用了此规则。</li>\n<li>分片枚举<br>\n通过在配置文件中配置可能的枚举<code>id</code>，自己配置分片，本规则适用于特定的场景，比如有些业务需要按照省份或区县来做保存，而全国省份区县固定的，这类业务使用本条规则。\n<ol>\n<li>\n<p>修改<code>schema.xml</code>配置文件</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>修改<code>rule.xml</code>配置文件</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li><code>columns</code>：分片字段</li>\n<li><code>algorithm</code>：分片函数</li>\n<li><code>mapFile</code>：标识配置文件名称</li>\n<li><code>type</code>：0 为<code>int</code>型、非 0 为<code>String</code></li>\n<li><code>defaultNode</code>：默认节点，小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就报错</li>\n</ul>\n</li>\n<li>\n<p>修改<code>partition-hash-int.txt</code>配置文件</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重启<code>MyCat</code></p>\n</li>\n<li>\n<p>访问<code>MyCat</code>创建表</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>插入数据</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查询<code>MyCat</code>、<code>dn1</code>、<code>dn2</code>可以看到数据分片效果</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>范围约定<br>\n此分片适用于，提前规划好分片字段某个范围属于哪个分片。\n<ol>\n<li>\n<p>修改<code>schema.xml</code>配置文件</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>修改<code>rule.xml</code>配置文件</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li><code>columns</code>：分片字段</li>\n<li><code>algorithm</code>：分片函数</li>\n<li><code>mapFile</code>：标识配置文件名称</li>\n<li><code>defaultNode</code>：默认节点，小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就报错</li>\n</ul>\n</li>\n<li>\n<p>修改<code>autopartition-long.txt</code>配置文件</p>\n<div class=\"language-txt line-numbers-mode\" data-ext=\"txt\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重启<code>MyCat</code></p>\n</li>\n<li>\n<p>访问<code>MyCat</code>创建表</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>插入数据</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查询<code>MyCat</code>、<code>dn1</code>、<code>dn2</code>可以看到数据分片效果</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>按日期（天）分片<br>\n此规则为按天分片。设定时间格式、范围\n<ol>\n<li>\n<p>修改<code>schema.xml</code>配置文件</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>修改<code>rule.xml</code>配置文件</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li><code>columns</code>：分片字段</li>\n<li><code>algorithm</code>：分片函数</li>\n<li><code>dateFormat</code>：日期格式</li>\n<li><code>sBeginDate</code>：开始日期</li>\n<li><code>sEndDate</code>：结束日期,则代表数据达到了这个日期的分片后循环从开始分片</li>\n<li><code>sPartionDay</code>：分区天数，即默认从开始日期算起，分隔 2 天一个分区</li>\n</ul>\n</li>\n<li>\n<p>重启<code>MyCat</code></p>\n</li>\n<li>\n<p>访问<code>MyCat</code>创建表</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>插入数据</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查询<code>MyCat</code>、<code>dn1</code>、<code>dn2</code>可以看到数据分片效果</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n</ol>\n<h3> 全局序列</h3>\n<p>在实现分库分表的情况下，数据库自增主键已无法保证自增主键的全局唯一；为此，<code>MyCat</code>提供了全局<code>sequence</code>，并且提供了包含本地配置和数据库配置等多种实现方式。</p>\n<ol>\n<li>\n<p>本地文件<br>\n此方式<code>MyCat</code>将<code>sequence</code>配置到文件中，当使用到<code>sequence</code>中的配置后，<code>MyCat</code>会更下<code>classpath</code>中的<code>sequence_conf.properties</code>文件中<code>sequence</code>当前的值。</p>\n<ul>\n<li>优点：本地加载，读取速度较快C</li>\n<li>缺点：抗风险能力差，<code>MyCat</code>所在主机宕机后，无法读取本地文件</li>\n</ul>\n</li>\n<li>\n<p>数据库方式<br>\n利用数据库一个表 来进行计数累加。但是并不是每次生成序列都读写数据库，这样效率太低。</p>\n<p><code>MyCat</code>会预加载一部分号段到<code>MyCat</code>的内存中，这样大部分读写序列都是在内存中完成的，如果内存中的号段用完了<code>MyCat</code>会再向数据库要一次。<br>\n问：如果<code>MyCat</code>崩溃了，那内存中的序列岂不是都没了？<br>答：是的。如果是这样，那么<code>MyCat</code>启动后会向数据库申请新的号段，原有号段会弃用；也就是说如果<code>MyCat</code>重启，那么损失是当前的号段没用完的号码，但是不会因此出现主键重复。</p>\n<ol>\n<li>\n<p>建库序列脚本</p>\n<ol>\n<li>\n<p>在<code>dn1</code>上创建全局序列表</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>创建全局序列所需函数</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>初始化序列表记录</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>\n<p>修改<code>MyCat</code>配置</p>\n<ol>\n<li>\n<p>修改<code>sequence_db_conf.properties</code><br>\n意思是<code>orders</code>这个序列在<code>dn1</code>这个节点上，具体<code>dn1</code>节点是哪台机子，请参考<code>schema.xml</code></p>\n<div class=\"language-properties line-numbers-mode\" data-ext=\"properties\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>修改<code>server.xml</code><br>\n全局序列类型：</p>\n<ul>\n<li>0：本地文件</li>\n<li>1：数据库方式</li>\n<li>2：时间戳方式</li>\n</ul>\n<p>此处应该修改成 1。</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重启<code>MyCat</code></p>\n</li>\n</ol>\n</li>\n<li>\n<p>验证全局序列</p>\n<ol>\n<li>\n<p>登录<code>MyCat</code>，插入数据</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>查询数据</p>\n<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>重启<code>MyCat</code>后，再次插入数据，再查询</p>\n</li>\n</ol>\n</li>\n</ol>\n</li>\n<li>\n<p>时间戳方式<br>\n全局序列<code>ID= 64</code>位二进制<br>\n42（毫秒）+ 5（机器 ID）+ 5（业务编码）+ 12（重复累加）换算成十进制为 18 位数的<code>long</code>类型，每毫秒可以并发 12 位二进制的累加。</p>\n<ul>\n<li>优点：配置简单</li>\n<li>缺点：18 位<code>ID</code>过长</li>\n</ul>\n</li>\n<li>\n<p>自主生成全局序列<br>\n可在<code>Java</code>项目里自己生成全局序列，如下：</p>\n<ol>\n<li>根据业务逻辑组合</li>\n<li>可以利用<code>Redis</code>的单线程原子性<code>incr</code>来生成序列，但，自主生成需要单独在工程中用<code>Java</code> 代码实现，还是推荐使用<code>MyCat</code>自带全局序列</li>\n</ol>\n</li>\n</ol>\n<h2> 基于 HA 机制的 MyCat 高可用</h2>\n<p>在实际项目中，<code>MyCat</code>服务也需要考虑高可用性，如果<code>MyCat</code>所在服务器出现宕机，或<code>MyCat</code>服<br>务故障，需要有备机提供服务，需要考虑<code>MyCat</code>集群。</p>\n<h3> 高可用方案</h3>\n<p>可以使用<code>HAProxy + Keepalived</code>配合两台<code>MyCat</code>搭起<code>MyCat</code>集群，实现高可用性。<code>HAProxy</code>实现了<code>MyCat</code>多节点的集群高可用和负载均衡，而<code>HAProxy</code>自身的高可用则可以通过<code>Keepalived</code>来实现。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/mycat-haproxy-keepalived.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<table>\n<thead>\n<tr>\n<th>编号</th>\n<th>角色</th>\n<th><code>IP</code>地址</th>\n<th>机器名</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>Mycat1</td>\n<td>192.168.140.128</td>\n<td>host79</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Mycat2<br></td>\n<td>192.168.140.127</td>\n<td>host80</td>\n</tr>\n<tr>\n<td>3</td>\n<td>HAProxy（master）</td>\n<td>192.168.140.126</td>\n<td>host81</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Keepalived（master）</td>\n<td>192.168.140.126</td>\n<td>host81</td>\n</tr>\n<tr>\n<td>5</td>\n<td>HAProxy（backup）</td>\n<td>192.168.140.125</td>\n<td>host82</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Keepalived（backup）</td>\n<td>192.168.140.125</td>\n<td>host82</td>\n</tr>\n</tbody>\n</table>\n<h3> 安装配置 HAProxy</h3>\n<ol>\n<li>安装<code>HAProxy</code>\n<ol>\n<li>\n<p>准备好<code>HAProxy</code>安装包，传到<code>/opt</code>目录下</p>\n</li>\n<li>\n<p>解压到<code>/usr/local/src</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>进入解压后的目录，查看内核版本，进行编译</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li><code>ARGET=linux310</code>：内核版本，使用<code>uname -r</code>查看内核，如：<code>3.10.0-514.el7</code>，此时该参数就为<code>linux310</code></li>\n<li><code>ARCH=x86_64</code>：系统位数</li>\n<li><code>PREFIX=/usr/local/haprpxy</code>：<code>/usr/local/haprpxy</code>，为<code>HAPrpxy</code>安装路径</li>\n</ul>\n</li>\n<li>\n<p>编译完成后，进行安装</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>安装完成后，创建目录、创建<code>HAProxy</code>配置文件</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>向配置文件中插入以下配置信息,并保存</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>启动验证\n<ol>\n<li>启动<code>HAProxy</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>查看<code>HAProxy</code>进程<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>打开浏览器访问<code>http://192.168.140.125:7777/admin</code>\n<ul>\n<li>在弹出框输入用户名：<code>admin</code>密码：<code>123456</code></li>\n<li>如果<code>MyCat</code>主备机均已启动，则可以看到如下图（<code>MyCat1</code>和<code>MyCat2</code>全绿）</li>\n</ul>\n</li>\n<li>验证负载均衡，通过<code>HAProxy</code>访问<code>MyCat</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n</ol>\n<h3> 配置 Keepalived</h3>\n<ol>\n<li>安装<code>Keepalived</code>\n<ol>\n<li>\n<p>准备好<code>Keepalived</code>安装包，传到<code>/opt</code>目录下</p>\n</li>\n<li>\n<p>解压到<code>/usr/local/src</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>安装依赖插件</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>进入解压后的目录，进行配置，进行编译</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>进行编译，完成后进行安装</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>运行前配置</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>修改配置文件</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li>启动验证\n<ol>\n<li>启动<code>Keepalived</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>登录验证<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n</ol>\n<h3> 测试高可用</h3>\n<ol>\n<li>关闭<code>MyCat</code></li>\n<li>通过虚拟<code>IP</code>查询数据<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h1> MyCat 安全设置</h1>\n<h2> 权限配置</h2>\n<h3> user 标签权限控制</h3>\n<p>目前<code>MyCat</code>对于中间件的连接控制并没有做太复杂的控制，目前只做了中间件逻辑库级别的读<br>写权限控制。是通过<code>server.xml</code>的<code>user</code>标签进行配置。</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 配置说明</h4>\n<table>\n<thead>\n<tr>\n<th>标签属性</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>name</code></td>\n<td>应用连接中间件逻辑库的用户名</td>\n</tr>\n<tr>\n<td><code>password</code></td>\n<td>该用户对应的密码</td>\n</tr>\n<tr>\n<td><code>TESTDB</code></td>\n<td>应用当前连接的逻辑库中所对应的逻辑表，<code>schemas</code>中可以配置一个或多个</td>\n</tr>\n<tr>\n<td><code>readOnly</code></td>\n<td>应用连接中间件逻辑库所具有的权限<br><code>true</code>为只读，<code>false</code>为读写都有，默认为<code>false</code><br></td>\n</tr>\n</tbody>\n</table>\n<h4> 测试案例一</h4>\n<p>使用<code>user</code>用户，权限为只读（<code>readOnly：true</code>），验证是否可以查询出数据，验证是否可以写入数据。</p>\n<ol>\n<li>用<code>user</code>用户登录<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>切换到<code>TESTDB</code>数据库，查询<code>orders</code>表数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>执行插入数据<code>sql</code>，可看到运行结果，插入失败，只有只读权限<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h4> 测试案例二</h4>\n<p>使用<code>mycat</code>用户，权限为可读写（<code>readOnly：false</code>），验证是否可以查询出数据，验证是否可以写入数据。</p>\n<ol>\n<li>用<code>mycat</code>用户登录<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>切换到<code>TESTDB</code>数据库，查询<code>orders</code>表数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>执行插入数据<code>sql</code>，可看到运行结果，插入成功<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h3> privileges 标签权限控制</h3>\n<p>在<code>user</code>标签下的<code>privileges</code>标签可以对逻辑库（<code>schema</code>）、表（<code>table</code>）进行精细化的<code>DML</code>权限控制。<br><code>privileges</code>标签下的<code>check</code>属性，如为<code>true</code>开启权限检查，为<code>false</code>不开启，默认为<code>false</code>。</p>\n<p>由于<code>Mycat</code>一个用户的<code>schemas</code>属性可配置多个逻辑库（<code>schema</code>） ，所以<code>privileges</code>的下级节点<code>schema</code>节点同样可配置多个，对多库多表进行细粒度的<code>DML</code>权限控制。</p>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 配置说明</h4>\n<table>\n<thead>\n<tr>\n<th><code>DML</code>权限</th>\n<th>增加（<code>insert</code>）</th>\n<th>更新（<code>update</code>）</th>\n<th>查询（<code>select</code>）</th>\n<th>删除（<code>delete</code>）</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0000</td>\n<td>禁止</td>\n<td>禁止</td>\n<td>禁止</td>\n<td>禁止</td>\n</tr>\n<tr>\n<td>0010</td>\n<td>禁止<br></td>\n<td>禁止</td>\n<td>可以</td>\n<td>禁止</td>\n</tr>\n<tr>\n<td>1110</td>\n<td>可以</td>\n<td>禁止</td>\n<td>禁止</td>\n<td>禁止</td>\n</tr>\n<tr>\n<td>1111</td>\n<td>可以</td>\n<td>可以</td>\n<td>可以</td>\n<td>可以</td>\n</tr>\n</tbody>\n</table>\n<h4> 测试案例一</h4>\n<p>使用<code>mycat</code>用户，<code>privileges</code>配置<code>orders</code>表权限为禁止增删改查（<code>dml=\"0000\"</code>），验证是否可以查询出数据，验证是否可以写入数据。</p>\n<ol>\n<li>重启<code>MyCat</code>，用<code>mycat</code>用户登录<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>切换到<code>TESTDB</code>数据库，查询<code>orders</code>表数据，发现禁止该用户查询数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>执行插入数据<code>sql</code>，可看到运行结果，禁止该用户插入数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h4> 测试案例二</h4>\n<p>使用<code>mycat</code>用户，<code>privileges</code>配置<code>orders</code>表权限为可以增删改查（<code>dml=\"1111\"</code>），验证是否可以查询出数据，验证是否可以写入数据。</p>\n<ol>\n<li>重启<code>MyCat</code>，用<code>mycat</code>用户登录<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>切换到<code>TESTDB</code>数据库，查询<code>orders</code>表数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>执行插入数据<code>sql</code>，可看到运行结果，插入成功<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>执行删除数据<code>sql</code>，可看到运行结果，删除成功<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h2> SQL 拦截</h2>\n<p><code>firewall</code>标签用来定义防火墙；<code>firewall</code>下<code>whitehost</code>标签用来定义<code>IP</code>白名单，<code>blacklist</code>用来定义<code>SQL</code>黑名单。</p>\n<h3> 白名单</h3>\n<p>可以通过设置白名单，实现某主机某用户可以访问<code>MyCat</code>，而其他主机用户禁止访问。</p>\n<ol>\n<li>设置白名单<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>重启<code>MyCat</code>后，<code>192.168.140.128</code>主机使用<code>mycat</code>用户访问，可以正常访问，使用<code>user</code>用户访问，禁止访问；在<code>192.168.140.127</code>主机用<code>mycat</code>用户访问，禁止访问<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h3> 黑名单</h3>\n<p>可以通过设置黑名单，实现<code>MyCat</code>对具体<code>SQL</code>操作的拦截，如增删改查等操作的拦截。</p>\n<ol>\n<li>设置黑名单<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>重启<code>MyCat</code>后，<code>192.168.140.128</code>主机使用<code>mycat</code>用户访问，可以正常访问<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>切换<code>TESTDB</code>数据库后，执行删除数据语句，发现已禁止删除数据<div class=\"language-sql line-numbers-mode\" data-ext=\"sql\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n<p>可以设置的黑名单<code>SQL</code>拦截功能列表：</p>\n<table>\n<thead>\n<tr>\n<th>配置项</th>\n<th>缺省值</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>selelctAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许执行<code>SELECT</code>语句</td>\n</tr>\n<tr>\n<td><code>deleteAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许执行<code>DELETE</code>语句</td>\n</tr>\n<tr>\n<td><code>updateAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许执行<code>UPDATE</code>语句</td>\n</tr>\n<tr>\n<td><code>insertAllow</code></td>\n<td><code>true</code><br></td>\n<td>是否允许执行<code>INSERT</code>语句</td>\n</tr>\n<tr>\n<td><code>createTableAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许创建表</td>\n</tr>\n<tr>\n<td><code>setAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许使用<code>SET</code>语法</td>\n</tr>\n<tr>\n<td><code>alterTableAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许执行<code>Alter Table</code>语句</td>\n</tr>\n<tr>\n<td><code>dropTableAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许修改表</td>\n</tr>\n<tr>\n<td><code>commitAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许执行<code>commit</code>操作</td>\n</tr>\n<tr>\n<td><code>rollbackAllow</code></td>\n<td><code>true</code></td>\n<td>是否允许执行<code>roll back</code>操作</td>\n</tr>\n</tbody>\n</table>\n<h1> MyCat 监控工具</h1>\n<h2> MyCat-Web 简介</h2>\n<p><code>Mycat-Web</code>是<code>MyCat</code>可视化运维的管理和监控平台，弥补了<code>MyCat</code>在监控上的空白。帮<code>MyCat</code>分<br>担统计任务和配置管理任务。<code>Mycat-Web</code>引入了<code>ZooKeeper</code>作为配置中心，可以管理多个节点。</p>\n<p><code>Mycat-Ceb</code>主要管理和监控<code>MyCat</code>的流量、连接、活动线程和内存等，具备<code>IP</code>白名单、邮件告警等模块，还可以统计<code>SQL</code>并分析慢<code>SQL</code>和高频<code>SQL</code>等。为优化<code>SQL</code>提供依据。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/mycat-web.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> MyCat-Web 配置使用</h2>\n<ol>\n<li><code>ZooKeeper</code>安装\n<ol>\n<li><a href=\"http://zookeeper.apache.org/\" target=\"_blank\" rel=\"noopener noreferrer\">下载安装包</a></li>\n<li>安装包拷贝到<code>Linux</code>系统<code>/opt</code>目录下，并解压<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>进入<code>ZooKeeper</code>解压后的配置目录（<code>conf</code>），复制配置文件并改名<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>进入<code>ZooKeeper</code>的命令目录（<code>bin</code>），运行启动命令<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li><code>ZooKeeper</code>服务端口为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2181</mn></mrow><annotation encoding=\"application/x-tex\">2181</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2181</span></span></span></span>，查看服务已经启动<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n<li><code>MyCat-Web</code>安装\n<ol>\n<li><a href=\"http://www.mycat.io\" target=\"_blank\" rel=\"noopener noreferrer\">下载安装包</a></li>\n<li>安装包拷贝到<code>Linux</code>系统<code>/opt</code>目录下，并解压<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>拷贝<code>mycat-web</code>文件夹到<code>/usr/local</code>目录下<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>进入<code>mycat-web</code>的目录下运行启动命令<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li><code>MyCat-Web</code>服务端口为 8082，查看服务已经启动<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>通过地址访问服务<code>http://192.168.140.127:8082/mycat/</code></li>\n</ol>\n</li>\n<li><code>MyCat-Web</code>配置\n<ol>\n<li>在注册中心配置<code>ZooKeeper</code>地址，配置后刷新页面</li>\n<li>新增<code>MyCat</code>监控实例</li>\n</ol>\n</li>\n</ol>\n<h2> Mycat 性能监控指标</h2>\n<p>在<code>Mycat-web</code>上可以进行<code>Mycat</code>性能监控，例如：内存分享、流量分析、连接分析、活动线程分析等等。</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/mycat-summary/read-write-separation.png",
      "date_published": "2023-09-06T00:00:00.000Z",
      "date_modified": "2023-08-27T07:08:54.000Z",
      "authors": [],
      "tags": [
        "MyCat"
      ]
    },
    {
      "title": "面向对象设计的 SOLID 原则",
      "url": "https://1coins.github.io/article/object-oriented/object-oriented-solid.html",
      "id": "https://1coins.github.io/article/object-oriented/object-oriented-solid.html",
      "summary": "S.O.L.I.D是面向对象设计和编程（OOD&amp;OOP）中几个重要编码原则（Programming Priciple）的首字母缩写。 简称 书籍 名称 SRP The Single Responsibility Principle 单一责任原则 OCP The Open Closed Principle 开放封闭原则 LSP The Liskov Substitution Principle 里氏替换原则 DIP The Dependency Inversion Principle 依赖倒置原则 ISP The Interface Segregation Principle 接口分离原则",
      "content_html": "<p><code>S.O.L.I.D</code>是面向对象设计和编程（<code>OOD&amp;OOP</code>）中几个重要编码原则（<code>Programming Priciple</code>）的首字母缩写。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">简称</th>\n<th style=\"text-align:center\">书籍</th>\n<th style=\"text-align:center\">名称</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><strong>SRP</strong></td>\n<td style=\"text-align:center\"><a href=\"http://www.objectmentor.com/resources/articles/srp.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">The Single Responsibility Principle</a><br></td>\n<td style=\"text-align:center\">单一责任原则</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong>OCP</strong></td>\n<td style=\"text-align:center\"><a href=\"http://www.objectmentor.com/resources/articles/ocp.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">The Open Closed Principle</a><br></td>\n<td style=\"text-align:center\">开放封闭原则</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong>LSP</strong></td>\n<td style=\"text-align:center\"><a href=\"http://www.objectmentor.com/resources/articles/lsp.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">The Liskov Substitution Principle</a></td>\n<td style=\"text-align:center\">里氏替换原则</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong>DIP</strong></td>\n<td style=\"text-align:center\"><a href=\"http://www.objectmentor.com/resources/articles/dip.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">The Dependency Inversion Principle</a></td>\n<td style=\"text-align:center\">依赖倒置原则</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong>ISP</strong></td>\n<td style=\"text-align:center\"><a href=\"http://www.objectmentor.com/resources/articles/isp.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">The Interface Segregation Principle</a></td>\n<td style=\"text-align:center\">接口分离原则</td>\n</tr>\n</tbody>\n</table>\n<p><a href=\"http://stevesmithblog.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Steve Smith</a>在5月份的微软TechED 2009上有个<a href=\"http://stevesmithblog.com/blog/teched-2009-session-aftermath/\" target=\"_blank\" rel=\"noopener noreferrer\">SOLIDify Your ASP.NET MVC</a>的讲座, <a href=\"http://www.lostechies.com/members/derick.bailey/default.aspx\" target=\"_blank\" rel=\"noopener noreferrer\">derick.bailey</a>的<a href=\"http://www.lostechies.com/blogs/derickbailey/archive/2009/02/11/solid-development-principles-in-motivational-pictures.aspx\" target=\"_blank\" rel=\"noopener noreferrer\">SOLID Development Principles – In Motivational Pictures</a>很好的解释了SOLID原则。</p>\n<h1> 单一责任原则</h1>\n<p>当需要修改某个类的时候原因有且只有一个（<code>THERE SHOULD NEVER BE MORE THAN ONE REASON FOR A CLASS TO CHANGE</code>）。换句话说就是让一个类只做一种类型责任，当这个类需要承当其他类型的责任的时候，就需要分解这个类。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/object-oriented-solid/srp.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption>Single Responsibility Principle</figcaption></figure>\n<h1> 开放封闭原则</h1>\n<p>软件实体应该是可扩展，而不可修改的。也就是说，对扩展是开放的，而对修改是封闭的。这个原则是诸多面向对象编程原则中最抽象、最难理解的一个。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/object-oriented-solid/ocp.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption>Open Closed Principle</figcaption></figure>\n<h1> 里氏替换原则</h1>\n<p>当一个子类的实例应该能够替换任何其超类的实例时，它们之间才具有<code>is-a</code>关系。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/object-oriented-solid/lsp.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption>Liskov Subtitution Principle</figcaption></figure>\n<h1> 依赖倒置原则</h1>\n<ol>\n<li>高层模块不应该依赖于低层模块，二者都应该依赖于抽象</li>\n<li>抽象不应该依赖于细节，细节应该依赖于抽象</li>\n</ol>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/object-oriented-solid/dip.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption>Dependency Inversion Principle</figcaption></figure>\n<h1> 接口分离原则</h1>\n<p>不能强迫用户去依赖那些他们不使用的接口。换句话说，使用多个专门的接口比使用单一的总接口总要好。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/object-oriented-solid/isp.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption>Interface Segregation Principle</figcaption></figure>\n<p>这几条原则是非常基础而且重要的面向对象设计原则，正是由于这些原则的基础性，理解、融汇贯通这些原则需要不少的经验和知识的积累，上述的图片很好的注释了这几条原则。</p>\n<p>‍</p>\n",
      "date_published": "2023-08-30T00:00:00.000Z",
      "date_modified": "2023-08-27T07:08:54.000Z",
      "authors": [],
      "tags": [
        "OOP"
      ]
    },
    {
      "title": "计算机网络总结",
      "url": "https://1coins.github.io/article/computer-network/computer-network-summary.html",
      "id": "https://1coins.github.io/article/computer-network/computer-network-summary.html",
      "summary": "本文是大部分内容都来自于谢希仁老师的《计算机网络》第七版 这本书。为了内容便于理解，我对之前的整理进行了重构，并配上了一些相关的示意图。",
      "content_html": "<p>本文是大部分内容都来自于谢希仁老师的<a href=\"https://www.elias.ltd/usr/local/etc/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%EF%BC%88%E7%AC%AC7%E7%89%88%EF%BC%89%E8%B0%A2%E5%B8%8C%E4%BB%81.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">《计算机网络》第七版 </a>这本书。为了内容便于理解，我对之前的整理进行了重构，并配上了一些相关的示意图。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/computer-network-xiexiren.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>相关问题：<a href=\"https://www.zhihu.com/question/327872966\" target=\"_blank\" rel=\"noopener noreferrer\">如何评价谢希仁的计算机网络（第七版）？ - 知乎</a>  。</p>\n<h2> 1. 计算机网络概述</h2>\n<h3> 1.1. 基本术语</h3>\n<ul>\n<li>\n<p><strong>结点（node）</strong> ：网络中的结点可以是计算机，集线器，交换机或路由器等</p>\n</li>\n<li>\n<p><strong>链路（link）</strong>：从一个结点到另一个结点的一段物理线路。中间没有任何其他交点</p>\n</li>\n<li>\n<p><strong>主机（host）</strong>：连接在因特网上的计算机</p>\n</li>\n<li>\n<p><strong>ISP（Internet Service Provider）</strong>：因特网服务提供者（提供商）</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/internet-service-provider.png\" alt=\"ISP (Internet Service Provider) Definition\" tabindex=\"0\" loading=\"lazy\"><figcaption>ISP (Internet Service Provider) Definition</figcaption></figure>\n</li>\n<li>\n<p><strong>IXP（Internet eXchange Point）</strong> ：互联网交换点 IXP 的主要作用就是允许两个网络直接相连并交换分组，而不需要再通过第三个网络来转发分组</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/internet-exchange-point.png\" alt=\"IXP Traffic Levels During the Stratos Skydive — RIPE Labs\" tabindex=\"0\" loading=\"lazy\"><figcaption>IXP Traffic Levels During the Stratos Skydive — RIPE Labs</figcaption></figure>\n<p style=\"text-align:center;font-size:13px;color:gray\">https://labs.ripe.net/Members/fergalc/ixp-traffic-during-stratos-skydive</p>\n</li>\n<li>\n<p><strong>RFC（Request For Comments）</strong>：意思是“请求评议”，包含了关于 Internet 几乎所有的重要的文字资料</p>\n</li>\n<li>\n<p><strong>广域网 WAN（Wide Area Network）</strong>：任务是通过长距离运送主机发送的数据</p>\n</li>\n<li>\n<p><strong>城域网 MAN（Metropolitan Area Network）</strong>：用来将多个局域网进行互连</p>\n</li>\n<li>\n<p><strong>局域网 LAN（Local Area Network）</strong>：学校或企业大多拥有多个互连的局域网</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/local-area-network.png\" alt=\"MAN &amp; WMAN | Red de área metropolitana, Redes informaticas, Par trenzado\" tabindex=\"0\" loading=\"lazy\"><figcaption>MAN &amp; WMAN | Red de área metropolitana, Redes informaticas, Par trenzado</figcaption></figure>\n<p style=\"text-align:center;font-size:13px;color:gray\">http://conexionesmanwman.blogspot.com/</p>\n</li>\n<li>\n<p><strong>个人区域网 PAN（Personal Area Network）</strong>：在个人工作的地方把属于个人使用的电子设备用无线技术连接起来的网络</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/personal-area-network.png\" alt=\"Advantages and disadvantages of personal area network (PAN) - IT Release\" tabindex=\"0\" loading=\"lazy\"><figcaption>Advantages and disadvantages of personal area network (PAN) - IT Release</figcaption></figure>\n<p style=\"text-align:center;font-size:13px;color:gray\">https://www.itrelease.com/2018/07/advantages-and-disadvantages-of-personal-area-network-pan/</p>\n</li>\n<li>\n<p><strong>分组（packet）</strong>：因特网中传送的数据单元。由首部 header 和数据段组成；分组又称为包，首部可称为包头</p>\n</li>\n<li>\n<p><strong>存储转发（store and forward）</strong>：路由器收到一个分组，先检查分组是否正确，并过滤掉冲突包错误；确定包正确后，取出目的地址，通过查找表找到想要发送的输出端口地址，然后将该包发送出去</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/store-and-forward.gif\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n<li>\n<p><strong>带宽（bandwidth）</strong>：在计算机网络中，表示在单位时间内从网络中的某一点到另一点所能通过的“最高数据率”；常用来表示网络的通信线路所能传送数据的能力；单位是“比特每秒”，记为 b/s</p>\n</li>\n<li>\n<p><strong>吞吐量（throughput）</strong>：表示在单位时间内通过某个网络（或信道、接口）的数据量；吞吐量更经常地用于对现实世界中的网络的一种测量，以便知道实际上到底有多少数据量能够通过网络；吞吐量受网络的带宽或网络的额定速率的限制</p>\n</li>\n</ul>\n<h3> 1.2. 重要知识点总结</h3>\n<ul>\n<li><strong>计算机网络（简称网络）把许多计算机连接在一起，而互联网把许多网络连接在一起，是网络的网络</strong></li>\n<li>小写字母 i 开头的 internet（互联网）是通用名词，它泛指由多个计算机网络相互连接而成的网络。在这些网络之间的通信协议（即通信规则）可以是任意的；大写字母 I 开头的 Internet（互联网）是专用名词，它指全球最大的，开放的，由众多网络相互连接而成的特定的互联网，并采用 TCP/IP 协议作为通信规则，其前身为 ARPANET；Internet 的推荐译名为因特网，现在一般流行称为互联网</li>\n<li>路由器是实现分组交换的关键构件，其任务是转发收到的分组，这是网络核心部分最重要的功能；分组交换采用存储转发技术，表示把一个报文（要发送的整块数据）分为几个分组后再进行传送；在发送报文之前，先把较长的报文划分成为一个个更小的等长数据段；在每个数据端的前面加上一些由必要的控制信息组成的首部后，就构成了一个分组；分组又称为包；分组是在互联网中传送的数据单元，正是由于分组的头部包含了诸如目的地址和源地址等重要控制信息，每一个分组才能在互联网中独立的选择传输路径，并正确地交付到分组传输的终点</li>\n<li>互联网按工作方式可划分为边缘部分和核心部分；主机在网络的边缘部分，其作用是进行信息处理；由大量网络和连接这些网络的路由器组成核心部分，其作用是提供连通性和交换</li>\n<li>计算机通信是计算机中进程（即运行着的程序）之间的通信；计算机网络采用的通信方式是客户-服务器方式（C/S 方式）和对等连接方式（P2P 方式）</li>\n<li>客户和服务器都是指通信中所涉及的应用进程；客户是服务请求方，服务器是服务提供方</li>\n<li>按照作用范围的不同，计算机网络分为广域网 WAN，城域网 MAN，局域网 LAN，个人区域网 PAN</li>\n<li><strong>计算机网络最常用的性能指标是：速率，带宽，吞吐量，时延（发送时延，处理时延，排队时延），时延带宽积，往返时间和信道利用率</strong></li>\n<li>网络协议即协议，是为进行网络中的数据交换而建立的规则；计算机网络的各层以及其协议集合，称为网络的体系结构</li>\n<li><strong>五层体系结构由应用层，运输层，网络层（网际层），数据链路层，物理层组成；运输层最主要的协议是 TCP 和 UDP 协议，网络层最重要的协议是 IP 协议</strong></li>\n</ul>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/tcp-ip.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>下面的内容会介绍计算机网络的五层体系结构：<strong>物理层+数据链路层+网络层（网际层）+运输层+应用层</strong>。</p>\n<h2> 2. 物理层（Physical Layer）</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/phsical-layer.png\" alt=\"物理层\" tabindex=\"0\" loading=\"lazy\"><figcaption>物理层</figcaption></figure>\n<h3> 2.1. 基本术语</h3>\n<ul>\n<li>\n<p><strong>数据（data）</strong>：运送消息的实体</p>\n</li>\n<li>\n<p><strong>信号（signal）</strong>：数据的电气的或电磁的表现。或者说信号是适合在传输介质上传输的对象</p>\n</li>\n<li>\n<p><strong>码元（code）</strong>：在使用时间域（或简称为时域）的波形来表示数字信号时，代表不同离散数值的基本波形</p>\n</li>\n<li>\n<p><strong>单工（simplex）</strong>：只能有一个方向的通信而没有反方向的交互</p>\n</li>\n<li>\n<p><strong>半双工（half duplex）</strong>：通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)</p>\n</li>\n<li>\n<p><strong>全双工（full duplex）</strong>：通信的双方可以同时发送和接收信息</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/duplex.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n<li>\n<p><strong>失真</strong>：失去真实性，主要是指接受到的信号和发送的信号不同，有磨损和衰减<br>\n影响失真程度的因素：</p>\n<ol>\n<li>码元传输速率</li>\n<li>信号传输距离</li>\n<li>噪声干扰</li>\n<li>传输媒体质量</li>\n</ol>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/distort.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n<li>\n<p><strong>奈氏准则</strong>：在任何信道中，码元的传输的效率是有上限的，传输速率超过此上限，就会出现严重的码间串扰问题，使接收端对码元的判决（即识别）成为不可能</p>\n</li>\n<li>\n<p><strong>香农定理</strong>：在带宽受限且有噪声的信道中，为了不产生误差，信息的数据传输速率有上限值</p>\n</li>\n<li>\n<p><strong>基带信号（baseband signal）</strong>：来自信源的信号，指没有经过调制的数字信号或模拟信号</p>\n</li>\n<li>\n<p><strong>带通（频带）信号（bandpass signal）</strong>：把基带信号经过载波调制后，把信号的频率范围搬移到较高的频段以便在信道中传输（即仅在一段频率范围内能够通过信道），这里调制过后的信号就是带通信号</p>\n</li>\n<li>\n<p><strong>调制（modulation）</strong>：对信号源的信息进行处理后加到载波信号上，使其变为适合在信道传输的形式的过程</p>\n</li>\n<li>\n<p><strong>信噪比（signal-to-noise ratio）</strong>：指信号的平均功率和噪声的平均功率之比，记为 S/N；信噪比（dB）=10*log10（S/N）</p>\n</li>\n<li>\n<p><strong>信道复用（channel multiplexing ）</strong>：指多个用户共享同一个信道（并不一定是同时）</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/channel-multiplexing.png\" alt=\"信道复用技术\" tabindex=\"0\" loading=\"lazy\"><figcaption>信道复用技术</figcaption></figure>\n</li>\n<li>\n<p><strong>比特率（bit rate ）</strong>：单位时间（每秒）内传送的比特数</p>\n</li>\n</ul>\n<ol>\n<li><strong>波特率（baud rate）</strong>：单位时间载波调制状态改变的次数。针对数据信号对载波的调制速率</li>\n</ol>\n<ul>\n<li><strong>复用（multiplexing）</strong>：共享信道的方法</li>\n<li><strong>ADSL（Asymmetric Digital Subscriber Line）</strong> ：非对称数字用户线</li>\n<li><strong>光纤同轴混合网（HFC 网）</strong>：在目前覆盖范围很广的有线电视网的基础上开发的一种居民宽带接入网</li>\n</ul>\n<h3> 2.2. 重要知识点总结</h3>\n<ul>\n<li><strong>物理层的主要任务就是确定与传输媒体接口有关的一些特性，如机械特性，电气特性，功能特性，过程特性</strong></li>\n<li>一个数据通信系统可划分为三大部分，即源系统，传输系统，目的系统；源系统包括源点（或源站，信源）和发送器，目的系统包括接收器和终点</li>\n<li><strong>通信的目的是传送消息。如话音，文字，图像等都是消息，数据是运送消息的实体。信号则是数据的电气或电磁的表现</strong></li>\n<li>根据信号中代表消息的参数的取值方式不同，信号可分为模拟信号（或连续信号）和数字信号（或离散信号）；在使用时间域（简称时域）的波形表示数字信号时，代表不同离散数值的基本波形称为码元</li>\n<li>根据双方信息交互的方式，通信可划分为单向通信（或单工通信），双向交替通信（或半双工通信），双向同时通信（全双工通信）</li>\n<li>来自信源的信号称为基带信号；信号要在信道上传输就要经过调制。调制有基带调制和带通调制之分；最基本的带通调制方法有调幅，调频和调相；还有更复杂的调制方法，如正交振幅调制</li>\n<li>要提高数据在信道上的传递速率，可以使用更好的传输媒体，或使用先进的调制技术，但数据传输速率不可能任意被提高</li>\n<li>传输媒体可分为两大类，即导引型传输媒体（双绞线，同轴电缆，光纤）和非导引型传输媒体（无线，红外，大气激光）</li>\n<li>为了有效利用光纤资源，在光纤干线和用户之间广泛使用无源光网络 PON；无源光网络无需配备电源，其长期运营成本和管理成本都很低；最流行的无源光网络是以太网无源光网络 EPON 和吉比特无源光网络 GPON</li>\n</ul>\n<h3> 2.3. 补充</h3>\n<h4> 2.3.1. 物理层主要做啥？</h4>\n<p>物理层主要做的事情就是 <strong>透明地传送比特流</strong>；也可以将物理层的主要任务描述为确定与传输媒体的接口的一些特性，即：机械特性（接口所用接线器的一些物理属性如形状和尺寸），电气特性（接口电缆的各条线上出现的电压的范围），功能特性（某条线上出现的某一电平的电压的意义），过程特性（对于不同功能的各种可能事件的出现顺序）。</p>\n<p>**物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。**现有的计算机网络中的硬件设备和传输媒体的种类非常繁多，而且通信手段也有许多不同的方式。物理层的作用正是尽可能地屏蔽掉这些传输媒体和通信手段的差异，使物理层上面的数据链路层感觉不到这些差异，这样就可以使数据链路层只考虑完成本层的协议和服务，而不必考虑网络的具体传输媒体和通信手段是什么。</p>\n<h4> 2.3.2. 几种常用的信道复用技术</h4>\n<ul>\n<li><strong>频分复用(FDM)</strong>：所有用户在同样的时间占用不同的带宽资源</li>\n<li><strong>时分复用（TDM）</strong>：所有用户在不同的时间占用同样的频带宽度（分时不分频）</li>\n<li><strong>统计时分复用 (Statistic TDM)</strong>：改进的时分复用，能够明显提高信道的利用率</li>\n<li><strong>码分复用(CDM)</strong>：用户使用经过特殊挑选的不同码型，因此各用户之间不会造成干扰；这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现</li>\n<li><strong>波分复用( WDM)</strong>：波分复用就是光的频分复用</li>\n</ul>\n<h4> 2.3.3. 几种常用的宽带接入技术，主要是 ADSL 和 FTTx</h4>\n<p>用户到互联网的宽带接入方法有非对称数字用户线 ADSL（用数字技术对现有的模拟电话线进行改造，而不需要重新布线，ADSL 的快速版本是甚高速数字用户线 VDSL），光纤同轴混合网 HFC（是在目前覆盖范围很广的有线电视网的基础上开发的一种居民宽带接入网）和 FTTx（即光纤到······）。</p>\n<h2> 3. 数据链路层（Data Link Layer）</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/data-link-layer.png\" alt=\"数据链路层\" tabindex=\"0\" loading=\"lazy\"><figcaption>数据链路层</figcaption></figure>\n<h3> 3.1. 基本术语</h3>\n<ul>\n<li>\n<p><strong>链路（link）</strong>：一个结点到相邻结点的一段物理链路</p>\n</li>\n<li>\n<p><strong>数据链路（data link）</strong>：把实现控制数据运输的协议的硬件和软件加到链路上就构成了数据链路</p>\n</li>\n<li>\n<p><strong>循环冗余检验 CRC（Cyclic Redundancy Check）</strong>：为了保证数据传输的可靠性，CRC 是数据链路层广泛使用的一种检错技术</p>\n</li>\n<li>\n<p><strong>帧（frame）</strong>：一个数据链路层的传输单元，由一个数据链路层首部和其携带的封包所组成协议数据单元</p>\n</li>\n<li>\n<p><strong>MTU（Maximum Transfer Uint）</strong>：最大传送单元。帧的数据部分的的长度上限</p>\n</li>\n<li>\n<p><strong>误码率 BER（Bit Error Rate）</strong>：在一段时间内，传输错误的比特占所传输比特总数的比率</p>\n</li>\n<li>\n<p><strong>PPP（Point-to-Point Protocol）</strong>：点对点协议，即用户计算机和 ISP 进行通信时所使用的数据链路层协议；以下是 PPP 帧的示意图：<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/point-to-point-protocol.png\" alt=\"PPP\" loading=\"lazy\"></p>\n</li>\n<li>\n<p><strong>MAC 地址（Media Access Control 或者 Medium Access Control）</strong> ：意译为媒体访问控制，或称为物理地址、硬件地址，用来定义网络设备的位置；在 OSI 模型中，第三层网络层负责 IP 地址，第二层数据链路层则负责 MAC 地址，因此一个主机会有一个 MAC 地址，而每个网络位置会有一个专属于它的 IP 地址；地址是识别某个系统的重要标识符，“名字指出我们所要寻找的资源，地址指出资源所在的地方，路由告诉我们如何到达该处”</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/address-resolution-protocol.png\" alt=\"ARP (Address Resolution Protocol) explained\" tabindex=\"0\" loading=\"lazy\"><figcaption>ARP (Address Resolution Protocol) explained</figcaption></figure>\n</li>\n<li>\n<p><strong>网桥（bridge）</strong>：一种用于数据链路层实现中继，连接两个或多个局域网的网络互连设备</p>\n</li>\n<li>\n<p><strong>交换机（switch ）</strong>：广义的来说，交换机指的是一种通信系统中完成信息交换的设备；这里工作在数据链路层的交换机指的是交换式集线器，其实质是一个多接口的网桥</p>\n</li>\n</ul>\n<h3> 3.2. 重要知识点总结</h3>\n<ul>\n<li>链路是从一个结点到相邻结点的一段物理链路，数据链路则在链路的基础上增加了一些必要的硬件（如网络适配器）和软件（如协议的实现）</li>\n<li>数据链路层使用的主要是<strong>点对点信道</strong>和<strong>广播信道</strong>两种</li>\n<li>数据链路层传输的协议数据单元是帧；数据链路层的三个基本问题是：<strong>封装成帧</strong>，<strong>透明传输</strong>和<strong>差错检测</strong></li>\n<li><strong>循环冗余检验 CRC</strong> 是一种检错方法，而帧检验序列 FCS 是添加在数据后面的冗余码</li>\n<li><strong>点对点协议 PPP</strong> 是数据链路层使用最多的一种协议；它的特点是：简单，只检测差错而不去纠正差错，不使用序号，也不进行流量控制，可同时支持多种网络层协议</li>\n<li>PPPoE 是为宽带上网的主机使用的链路层协议</li>\n<li><strong>局域网的优点是：具有广播功能，从一个站点可方便地访问全网；便于系统的扩展和逐渐演变；提高了系统的可靠性，可用性和生存性</strong></li>\n<li>计算机与外接局域网通信需要通过通信适配器（或网络适配器），它又称为网络接口卡或网卡；<strong>计算器的硬件地址就在适配器的 ROM 中</strong></li>\n<li>以太网采用的无连接的工作方式，对发送的数据帧不进行编号，也不要求对方发回确认；目的站收到有差错帧就把它丢掉，其他什么也不做</li>\n<li>以太网采用的协议是具有冲突检测的<strong>载波监听多点接入 CSMA/CD</strong>；协议的特点是：<strong>发送前先监听，边发送边监听，一旦发现总线上出现了碰撞，就立即停止发送。然后按照退避算法等待一段随机时间后再次发送</strong>； 因此，每一个站点在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。以太网上的各站点平等地争用以太网信道</li>\n<li>以太网的适配器具有过滤功能，它只接收单播帧，广播帧和多播帧</li>\n<li>使用集线器可以在物理层扩展以太网（扩展后的以太网仍然是一个网络）</li>\n</ul>\n<h3> 3.3. 补充</h3>\n<ul>\n<li>数据链路层的点对点信道和广播信道的特点，以及这两种信道所使用的协议（PPP 协议以及 CSMA/CD 协议）的特点</li>\n<li>数据链路层的三个基本问题：<strong>封装成帧</strong>，<strong>透明传输</strong>，<strong>差错检测</strong></li>\n<li>以太网的 MAC 层硬件地址</li>\n<li>适配器，转发器，集线器，网桥，以太网交换机的作用以及适用场合</li>\n</ul>\n<h2> 4. 网络层（Network Layer）</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/network-layer.png\" alt=\"网络层\" tabindex=\"0\" loading=\"lazy\"><figcaption>网络层</figcaption></figure>\n<h3> 4.1. 基本术语</h3>\n<ul>\n<li><strong>虚电路（Virtual Circuit）</strong>: 在两个终端设备的逻辑或物理端口之间，通过建立的双向的透明传输通道；虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接</li>\n<li><strong>IP（Internet Protocol）</strong>: 网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一，是 TCP/IP 体系结构网际层的核心；配套的有 ARP，RARP，ICMP，IGMP</li>\n<li><strong>ARP（Address Resolution Protocol）</strong>: 地址解析协议；地址解析协议 ARP 把 IP 地址解析为硬件地址</li>\n<li><strong>ICMP（Internet Control Message Protocol）</strong>：网际控制报文协议 （ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告）</li>\n<li><strong>子网掩码（subnet mask）</strong>：它是一种用来指明一个 IP 地址的哪些位标识的是主机所在的子网以及哪些位标识的是主机的位掩码；子网掩码不能单独存在，它必须结合 IP 地址一起使用。</li>\n<li><strong>CIDR（Classless Inter-Domain Routing ）</strong>：无分类域间路由选择；特点是消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，并使用各种长度的“网络前缀”（network-prefix）来代替分类地址中的网络号和子网号</li>\n<li><strong>默认路由（default route）</strong>：当在路由表中查不到能到达目的地址的路由时，路由器选择的路由；默认路由还可以减小路由表所占用的空间和搜索路由表所用的时间</li>\n<li><strong>路由选择算法（Virtual Circuit）</strong>：路由选择协议的核心部分；因特网采用自适应的，分层次的路由选择协议</li>\n</ul>\n<h3> 4.2. 重要知识点总结</h3>\n<ul>\n<li>\n<p><strong>TCP/IP 协议中的网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务；网络层不提供服务质量的承诺，不保证分组交付的时限所传送的分组可能出错，丢失，重复和失序；进程之间通信的可靠性由运输层负责</strong></p>\n</li>\n<li>\n<p>在互联网的交付有两种，一是在本网络直接交付不用经过路由器，另一种是和其他网络的间接交付，至少经过一个路由器，但最后一次一定是直接交付</p>\n</li>\n<li>\n<p>分类的 IP 地址由网络号字段（指明网络）和主机号字段（指明主机）组成。网络号字段最前面的类别指明 IP 地址的类别；IP 地址是一种分等级的地址结构。IP 地址管理机构分配 IP 地址时只分配网络号，主机号由得到该网络号的单位自行分配。路由器根据目的主机所连接的网络号来转发分组；一个路由器至少连接到两个网络，所以一个路由器至少应当有两个不同的 IP 地址</p>\n</li>\n<li>\n<p>IP 数据报分为首部和数据两部分；首部的前一部分是固定长度，共 20 字节，是所有 IP 数据包必须具有的（源地址，目的地址，总长度等重要地段都固定在首部）；一些长度可变的可选字段固定在首部的后面；IP 首部中的生存时间给出了 IP 数据报在互联网中所能经过的最大路由器数，可防止 IP 数据报在互联网中无限制的兜圈子</p>\n</li>\n<li>\n<p><strong>地址解析协议 ARP 把 IP 地址解析为硬件地址；ARP 的高速缓存可以大大减少网络上的通信量；因为这样可以使主机下次再与同样地址的主机通信时，可以直接从高速缓存中找到所需要的硬件地址而不需要再去以广播方式发送 ARP 请求分组</strong></p>\n</li>\n<li>\n<p>无分类域间路由选择 CIDR 是解决目前 IP 地址紧缺的一个好办法；CIDR 记法在 IP 地址后面加上斜线“/”，然后写上前缀所占的位数；前缀（或网络前缀）用来指明网络，前缀后面的部分是后缀，用来指明主机。CIDR 把前缀都相同的连续的 IP 地址组成一个“CIDR 地址块”，IP 地址分配都以 CIDR 地址块为单位</p>\n</li>\n<li>\n<p>网际控制报文协议是 IP 层的协议。ICMP 报文作为 IP 数据报的数据，加上首部后组成 IP 数据报发送出去；使用 ICMP 数据报并不是为了实现可靠传输；ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告；ICMP 报文的种类有两种，即 ICMP 差错报告报文和 ICMP 询问报文</p>\n</li>\n<li>\n<p><strong>要解决 IP 地址耗尽的问题，最根本的办法是采用具有更大地址空间的新版本 IP 协议-IPv6</strong>；IPv6 所带来的变化有：</p>\n<ol>\n<li>更大的地址空间（采用 128 位地址）</li>\n<li>灵活的首部格式</li>\n<li>改进的选项</li>\n<li>支持即插即用</li>\n<li>支持资源的预分配</li>\n<li>IPv6 的首部改为 8 字节对齐</li>\n</ol>\n</li>\n<li>\n<p><strong>虚拟专用网络 VPN 利用公用的互联网作为本机构专用网之间的通信载体；VPN 内使用互联网的专用地址，一个 VPN 至少要有一个路由器具有合法的全球 IP 地址，这样才能和本系统的另一个 VPN 通过互联网进行通信；所有通过互联网传送的数据都需要加密</strong></p>\n</li>\n<li>\n<p>MPLS 的特点是：</p>\n<ol>\n<li>支持面向连接的服务质量</li>\n<li>支持流量工程，平衡网络负载</li>\n<li>有效的支持虚拟专用网 VPN</li>\n</ol>\n<p>MPLS 在入口节点给每一个 IP 数据报打上固定长度的“标记”，然后根据标记在第二层（链路层）用硬件进行转发（在标记交换路由器中进行标记交换），因而转发速率大大加快。</p>\n</li>\n</ul>\n<h2> 5. 传输层（Transport Layer）</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/transport-layer.png\" alt=\"传输层\" tabindex=\"0\" loading=\"lazy\"><figcaption>传输层</figcaption></figure>\n<h3> 5.1. 基本术语</h3>\n<ul>\n<li>\n<p><strong>进程（process）</strong>：指计算机中正在运行的程序实体</p>\n</li>\n<li>\n<p><strong>应用进程互相通信</strong>：一台主机的进程和另一台主机中的一个进程交换数据的过程（另外注意通信真正的端点不是主机而是主机中的进程，也就是说端到端的通信是应用进程之间的通信）</p>\n</li>\n<li>\n<p><strong>传输层的复用与分用</strong>：复用指发送方不同的进程都可以通过同一个运输层协议传送数据；分用指接收方的运输层在剥去报文的首部后能把这些数据正确的交付到目的应用进程</p>\n</li>\n<li>\n<p><strong>TCP（Transmission Control Protocol）</strong>：传输控制协议</p>\n</li>\n<li>\n<p><strong>UDP（User Datagram Protocol）</strong>：用户数据报协议</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/tcp-and-udp.png\" alt=\"TCP和UDP\" tabindex=\"0\" loading=\"lazy\"><figcaption>TCP和UDP</figcaption></figure>\n</li>\n<li>\n<p><strong>端口（port）</strong>：端口的目的是为了确认对方机器的哪个进程在与自己进行交互，比如 MSN 和 QQ 的端口不同，如果没有端口就可能出现 QQ 进程和 MSN 交互错误。端口又称协议端口号</p>\n</li>\n<li>\n<p><strong>停止等待协议（stop-and-wait）</strong>：指发送方每发送完一个分组就停止发送，等待对方确认，在收到确认之后在发送下一个分组</p>\n</li>\n<li>\n<p><strong>流量控制</strong>: 就是让发送方的发送速率不要太快，既要让接收方来得及接收，也不要使网络发生拥塞</p>\n</li>\n<li>\n<p><strong>拥塞控制</strong>：防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷</p>\n</li>\n</ul>\n<h3> 5.2. 重要知识点总结</h3>\n<ul>\n<li><strong>运输层提供应用进程之间的逻辑通信，也就是说，运输层之间的通信并不是真正在两个运输层之间直接传输数据。运输层向应用层屏蔽了下面网络的细节（如网络拓补，所采用的路由选择协议等），它使应用进程之间看起来好像两个运输层实体之间有一条端到端的逻辑通信信道</strong></li>\n<li><strong>网络层为主机提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信</strong></li>\n<li>运输层的两个重要协议是用户数据报协议 UDP 和传输控制协议 TCP；按照 OSI 的术语，两个对等运输实体在通信时传送的数据单位叫做运输协议数据单元 TPDU（Transport Protocol Data Unit）；但在 TCP/IP 体系中，则根据所使用的协议是 TCP 或 UDP，分别称之为 TCP 报文段或 UDP 用户数据报</li>\n<li><strong>UDP 在传送数据之前不需要先建立连接，远地主机在收到 UDP 报文后，不需要给出任何确认；虽然 UDP 不提供可靠交付，但在某些情况下 UDP 确是一种最有效的工作方式；TCP 提供面向连接的服务；在传送数据之前必须先建立连接，数据传送结束后要释放连接；TCP 不提供广播或多播服务；由于 TCP 要提供可靠的，面向连接的传输服务，难以避免地增加了许多开销，如确认，流量控制，计时器以及连接管理等；这不仅使协议数据单元的首部增大很多，还要占用许多处理机资源</strong></li>\n<li>硬件端口是不同硬件设备进行交互的接口，而软件端口是应用层各种协议进程与运输实体进行层间交互的一种地址；UDP 和 TCP 的首部格式中都有源端口和目的端口这两个重要字段；当运输层收到 IP 层交上来的运输层报文时，就能够根据其首部中的目的端口号把数据交付应用层的目的应用层（两个进程之间进行通信不光要知道对方 IP 地址而且要知道对方的端口号(为了找到对方计算机中的应用进程)）</li>\n<li>运输层用一个 16 位端口号标志一个端口；端口号只有本地意义，它只是为了标志计算机应用层中的各个进程在和运输层交互时的层间接口；在互联网的不同计算机中，相同的端口号是没有关联的。协议端口号简称端口；虽然通信的终点是应用进程，但只要把所发送的报文交到目的主机的某个合适端口，剩下的工作（最后交付目的进程）就由 TCP 和 UDP 来完成</li>\n<li>运输层的端口号分为服务器端使用的端口号（0˜1023 指派给熟知端口，1024˜49151 是登记端口号）和客户端暂时使用的端口号（49152˜65535）</li>\n<li>UDP 的主要特点是：\n<ol>\n<li>无连接</li>\n<li>尽最大努力交付</li>\n<li>面向报文</li>\n<li>无拥塞控制</li>\n<li>支持一对一，一对多，多对一和多对多的交互通信</li>\n<li>首部开销小（只有四个字段：源端口，目的端口，长度和检验和）</li>\n</ol>\n</li>\n<li>TCP 的主要特点是：\n<ol>\n<li>面向连接</li>\n<li>每一条 TCP 连接只能是一对一的</li>\n<li>提供可靠交付</li>\n<li>提供全双工通信</li>\n<li>面向字节流</li>\n</ol>\n</li>\n<li><strong>TCP 用主机的 IP 地址加上主机上的端口号作为 TCP 连接的端点。这样的端点就叫做套接字（socket）或插口；套接字用（IP 地址：端口号）来表示；每一条 TCP 连接唯一地被通信两端的两个端点所确定</strong></li>\n<li>停止等待协议是为了实现可靠传输的；它的基本原理就是每发完一个分组就停止发送，等待对方确认。在收到确认后再发下一个分组</li>\n<li>为了提高传输效率，发送方可以不使用低效率的停止等待协议，而是采用流水线传输；流水线传输就是发送方可连续发送多个分组，不必每发完一个分组就停下来等待对方确认，这样可使信道上一直有数据不间断的在传送；这种传输方式可以明显提高信道利用率</li>\n<li>停止等待协议中超时重传是指只要超过一段时间仍然没有收到确认，就重传前面发送过的分组（认为刚才发送过的分组丢失了）；因此每发送完一个分组需要设置一个超时计时器，其重传时间应比数据在分组传输的平均往返时间更长一些；这种自动重传方式常称为自动重传请求 ARQ；另外在停止等待协议中若收到重复分组，就丢弃该分组，但同时还要发送确认；连续 ARQ 协议可提高信道利用率。发送维持一个发送窗口，凡位于发送窗口内的分组可连续发送出去，而不需要等待对方确认；接收方一般采用累积确认，对按序到达的最后一个分组发送确认，表明到这个分组位置的所有分组都已经正确收到了</li>\n<li>TCP 报文段的前 20 个字节是固定的，其后有 40 字节长度的可选字段；如果加入可选字段后首部长度不是 4 的整数倍字节，需要在再在之后用 0 填充；因此，TCP 首部的长度取值为 20+4n 字节，最长为 60 字节</li>\n<li><strong>TCP 使用滑动窗口机制，发送窗口里面的序号表示允许发送的序号；发送窗口后沿的后面部分表示已发送且已收到确认，而发送窗口前沿的前面部分表示不允许发送；发送窗口后沿的变化情况有两种可能，即不动（没有收到新的确认）和前移（收到了新的确认）；发送窗口的前沿通常是不断向前移动的；一般来说，我们总是希望数据传输更快一些，但如果发送方把数据发送的过快，接收方就可能来不及接收，这就会造成数据的丢失；所谓流量控制就是让发送方的发送速率不要太快，要让接收方来得及接收</strong></li>\n<li>在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏，这种情况就叫拥塞；拥塞控制就是为了防止过多的数据注入到网络中，这样就可以使网络中的路由器或链路不致过载；拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷；拥塞控制是一个全局性的过程，涉及到所有的主机，所有的路由器，以及与降低网络传输性能有关的所有因素；相反，流量控制往往是点对点通信量的控制，是个端到端的问题，流量控制所要做到的就是抑制发送端发送数据的速率，以便使接收端来得及接收</li>\n<li><strong>为了进行拥塞控制，TCP 发送方要维持一个拥塞窗口 cwnd 的状态变量；拥塞控制窗口的大小取决于网络的拥塞程度，并且动态变化；发送方让自己的发送窗口取为拥塞窗口和接收方的接受窗口中较小的一个</strong></li>\n<li><strong>TCP 的拥塞控制采用了四种算法，即慢开始，拥塞避免，快重传和快恢复；在网络层也可以使路由器采用适当的分组丢弃策略（如主动队列管理 AQM），以减少网络拥塞的发生</strong></li>\n<li>运输连接的三个阶段，即：连接建立，数据传送和连接释放</li>\n<li><strong>主动发起 TCP 连接建立的应用进程叫做客户，而被动等待连接建立的应用进程叫做服务器；TCP 连接采用三报文握手机制。服务器要确认用户的连接请求，然后客户要对服务器的确认进行确认</strong></li>\n<li>TCP 的连接释放采用四报文握手机制。任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态；当另一方也没有数据再发送时，则发送连接释放通知，对方确认后就完全关闭了 TCP 连接</li>\n</ul>\n<h3> 5.3. 补充（重要）</h3>\n<p>以下知识点需要重点关注：</p>\n<ul>\n<li>端口和套接字的意义</li>\n<li>UDP 和 TCP 的区别以及两者的应用场景</li>\n<li>在不可靠的网络上实现可靠传输的工作原理，停止等待协议和 ARQ 协议</li>\n<li>TCP 的滑动窗口，流量控制，拥塞控制和连接管理</li>\n<li>TCP 的三次握手，四次挥手机制</li>\n</ul>\n<h2> 6. 应用层（Application Layer）</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/applicaion-layer.png\" alt=\"应用层\" tabindex=\"0\" loading=\"lazy\"><figcaption>应用层</figcaption></figure>\n<h3> 6.1. 基本术语</h3>\n<ul>\n<li>\n<p><strong>域名系统（DNS）</strong>：域名系统（DNS，Domain Name System）将人类可读的域名 (例如，<a href=\"http://www.baidu.com\" target=\"_blank\" rel=\"noopener noreferrer\">www.baidu.com</a>) 转换为机器可读的 IP 地址 (例如，220.181.38.148)；我们可以将其理解为专为互联网设计的电话薄</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/dns.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p style=\"text-align:right;font-size:12px\">https://www.seobility.net/en/wiki/HTTP_headers</p>\n</li>\n<li>\n<p><strong>文件传输协议（FTP）</strong>：FTP 是 File Transfer Protocol（文件传输协议）的英文简称，而中文简称为“文传协议”；用于 Internet 上的控制文件的双向传输。同时，它也是一个应用程序（Application）；基于不同的操作系统有不同的 FTP 应用程序，而所有这些应用程序都遵守同一种协议以传输文件；在 FTP 的使用当中，用户经常遇到两个概念：\"下载\"（Download）和\"上传\"（Upload）； \"下载\"文件就是从远程主机拷贝文件至自己的计算机上；\"上传\"文件就是将文件从自己的计算机中拷贝至远程主机上；用 Internet 语言来说，用户可通过客户机程序向（从）远程主机上传（下载）文件</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/ftp.png\" alt=\"FTP工作过程\" tabindex=\"0\" loading=\"lazy\"><figcaption>FTP工作过程</figcaption></figure>\n</li>\n<li>\n<p><strong>简单文件传输协议（TFTP）</strong>：TFTP（Trivial File Transfer Protocol,简单文件传输协议）是 TCP/IP 协议族中的一个用来在客户机与服务器之间进行简单文件传输的协议，提供不复杂、开销不大的文件传输服务，端口号为 69</p>\n</li>\n<li>\n<p><strong>远程终端协议（TELNET）</strong>：Telnet 协议是 TCP/IP 协议族中的一员，是 Internet 远程登陆服务的标准协议和主要方式，它为用户提供了在本地计算机上完成远程主机工作的能力；在终端使用者的电脑上使用 Telnet 程序，用它连接到服务器。终端使用者可以在 Telnet 程序中输入命令，这些命令会在服务器上运行，就像直接在服务器的控制台上输入一样，可以在本地就能控制服务器；要开始一个 Telnet 会话，必须输入用户名和密码来登录服务器；Telnet 是常用的远程控制 Web 服务器的方法</p>\n</li>\n<li>\n<p><strong>万维网（WWW）</strong>：WWW 是环球信息网的缩写，（亦作“Web”、“WWW”、“'W3'”，英文全称为“World Wide Web”），中文名字为“万维网”，\"环球网\"等，常简称为 Web，分为 Web 客户端和 Web 服务器程序；WWW 可以让 Web 客户端（常用浏览器）访问浏览 Web 服务器上的页面，是一个由许多互相链接的超文本组成的系统，通过互联网访问；在这个系统中，每个有用的事物，称为一样“资源”，并且由一个全局“统一资源标识符”（URI）标识；这些资源通过超文本传输协议（Hypertext Transfer Protocol）传送给用户，而后者通过点击链接来获得资源；万维网联盟（英语：World Wide Web Consortium，简称 W3C），又称 W3C 理事会，1994 年 10 月在麻省理工学院（MIT）计算机科学实验室成立；万维网联盟的创建者是万维网的发明者蒂姆·伯纳斯-李，万维网并不等同互联网，万维网只是互联网所能提供的服务其中之一，是靠着互联网运行的一项服务</p>\n</li>\n<li>\n<p><strong>万维网的大致工作工程：</strong></p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/www.png\" alt=\"万维网的大致工作工程\" tabindex=\"0\" loading=\"lazy\"><figcaption>万维网的大致工作工程</figcaption></figure>\n</li>\n<li>\n<p><strong>统一资源定位符（URL）</strong>：统一资源定位符是对可以从互联网上得到的资源的位置和访问方法的一种简洁的表示，是互联网上标准资源的地址；互联网上的每个文件都有一个唯一的 URL，它包含的信息指出文件的位置以及浏览器应该怎么处理它</p>\n</li>\n<li>\n<p><strong>超文本传输协议（HTTP）</strong>：超文本传输协议（HTTP，HyperText Transfer Protocol)是互联网上应用最为广泛的一种网络协议；所有的 WWW 文件都必须遵守这个标准。设计 HTTP 最初的目的是为了提供一种发布和接收 HTML 页面的方法；1960 年美国人 Ted Nelson 构思了一种通过计算机处理文本信息的方法，并称之为超文本（hypertext）,这成为了 HTTP 超文本传输协议标准架构的发展根基</p>\n<p>HTTP 协议的本质就是一种浏览器与服务器之间约定好的通信格式。HTTP 的原理如下图所示：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/http.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n</li>\n<li>\n<p><strong>代理服务器（Proxy Server）</strong>：代理服务器（Proxy Server）是一种网络实体，它又称为万维网高速缓存；代理服务器把最近的一些请求和响应暂存在本地磁盘中，当新请求到达时，若代理服务器发现这个请求与暂时存放的的请求相同，就返回暂存的响应，而不需要按 URL 的地址再次去互联网访问该资源；代理服务器可在客户端或服务器工作，也可以在中间系统工作</p>\n</li>\n<li>\n<p><strong>简单邮件传输协议(SMTP)</strong>：SMTP（Simple Mail Transfer Protocol）即简单邮件传输协议，它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式；SMTP 协议属于 TCP/IP 协议簇，它帮助每台计算机在发送或中转信件时找到下一个目的地；通过 SMTP 协议所指定的服务器,就可以把 E-mail 寄到收信人的服务器上了，整个过程只要几分钟；SMTP 服务器则是遵循 SMTP 协议的发送邮件服务器，用来发送或中转发出的电子邮件</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/smtp.png\" alt=\"一个电子邮件被发送的过程\" tabindex=\"0\" loading=\"lazy\"><figcaption>一个电子邮件被发送的过程</figcaption></figure>\n<p style=\"text-align:right;font-size:12px\">https://www.campaignmonitor.com/resources/knowledge-base/what-is-the-code-that-makes-bcc-or-cc-operate-in-an-email/</p>\n</li>\n<li>\n<p><strong>搜索引擎</strong>：搜索引擎（Search Engine）是指根据一定的策略、运用特定的计算机程序从互联网上搜集信息，在对信息进行组织和处理后，为用户提供检索服务，将用户检索相关的信息展示给用户的系统；搜索引擎包括全文索引、目录索引、元搜索引擎、垂直搜索引擎、集合式搜索引擎、门户搜索引擎与免费链接列表等</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/search-engine.png\" alt=\"搜索引擎\" tabindex=\"0\" loading=\"lazy\"><figcaption>搜索引擎</figcaption></figure>\n</li>\n<li>\n<p><strong>垂直搜索引擎</strong>：垂直搜索引擎是针对某一个行业的专业搜索引擎，是搜索引擎的细分和延伸，是对网页库中的某类专门的信息进行一次整合，定向分字段抽取出需要的数据进行处理后再以某种形式返回给用户；垂直搜索是相对通用搜索引擎的信息量大、查询不准确、深度不够等提出来的新的搜索引擎服务模式，通过针对某一特定领域、某一特定人群或某一特定需求提供的有一定价值的信息和相关服务；其特点就是“专、精、深”，且具有行业色彩，相比较通用搜索引擎的海量信息无序化，垂直搜索引擎则显得更加专注、具体和深入</p>\n</li>\n<li>\n<p><strong>全文索引</strong>：全文索引技术是目前搜索引擎的关键技术；试想在 1M 大小的文件中搜索一个词，可能需要几秒，在 100M 的文件中可能需要几十秒，如果在更大的文件中搜索那么就需要更大的系统开销，这样的开销是不现实的；所以在这样的矛盾下出现了全文索引技术，有时候有人叫倒排文档技术</p>\n</li>\n<li>\n<p><strong>目录索引</strong>：目录索引（search index/directory)，顾名思义就是将网站分门别类地存放在相应的目录中，因此用户在查询信息时，可选择关键词搜索，也可按分类目录逐层查找</p>\n</li>\n</ul>\n<h3> 6.2. 重要知识点总结</h3>\n<ul>\n<li>文件传输协议（FTP）使用 TCP 可靠的运输服务；FTP 使用客户服务器方式。一个 FTP 服务器进程可以同时为多个用户提供服务；在进行文件传输时，FTP 的客户和服务器之间要先建立两个并行的 TCP 连接：控制连接和数据连接。实际用于传输文件的是数据连接</li>\n<li>万维网客户程序与服务器之间进行交互使用的协议是超文本传输协议 HTTP，HTTP 使用 TCP 连接进行可靠传输；但 HTTP 本身是无连接、无状态的，HTTP/1.1 协议使用了持续连接（分为非流水线方式和流水线方式）</li>\n<li>电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可随时上网到自己使用的邮件服务器读取，相当于电子邮箱</li>\n<li>一个电子邮件系统有三个重要组成构件：用户代理、邮件服务器、邮件协议（包括邮件发送协议，如 SMTP，和邮件读取协议，如 POP3 和 IMAP）；用户代理和邮件服务器都要运行这些协议</li>\n</ul>\n<h3> 6.3. 补充（重要）</h3>\n<p>以下知识点需要重点关注：</p>\n<ul>\n<li>应用层的常见协议（重点关注 HTTP 协议）</li>\n<li>域名系统-从域名解析出 IP 地址</li>\n<li>访问一个网站大致的过程</li>\n<li>系统调用和应用编程接口概念</li>\n</ul>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/computer-network-summary/computer-network-xiexiren.png",
      "date_published": "2023-07-21T00:00:00.000Z",
      "date_modified": "2023-08-21T16:04:04.000Z",
      "authors": [],
      "tags": [
        "计算机基础"
      ]
    },
    {
      "title": "OSI 和 TCP-IP 网络分层模型详解",
      "url": "https://1coins.github.io/article/computer-network/osi-and-tcp-ip-model.html",
      "id": "https://1coins.github.io/article/computer-network/osi-and-tcp-ip-model.html",
      "summary": "OSI 七层模型 OSI 七层模型 是国际标准化组织提出一个网络分层模型，其大体结构以及每一层提供的功能如下图所示： OSI 七层模型 每一层都专注做一件事情，并且每一层都需要使用下一层提供的功能；比如传输层需要使用网络层提供的路由和寻址功能，这样传输层才知道把数据传输到哪里去。",
      "content_html": "<h2> OSI 七层模型</h2>\n<p><strong>OSI 七层模型</strong> 是国际标准化组织提出一个网络分层模型，其大体结构以及每一层提供的功能如下图所示：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/osi-seven-model-1.png\" alt=\"OSI 七层模型\" tabindex=\"0\" loading=\"lazy\"><figcaption>OSI 七层模型</figcaption></figure>\n<p>每一层都专注做一件事情，并且每一层都需要使用下一层提供的功能；比如传输层需要使用网络层提供的路由和寻址功能，这样传输层才知道把数据传输到哪里去。</p>\n<p><strong>OSI 的七层体系结构概念清楚，理论也很完整，但是它比较复杂而且不实用，并且有些功能在多个层中重复出现。</strong></p>\n<p>上面的图可能比较抽象，下面这个图片是我在国外的一个网站上看到的，比较生动：</p>\n<p>​<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/osi-seven-model-2.png\" alt=\"osi七层模型2\" loading=\"lazy\">​</p>\n<p><strong>既然 OSI 七层模型这么厉害，为什么干不过 TCP/IP 四层模型呢？</strong></p>\n<p>的确，OSI 七层模型当时一直被一些大公司甚至国家政府支持；这样的背景下，为什么会失败？我觉得主要有下面几方面原因：</p>\n<ol>\n<li>OSI 的专家缺乏实际经验，他们在完成 OSI 标准时缺乏商业驱动力</li>\n<li>OSI 的协议实现起来过分复杂，而且运行效率很低</li>\n<li>OSI 制定标准的周期太长，因而使得按 OSI 标准生产的设备无法及时进入市场（20 世纪 90 年代初期，虽然整套的 OSI 国际标准都已经制定出来，但基于 TCP/IP 的互联网已经抢先在全球相当大的范围成功运行了）</li>\n<li>OSI 的层次划分不太合理，有些功能在多个层次中重复出现</li>\n</ol>\n<p>OSI 七层模型虽然失败了，但是却提供了很多不错的理论基础。为了更好地去了解网络分层，OSI 七层模型还是非常有必要学习的。</p>\n<p>最后是一个关于 OSI 七层模型的总结图片！</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/osi-model-detail.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> TCP/IP 四层模型</h2>\n<p><strong>TCP/IP 四层模型</strong>是目前被广泛采用的一种模型，可以将 TCP / IP 模型看作是 OSI 七层模型的精简版本，由以下 4 层组成：</p>\n<ol>\n<li>应用层</li>\n<li>传输层</li>\n<li>网络层</li>\n<li>网络接口层</li>\n</ol>\n<p>需要注意的是，我们并不能将 TCP/IP 四层模型 和 OSI 七层模型完全精确地匹配起来，不过可以简单将两者对应起来，如下图所示：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/tcp-ip-four-model.png\" alt=\"TCP/IP 四层模型\" tabindex=\"0\" loading=\"lazy\"><figcaption>TCP/IP 四层模型</figcaption></figure>\n<h3> 应用层（Application layer）</h3>\n<p><strong>应用层位于传输层之上，主要提供两个终端设备上的应用程序之间信息交换的服务，它定义了信息交换的格式，消息会交给下一层传输层来传输。</strong> 我们把应用层交互的数据单元称为报文。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/application-layer-packet.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>应用层协议定义了网络通信规则，对于不同的网络应用需要不同的应用层协议。在互联网中应用层协议很多，如支持 Web 应用的 HTTP 协议，支持电子邮件的 SMTP 协议等等。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/application-layer-protocol.png\" alt=\"应用层重要协议\" tabindex=\"0\" loading=\"lazy\"><figcaption>应用层重要协议</figcaption></figure>\n<p>应用层常见协议总结，请看这篇文章：<a href=\"/article/computer-network/application-layer-protocol.html\" target=\"blank\">应用层常见协议总结（应用层）</a>。</p>\n<h3> 传输层（Transport layer）</h3>\n<p>**传输层的主要任务就是负责向两台终端设备进程之间的通信提供通用的数据传输服务。**应用进程利用该服务传送应用层报文。“通用的”是指并不针对某一个特定的网络应用，而是多种应用可以使用同一个运输层服务。</p>\n<p><strong>运输层主要使用以下两种协议：</strong></p>\n<ol>\n<li><strong>传输控制协议 TCP</strong>（Transmisson Control Protocol）：提供<strong>面向连接</strong>的，<strong>可靠的</strong>数据传输服务</li>\n<li><strong>用户数据协议 UDP</strong>（User Datagram Protocol）：提供<strong>无连接</strong>的，尽最大努力的数据传输服务（不保证数据传输的可靠性）</li>\n</ol>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/transport-layer-protocol.png\" alt=\"传输层重要协议\" tabindex=\"0\" loading=\"lazy\"><figcaption>传输层重要协议</figcaption></figure>\n<h3> 网络层（Network layer）</h3>\n<p>**网络层负责为分组交换网上的不同主机提供通信服务。**在发送数据时，网络层把运输层产生的报文段或用户数据报封装成分组和包进行传送。在 TCP/IP 体系结构中，由于网络层使用 IP 协议，因此分组也叫 IP 数据报，简称数据报。</p>\n<div class=\"hint-container warning\">\n<p class=\"hint-container-title\">注意</p>\n<p><strong>不要把运输层的“用户数据报 UDP”和网络层的“IP 数据报”弄混</strong>。</p>\n</div>\n<p><strong>网络层的还有一个任务就是选择合适的路由，使源主机运输层所传下来的分组，能通过网络层中的路由器找到目的主机。</strong></p>\n<p>这里强调指出，网络层中的“网络”二字已经不是我们通常谈到的具体网络，而是指计算机网络体系结构模型中第三层的名称。</p>\n<p>互联网是由大量的异构（heterogeneous）网络通过路由器（router）相互连接起来的。互联网使用的网络层协议是无连接的网际协议（Internet Prococol）和许多路由选择协议，因此互联网的网络层也叫做<strong>网际层</strong>或 <strong>IP 层</strong>。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/nerwork-layer-protocol.png\" alt=\"网络层重要协议\" tabindex=\"0\" loading=\"lazy\"><figcaption>网络层重要协议</figcaption></figure>\n<p><strong>网络层常见协议</strong> ：</p>\n<ul>\n<li><strong>IP 协议</strong>：IP 网络协议是TCP/IP协议中最重要的协议之一，也是网络层最重要的协议之一；IP 协议的作用包括寻址规约、定义数据包的格式等等，是网络层信息传输的主力协议；目前 IP 协议主要分为两种，一种是过去的 IPv4，另一种是较新的 IPv6，目前这两种协议都在使用，但后者已经被提议来取代前者</li>\n<li><strong>ARP 协议</strong>：ARP 协议，全称地址解析协议（Address Resolution Protocol），它解决的是网络层地址和链路层地址之间的转换问题；因为一个IP数据报在物理上传输的过程中，总是需要知道下一跳（物理上的下一个目的地）该去往何处，但IP地址属于逻辑地址，而MAC地址才是物理地址，ARP协议解决了IP地址转MAC地址的一些问题</li>\n<li><strong>NAT：网络地址转换协议</strong> ：NAT协议（Network Address Translation）的应用场景如同它的名称——网络地址转换，应用于内部网到外部网的地址转换过程中；具体地说，在一个小的子网（局域网，LAN）内，各主机使用的是同一个 LAN 下的IP地址，但在该 LAN 以外，在广域网（WAN）中，需要一个统一的 IP 地址来标识该LAN在整个Internet上的位置</li>\n<li>......</li>\n</ul>\n<h3> 网络接口层（Network interface layer）</h3>\n<p>我们可以把网络接口层看作是数据链路层和物理层的合体。</p>\n<ol>\n<li>数据链路层（data link layer）通常简称为链路层（ 两台主机之间的数据传输，总是在一段一段的链路上传送的）；<strong>数据链路层的作用是将网络层交下来的 IP 数据报组装成帧，在两个相邻节点间的链路上传送帧；每一帧包括数据和必要的控制信息（如同步信息，地址信息，差错控制等）</strong></li>\n<li><strong>物理层的作用是实现相邻计算机节点之间比特流的透明传送，尽可能屏蔽掉具体传输介质和物理设备的差异</strong></li>\n</ol>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/network-interface-layer-protocol.png\" alt=\"网络接口层重要协议\" tabindex=\"0\" loading=\"lazy\"><figcaption>网络接口层重要协议</figcaption></figure>\n<h3> 总结</h3>\n<p>简单总结一下每一层包含的协议和核心技术:</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/network-protocol-overview.png\" alt=\"TCP/IP 各层协议概览\" tabindex=\"0\" loading=\"lazy\"><figcaption>TCP/IP 各层协议概览</figcaption></figure>\n<p><strong>应用层协议</strong> :</p>\n<ul>\n<li>HTTP 协议（超文本传输协议，网页浏览常用的协议）</li>\n<li>DHCP 协议（动态主机配置）</li>\n<li>DNS 系统原理（域名系统）</li>\n<li>FTP 协议（文件传输协议）</li>\n<li>Telnet 协议（远程登陆协议）</li>\n<li>电子邮件协议等（SMTP、POP3、IMAP）</li>\n<li>......</li>\n</ul>\n<p><strong>传输层协议</strong> :</p>\n<ul>\n<li>TCP 协议\n<ul>\n<li>报文段结构</li>\n<li>可靠数据传输</li>\n<li>流量控制</li>\n<li>拥塞控制</li>\n</ul>\n</li>\n<li>UDP 协议\n<ul>\n<li>报文段结构</li>\n<li>RDT（可靠数据传输协议）</li>\n</ul>\n</li>\n</ul>\n<p><strong>网络层协议</strong> :</p>\n<ul>\n<li>IP 协议（TCP/IP 协议的基础，分为 IPv4 和 IPv6）</li>\n<li>ARP 协议（地址解析协议，用于解析 IP 地址和 MAC 地址之间的映射）</li>\n<li>ICMP 协议（控制报文协议，用于发送控制消息）</li>\n<li>NAT 协议（网络地址转换协议）</li>\n<li>RIP 协议、OSPF 协议、BGP 协议（路由选择协议）</li>\n<li>......</li>\n</ul>\n<p><strong>网络接口层</strong> :</p>\n<ul>\n<li>差错检测技术</li>\n<li>多路访问协议（信道复用技术）</li>\n<li>CSMA/CD 协议</li>\n<li>MAC 协议</li>\n<li>以太网技术</li>\n<li>......</li>\n</ul>\n<h2> 网络分层的原因</h2>\n<p>在这篇文章的最后，我想聊聊：“为什么网络要分层？”。</p>\n<p>说到分层，先从我们平时使用框架开发一个后台程序来说，我们往往会按照每一层做不同的事情的原则将系统分为三层（复杂的系统分层会更多）:</p>\n<ol>\n<li>Repository（数据库操作）</li>\n<li>Service（业务操作）</li>\n<li>Controller（前后端数据交互）</li>\n</ol>\n<p><strong>复杂的系统需要分层，因为每一层都需要专注于一类事情；网络分层的原因也是一样，每一层只专注于做一类事情。</strong></p>\n<p>好了，再来说回：“为什么网络要分层？”。我觉得主要有 3 方面的原因：</p>\n<ol>\n<li><strong>各层之间相互独立</strong>：各层之间相互独立，各层之间不需要关心其他层是如何实现的，只需要知道自己如何调用下层提供好的功能就可以了（可以简单理解为接口调用）；<strong>这个和我们对开发时系统进行分层是一个道理</strong></li>\n<li><strong>提高了整体灵活性</strong>：每一层都可以使用最适合的技术来实现，只需要保证自己提供的功能以及暴露的接口的规则没有改变就行了；<strong>这个和我们平时开发系统的时候要求的高内聚、低耦合的原则也是可以对应上的。</strong></li>\n<li><strong>大问题化小</strong>： 分层可以将复杂的网络间题分解为许多比较小的、界线比较清晰简单的小问题来处理和解决，这样使得复杂的计算机网络系统变得易于设计，实现和标准化。；<strong>这个和我们平时开发的时候，一般会将系统功能分解，然后将复杂的问题分解为容易理解的更小的问题是相对应的，这些较小的问题具有更好的边界（目标和接口）定义</strong></li>\n</ol>\n<p>我想到了计算机世界非常非常有名的一句话，这里分享一下：</p>\n<blockquote>\n<p>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决，计算机整个体系从上到下都是按照严格的层次结构设计的。</p>\n</blockquote>\n<h2> 参考</h2>\n<ul>\n<li>TCP/IP model vs OSI model：<a href=\"https://fiberbit.com.tw/tcpip-model-vs-osi-model/\" target=\"_blank\" rel=\"noopener noreferrer\">https://fiberbit.com.tw/tcpip-model-vs-osi-model/</a></li>\n<li>Data Encapsulation and the TCP/IP Protocol Stack：<a href=\"https://docs.oracle.com/cd/E19683-01/806-4075/ipov-32/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.oracle.com/cd/E19683-01/806-4075/ipov-32/index.html</a></li>\n</ul>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/osi-and-tcp-ip-model/osi-seven-model-1.png",
      "date_published": "2023-07-27T00:00:00.000Z",
      "date_modified": "2023-08-21T16:04:04.000Z",
      "authors": [],
      "tags": [
        "计算机基础"
      ]
    },
    {
      "title": "TCP 三次握手和四次挥手（传输层）",
      "url": "https://1coins.github.io/article/computer-network/tcp-connection-and-disconnection.html",
      "id": "https://1coins.github.io/article/computer-network/tcp-connection-and-disconnection.html",
      "summary": "为了准确无误地把数据送达目标处，TCP 协议采用了三次握手策略。 建立连接：TCP 三次握手 TCP 三次握手图解 建立一个 TCP 连接需要“三次握手”，缺一不可 ：",
      "content_html": "<p>为了准确无误地把数据送达目标处，TCP 协议采用了三次握手策略。</p>\n<h2> 建立连接：TCP 三次握手</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/tcp-connection-and-disconnection/tcp-shakes-hands-three-times.png\" alt=\"TCP 三次握手图解\" tabindex=\"0\" loading=\"lazy\"><figcaption>TCP 三次握手图解</figcaption></figure>\n<p>建立一个 TCP 连接需要“三次握手”，缺一不可 ：</p>\n<ul>\n<li><strong>一次握手</strong>：客户端发送带有 SYN（SEQ=x） 标志的数据包给服务端，然后客户端进入 <strong>SYN_SEND</strong> 状态，等待服务器的确认</li>\n<li><strong>二次握手</strong>：服务端发送带有 SYN+ACK（SEQ=y,ACK=x+1）标志的数据包给客户端，然后服务端进入 <strong>SYN_RECV</strong> 状态</li>\n<li><strong>三次握手</strong>：客户端发送带有带有 ACK（ACK=y+1）标志的数据包给服务端，然后客户端和服务器端都进入 <strong>ESTABLISHED</strong> 状态，完成 TCP 三次握手</li>\n</ul>\n<p><strong>当建立了 3 次握手之后，客户端和服务端就可以传输数据啦！</strong></p>\n<h3> 为什么要三次握手?</h3>\n<p>三次握手的目的是建立可靠的通信信道，说到通信，简单来说就是数据的发送与接收，而三次握手最主要的目的就是双方确认自己与对方的发送与接收是正常的。</p>\n<ol>\n<li><strong>第一次握手</strong>：Client 什么都不能确认；Server 确认了对方发送正常，自己接收正常</li>\n<li><strong>第二次握手</strong>：Client 确认了自己发送、接收正常，对方发送、接收正常；Server 确认了对方发送正常，自己接收正常</li>\n<li><strong>第三次握手</strong>：Client 确认了自己发送、接收正常，对方发送、接收正常；Server 确认了自己发送、接收正常，对方发送、接收正常</li>\n</ol>\n<p>三次握手就能确认双方收发功能都正常，缺一不可。</p>\n<p>更详细的解答可以看这个：<a href=\"https://www.zhihu.com/question/24853633/answer/115173386\" target=\"_blank\" rel=\"noopener noreferrer\">TCP 为什么是三次握手，而不是两次或四次？ - 车小胖的回答 - 知乎</a>  。</p>\n<h3> 第 2 次握手传回了 ACK，为什么还要传回 SYN？</h3>\n<p>服务端传回发送端所发送的 ACK 是为了告诉客户端：“我接收到的信息确实就是你所发送的信号了”，这表明从客户端到服务端的通信是正常的；回传 SYN 则是为了建立并确认从服务端到客户端的通信。</p>\n<blockquote>\n<p>SYN 同步序列编号（Synchronize Sequence Numbers）是 TCP/IP 建立连接时使用的握手信号。在客户机和服务器之间建立正常的 TCP 网络连接时，客户机首先发出一个 SYN 消息，服务器使用 SYN-ACK 应答表示接收到了这个消息，最后客户机再以 ACK（Acknowledgement）消息响应。这样在客户机和服务器之间才能建立起可靠的 TCP 连接，数据才可以在客户机和服务器之间传递。</p>\n</blockquote>\n<h2> 断开连接-TCP 四次挥手</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/tcp-connection-and-disconnection/tcp-waves-four-times.png\" alt=\"TCP 四次挥手图解\" tabindex=\"0\" loading=\"lazy\"><figcaption>TCP 四次挥手图解</figcaption></figure>\n<p>断开一个 TCP 连接则需要“四次挥手”，缺一不可 ：</p>\n<ol>\n<li><strong>第一次挥手</strong>：客户端发送一个 FIN（SEQ=x） 标志的数据包给服务端，用来关闭客户端到服务器的数据传送；然后，客户端进入 <strong>FIN-WAIT-1</strong> 状态</li>\n<li><strong>第二次挥手</strong>：服务器收到这个 FIN（SEQ=x） 标志的数据包，它发送一个 ACK（SEQ=x+1）标志的数据包给客户端 ；然后，服务端进入 <strong>CLOSE-WAIT ​</strong>状态，客户端进入 <strong>FIN-WAIT-2 ​</strong>状态</li>\n<li><strong>第三次挥手</strong>：服务端关闭与客户端的连接并发送一个 FIN（SEQ=y）标志的数据包给客户端请求关闭连接；然后，服务端进入 <strong>LAST-ACK ​</strong>状态</li>\n<li><strong>第四次挥手</strong>：客户端发送 ACK（SEQ=y+1）标志的数据包给服务端并且进入 <strong>TIME-WAIT ​</strong>状态，服务端在收到 ACK (SEQ=y+1）标志的数据包后进入 CLOSE 状态；此时，如果客户端等待 <strong>2MSL</strong> 后依然没有收到回复，就证明服务端已正常关闭，随后，客户端也可以关闭连接了</li>\n</ol>\n<p><strong>只要四次挥手没有结束，客户端和服务端就可以继续传输数据！</strong></p>\n<h3> 为什么要四次挥手？</h3>\n<p>TCP 是全双工通信，可以双向传输数据。任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态。当另一方也没有数据再发送的时候，则发出连接释放通知，对方确认后就完全关闭了 TCP 连接。</p>\n<p>举个例子：A 和 B 打电话，通话即将结束后。</p>\n<ol>\n<li><strong>第一次挥手</strong>：A 说“我没啥要说的了”</li>\n<li><strong>第二次挥手</strong>：B 回答“我知道了”，但是 B 可能还会有要说的话，A 不能要求 B 跟着自己的节奏结束通话</li>\n<li><strong>第三次挥手</strong>：于是 B 可能又巴拉巴拉说了一通，最后 B 说“我说完了”</li>\n<li><strong>第四次挥手</strong>：A 回答“知道了”，这样通话才算结束</li>\n</ol>\n<h3> 为什么不能把服务器发送的 ACK 和 FIN 合并起来，变成三次挥手？</h3>\n<p>因为服务器收到客户端断开连接的请求时，可能还有一些数据没有发完，这时先回复 ACK，表示接收到了断开连接的请求；等到数据发完之后再发 FIN，断开服务器到客户端的数据传送。</p>\n<h3> 如果第二次挥手时服务器的 ACK 没有送达客户端，会怎样？</h3>\n<p>客户端没有收到 ACK 确认，会重新发送 FIN 请求。</p>\n<h3> 为什么第四次挥手客户端需要等待 2*MSL（报文段最长寿命）时间后才进入 CLOSED 状态？</h3>\n<p>第四次挥手时，客户端发送给服务器的 ACK 有可能丢失，如果服务端没有因为某些原因而没有收到 ACK 的话，服务端就会重发 FIN，如果客户端在 2*MSL 的时间内收到了 FIN，就会重新发送 ACK 并再次等待 2MSL，防止 Server 没有收到 ACK 而不断重发 FIN。</p>\n<blockquote>\n<p>**MSL(Maximum Segment Lifetime)：**一个片段在网络中最大的存活时间，2MSL 就是一个发送和一个回复所需的最大时间；如果直到 2MSL，Client 都没有再次收到 FIN，那么 Client 推断 ACK 已经被成功接收，则结束 TCP 连接。</p>\n</blockquote>\n<h2> 参考</h2>\n<ul>\n<li>《计算机网络（第 7 版）》</li>\n<li>《图解 HTTP》</li>\n<li>TCP and UDP Tutorial：<a href=\"https://www.9tut.com/tcp-and-udp-tutorial\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.9tut.com/tcp-and-udp-tutorial</a></li>\n</ul>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/tcp-connection-and-disconnection/tcp-shakes-hands-three-times.png",
      "date_published": "2023-07-30T00:00:00.000Z",
      "date_modified": "2023-08-21T16:04:04.000Z",
      "authors": [],
      "tags": [
        "计算机基础"
      ]
    },
    {
      "title": "IDEA 注释模板",
      "url": "https://1coins.github.io/article/idea/idea-annotation-tempplate.html",
      "id": "https://1coins.github.io/article/idea/idea-annotation-tempplate.html",
      "summary": "类注释 打开IDEA的Settings，点击Editor--&gt;File and Code Templates，点击右边File选项卡下面的Class，在其中添加下面的内容： #if (${PACKAGE_NAME} &amp;&amp; ${PACKAGE_NAME} != \"\")package ${PACKAGE_NAME};#end #parse(\"File Header.java\") /** * @author echo * @date ${YEAR}年 ${MONTH}月 ${DAY}日 ${TIME} */ public class ${NAME} { }",
      "content_html": "<h1> 类注释</h1>\n<p>打开<code>IDEA</code>的<code>Settings</code>，点击<code>Editor--&gt;File and Code Templates</code>，点击右边<code>File</code>选项卡下面的<code>Class</code>，在其中添加下面的内容：</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 注意</h2>\n<p>​<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/sample-template.png\" alt=\"\" loading=\"lazy\">​</p>\n<p>在我提供的示例模板中，说明了作者和时间，<code>IDEA</code>​支持的所有的模板参数在下方的<code>description</code>​中被列出来。</p>\n<p>保存后，当你创建一个新的类的时候就会自动添加类注释。如果你想对接口也生效，同时配置上图中的<code>Interface</code>项即可。</p>\n<h1> 方法注释</h1>\n<p>不同于目前网络上互相复制粘贴的方法注释教程，本文将实现以下功能：</p>\n<ul>\n<li>根据形参数目自动生成<code>@param</code>注解</li>\n<li>根据方法是否有返回值智能生成<code>@return</code>注解</li>\n</ul>\n<p>相较于类模板，为方法添加注释模板就较为复杂，首先在 <code>Settings</code>中点击<code>Editor--&gt;Live Templates</code>。</p>\n<p>点击最右边的<code>+</code>，首先选择<code>2. Template Group...</code>来创建一个模板分组：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/template-group.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>在弹出的对话框中填写分组名，我这里叫做<code>userDefine</code>：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/template-group-name.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>然后选中刚刚创建的模板分组<code>userDefine</code>，然后点击<code>+</code>，选择<code>1. Live Template</code>：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/live-templates.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>此时就会创建了一个空的模板，我们修改该模板的<code>Abbreviation、Description</code>和<code>Template text</code>。需要注意的是，<code>Abbreviation</code>必须为<code>*</code>，最后检查下<code>Expand with</code>的值是否为<code>Enter</code>键。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/live-templates-userdefine.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>上图中· <code>Template text</code>内容如下，需要注意首行没有 <code>/</code>，且<code>*</code>是顶格的。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>注意到右下角的<code>No applicable contexts yet</code>了吗，这说明此时这个模板还没有指定应用的语言。</p>\n<p>点击<code>Define</code>，在弹框中勾选<code>Java</code>，表示将该模板应用于所有的<code>Java</code>类型文件。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/live-templates-userdefine.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 设置<code>applicable contexts</code></h2>\n<p>还记得我们配置<code>Template text</code>时里面包含了类似于<code>$date$</code>这样的参数，此时<code>IDEA</code>还不认识这些参数是啥玩意，下面我们对这些参数进行方法映射，让<code>IDEA</code>能够明白这些参数的含义。</p>\n<p>点击<code>Edit variables</code>按钮：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/live-templates-variables.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>为每一个参数设置相对应的<code>Expression</code>：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/live-templates-edit-variables.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 设置<code>Expression</code></h2>\n<p>需要注意的是，<code>date</code>和<code>time</code>的<code>Expression</code>使用的是<code>IDEA</code>内置的函数，直接使用下拉框选择就可以了，而<code>param</code>这个参数<code>IDEA</code>默认的实现很差，因此我们需要手动实现，代码如下：</p>\n<div class=\"language-text line-numbers-mode\" data-ext=\"text\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>另外<code>return</code>这个参数也要实现了下，代码如下：</p>\n<div class=\"language-text line-numbers-mode\" data-ext=\"text\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><blockquote>\n<p>注：你还注意到我并没有勾选<code>Skip if defined</code>属性，它的意思是如果在生成注释时候如果这一项被定义了，那么鼠标光标就会直接跳过它。我并不需要这个功能，因此有被勾选该属性。</p>\n</blockquote>\n<p>点击<code>OK</code>保存设置，大功告成！</p>\n<h1> Q &amp; A</h1>\n<ol>\n<li>\n<p>为什么模板的<code>Abbreviation</code>一定要叫<code>*</code>？<code>Expand with</code>要保证是<code>Enter</code>键？</p>\n<blockquote>\n<p>答：因为<code>IDEA</code>模板的生成逻辑是<code>模板名 + 生成键</code>，当生成键是<code>Enter</code>时，我们输入<code>* + Enter</code>就能够触发模板。<br>\n这也同时说明了为什么注释模板首行是一个<code>*</code>了，因为当我们先输入<code>/*</code>，然后输入<code>* + Enter</code>，触发模板，首行正好拼成了<code>/**</code>，符合<code>Javadoc</code>的规范。</p>\n</blockquote>\n</li>\n<li>\n<p>注释模板中为什么有一行空的<code>*</code>？</p>\n<blockquote>\n<p>答：因为我习惯在这一行写方法说明，所以就预留了一行空的写，你也可以把它删掉。</p>\n</blockquote>\n</li>\n<li>\n<p>注释模板中<code>$time$$param$</code>&nbsp;`这两个明明不相干的东西为什么紧贴在一起？</p>\n<blockquote>\n<p>答：首先网上提供的大部分<code>param</code>生成函数在无参情况下仍然会生成一行空的<code>@param</code>，因此我对<code>param</code>函数的代码进行修改，使得在无参情况下不生成<code>@param</code>，但是这就要求<code>$param$</code>要和别人处在同一行中，不然没法处理退格。</p>\n</blockquote>\n</li>\n<li>\n<p>为什么<code>return</code>参数不使用<code>methodReturnType()</code>， 而要自己实现？</p>\n<blockquote>\n<p>答：<code>methodReturnType()</code>在无返回值的情况下会返回<code>void</code>，这并没有什么意义，因此我对<code>methodReturnType()</code>返回值进行了处理，仅在有返回值时才生成。</p>\n</blockquote>\n</li>\n<li>\n<p>为什么<code>$return$</code>&nbsp;`不是单独一行？</p>\n<blockquote>\n<p>答：因为当<code>methodReturnType()</code>返回<code>null</code>时，无法处理退格问题，原因同第三点。</p>\n</blockquote>\n</li>\n</ol>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/idea-annotation-tempplate/sample-template.png",
      "date_published": "2023-07-24T00:00:00.000Z",
      "date_modified": "2023-08-21T16:04:04.000Z",
      "authors": [],
      "tags": [
        "工具"
      ]
    },
    {
      "title": "Nginx 总结",
      "url": "https://1coins.github.io/article/nginx/nginx-summary.html",
      "id": "https://1coins.github.io/article/nginx/nginx-summary.html",
      "summary": "简介 Nginx 概述 Nginx是一个高性能的HTTP和反向代理服务器，特点是占有内存少，并发能力强。事实上Nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用Nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。 Nginx 作为 web 服务器 Nginx可以作为静态页面的Web服务器，同时还支持CGI协议的动态语言，比如perl、php等。但是不支持Java。Java程序只能通过与Tomcat配合完成。Nginx专为性能优化而开发，性能是其最重要的考量，实现上非常注重效率 ，能经受高负载的考验,有报告表明能支持高达 500005000050000 个并发连接数。",
      "content_html": "<h1> 简介</h1>\n<h2> Nginx 概述</h2>\n<p><code>Nginx</code>是一个高性能的<code>HTTP</code>和反向代理服务器，特点是占有内存少，并发能力强。事实上<code>Nginx</code>的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用<code>Nginx</code>网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p>\n<h2> Nginx 作为 web 服务器</h2>\n<p><code>Nginx</code>可以作为静态页面的<code>Web</code>服务器，同时还支持<code>CGI</code>协议的动态语言，比如<code>perl</code>、<code>php</code>等。但是不支持<code>Java</code>。<code>Java</code>程序只能通过与<code>Tomcat</code>配合完成。<code>Nginx</code>专为性能优化而开发，性能是其最重要的考量，实现上非常注重效率 ，能经受高负载的考验,有报告表明能支持高达 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>50000</mn></mrow><annotation encoding=\"application/x-tex\">50000</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">50000</span></span></span></span> 个并发连接数。</p>\n<p><code>https://lnmp.org/nginx.html</code></p>\n<h2> 正向代理</h2>\n<p><code>Nginx</code>不仅可以做反向代理，实现负载均衡。还能用作正向代理来进行上网等功能。</p>\n<p>正向代理：如果把局域网外的<code>Internet</code>想象成一个巨大的资源库，则局域网中的客户端要访问<code>Internet</code>，则需要通过代理服务器来访问，这种代理服务就称为正向代理。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/forward-proxy.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 反向代理</h2>\n<p>反向代理，其实客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，在返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器<code>IP</code>地址。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/reverse-proxy.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 负载均衡</h2>\n<p>客户端发送多个请求到服务器，服务器处理请求，有一些可能要与数据库进行交互，服务器处理完毕后，再将结果返回给客户端。</p>\n<p>这种架构模式对于早期的系统相对单一，并发请求相对较少的情况下是比较适合的，成本也低。但是随着信息数量的不断增长，访问量和数据量的飞速增长，以及系统业务的复杂度增加，这种架构会造成服务器相应客户端的请求日益缓慢，并发量特别大的时候，还容易造成服务器直接崩溃。很明显这是由于服务器性能的瓶颈造成的问题，那么如何解决这种情况呢？</p>\n<p>首先想到的可能是升级服务器的配置，比如提高<code>CPU</code>执行频率，加大内存等提高机器的物理性能来解决此问题，但是应该知道由于摩尔定律的日益失效，硬件的性能提升已经不能满足日益提升的需求了。最明显的一个例子，天猫双十一当天，某个热销商品的瞬时访问量是极其庞大的，那么类似上面的系统架构，将机器都增加到现有的顶级物理配置，都是不能够满足需求的。那么怎么办呢？</p>\n<p>通过上面的分析，去掉了增加服务器物理配置来解决问题的办法，也就是说纵向解决问题的办法行不通了，那么横向增加服务器的数量呢？这时候集群的概念产生了，单个服务器解决不了，就增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器，也就是所说的负载均衡。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/load-balance.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> 动静分离</h2>\n<p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/dynamic-static-separate.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> 安装</h1>\n<h2> 普通版</h2>\n<ol>\n<li>进入<code>Nginx</code><a href=\"http://nginx.org/\" target=\"_blank\" rel=\"noopener noreferrer\">官网</a>下载</li>\n<li>安装<code>Nginx</code>\n<ol>\n<li>\n<p>安装<code>openssl</code>、<code>zlib</code>、<code>gcc</code>依赖</p>\n<div class=\"language-text line-numbers-mode\" data-ext=\"text\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>安装<code>pcre</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>安装<code>nginx</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>进入目录<code>/usr/local/nginx/sbin/nginx</code>启动服务</p>\n<ul>\n<li>因为防火墙问题，在<code>windows</code>系统中访问<code>linux</code>中的<code>nginx</code>，默认不能访问的\n<ol>\n<li>查看开放的端口号<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>设置开放的端口号<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>重启防火墙<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n</li>\n</ul>\n</li>\n</ol>\n</li>\n</ol>\n<h2> Docker 版</h2>\n<p>见 <a href=\"/article/nginx/assets/01.%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8-20220116221224-5423vi3.html\" target=\"blank\">Docker-镜像与容器</a></p>\n<p>此外，运行容器时要挂载目录：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> 常用命令和配置文件</h1>\n<h2> 常用命令</h2>\n<ol>\n<li>查看版本号\n<ul>\n<li>在<code>/usr/local/nginx/sbin</code>目录下执行<code>./nginx -v</code></li>\n</ul>\n</li>\n<li>启动\n<ul>\n<li>在<code>/usr/local/nginx/sbin</code>目录下执行<code>./nginx</code></li>\n</ul>\n</li>\n<li>关闭\n<ul>\n<li>在<code>/usr/local/nginx/sbin</code>目录下执行<code>./nginx -s stop</code></li>\n</ul>\n</li>\n<li>重新加载\n<ul>\n<li>在<code>/usr/local/nginx/sbin</code>目录下执行<code>./nginx-sreload</code></li>\n</ul>\n</li>\n</ol>\n<h2> 配置文件</h2>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 配置文件位置</h3>\n<ul>\n<li>默认的配置文件都放在<code>Nginx</code>安装目录下的<code>conf</code>目录下</li>\n<li><code>/usr/local/nginx/conf/nginx.conf</code></li>\n</ul>\n<h3> 配置文件中的内容</h3>\n<h4> 全局块</h4>\n<p>配置服务器整体运行的配置指令。</p>\n<p>从配置文件开始到<code>events</code>块之间的内容，主要会设置一些影响<code>Nginx</code>服务器整体运行的配置指令，主要包括配置运行<code>Nginx</code>服务器的用户（组）、允许生成的<code>worker_process</code>数，进程<code>PID</code>存放路径、日志存放路径和类型以及配置文件的引入等。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p><code>worker_processes</code>是<code>Nginx</code>服务器并发处理服务的关键配置，<code>worker_processes</code>值越大，可以支持的并发处理量也越多，但是会受到硬件、软件等设备的制约。</p>\n<h4> events 块</h4>\n<p>影响<code>Nginx</code>服务器与用户的网络连接。</p>\n<p><code>events</code>块涉及的指令主要影响<code>Nginx</code>服务器与用户的网络连接，常用的设置包括是否开启对多<code>work_process</code>下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型来处理连接请求，每个<code>work_process</code>可以同时支持的最大连接数等。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>上述例子就表示每个<code>work_process</code>支持的最大连接数为 1024。这部分的配置对<code>Nginx</code>的性能影响较大，在实际中应该灵活配置。</p>\n<h4> http块</h4>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><code>http</code>块算是<code>Nginx</code>服务器配置中最频繁的部分，代理、缓存和日志定义等绝大多数功能和第三方模块的配置都在这里。<br>\n需要注意的是，<code>http</code>块包括<code>http</code>全局块和<code>server</code>块。</p>\n<h5> http 全局块</h5>\n<p><code>http</code>全局块配置的指令包括文件引入、<code>MIME-TYPE</code>定义、日志自定义、连接超时时间、单链接请求数上限等。</p>\n<h5> server 块</h5>\n<p><code>server</code>块和虚拟主机有密切关系，虚拟主机从用户角度看，和一台独立的硬件主机是完全一样的，该技术的产生是为了节省互联网服务器硬件成本。</p>\n<p>每个<code>http</code>块可以包括多个<code>server</code>块，而每个<code>server</code>块就相当于一个虚拟主机。而每个 <code>server</code>块也分为全局<code>server</code>块，以及可以同时包含多个<code>locaton</code>块。</p>\n<ul>\n<li>全局<code>server</code>块<br>\n最常见的配置是本虚拟机主机的监听配置和本虚拟主机的名称或IP配置。</li>\n<li><code>locaton</code>块<br>\n一个<code>server</code>块可以配置多个<code>location</code>块。<br>\n这块的主要作用是基于<code>Nginx</code>服务器接收到的请求字符串（例如<code>server_name/uri-string</code>），对虚拟主机名称（也可以是<code>IP</code>别名）之外的字符串（例如前面的<code>/uri-string</code>）进行匹配，对特定的请求进行处理。地址定向、数据缓存和应答控制等功能，还有许多第三方模块的配置也在这里进行。</li>\n</ul>\n<h1> 实例</h1>\n<h2> 反向代理</h2>\n<h3> 案例 1</h3>\n<h4> 实现效果</h4>\n<p>打开浏览器，在浏览器地址栏输入地址 <a href=\"http://www.123.com/\" target=\"_blank\" rel=\"noopener noreferrer\">www.123.com</a>，跳转到<code>Liunx</code>系统<code>Tomcat</code>主页面中。</p>\n<h4> 实现步骤</h4>\n<ol>\n<li>\n<p>在<code>Liunx</code>系统安装<code>Tomcat</code>，使用默认端口 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>8080</mn></mrow><annotation encoding=\"application/x-tex\">8080</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">8080</span></span></span></span></p>\n<ul>\n<li>\n<p>普通版</p>\n<ol>\n<li><code>Tomcat</code>安装文件放到<code>Liunx</code>系统中，解压</li>\n<li>进入<code>Tomcat</code>的<code>bin</code>目录中，<code>./startup.sh</code>启动<code>tomcat</code>服务器</li>\n</ol>\n</li>\n<li>\n<p><code>Docker</code>版</p>\n<p>见 <a href=\"/article/nginx/assets/01.%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8-20220116221224-f8q6z2d.html\" target=\"blank\">Docker-镜像与容器</a>，此外，在运行容器时要挂载卷。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>对外开放访问的端口</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>在<code>Windows</code>系统的<code>C:\\Windows\\System32\\drivers\\et\\host</code>文件进行域名和<code>ip</code>对应关系的配置<br>\n配置完成之后，就可以通过 <a href=\"www.123.com:8080\">www.123.com:8080</a> 访问到第一步出现的<code>Tomcat</code>初始界面；再通过<code>Nginx</code>的反向代理，只需要输入 <a href=\"http://www.123.com/\" target=\"_blank\" rel=\"noopener noreferrer\">www.123.com</a> 就可以跳转到<code>Tomcat</code>初始界面。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>在<code>Nginx</code>进行请求转发的配置（反向代理配置）</p>\n<p>如下配置，监听 80 端口，访问域名为 <a href=\"http://www.123.com/\" target=\"_blank\" rel=\"noopener noreferrer\">www.123.com</a>，不加端口号时默认为 80 端口，故访问该域名时会跳转到<code>192.168.30.128:8080</code>路径上。</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>通过浏览器访问<a href=\"http://www.123.com/\" target=\"_blank\" rel=\"noopener noreferrer\">www.123.com</a></p>\n</li>\n</ol>\n<h4> 访问过程分析</h4>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/access-process-analysis.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 案例 2</h3>\n<ul>\n<li>实现效果\n<ul>\n<li>使用<code>Nginx</code>反向代理，根据访问的路径跳转到不同端口的服务中，<code>Nginx</code>监听端口为 80\n<ul>\n<li>访问 <a href=\"http://192.168.30.128:80/edu/\" target=\"_blank\" rel=\"noopener noreferrer\">http://192.168.30.128:80/edu/</a> 直接跳转到 <a href=\"192.168.30.128:8080\">192.168.30.128:8080</a></li>\n<li>访问 <a href=\"http://192.168.30.128:80/vod/\" target=\"_blank\" rel=\"noopener noreferrer\">http://192.168.30.128:80/vod/</a> 直接跳转到 <a href=\"192.168.30.128:8081\">192.168.30.128:8081</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>实现步骤\n<ol>\n<li>\n<p>准备一台服务器安装两个<code>Tomcat</code>，一个 8080 端口，一个 8081 端口</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>创建文件夹和测试页面</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>开放对外访问的端口号 80、8080、8081</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>配置<code>Nginx</code>反向代理<br>\n在<code>http</code>块中添加<code>server{}</code></p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><code>location</code>指令说明：该指令用于匹配<code>URL</code><br>\n语法如下：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li><code>=</code>：用于不含正则表达式的<code>uri</code>前，要求请求字符串与<code>uri</code>严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求</li>\n<li><code>~</code>：用于表示<code>uri</code>包含正则表达式，并且区分大小写</li>\n<li><code>~*</code>：用于表示<code>uri</code>包含正则表达式，并且不区分大小写</li>\n<li><code>^~</code>：用于不含正则表达式的<code>uri</code>前，要求<code>Nginx</code>服务器找到标识<code>uri</code>和请求字符串匹配度最高的<code>location</code>后，立即使用此<code>location</code>处理请求，而不再使用<code>location</code>块中的正则<code>uri</code>和请求字符串做匹配</li>\n</ul>\n<p>注意：如果<code>uri</code>包含正则表达式，则必须要有<code>~</code>或<code>~*</code>标识</p>\n</li>\n<li>\n<p>访问<a href=\"http://192.168.30.128:80/edu/\" target=\"_blank\" rel=\"noopener noreferrer\">http://192.168.30.128:80/edu/</a>、<a href=\"http://192.168.30.128:80/vod/\" target=\"_blank\" rel=\"noopener noreferrer\">http://192.168.30.128:80/vod/</a>测试</p>\n</li>\n</ol>\n</li>\n</ul>\n<h2> 负载均衡</h2>\n<p>随着互联网信息的爆炸性增长，负载均衡（<code>load balance</code>）已经不再是一个很陌生的话题，  顾名思义，负载均衡即是将负载分摊到不同的服务单元，既保证服务的可用性，又保证响应  足够快，给用户很好的体验。快速增长的访问量和数据流量催生了各式各样的负载均衡产品，  很多专业的负载均衡硬件提供了很好的功能，但却价格不菲，这使得负载均衡软件大受欢迎，<code>Nginx</code>就是其中的一个，在<code>Linux</code>下有<code>Nginx</code>、<code>LVS</code>、<code>Haproxy</code>等等服务可以提供负载均衡服  务，而且<code>Nginx</code>提供了几种分配方式（策略）。</p>\n<h3> 实现效果</h3>\n<p>浏览器地址栏输入地址 <a href=\"http://192.168.30.128/edu/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">http://192.168.30.128/edu/index.html</a>，实现负载均衡效果，平均访问 8080 和 8081 端口。</p>\n<h3> 实现步骤</h3>\n<ol>\n<li>\n<p>准备一台服务器安装两个<code>Tomcat</code>，端口分别是 8080 和 8081</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>在两台<code>Tomcat</code>的<code>webapps</code>目录中，创建名称是<code>edu</code>的文件夹，在<code>edu</code>文件夹中创建页面<code>index.html</code>，用于测试</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>在<code>Nginx</code>的配置文件中进行负载均衡的配置</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h3> 策略说明</h3>\n<ol>\n<li>\n<p>轮询（默认）</p>\n<p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器<code>down</code>掉，能自动剔除。</p>\n</li>\n<li>\n<p><code>weight</code></p>\n<ul>\n<li><code>weight</code>代表权重，默认为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>，权重越高被分配的客户端越多</li>\n<li>可以指定轮询几率，<code>weight</code>和访问比率成正比，用于后端服务器性能不均的情况</li>\n</ul>\n<div class=\"language-dsconfig line-numbers-mode\" data-ext=\"dsconfig\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>ip_hash</code></p>\n<p>每个请求按访问<code>ip</code>的<code>hash</code>结果分配，这样每个访客固定访问一个后端服务器。</p>\n<div class=\"language-dsconfig line-numbers-mode\" data-ext=\"dsconfig\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>fair</code></p>\n<p>按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>\n<div class=\"language-dsconfig line-numbers-mode\" data-ext=\"dsconfig\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h2> 动静分离</h2>\n<p><code>Nginx</code>动静分离简单来说就是把动态跟静态请求分开，不能理解成只是单纯的把动态页面和静态页面物理分离。严格意义上说应该是动态请求跟静态请求分开，可以理解成使用<code>Nginx</code>处理静态页面，<code>Tomcat</code>处理动态页面。</p>\n<p>动静分离从目前实现角度来讲大致分为两种：</p>\n<ol>\n<li>纯粹把静态文件独立成单独的域名，放在独立的服务器上，也是目前主流推崇的方案</li>\n<li>动态跟静态文件混合在一起发布，通过<code>Nginx</code>分开，配置<code>location</code>指定不同的后缀名实现不同的请求转发，<code>expires</code>参数设置浏览器缓存过期时间，减少与服务器之前的请求和流量。</li>\n</ol>\n<p><code>Expires</code>具体定义：是给一个资源设定一个过期时间，也就是说无需去服务端验证，直接通过浏览器自身确认是否过期即可，所以不会产生额外的流量。此种方法非常适合不经常变动的资源，如果经常更新的文件，不建议使<code>Expires</code>来缓存。设置<code>3d</code>，表示在 3 天之内访问这个<code>URL</code>，发送一个请求，比对服务器该文件最后更新时间没有变化，则不会从服务器抓取，返回状态码 304，如果有修改，则直接从服务器重新下载，返回状态码 200。</p>\n<h3> 实现效果</h3>\n<p>静态资源存放在<code>Nginx</code>服务器中，动态资源存放在<code>Tomcat</code>服务器中，访问静态资源时直接从<code>Nginx</code>服务器中获取。</p>\n<h3> 实现步骤</h3>\n<ol>\n<li>\n<p>在<code>Liunx</code>系统中准备静态资源，用于进行访问</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>在<code>Nginx</code>配置文件中进行配置</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>访问<code>192.168.30.128/image.cover.jpg</code>测试</p>\n<p>参数<code>autoindex on</code>效果：<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/autoindex-on.png\" alt=\"\" loading=\"lazy\"></p>\n</li>\n</ol>\n<h2> 高可用集群</h2>\n<h3> 什么是 Nginx 高可用</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/nginx-high-available.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 准备工作</h3>\n<ul>\n<li>两台服务器 <a href=\"192.168.30.129\">192.168.30.129</a> 和 <a href=\"192.168.30.130\">192.168.30.130</a></li>\n<li>在两台服务器安装<code>Nginx</code></li>\n<li>在两台服务器安装<code>keepalived</code></li>\n</ul>\n<h3> 单主单从</h3>\n<ol>\n<li>安装<code>keepalived</code>和<code>Nginx</code>\n<ul>\n<li>安装<code>Nginx</code></li>\n<li>安装<code>keepalived</code><div class=\"language-text line-numbers-mode\" data-ext=\"text\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>修改<code>/etc/keepalived/keepalivec.conf</code>配置文件\n<ul>\n<li><code>master</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li><code>salve</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>在两天服务器的<code>/usr/local/src/</code>中编写<code>Nginx</code>检测脚本<code>nginx_check.sh</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>在所有节点上面进行配置<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>把两台服务器上<code>Nginx</code>和<code>keepalived</code>启动<div class=\"language-text line-numbers-mode\" data-ext=\"text\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>最终测试\n<ul>\n<li>\n<p>在浏览器地址栏输入虚拟<code>ip</code>地址 <a href=\"192.168.30.60\">192.168.30.60</a>，可以访问</p>\n</li>\n<li>\n<p>把主服务器（<a href=\"192.168.60.129\">192.168.60.129</a>）<code>Nginx</code>和<code>keepalived</code>停止，再输入 <a href=\"192.168.30.60\">192.168.30.60</a>，仍然可以访问</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n</ol>\n<h3> 双主双从</h3>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/both-master-and-slave.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ol>\n<li>\n<p>修改配置</p>\n<ul>\n<li><code>master</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li><code>slave</code><div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>重启</p>\n<ul>\n<li>重启<code>master</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>重启<code>slave</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n</li>\n<li>\n<p>测试</p>\n<ul>\n<li>\n<p>在浏览器地址栏输入虚拟<code>ip</code>地址 <a href=\"192.168.10.30\">192.168.10.30</a>、<a href=\"192.168.10.60\">192.168.10.60</a>，可以访问</p>\n</li>\n<li>\n<p>把主服务器（<a href=\"192.168.60.129\">192.168.60.129</a>）<code>Nginx</code>和<code>keepalived</code>停止，再输入 <a href=\"192.168.30.60\">192.168.10.30、192.168.10.60</a>，仍然可以访问</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<p>测试可以发现访问<code>keepalived</code>中配置的两个<code>VIP</code>都可以正常调度等，当停止任意一台<code>keepalived</code>节点，同样还是正常访问；到此，<code>keepalived+nginx</code>高可用集群（双主模式）就搭建完成了。</p>\n</li>\n</ol>\n<h1> 原理</h1>\n<h2> Master 和 Worker机制</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/master-and-worker-one.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/master-and-worker-two.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> 优点</h3>\n<ol>\n<li>可以使用<code>nginx –s reload</code>热部署，利用<code>Nginx</code>进行热部署操作</li>\n<li>对于每个<code>worker</code>进程来说，独立的进程，不需要加锁，省掉了锁带来的开销，同时在编程以及问题查找时会方便很多</li>\n<li>每个<code>woker</code>是独立的进程，如果有其中的一个<code>woker</code>出现问题，其他<code>woker</code>独立的，继续进行争抢，实现请求过程，不会造成服务中断</li>\n</ol>\n<h3> worker 数量</h3>\n<p><code>Nginx</code>同<code>Redis</code>类似都采用了<code>io</code>多路复用机制，每个<code>worker</code>都是一个独立的进程，但每个进程里只有一个主线程，通过异步非阻塞的方式来处理请求，即使是千上万个请求也不在话下。</p>\n<p>每个<code>worker</code>的线程可以把一个<code>CPU</code>的性能发挥到极致。所以<code>worker</code>数和服务器的<code>CPU</code>数相等是最为适宜的。设少了会浪费<code>CPU</code>，设多了会造成<code>CPU</code>频繁切换上下文带来的损耗。</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 连接数</h2>\n<p><code>worker_connection</code>表示每个<code>worker</code>进程所能建立连接的最大值，所以，一个<code>Nginx</code>能建立的最大连接数，应该是<code>worker_connections * worker_processes</code>。</p>\n<p>当然，这里说的是最大连接数，对于<code>HTTP</code>请 求 本 地 资 源 来 说 ， 能 够 支 持 的 最 大 并 发 数 量 是<code>worker_connections * worker_processes</code>，如果是支持<code>HTTP1.1</code>的浏览器每次访问要占两个连接，所以普通的静态访问最大并发数是：<code>worker_connections * worker_processes / 2</code>，而如果是<code>HTTP</code>作为反向代理来说，最大并发数量应该是<code>worker_connections * worker_processes / 4</code>。因为作为反向代理服务器，每个并发会建立与客户端的连接和与后端服务的连接，会占用两个连接。</p>\n<h3> 问题</h3>\n<ol>\n<li>发送请求，占用了<code>woker</code>的几个连接数？\n<ul>\n<li>2 或者 4 个</li>\n</ul>\n</li>\n<li><code>Nginx</code>有一个<code>master</code>，四个<code>woker</code>，每个<code>woker</code>支持的最大连接数是 1024，那么支持的最大并发数是多少？\n<ul>\n<li>普通的静态访问最大并发数是：<code>worker_connections * worker_processes /2</code></li>\n<li>而如果是<code>HTTP</code>作为反向代理来说，最大并发数量应该是<code>worker_connections * worker_processes / 4</code></li>\n</ul>\n</li>\n</ol>\n<h2> 配置文件结构</h2>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/nginx-conf-structure.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/nginx-summary/forward-proxy.png",
      "date_published": "2023-08-05T00:00:00.000Z",
      "date_modified": "2023-08-21T16:04:04.000Z",
      "authors": [],
      "tags": [
        "Nginx"
      ]
    },
    {
      "title": "Zookeeper 总结",
      "url": "https://1coins.github.io/article/zookeeper/zookeeper-summary.html",
      "id": "https://1coins.github.io/article/zookeeper/zookeeper-summary.html",
      "summary": "简介/快速入门 Zookeeper是一个集中的服务，用于维护配置信息、命名、提供分布式同步和提供组服务。所有这些类型的服务都以某种形式被分布式应用程序使用。每次它们被实现时，都会有大量的工作来修复不可避免的错误和竞争条件。由于实现这些服务的困难，应用程序最初通常会略过这些服务，这使得它们在出现更改时变得脆弱，并且难以管理。即使正确地执行了这些服务，在部署应用程序时，这些服务的不同实现也会导致管理复杂性。 Zookeeper由雅虎研究院开发，是Google Chubby的开源实现,后来托管到Apache,于2010年11月正式成为apache的顶级项目。",
      "content_html": "<h1> 简介/快速入门</h1>\n<p><code>Zookeeper</code>是一个集中的服务，用于维护配置信息、命名、提供分布式同步和提供组服务。所有这些类型的服务都以某种形式被分布式应用程序使用。每次它们被实现时，都会有大量的工作来修复不可避免的错误和竞争条件。由于实现这些服务的困难，应用程序最初通常会略过这些服务，这使得它们在出现更改时变得脆弱，并且难以管理。即使正确地执行了这些服务，在部署应用程序时，这些服务的不同实现也会导致管理复杂性。</p>\n<p><code>Zookeeper</code>由雅虎研究院开发，是<code>Google Chubby</code>的开源实现,后来托管到<code>Apache</code>,于<code>2010年11月</code>正式成为<code>apache</code>的顶级项目。</p>\n<p>大数据生态系统里由很多组件的命名都是某些动物或者昆虫，比如<code>hadoop</code>大象，<code>hive</code>就是蜂巢，<code>zookeeper</code>即管理员，顾名思义就算管理大数据生态系统各组件的管理员，如下所示：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/zookeeper-big-data.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h1> 应用场景</h1>\n<p><code>Zookeepepr</code>是一个经典的<strong>分布式</strong>数据一致性解决方案，致力于为分布式应用提供一个高性能、高可用,且具有严格顺序访问控制能力的分布式协调存储服务。</p>\n<ol>\n<li>维护配置信息<br>\n<code>Java</code>编程经常会遇到配置项，比如数据库的<code>url</code>、 <code>schema</code>、<code>user</code>和 <code>password</code>等；通常这些配置项我们会放置在配置文件中，再将配置文件放置在服务器上当需要更改配置项时，需要去服务器上修改对应的配置文件。<br>\n但是随着分布式系统的兴起,由于许多服务都需要使用到该配置文件，因此有<strong>必须保证该配置服务的高可用性</strong>（<code>highavailability</code>）和各台服务器上配置数据的一致性。<br>\n通常会将配置文件部署在一个集群上，然而一个<strong>集群动辄上千台</strong>服务器，此时如果再一台台服务器逐个修改配置文件那将是非常繁琐且危险的的操作，因此就<strong>需要一种服务</strong>，<strong>能够高效快速且可靠地完成配置项的更改等操作</strong>，并能够保证各配置项在每台服务器上的数据一致性。<br>\n<code>Zookeeper</code><strong>就可以提供这样一种服务</strong>，其使用<code>Zab</code>这种一致性协议来保证一致性。现在有很多开源项目使用<code>Zookeeper</code>来维护配置，如在 <code>Hbase</code>中，客户端就是连接一个 <code>Zookeeper</code>，获得必要的<code>Hbase</code>集群的配置信息，然后才可以进一步操作。还有在开源的消息队列<code>Kafka</code>中，也便用<code>Zookeeper</code>来维护<code>brokers</code>的信息。在<code>Alibaba</code>开源的<code>soa</code>框架<code>Dubbo</code>中也广泛的使用<code>Zookeeper</code>管理一些配置来实现服务治理。<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/zookeeper-maintain-config.png\" alt=\"\" loading=\"lazy\"></li>\n<li>分布式锁服务<br>\n一个集群是一个分布式系统，由多台服务器组成。为了提高并发度和可靠性，多台服务器上运行着同一种服务。当多个服务在运行时就需要协调各服务的进度，有时候需要保证当某个服务在进行某个操作时，其他的服务都不能进行该操作，即对该操作进行加锁，如果当前机器挂掉后，释放锁并<code>fail over</code>到其他的机器继续执行该服务。</li>\n<li>集群管理<br>\n一个集群有时会因为各种软硬件故障或者网络故障，出现棊些服务器挂掉而被移除集群，而某些服务器加入到集群中的情况，<code>Zookeeper</code>会将这些服务器加入/移出的情况通知给集群中的其他正常工作的服务器，以及时调整存储和计算等任务的分配和执行等，此外<code>Zookeeper</code>还会对故障的服务器做出诊断并尝试修复。<br>\n<img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/zookeeper-cluster-manager.png\" alt=\"\" loading=\"lazy\"></li>\n<li>生产分布式唯一<code>ID</code><br>\n在过去的单库单表型系统中，通常可以使用数据库字段自带的<code>auto_ increment</code>属性来自动为每条记录生成一个唯一的<code>ID</code>。但是分库分表后，就无法在依靠数据库的<code>auto_ Increment</code>属性来唯一标识一条记录了。此时我们就可以用<code>Zookeeper</code>在分布式环境下生成全局唯一<code>ID</code>。<br>\n做法如下:每次要生成一个新<code>ID</code>时，创建一个持久顺序节点，创建操作返回的节点序号，即为新<code>ID</code>，然后把比自己节点小的删除即可。</li>\n</ol>\n<h1> Zookeeper 的设计目标</h1>\n<p><code>ZooKeeper</code>致力于为分布式应用提供一个高性能、高可用，且具有严格顺序访问控制能力的分布式协调服务</p>\n<ul>\n<li>高性能<br>\n<code>Zookeeper</code>将全量数据存储在<strong>内存</strong>中，并直接服务于客户端的所有非事务请求，尤其用于以读为主的应用场景</li>\n<li>高可用<br>\n<code>Zookeeper</code>一般以集群的方式对外提供服务，一般<code>3~5</code>台机器就可以组成一个可用的<code>Zookeeper</code>集群了，每台机器都会在内存中维护当前的服务器状态，井且每台机器之间都相互保持着通信。只要集群中超过一半的机器都能够正常工作，那么整个集群就能够正常对外服务</li>\n<li>严格顺序访问<br>\n对于来自客户端的每个更新请求，<code>Zookeeper</code>都会分配一个全局唯一的递增编号，这个编号反应了所有事务操作的先后顺序。</li>\n</ul>\n<h1> 数据模型</h1>\n<p><code>Zookeeper</code>的数据结点可以视为树状结构（或目录），树中的各个结点被称为<code>znode </code>（即<code>zookeeper node</code>），一个<code>znode</code>可以由多个子结点。<code>Zookeeper</code>结点在结构上表现为树状。</p>\n<p>使用路径<code>path</code>来定位某个<code>znode</code>，比如<code>/ns-1/itcast/mysqml/schemal1/table1</code>，此处<code>ns-1，itcast、mysql、schemal1、table1</code>分别是根结点、2 级结点、3 级结点以及 4 级结点；其中<code>ns-1</code>是<code>itcast</code>的父结点，<code>itcast</code>是<code>ns-1</code>的子结点，<code>itcast</code>是<code>mysql</code>的父结点....以此类推。</p>\n<p><code>znode</code>兼具文件和目录两种特点，即像文件一样维护着数据、元信息、ACL、时间戳等数据结构，又像目录一样可以作为路径标识的一部分。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/znode.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>那么如何描述一个<code>znode</code>呢？一个<code>znode</code>大体上分为 3 个部分：</p>\n<ul>\n<li>结点的数据：即<code>znode data </code>(结点<code>path</code>，结点<code>data</code>)的关系就像是<code>Java map </code>中的 <code>key value </code>关系</li>\n<li>结点的子结点<code>children</code></li>\n<li>结点的状态<code>stat</code>：用来描述当前结点的创建、修改记录，包括<code>cZxid</code>、<code>ctime</code>等</li>\n</ul>\n<h2> 结点状态 stat 的属性</h2>\n<p>在<code>zookeeper shell</code>中使用<code>get</code>命令查看指定路径结点的<code>data</code>、<code>stat</code>信息。</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h3> 属性说明</h3>\n<p>结点的各个属性如下：<a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_zkDataModel_znodes\" target=\"_blank\" rel=\"noopener noreferrer\">Znodes 属性详解</a>。</p>\n<p>其中重要的概念是<code>Zxid(Zookeeper Transaction ID)</code>，<code>Zookeeper</code>结点的每一次更改都具有唯一的<code>Zxid</code>，如果<code>Zxid-1</code> 小于<code> Zxid-2</code> ，则<code>Zxid-1</code> 的更改发生在 <code>Zxid-2 </code>更改之前。</p>\n<ul>\n<li><code>cZxid</code>：数据结点创建时的事务<code>ID</code>——针对于<code>Zookeeper</code>数据结点的管理：我们对结点数据的一些写操作都会导致<code>Zookeeper</code>自动地为我们去开启一个事务，并且自动地去为每一个事务维护一个事务<code>ID</code></li>\n<li><code>ctime</code>：数据结点创建时的时间</li>\n<li><code>mZxid</code>：数据结点最后一次更新时的事务<code>ID</code></li>\n<li><code>mtime</code>：数据结点最后一次更新时的时间</li>\n<li><code>pZxid</code>：数据节点最后一次修改此<code>znode</code>子节点更改的<code>zxid</code></li>\n<li><code>cversion</code>：子结点的更改次数</li>\n<li><code>dataVersion</code>：结点数据的更改次数</li>\n<li><code>aclVersion</code>：结点的<code>ACL</code>更改次数——类似<code>Linux</code>的权限列表，维护的是当前结点的权限列表被修改的次数</li>\n<li><code>ephemeralOwner</code>：如果结点是临时结点，则表示创建该结点的会话的<code>SessionID</code>；如果是持久结点，该属性值为 0</li>\n<li><code>dataLength</code>：数据内容的长度</li>\n<li><code>numChildren</code>：数据结点当前的子结点个数</li>\n</ul>\n<h3> 结点类型</h3>\n<p><code>Zookeeper</code>中的结点有两种，分别为<strong>临时结点</strong>和<strong>永久结点</strong>。结点的类型在创建时被确定，并且不能改变。</p>\n<ul>\n<li>临时节点<br>\n该节点的生命周期依赖于创建它们的会话。一旦会话（<code>Session</code>）结束，临时节点将被自动删除，当然可以也可以手动删除；虽然每个临时的<code>Znode</code>都会绑定到一个客户端会话，但他们对所有的客户端还是可见的；另外，<code>Zookeeper</code>的临时节点不允许拥有子节点。</li>\n<li>持久化结点<br>\n该结点的生命周期不依赖于会话，并且只有在客户端显示执行删除操作的时候，它们才能被删除。</li>\n</ul>\n<h1> 单机安装</h1>\n<p><a href=\"http://archive.apache.org/dist/zookeeper/\" target=\"_blank\" rel=\"noopener noreferrer\">Zookeeper 镜像</a></p>\n<p>测试系统环境：</p>\n<ul>\n<li><code>Centos7.3</code></li>\n<li><code>Zookeeper:zookeeper-3.4.10.tar.gz</code></li>\n<li><code>jdk:jdk-8u131-linux-x64.tar.gz</code></li>\n</ul>\n<p>安装步骤：</p>\n<ol>\n<li>在<code>Centos</code>中使用<code>root</code>用户创建<code>zookeeper</code>用户，用户名：<code>zookeeper</code>密码：<code>zookeeper</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li><code>Zookeeper</code>底层依赖于<code>jdk</code>，<code>Zookeeper</code>用户登录后，根目录下先进行<code>jdk</code>的安装，<code>jdk</code>使用 <code>jdk-8u131-linux-x64.tar.gz</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>配置<code>jdk</code>环境变量<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>检测<code>jdk</code>安装<br>\n<code>java -version</code> // 如果反馈了Java信息，则成功</li>\n<li><code>Zookeeper</code> 上传解压<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>为<code>Zookeeper</code>准备配置文件<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>启动<code>Zookeeper</code><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h1> 常用 shell 命令</h1>\n<p><code>zookeeper</code>——<code>getting started</code>——<a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_FileManagement\" target=\"_blank\" rel=\"noopener noreferrer\">命令详解</a></p>\n<h2> 操作结点</h2>\n<h3> 查询</h3>\n<ul>\n<li><code>get /hadoop</code>：查看结点的数据和属性</li>\n<li><code>stat /hadoop</code>：查看结点的属性</li>\n</ul>\n<h3> 创建</h3>\n<p>创建结点并写入数据：</p>\n<p><code>create [-s] [-e] path data</code>：其中<code>-s</code>为有序结点，<code>-e</code>临时结点（默认是持久结点）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><strong>更新</strong></p>\n<p>更新结点的命令是<code>set</code>，可以直接进行修改，如下：</p>\n<p><code>set path [version]</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 删除</h3>\n<p>删除结点的语法如下：</p>\n<p><code>delete path [version]</code>：和<code>set</code>方法相似，也可以传入版本号</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>要想删除某个结点及其所有后代结点，可以使用递归删除，命令为<code>rmr path</code></p>\n<h3> 查看结点列表</h3>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 监听器</h2>\n<ul>\n<li><code>get path [watch] | stat path [watch]</code>：使用<code>get path [watch]</code> 注册的监听器能够在结点<strong>内容发生改变</strong>的时候，向客户端发出通知。需要注意的是<code>Zookeeper</code>的触发器是一次性的（<code>One-time trigger</code>），即触发一次后就会立即失效<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li><code>ls\\ls2 path [watch]</code>：使用<code>ls path [watch] 或 ls2 path [watch] </code>注册的监听器能够监听该结点下<strong>所有子节点</strong>的<strong>增加</strong>和<strong>删除</strong>操作<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h2> Zookeeper 的 ACL 权限控制</h2>\n<p><a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_ZooKeeperAccessControl\" target=\"_blank\" rel=\"noopener noreferrer\">ACL 详解</a> <a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_BuiltinACLSchemes\" target=\"_blank\" rel=\"noopener noreferrer\">ACL案例</a></p>\n<p><code>Zookeeper </code>类似文件系统，<code>client</code>可以创建结点、更新结点、删除结点，那么如何做到结点的权限控制呢？</p>\n<p><code>Zookeeper</code>的 <code>access control list</code> 访问控制列表可以做到这一点，<code>acl</code>权限控制，使用<code>scheme：id：permission </code>来标识，主要涵盖 3 个方面：</p>\n<ul>\n<li>权限模式（<code>scheme</code>）：授权的策略</li>\n<li>授权对象（<code>id</code>）：授权的对象</li>\n<li>权限（<code>permission</code>）：授予的权限</li>\n</ul>\n<p>其特性如下：</p>\n<ul>\n<li>\n<p><code>Zookeeper</code>的权限控制是基于每个<code>znode</code>结点的，需要对每个结点设置权限</p>\n</li>\n<li>\n<p>每个<code>znode</code>支持多种权限控制方案和多个权限</p>\n</li>\n<li>\n<p>子结点不会继承父结点的权限，客户端无权访问某结点，但可能可以访问它的子结点，例如：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h3> 权限模式</h3>\n<h4> 授权方式</h4>\n<table>\n<thead>\n<tr>\n<th>方案</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>world</td>\n<td>只有一个用户：<code>anyone</code>，代表登录 <code>zookeeper</code> 所有人(默认)</td>\n</tr>\n<tr>\n<td>ip</td>\n<td>对客户端使用 IP 地址认证</td>\n</tr>\n<tr>\n<td>auth</td>\n<td>使用已添加认证的用户认证</td>\n</tr>\n<tr>\n<td>digest</td>\n<td>使用\"用户名：密码\"方式认证</td>\n</tr>\n</tbody>\n</table>\n<h4> 授权对象</h4>\n<p>给谁授予权限：授权对象<code>ID</code>是指权限赋予的实体，例如：<code>IP</code>地址或用户。</p>\n<h4> 授权权限</h4>\n<p>授予什么权限：<code>create、delete、read、writer、admin</code>也就是 增、删、查、改、管理权限，这 5 种权限简写为<code>c d r w a</code>。</p>\n<p>注意：这五种权限中，有的权限并不是对结点自身操作的。</p>\n<p>例如：<code>delete</code>是指对<strong>子结点</strong>的删除权限可以试图删除父结点，但是子结点必须删除干净，所以<code>delete</code>的权限也是很有用的</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">权限</th>\n<th style=\"text-align:center\">ACL 简写</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">create</td>\n<td style=\"text-align:center\">c</td>\n<td style=\"text-align:center\">可以创建子结点</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">delete</td>\n<td style=\"text-align:center\">d</td>\n<td style=\"text-align:center\">可以删除子结点(仅下一级结点)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">read</td>\n<td style=\"text-align:center\">r</td>\n<td style=\"text-align:center\">可以读取结点数据以及显示子结点列表</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">write</td>\n<td style=\"text-align:center\">w</td>\n<td style=\"text-align:center\">可以设置结点数据</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">admin</td>\n<td style=\"text-align:center\">a</td>\n<td style=\"text-align:center\">可以设置结点访问控制权限列表</td>\n</tr>\n</tbody>\n</table>\n<h5> 授权的相关命令</h5>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>使用方式</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>getAcl</td>\n<td>getAcl</td>\n<td>读取 ACL 权限</td>\n</tr>\n<tr>\n<td>setAcl</td>\n<td>setAcl</td>\n<td>设置 ACL 权限</td>\n</tr>\n<tr>\n<td>addauth</td>\n<td>addauth</td>\n<td>添加认证用户</td>\n</tr>\n</tbody>\n</table>\n<h3> 案例/远程登录</h3>\n<p><code>./zkServer.sh -server 192.168.133.133</code>可以远程登录</p>\n<h4> world 权限模式</h4>\n<ul>\n<li><code>getAcl /node</code>：读取权限信息</li>\n<li><code>setAcl /node world:anyone:drwa</code>：设置权限（禁用创建子结点的权限）</li>\n</ul>\n<h4> ip 模式</h4>\n<p><code>./zkServer.sh -server 192.168.133.133</code>可以远程登录</p>\n<ul>\n<li><code>setAcl /hadoop ip:192.168.133.133:drwa</code>：如果在两台不同的虚拟机中，另一台用远程连接的模式进行这条命令，那么只会有一台被授权</li>\n<li>需要两台虚拟机一起授权的话需要用<strong>逗号</strong>将授权列表隔开：<code>setAcl /hadoop ip:192.168.133.133:cdrwa,ip:192.168.133.132:cdrwa</code></li>\n</ul>\n<h4> auth 认证用户模式</h4>\n<ul>\n<li><code>addauth digest &lt;user&gt;:&lt;password&gt;</code></li>\n<li><code>setAcl &lt;path&gt; auth:&lt;user&gt;:&lt;acl&gt;</code></li>\n</ul>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Digest 授权模式</h4>\n<p><code>setAcl &lt;path&gt; digest:&lt;user&gt;:&lt;password&gt;:&lt;acl&gt;</code>：这里的密码是经过<code>SHA1</code>以及<code>BASE64</code>处理的密文，在<code>shell</code>中可以通过以下命令计算：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 多种授权模式</h4>\n<p>仅需逗号隔开</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><h4> ACL 超级管理员</h4>\n<ul>\n<li><code>Zookeeper</code>的权限管理模式有一种叫做<code>super</code>，该模式提供一个超管，可以方便的访问任何权限的节点<br>\n假设这个超管是<code>supper:admin</code>，需要为超管生产密码的密文：<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>那么打开<code>Zookeeper</code>目录下<code>/bin/zkServer.sh</code>服务器脚本文件，找到如下一行：<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>这个就算脚本中启动<code>Zookeeper</code>的命令，默认只有以上两个配置项，我们需要添加一个超管的配置项<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>修改后命令变成如下<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div></li>\n<li>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ul>\n<h1> Zookeeper 的 JavaAPI</h1>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><code>zonde</code>是<code>Zookeeper</code>集合的核心组件，<code>Zookeeper API</code> 提供了一小组使用<code>Zookeeper</code>集群来操作<code>znode</code>的所有细节。</p>\n<p>客户端应该遵循以下步骤，与<code>Zookeeper</code>服务器进行清晰和干净的交互：</p>\n<ol>\n<li>连接到<code>Zookeeper</code>服务器，<code>Zookeeper</code>服务器为客户端分配会话<code>ID</code></li>\n<li>定期向服务器发送心跳，否则，<code>Zookeeper</code>服务器将过期会话<code>ID</code>，客户端需要重新连接</li>\n<li>只要会话<code>ID</code>处于活动状态，就可以获取/设置<code>znode</code></li>\n<li>所有任务完成后，断开与<code>Zookeeper</code>服务器连接，如果客户端长时间不活动，则<code>Zookeeper</code>服务器将自动断开客户端</li>\n</ol>\n<h2> 连接到 Zookeeper</h2>\n<p>这部分，官网的解释十分稀少<a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_ConnectingToZooKeeper\" target=\"_blank\" rel=\"noopener noreferrer\">官网详解</a></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><ul>\n<li><code>connectionString</code>：<code>Zookeeper</code>主机</li>\n<li><code>sessionTimeout </code>：会话超时</li>\n<li><code>watcher</code>：  实现\"监听器\" 对象，<code>Zookeeper</code>集合通过监视器对象返回连接状态</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 新增节点</h2>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">path</td>\n<td style=\"text-align:center\">znode 路径</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">data</td>\n<td style=\"text-align:center\">数据</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">acl</td>\n<td style=\"text-align:center\">要创建的节点的访问控制列表。Zookeeper API 提供了一个静态接口 ZooDefs.Ids 来获取一些基本的 ACL 列表。例如，ZooDefs.Ids.OPEN_ACL_UNSAFE 返回打开 znode 的 ACL 列表</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">createMode</td>\n<td style=\"text-align:center\">节点的类型，这是一个枚举</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">callBack</td>\n<td style=\"text-align:center\">异步回调接口</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ctx</td>\n<td style=\"text-align:center\">传递上下文参数</td>\n</tr>\n</tbody>\n</table>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 修改节点</h2>\n<p>同样也有两种修改方式（<code>异步和同步</code>）</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><table>\n<thead>\n<tr>\n<th>参数</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td>节点路径</td>\n</tr>\n<tr>\n<td>data</td>\n<td>数据</td>\n</tr>\n<tr>\n<td>version</td>\n<td>数据的版本号， -1 代表不使用版本号，乐观锁机制</td>\n</tr>\n<tr>\n<td>callBack</td>\n<td>异步回调 AsyncCallback.StatCallback，和之前的回调方法参数不同，这个可以获取节点状态</td>\n</tr>\n<tr>\n<td>ctx</td>\n<td>传递上下文参数</td>\n</tr>\n</tbody>\n</table>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 删除节点</h2>\n<p>异步、同步</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><table>\n<thead>\n<tr>\n<th>参数</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td>节点路径</td>\n</tr>\n<tr>\n<td>version</td>\n<td>版本</td>\n</tr>\n<tr>\n<td>callBack</td>\n<td>数据的版本号， -1 代表不使用版本号，乐观锁机制</td>\n</tr>\n<tr>\n<td>ctx</td>\n<td>传递上下文参数</td>\n</tr>\n</tbody>\n</table>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 查看节点</h2>\n<p>同步、异步</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><table>\n<thead>\n<tr>\n<th>参数</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td>节点路径</td>\n</tr>\n<tr>\n<td>boolean</td>\n<td>是否使用连接对象中注册的监听器</td>\n</tr>\n<tr>\n<td>stat</td>\n<td>元数据</td>\n</tr>\n<tr>\n<td>callBack</td>\n<td>异步回调接口，可以获得状态和数据</td>\n</tr>\n<tr>\n<td>ctx</td>\n<td>传递上下文参数</td>\n</tr>\n</tbody>\n</table>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 查看子节点</h2>\n<p>同步、异步</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><table>\n<thead>\n<tr>\n<th>参数</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td>节点路径</td>\n</tr>\n<tr>\n<td>boolean</td>\n<td></td>\n</tr>\n<tr>\n<td>callBack</td>\n<td>异步回调，可以获取节点列表</td>\n</tr>\n<tr>\n<td>ctx</td>\n<td>传递上下文参数</td>\n</tr>\n</tbody>\n</table>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> 检查节点是否存在</h2>\n<p>同步、异步</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><table>\n<thead>\n<tr>\n<th>参数</th>\n<th>解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path</td>\n<td>节点路径</td>\n</tr>\n<tr>\n<td>boolean</td>\n<td></td>\n</tr>\n<tr>\n<td>callBack</td>\n<td>异步回调，可以获取节点列表</td>\n</tr>\n<tr>\n<td>ctx</td>\n<td>传递上下文参数</td>\n</tr>\n</tbody>\n</table>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> 事件监听机制</h1>\n<h2> watcher 概念</h2>\n<p><a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperProgrammers.html#sc_WatchRememberThese\" target=\"_blank\" rel=\"noopener noreferrer\">watcher 概念</a></p>\n<ul>\n<li><code>Zookeeper</code>提供了数据的<code>发布/订阅</code>功能，多个订阅者可同时监听某一特定主题对象，当该主题对象的自身状态发生变化时例如节点内容改变、节点下的子节点列表改变等，会实时、主动通知所有订阅者</li>\n<li><code>Zookeeper</code>采用了<code>Watcher</code>机制实现数据的发布订阅功能。该机制在被订阅对象发生变化时会异步通知客户端，因此客户端不必在<code>Watcher</code>注册后轮询阻塞，从而减轻了客户端压力</li>\n<li><code>Watcher</code>机制事件上与观察者模式类似，也可看作是一种观察者模式在分布式场景下的实现方式</li>\n</ul>\n<h2> Watcher 架构</h2>\n<p><code>Watcher</code>实现由三个部分组成</p>\n<ul>\n<li><code>Zookeeper</code>服务端</li>\n<li><code>Zookeeper</code>客户端</li>\n<li>客户端的<code>ZKWatchManager对象</code></li>\n</ul>\n<p>客户端<strong>首先将****<code>Watcher</code>**<strong>注册到服务端</strong>，同时将<code>Watcher</code>对象</strong>保存到客户端的****<code>watch</code><strong><strong>管理器中</strong>。当<code>Zookeeper</code>服务端监听的数据状态发生变化时，服务端会<strong>主动通知客户端</strong>，接着客户端的<code>Watch</code>管理器会**触发相关</strong>**<code>Watcher</code>**来回调相应处理逻辑，从而完成整体的数据<code>发布/订阅</code>流程</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/watcher-framework.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h2> Watcher 特性</h2>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>一次性</td>\n<td><code>watcher</code>是<strong>一次性</strong>的，一旦被触发就会移除，再次使用时需要重新注册</td>\n</tr>\n<tr>\n<td>客户端顺序回调</td>\n<td><code>watcher</code>回调是<strong>顺序串行</strong>执行的，只有回调后客户端才能看到最新的数据状态。一个<code>watcher</code>回调逻辑不应该太多，以免影响别的<code>watcher</code>执行</td>\n</tr>\n<tr>\n<td>轻量级</td>\n<td><code>WatchEvent</code>是最小的通信单位，结构上只包含<strong>通知状态、事件类型和节点路径</strong>，并不会告诉数据节点变化前后的具体内容</td>\n</tr>\n<tr>\n<td>时效性</td>\n<td><code>watcher</code>只有在当前<code>session</code>彻底失效时才会无效，若在<code>session</code>有效期内快速重连成功，则<code>watcher</code>依然存在，仍可接收到通知；</td>\n</tr>\n</tbody>\n</table>\n<h2> Watcher 接口设计</h2>\n<p><code>Watcher</code>是一个接口，任何实现了<code>Watcher</code>接口的类就算一个新的<code>Watcher</code>。<code>Watcher</code>内部包含了两个枚举类：<code>KeeperState</code>、<code>EventType</code>。</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/watcher-interface.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<h3> Watcher 通知状态（KeeperState）</h3>\n<p><code>KeeperState</code>是客户端与服务端<strong>连接状态</strong>发生变化时对应的通知类型。路径为<code>org.apache.zookeeper.Watcher.EventKeeperState</code>，是一个枚举类，其枚举属性如下：</p>\n<table>\n<thead>\n<tr>\n<th>枚举属性</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>SyncConnected</td>\n<td>客户端与服务器正常连接时</td>\n</tr>\n<tr>\n<td>Disconnected</td>\n<td>客户端与服务器断开连接时</td>\n</tr>\n<tr>\n<td>Expired</td>\n<td>会话 session 失效时</td>\n</tr>\n<tr>\n<td>AuthFailed</td>\n<td>身份认证失败时</td>\n</tr>\n</tbody>\n</table>\n<h3> Watcher 事件类型（EventType）</h3>\n<p><code>EventType</code>是<strong>数据节点****<code>znode</code>****发生变化</strong>时对应的通知类型。**<code>EventType</code><strong><strong>变化时</strong></strong><code>KeeperState</code><strong><strong>永远处于</strong></strong><code>SyncConnected</code>**<strong>通知状态下</strong>；当<code>keeperState</code>发生变化时，<code>EventType</code>永远为<code>None</code>。其路径为<code>org.apache.zookeeper.Watcher.Event.EventType</code>，是一个枚举类，枚举属性如下：</p>\n<table>\n<thead>\n<tr>\n<th>枚举属性</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>None</td>\n<td>无</td>\n</tr>\n<tr>\n<td>NodeCreated</td>\n<td>Watcher 监听的数据节点被创建时</td>\n</tr>\n<tr>\n<td>NodeDeleted</td>\n<td>Watcher 监听的数据节点被删除时</td>\n</tr>\n<tr>\n<td>NodeDataChanged</td>\n<td>Watcher 监听的数据节点内容发生更改时(无论数据是否真的变化)</td>\n</tr>\n<tr>\n<td>NodeChildrenChanged</td>\n<td>Watcher 监听的数据节点的子节点列表发生变更时</td>\n</tr>\n</tbody>\n</table>\n<p>注意：客户端接收到的相关事件通知中只包含状态以及类型等信息，不包含节点变化前后的具体内容，变化前的数据需业务自身存储，变化后的数据需要调用<code>get</code>等方法重新获取</p>\n<h3> 捕获相应的事件</h3>\n<p>上面讲到<code>Zookeeper</code>客户端连接的状态和<code>Zookeeper</code>对<code>znode</code>节点监听的事件类型，下面我们来讲解如何建立<code>Zookeeper</code>的<code>Watcher</code>监听。在<code>Zookeeper</code>中采用<code>zk.getChildren(path,watch)、zk.exists(path,watch)、zk.getData(path,watcher,stat)</code>这样的方式来为某个<code>znode</code>注册监听 。</p>\n<p>下表以<code>node-x</code>节点为例，说明调用的注册方法和可用监听事件间的关系：</p>\n<table>\n<thead>\n<tr>\n<th>注册方式</th>\n<th>created</th>\n<th>childrenChanged</th>\n<th>Changed</th>\n<th>Deleted</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>zk.exists(\"/node-x\",watcher)</code></td>\n<td>可监控</td>\n<td></td>\n<td>可监控</td>\n<td>可监控</td>\n</tr>\n<tr>\n<td><code>zk.getData(\"/node-x\",watcher)</code></td>\n<td></td>\n<td></td>\n<td>可监控</td>\n<td>可监控</td>\n</tr>\n<tr>\n<td><code>zk.getChildren(\"/node-x\",watcher)</code></td>\n<td></td>\n<td>可监控</td>\n<td></td>\n<td>可监控</td>\n</tr>\n</tbody>\n</table>\n<h2> 注册 Watcher 的方法</h2>\n<h3> 客户端与服务器端的连接状态</h3>\n<ul>\n<li><code>KeeperState</code>：通知状态<code>SyncConnected</code>：客户端与服务器正常连接时</li>\n<li><code>Disconnected</code>：客户端与服务器断开连接时</li>\n<li><code>Expired</code>：会话 <code>session</code> 失效时</li>\n<li><code>AuthFailed</code>：身份认证失败时</li>\n<li>事件类型为：<code>None</code></li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> Watcher 检查节点</h3>\n<h4> exists</h4>\n<ul>\n<li><code>exists(String path, boolean b)</code>：使用连接对象的监视器</li>\n<li><code>exists(String path, Watcher w)</code>：自定义监视器</li>\n<li><code>NodeCreated</code>：<strong>节点</strong>创建</li>\n<li><code>NodeDeleted</code>：<strong>节点</strong>删除</li>\n<li><code>NodeDataChanged</code>：<strong>节点</strong>内容发生变化</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> getData</h4>\n<ul>\n<li><code>getData(String path, boolean b, Stat stat)</code>：使用连接对象的监视器</li>\n<li><code>getData(String path, Watcher w, Stat stat)</code>：自定义监视器</li>\n<li><code>NodeDeleted</code>：节点删除</li>\n<li><code>NodeDataChange</code>：节点内容发生变化</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> getChildren</h4>\n<ul>\n<li><code>getChildren(String path, boolean b)</code>：使用连接对象的监视器</li>\n<li><code>getChildren(String path, Watcher w)</code>：使用自定义的监视器</li>\n<li><code>NodeChildrenChanged</code>：<strong>子节点</strong>发生变化</li>\n<li><code>NodeDeleted</code>：<strong>节点删除</strong></li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 配置中心案例</h3>\n<p>工作中有这样的一个场景：数据库用户名和密码信息放在一个配置文件中，应用读取该配置文件，配置文件信息放入缓存。</p>\n<p>若数据库的用户名和密码改变时候，还需要重新加载媛存，比较麻烦，通过 <code>Zookeeper</code>可以轻松完成,当数据库发生变化时自动完成缓存同步。</p>\n<p>使用事件监听机制可以做出一个简单的配置中心。</p>\n<p>设计思路：</p>\n<ol>\n<li>连接<code>Zookeeper</code>服务器</li>\n<li>读取<code>Zookeeper</code>中的配置信息，注册<code>Watcher</code>监听器，存入本地变量</li>\n<li>当<code>Zookeeper</code>中的配置信息发生变化时，通过<code>Watcher</code>的回调方法捕获数据变化事件</li>\n<li>重新获取配置信息</li>\n</ol>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 分布式唯一id案例</h3>\n<p>在过去的单库单表型系统中，通常第可以使用数据库字段自带的<code>auto_ increment</code>属性来自动为每条记录生成个唯一的<code>ID</code>。但是分库分表后，就无法在依靠数据库的<code>auto_ increment</code>属性来唯一标识一条记录了。此时我们就可以用<code>zookeeper</code>在分布式环境下生成全局唯一<code>ID</code>。</p>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 分布式锁</h3>\n<p>分布式锁有多种实现方式，比如通过数据库、<code>Redis</code>都可实现。作为分布式协同工具<code>Zookeeper</code>，当然也有着标准的实现方式。下面介绍在<code>Zookeeper</code>中如果实现排他锁.</p>\n<p>设计思路：</p>\n<ol>\n<li>每个客户端往<code>/Locks</code>下创建临时有序节点<code>/Locks/Lock_</code>，创建成功后<code>/Locks</code>下面会有每个客户端对应的节点，如<code>/Locks/Lock_000000001</code></li>\n<li>客户端取得<code>/Locks</code>下子节点，并进行排序，判断排在前面的是否为自己，如果自己的锁节点在第一位，代表获取锁成功</li>\n<li>如果自己的锁节点不在第一位，则监听自己前一位的锁节点。例如，自己锁节点<code>Lock_000000002</code>，那么则监听<code>Lock_000000001</code></li>\n<li>当前一位锁节点<code>(Lock_000000001)</code>对应的客户端执行完成，释放了锁，将会触发监听客户端<code>(Lock_000000002)</code>的逻辑</li>\n<li>监听客户端重新执行第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2</span></span></span></span> 步逻辑，判断自己是否获得了锁</li>\n<li><code>Zookeeper</code>是有工具包的（这里采用手写）</li>\n</ol>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h1> 集群搭建</h1>\n<p><code>zookeeper</code>官网——<code>Getting started</code>——<a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperStarted.html#sc_RunningReplicatedZooKeeper\" target=\"_blank\" rel=\"noopener noreferrer\">zookeeper 官网</a></p>\n<p>完全配置——<a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_zkMulitServerSetup\" target=\"_blank\" rel=\"noopener noreferrer\">完全配置1</a>——<a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_configuration\" target=\"_blank\" rel=\"noopener noreferrer\">完全配置2</a></p>\n<p>运行时复制的<code>Zookeeper</code>。</p>\n<p><strong>说明</strong>：对于复制模式，至少需要三个服务器，并且强烈建议使用奇数个服务器。如果只有两台服务器，那么您将处于一种情况，如果其中一台服务器发生故障，则没有足够的计算机构成多数仲裁（<code>zk</code>采用的是过半数仲裁。因此，搭建的集群要容忍 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个节点的故障，就必须有 2n+1 台计算机，这是因为宕掉 n 台后，集群还残余 n+1 台计算机，n+1 台计算机中必定有一个最完整最接近<code>leader</code>的<code>follower</code>，假如宕掉的 n 台都是有完整信息的，剩下的一台就会出现在残余的<code>zk</code>集群中。也就是说：<code>zk</code>为了安全，必须达到多数仲裁，否则没有<code>leader</code>，集群失败，具体体现在<code>**leader**</code><strong>选举</strong>一章）。由于存在两个单点故障，因此两个服务器还<strong>不如</strong>单个服务器稳定。</p>\n<p>——关于 2n+1 原则，<code>Kafka</code>官网有权威的解释（虽然<code>Kafka</code>不采用）<a href=\"http://kafka.apache.org/0110/documentation.html#design_replicatedlog\" target=\"_blank\" rel=\"noopener noreferrer\">设计原则</a></p>\n<p>多数仲裁的设计是为了<strong>避免脑裂</strong>（<code>zk</code>已经采用了多数仲裁，所以不会出现），和数据一致性的问题</p>\n<ul>\n<li>\n<p><strong>脑裂</strong>：由于网络延迟等各种因素，最终导致集群一分为二，各自独立运行（两个<code>leader</code>），集群就是坏的</p>\n</li>\n<li>\n<p>如果有两台服务器，两台都认为另外的<code>zk</code>宕掉，各自成为<code>leader</code>运行（假设可以，实际上选不出<code>leader</code>，可以实际搭建一个集群，看看一台zk是否能够成功集群，详见**<code>leader</code>**<strong>选举</strong>），就会导致数据不一致。</p>\n</li>\n<li>\n<p>如果有三台服务器，一台因为网络分区，无法连接，剩下两台网络正常，选举出了<code>leader</code>，集群正常</p>\n</li>\n<li>\n<p>以此类推</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/zookeeper-cluster.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p><code>zk</code>的设计天生就是<code>cap</code>中的<code>cp</code>，所以不会出现上述的脑裂和数据一致性问题，我们搭建<code>zk</code>仅需保证<code>2n+1</code>原则</p>\n</li>\n</ul>\n<p>复制模式所需的<code>conf / zoo.cfg</code>文件类似于独立模式下使用的文件，但有一些区别。这是一个例子：</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li>新的键值<code>initLimit</code>是<code>zookeeper</code>用于限制选举中<code>zookeeper</code>服务连接到<code>leader</code>的时间，**<code>syncLimit</code>**限制服务器与<code>leader</code>的过期时间</li>\n<li>对于这两个超时，您都可以使用<code>tickTime</code>指定时间单位。在此示例中，<code>initLimit</code>的超时为 5 个滴答声，即<code>2000</code>毫秒/滴答声，即 10 秒</li>\n<li>表格<code>server.X</code>的条目列出了组成<code>ZooKeeper</code>服务的服务器。服务器启动时，它通过在数据目录中查找文件<code>myid</code>来知道它是哪台服务器。该文件包含<code>ASCII</code>的服务器号。</li>\n<li>最后，记下每个服务器名称后面的两个端口号：2888 和 3888。对等方使用前一个端口连接到其他对等方。这种连接是必需的，以便对等方可以进行通信，例如，以商定更新顺序。更具体地说，<strong><code>ZooKeeper</code><strong><strong>服务器使用此端口将</strong></strong><code>follower</code><strong><strong>连接到</strong></strong><code>leader</code></strong>。当出现新的<code>leader</code>者时，<code>follower</code>使用此端口打开与<code>leader</code>的<code>TCP</code>连接。因为默认的<code>leader</code>选举也使用<code>TCP</code>，所以我们当前需要另一个端口来进行<code>leader</code>选举。这是第二个端口。</li>\n</ul>\n<p><strong>正文</strong>搭建：单机环境下，<code>jdk</code>、<code>Zookeeper</code>安装完毕，基于一台虚拟机，进行<code>Zookeeper</code><strong>伪集群搭建</strong>，<code>Zookeeper</code>集群中包含 3 个节点，节点对外提供服务端口号，分别为 2181、2182、2183。</p>\n<ol>\n<li>\n<p>基于<code>zookeeper-3.4.10</code>复制三份<code>zookeeper</code>安装好的服务器文件,目录名称分别为<code>zookeeper2181</code>、<code>zookeeper2182</code>、<code>zookeeper2183</code></p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>修改<code>zookeeper2181</code>服务器对应配置文件</p>\n<div class=\"language-conf line-numbers-mode\" data-ext=\"conf\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p>在上一步<code>dataDir</code>指定的目录下，创建<code>myid</code>文件，然后在该文件添加上一步<code>server</code>配置的对应<code>A</code>数字</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n<li>\n<p><code>zookeeper2182、2183</code>参照 2/3 进行相应配置</p>\n</li>\n<li>\n<p>分别启动三台服务器，检验集群状态<br>\n检查：<code>cd</code>进入<code>bin</code>目录<code>./zkServer status</code><br>\n登录命令：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></li>\n</ol>\n<h2> 一致性协议——zab 协议</h2>\n<p><code>zab</code>协议的全称是<code>Zookeeper Atomic Broadcast</code>（<code>Zookeeper</code>原子广播）。<code>Zookeeper</code>是通过<code>zab</code>协议来保证分布式事务的最终一致性</p>\n<p>基于<code>zab</code>协议，<code>Zookeeper</code>集群中的角色主要有以下三类，如下所示：</p>\n<table>\n<thead>\n<tr>\n<th>角色</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>领导者(Leader)</td>\n<td>领导者负责进行投票的发起和决议，更新系统状态</td>\n</tr>\n<tr>\n<td>学习者(Learner)-跟随者(Follower)</td>\n<td>Follower 用于接收客户端请求并向客户端返回结果，在选主过程中参与投票</td>\n</tr>\n<tr>\n<td>学习者(Learner)-观察者(ObServer)</td>\n<td>ObServer 可以接收客户端连接，将写请求转发给 leader 节点。但 ObServer 不参加投票过程，只同步 leader 的状态。ObServer 的目的是为了扩展系统，提高读取速度</td>\n</tr>\n<tr>\n<td>客户端(Client)</td>\n<td>请求发起方</td>\n</tr>\n</tbody>\n</table>\n<p><code>zab</code>广播模式工作原理，通过类似两端式提交协议的方式解决数据一致性：</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/zab-broadcast.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<ol>\n<li><code>leader</code>从客户端收<strong>到一个写请求</strong></li>\n<li><code>leader</code><strong>生成一个新的事务</strong>并为这个事务生成一个唯一的<code>ZXID</code></li>\n<li><code>leader</code><strong>将事务提议（<strong><strong><code>propose</code></strong></strong>）发送给所有的</strong>**<code>follows</code>**<strong>节点</strong></li>\n<li><code>follower</code>节点将收到的事务请求加入到本地<strong>历史队列（<strong><strong><code>history queue</code></strong></strong>）中，并发送****<code>ack</code><strong><strong>给</strong></strong><code>leader</code></strong>，表示确认提议</li>\n<li>当<code>leader</code>收到大多数<code>follower</code>（<strong>半数以上节点</strong>）的<code>ack(acknowledgement)</code>确认消息，<code>leader</code>会本地提交，并发送<code>commit</code>请求</li>\n<li>当<code>follower</code><strong>收到</strong>**<code>commit</code><strong><strong>请求时，从历史队列中将事务请求</strong></strong><code>commit</code>**</li>\n</ol>\n<p>因为是半数以上的结点就可以通过事务请求，所以延迟不高。</p>\n<h2> leader 选举</h2>\n<h3> 服务器状态</h3>\n<ul>\n<li><code>looking</code>：寻找<code>leader</code>状态。当服务器处于该状态时，它会认为当前集群中没有<code>leader</code>，因此需要进入<code>leader</code>选举状态</li>\n<li><code>following</code>：跟随着状态。表明当前服务器角色是<code>follower</code></li>\n<li><code>observing</code>：观察者状态。表明当前服务器角色是<code>observer</code></li>\n</ul>\n<p>分为两种选举，<strong>服务器启动时的选举</strong>和<strong>服务器运行时期的选举。</strong></p>\n<h4> 服务器启动时期的 leader 选举</h4>\n<p>在集群初始化节点，当有一台服务器<code>server1</code>启动时，其**单独无法进行和完成****<code>leader</code><strong><strong>选举</strong>，当第二台服务器<code>server2</code>启动时，此时两台及其可以相互通信，每台及其都试图找到<code>leader</code>，<strong>于是进入</strong></strong><code>leader</code>**<strong>选举过程</strong>。选举过程如下：</p>\n<ol>\n<li>\n<p>每个<code>server</code>发出一个投票</p>\n<p>由于是初始状态，<code>server1</code>和<code>server2</code>都会将自己作为<code>leader</code>服务器来进行投票，每次投票都会包<strong>含所推举的****<code>myid</code><strong><strong>和</strong></strong><code>zxid</code><strong><strong>，使用</strong></strong><code>(myid，zxid)</code></strong>，此时<code>server1</code>的投票为 (1, 0)，<code>server2</code>的投票为 (2, 0)，然后<strong>各自将这个投票发给集群中的其它机器。</strong></p>\n</li>\n<li>\n<p>集群中的<strong>每台服务器都接收来自集群中各个服务器的投票</strong></p>\n</li>\n<li>\n<p><strong>处理投票</strong></p>\n<p>针对每一个投票，服务器都需要将别人的投票和自己的投票进行<code>pk</code>，规则如下：</p>\n<ul>\n<li>优先检查<code>zxid</code>。<code>zxid</code>比较大的服务器优先作为<code>leader</code>（**<code>zxid</code>**<strong>较大者保存的数据更多</strong>）</li>\n<li>如果<code>zxid</code>相同。那么就比较<code>myid</code>。<code>myid</code>较大的服务器作为<code>leader</code>服务器<br>\n<strong>对于 server1</strong> <strong>而言，它的投票是 (1, 0)，接收 server2</strong> <strong>的投票为 (2, 0)，<strong>首先会比较两者的<code>zxid</code></strong>，均为 0，<strong>再比较<code>myid</code></strong>，此时 server2 的</strong>**<code>myid</code>****最大，于是更新自己的投票为 (2, 0)**，然后重新投票，<strong>对于 server2 而言，无需更新自己的投票</strong>，只是再次向集群中所有机器发出上一次投票信息即可</li>\n</ul>\n</li>\n<li>\n<p><strong>统计投票</strong></p>\n</li>\n<li>\n<p>每次投票后，服务器都会统计投票信息，判断是否已经有<strong>过半机器接受到相同的投票信息</strong>，对于 server1、server2 而言，都统计出集群中已经有两台机器接受了 (2, 0) 的投票信息，此时便认为已经选举出了<code>leader</code></p>\n</li>\n<li>\n<p><strong>改变服务器状态</strong>。一旦确定了<code>leader</code>,每个服务器就会更新自己的状态，如果是<code>follower</code>，那么就变更为<code>following</code>，如果是<code>leader</code>，就变更为<code>leading</code></p>\n</li>\n</ol>\n<p><strong>举例：如果我们有三个节点的集群，1, 2, 3，启动 1 和 2 后，2 一定会是 <strong><strong><code>leader</code></strong></strong>，</strong>****** 再加入不会进行选举，而是直接成为****<code>follower</code>**—— 仔细观察 一台<code>zk</code>无法集群，没有<code>leader</code>。</p>\n<h4> 服务器运行时期选举</h4>\n<p>在<code>zookeeper</code>运行期间，<code>leader</code>与非<code>leader</code>服务器各司其职，即使当有非<code>leader</code>服务器宕机或者新加入，此时也不会影响<code>leader</code>，但是一旦<code>leader</code>服务器挂了，那么整个集群将暂停对外服务，进入新一轮<code>leader</code>选举，其过程和启动时期的<code>leader</code>选举过程基本一致。</p>\n<p>假设正在运行的有<code>server1</code>、<code>server2</code>、<code>server3</code>三台服务器，当前<code>leader</code>是<code>server2</code>，若某一时刻<code>leader</code>挂了，此时便开始<code>Leader</code>选举。选举过程如下：</p>\n<ol>\n<li>变更状态。<strong><code>leader</code><strong><strong>挂后，余下的服务器都会将自己的服务器状态变更为</strong></strong><code>looking</code></strong>，然后开始进入<code>leader</code>选举过程</li>\n<li>每个<code>server</code>发出一个投票。在运行期间，<strong>每个服务器上的</strong>**<code>zxid</code><strong><strong>可能不同</strong>，此时假定<code>server1</code>的<code>zxid</code>为<code>122</code>，<code>server3</code>的<code>zxid</code>为<code>122</code>，**在第一轮投票中，</strong>**<code>server1</code><strong><strong>和</strong></strong><code>server3</code>**<strong>都会投自己</strong>，产生投票 (1, 122), (3, 122)，然后<strong>各自将投票发送给集群中所有机器</strong></li>\n<li><strong>接收来自各个服务器的投票</strong>。与启动时过程相同</li>\n<li><strong>处理投票</strong>。与启动时过程相同，此时，<code>server3</code>将会成为<code>leader</code></li>\n<li><strong>统计投票</strong>。与启动时过程相同</li>\n<li><strong>改变服务器的状态</strong>。与启动时过程相同</li>\n</ol>\n<h3> observer 角色及其配置</h3>\n<p><code>zookeeper</code>官网——<code>Observers Guide</code><a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperObservers.html\" target=\"_blank\" rel=\"noopener noreferrer\">observer 详解</a>。</p>\n<p>尽管<code>ZooKeeper</code>通过使用客户端直接连接到该集合的投票成员表现良好，但是此体系结构使其很难扩展到大量客户端。问题在于，随着我们添加更多的投票成员，写入性能会下降。这是由于以下事实：写操作需要（通常）集合中至少一半节点的同意，因此，随着添加更多的投票者，投票的成本可能会显着增加。</p>\n<p>我们引入了一种称为<code>Observer</code>的新型<code>ZooKeeper</code>节点，该节点有助于解决此问题并进一步提高<code>ZooKeeper</code>的可伸缩性。观察员是合法的非投票成员，他们仅听取投票结果，而听不到投票结果。除了这种简单的区别之外，观察者的功能与跟随者的功能完全相同-客户端可以连接到观察者，并向其发送读写请求。观察者像追随者一样将这些请求转发给领导者，但是他们只是等待听取投票结果。因此，我们可以在不影响投票效果的情况下尽可能增加观察员的数量。</p>\n<p>观察者还有其他优点。因为他们不投票，所以它们不是<code>ZooKeeper</code>选举中的关键部分。因此，它们可以在不损害<code>ZooKeeper</code>服务可用性的情况下发生故障或与群集断开连接。给用户带来的好处是，观察者可以通过比跟随者更不可靠的网络链接进行连接。实际上，观察者可用于与另一个数据中心的<code>ZooKeeper</code>服务器进行对话。观察者的客户端将看到快速读取，因为所有读取均在本地提供，并且由于缺少表决协议而需要的消息数量较小，因此写入会导致网络流量最小</p>\n<p><code>ovserver</code>角色<strong>特点</strong>：</p>\n<ol>\n<li><strong>不参与集群的</strong>**<code>leader</code>**<strong>选举</strong></li>\n<li><strong>不参与集群中写数据时的</strong>**<code>ack</code>**<strong>反馈</strong></li>\n</ol>\n<p>为了使用<code>observer</code>角色，在任何想变成<code>observer</code>角色的配置文件中加入如下配置：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div></div></div><p>并在所有<code>server</code>的配置文件中，配置成<code>observer</code>模式的<code>server</code>的那行配置追加<code>:observer</code>，例如：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>注意<code> 2n+1</code>原则——<code>集群搭建</code></p>\n<h3> API 连接集群</h3>\n<p><code>Zookeeper(String connectionString, int sessionTimeout, Watcher watcher)</code></p>\n<ul>\n<li><code>connectionString </code> ：<code>Zookeeper</code>集合主机</li>\n<li><code>sessionTimeout</code>：会话超时(以毫秒为单位)</li>\n<li><code>watcher </code>：实现“监听器”界面的对象，<code>Zookeeper</code>集合通过监视器对象返回连接状态</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2> Curator 介绍</h2>\n<p><a href=\"https://blog.csdn.net/wo541075754/article/details/68067872\" target=\"_blank\" rel=\"noopener noreferrer\">curator 介绍</a></p>\n<p><code>zkClient </code>有对<code>dubbo</code>的一些操作支持，但是<code>zkClient</code>几乎没有文档，下面是<code>curator</code>。</p>\n<h3> Curator 简介</h3>\n<p><code>Curator</code>是<code>Netflix</code>公司开源的一个<code>Zookeeper</code>客户端，后捐献给<code>Apache</code>，<code>Curator</code>框架在<code>Zookeeper</code>原生<code>API</code>接口上进行了包装，解决了很多<code>ZooKeeper</code>客户端非常底层的细节开发，提供<code>ZooKeeper</code>各种应用场景（比如：分布式锁服务、集群领导选举、共享计数器、缓存机制、分布式队列等的抽象封装），实现了<code>Fluent</code>风格的<code>APl</code>接口，是最好用，最流行的<code>Zookeeper</code>的客户端。</p>\n<p>原生<code>Zookeeper API</code>的不足：</p>\n<ul>\n<li>连接对象异步创建，需要开发人员自行编码等待</li>\n<li>连接没有自动重连超时机制</li>\n<li><code>Watcher</code>一次注册生效一次</li>\n<li>不支持递归创建树形节点</li>\n</ul>\n<p><code>Curator</code>特点：</p>\n<ul>\n<li>解决<code>session</code>会话超时重连</li>\n<li><code>Watcher</code>反复注册</li>\n<li>简化开发<code>API</code></li>\n<li>遵循<code>Fluent</code>风格<code>API</code></li>\n</ul>\n<div class=\"language-xml line-numbers-mode\" data-ext=\"xml\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 基础用法</h3>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p><code>session</code>重连策略：</p>\n<ul>\n<li>\n<p><code>RetryPolicy retry Policy = new RetryOneTime(3000);</code></p>\n<p>说明：三秒后重连一次，只重连一次</p>\n</li>\n<li>\n<p><code>RetryPolicy retryPolicy = new RetryNTimes(3,3000);</code></p>\n<p>说明：每三秒重连一次，重连三次</p>\n</li>\n<li>\n<p><code>RetryPolicy retryPolicy = new RetryUntilElapsed(1000,3000);</code></p>\n<p>说明：每三秒重连一次，总等待时间超过个<code>10</code>秒后停止重连</p>\n</li>\n<li>\n<p><code>RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000,3)</code></p>\n<p>说明：这个策略的重试间隔会越来越长</p>\n<p>公式：<code>baseSleepTImeMs * Math.max(1,random.nextInt(1 &lt;&lt; (retryCount + 1)))</code></p>\n<ul>\n<li><code>baseSleepTimeMs</code> = <code>1000</code> 例子中的值</li>\n<li><code>maxRetries</code> = <code>3</code> 例子中的值</li>\n</ul>\n</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 创建</h4>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 修改</h4>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 删除</h4>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 读取节点</h4>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 读取子节点</h4>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 是否存在</h4>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> Watcher</h4>\n<p><code>Curator</code>提供了两种<code>Watcher(Cache)</code>来监听节点变化</p>\n<ul>\n<li><code>Node Cache</code>：只是监听某一个特定的节点，监听节点的新增和修改</li>\n<li><code>PathChildren Cache</code>：监控一个<code>ZNode</code>的子节点。当一个子节点增加、更新、删除时，<code>Path Cache</code>会改变它的状态，会包含最新的子节点、子节点的数据和状态</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 事务</h4>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> 分布式锁</h4>\n<ul>\n<li><code>InterProcessMutex</code>：分布式可重入排它锁</li>\n<li><code>InterProcessReadWriteLock</code>：分布式读写锁</li>\n</ul>\n<div class=\"language-java line-numbers-mode\" data-ext=\"java\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3> 四字监控命令/配置属性</h3>\n<p><code>Zookeeper</code>文档——<code>administrator's Guide</code>——<a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_zkCommands\" target=\"_blank\" rel=\"noopener noreferrer\">四字命令</a> <a href=\"https://zookeeper.apache.org/doc/r3.4.14/zookeeperAdmin.html#sc_configuration\" target=\"_blank\" rel=\"noopener noreferrer\">配置属性</a>。</p>\n<p><code>Zookeeper</code>支持某些特定的四字命令与其的交互。它们大多数是查询命令，用来获取<code>Zookeeper</code>服务的当前状态及相关信息。用户再客户端可以通过<code>telnet</code>或<code>nc</code>向<code>Zookeeper</code>提交相应的命令。</p>\n<p><code>Zookeeper</code>常用四字命令见下表所示：</p>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>conf</td>\n<td>输出相关服务配置的详细信息。比如端口号、<code>zk</code>数据以及日志配置路径、最大连接数，<code>session</code>超时、<code>serverId</code>等</td>\n</tr>\n<tr>\n<td>cons</td>\n<td>列出所有连接到这台服务器的客户端连接/会话的详细信息。包括\"接收/发送\"的包数量、<code>sessionId</code>、操作延迟、最后的操作执行等信息</td>\n</tr>\n<tr>\n<td>crst</td>\n<td>重置当前这台服务器所有连接/会话的统计信息</td>\n</tr>\n<tr>\n<td>dump</td>\n<td>列出未经处理的会话和临时节点，这仅适用于领导者</td>\n</tr>\n<tr>\n<td>envi</td>\n<td>处理关于服务器的环境详细信息</td>\n</tr>\n<tr>\n<td>ruok</td>\n<td>测试服务是否处于正确运行状态。如果正常返回\"<code>imok</code>\"，否则返回空</td>\n</tr>\n<tr>\n<td>stat</td>\n<td>输出服务器的详细信息：接收/发送包数量、连接数、模式(<code>leader/follower</code>)、节点总数、延迟。所有客户端的列表</td>\n</tr>\n<tr>\n<td>srst</td>\n<td>重置<code>server</code>状态</td>\n</tr>\n<tr>\n<td>wchs</td>\n<td>列出服务器<code>watchers</code>的简洁信息：连接总数、<code>watching</code>节点总数和<code>watches</code>总数</td>\n</tr>\n<tr>\n<td>wchc</td>\n<td>通过session分组，列出watch的所有节点，它的输出是一个与<code>watch</code>相关的会话的节点信息，根据<code>watch</code>数量的不同，此操作可能会很昂贵（即影响服务器性能），请小心使用</td>\n</tr>\n<tr>\n<td>mntr</td>\n<td>列出集群的健康状态。包括\"接收/发送\"的包数量、操作延迟、当前服务模式(<code>leader/follower</code>)、节点总数、<code>watch</code>总数、临时节点总数</td>\n</tr>\n</tbody>\n</table>\n<h4> tclnet</h4>\n<ul>\n<li>\n<p><code>yum install -y tclnet</code></p>\n</li>\n<li>\n<p><code>tclnet 192.168.133.133 2181</code>(进入终端)</p>\n<p><code>mntr</code>(现在可以看到信息)</p>\n</li>\n</ul>\n<h4> nc</h4>\n<ul>\n<li>\n<p><code>yum install -y nc</code></p>\n<p><code>echo mntr | nc 192.168.133.133:2181</code></p>\n</li>\n</ul>\n<h4> conf</h4>\n<p><code>echo conf | nc localhost2181</code>：输出相关服务配置的详细信息</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>clientPort</td>\n<td>客户端端口号</td>\n</tr>\n<tr>\n<td>dataDir</td>\n<td>数据快照文件目录，默认情况下 10w 次事务操作生成一次快照</td>\n</tr>\n<tr>\n<td>dataLogDir</td>\n<td>事务日志文件目录，生产环节中放再独立的磁盘上</td>\n</tr>\n<tr>\n<td>tickTime</td>\n<td>服务器之间或客户端与服务器之间维持心跳的时间间隔(以毫秒为单位)</td>\n</tr>\n<tr>\n<td>maxClientCnxns</td>\n<td>最大连接数</td>\n</tr>\n<tr>\n<td>minSessionTimeout</td>\n<td>最小<code>session</code>超时<code>minSessionTimeout=tickTime*2</code> ，即使客户端连接设置了会话超时，也不能打破这个限制</td>\n</tr>\n<tr>\n<td>maxSessionTimeout</td>\n<td>最大<code>session</code>超时<code>maxSessionTimeout=tickTime*20</code>，即使客户端连接设置了会话超时，也不能打破这个限制</td>\n</tr>\n<tr>\n<td>serverId</td>\n<td>服务器编号</td>\n</tr>\n<tr>\n<td>initLimit</td>\n<td>集群中<code>follower</code>服务器<code>(F)</code>与<code>leader</code>服务器<code>(L)</code>之间初始连接时能容忍的最多心跳数，实际上以<code>tickTime</code>为单位，换算为毫秒数</td>\n</tr>\n<tr>\n<td>syncLimit</td>\n<td>集群中<code>follower</code>服务器<code>(F)</code>与<code>leader</code>服务器<code>(L)</code>之间请求和应答之间能容忍的最大心跳数，实际上以<code>tickTime</code>为单位，换算为毫秒数</td>\n</tr>\n<tr>\n<td>electionAlg</td>\n<td>0：基于<code>UDP</code>的<code>LeaderElection</code>1：基于<code>UDP</code>的<code>FastLeaderElection</code>2：基于UDP和认证的<code>FastLeaderElection</code>3：基于<code>TCP</code>的<code>FastLeaderElection</code>在<code>3.4.10</code>版本中，默认值为3，另外三种算法以及被弃用，并且有计划在之后的版本中将它们彻底删除且不再支持</td>\n</tr>\n<tr>\n<td>electionPort</td>\n<td>选举端口</td>\n</tr>\n<tr>\n<td>quorumPort</td>\n<td>数据通信端口</td>\n</tr>\n<tr>\n<td>peerType</td>\n<td>是否为观察者 1为观察者</td>\n</tr>\n</tbody>\n</table>\n<h4> cons</h4>\n<p><code>echo cons | nc localhost2181</code>：列出所有连接到这台服务器的客户端连接/会话的详细信息</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ip</td>\n<td>IP 地址</td>\n</tr>\n<tr>\n<td>port</td>\n<td>端口号</td>\n</tr>\n<tr>\n<td>queued</td>\n<td>等待被处理的请求数，请求缓存在队列中</td>\n</tr>\n<tr>\n<td>received</td>\n<td>收到的包数</td>\n</tr>\n<tr>\n<td>sent</td>\n<td>发送的包数</td>\n</tr>\n<tr>\n<td>sid</td>\n<td>会话<code>id</code></td>\n</tr>\n<tr>\n<td>lop</td>\n<td>最后的操作 GETD-读取数据 DELE-删除数据 CREA-创建数据</td>\n</tr>\n<tr>\n<td>est</td>\n<td>连接时间戳</td>\n</tr>\n<tr>\n<td>to</td>\n<td>超时时间</td>\n</tr>\n<tr>\n<td>lcxid</td>\n<td>当前会话的操作<code>id</code></td>\n</tr>\n<tr>\n<td>lzxid</td>\n<td>最大事务<code>id</code></td>\n</tr>\n<tr>\n<td>lresp</td>\n<td>最后响应时间戳</td>\n</tr>\n<tr>\n<td>llat</td>\n<td>最后/最新 延迟</td>\n</tr>\n<tr>\n<td>minlat</td>\n<td>最小延时</td>\n</tr>\n<tr>\n<td>maxlat</td>\n<td>最大延时</td>\n</tr>\n<tr>\n<td>avglat</td>\n<td>平均延时</td>\n</tr>\n</tbody>\n</table>\n<h4> crst</h4>\n<p><code>echo crst | nc locakhost2181</code>：重置当前这台服务器所有连接/会话的统计信息</p>\n<h4> dump</h4>\n<p><code>echo dump | nc locakhost2181</code>：列出临时节点信息，适用于<code>leader</code></p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>session id</code></td>\n<td>znode.path（1 对多，处于队列中排队的 session 和临时节点）</td>\n</tr>\n</tbody>\n</table>\n<h4> envi</h4>\n<p><code>echo envi | nc locakhost2181</code>：输出关于服务器的环境详细信息</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>zookeeper.version</code></td>\n<td>版本</td>\n</tr>\n<tr>\n<td><code>host.name</code></td>\n<td><code>host</code>信息</td>\n</tr>\n<tr>\n<td><code>java.version</code></td>\n<td><code>java</code>版本</td>\n</tr>\n<tr>\n<td><code>java.vendor</code></td>\n<td>供应商</td>\n</tr>\n<tr>\n<td><code>java.home</code></td>\n<td>运行环境所在目录</td>\n</tr>\n<tr>\n<td><code>java.class.path</code></td>\n<td><code>classpath</code></td>\n</tr>\n<tr>\n<td><code>java.library.path</code></td>\n<td>第三方库指定非Java类包的为止(如：dll，so)</td>\n</tr>\n<tr>\n<td><code>java.io.tmpdir</code></td>\n<td>默认的临时文件路径</td>\n</tr>\n<tr>\n<td><code>java.compiler</code></td>\n<td><code>JIT</code>编辑器的名称</td>\n</tr>\n<tr>\n<td><code>os.name</code></td>\n<td><code>Linux</code></td>\n</tr>\n<tr>\n<td><code>os.arch</code></td>\n<td><code>amd64</code></td>\n</tr>\n<tr>\n<td><code>os.version</code></td>\n<td><code>3.10.0-1062.el7.x86_64</code></td>\n</tr>\n<tr>\n<td><code>user.name</code></td>\n<td><code>zookeeper</code></td>\n</tr>\n<tr>\n<td><code>user.home</code></td>\n<td><code>/opt/zookeeper</code></td>\n</tr>\n<tr>\n<td><code>user.dir</code></td>\n<td><code>/opt/zookeeper/zookeeper2181/bin</code></td>\n</tr>\n</tbody>\n</table>\n<h4> ruok</h4>\n<p><code>echo ruok | nc locakhost2181</code>：测试服务是否处于正确运行状态，如果目标正确运行会返回<code>imok</code>（<code>are you ok | I'm ok</code>）</p>\n<h4> stat</h4>\n<p><code>echo stat | nc locakhost2181</code>：输出服务器的详细信息与<code>srvr</code>相似（<code>srvr</code>这里不举例了，官网有一点描述），但是多了每个连接的会话信息</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>zookeeper version</code></td>\n<td>版本</td>\n</tr>\n<tr>\n<td><code>Latency min/avg/max</code></td>\n<td>延时</td>\n</tr>\n<tr>\n<td><code>Received</code></td>\n<td>收包</td>\n</tr>\n<tr>\n<td><code>Sent</code></td>\n<td>发包</td>\n</tr>\n<tr>\n<td><code>Connections</code></td>\n<td>当前服务器连接数</td>\n</tr>\n<tr>\n<td><code>Outstanding</code></td>\n<td>服务器堆积的未处理请求数</td>\n</tr>\n<tr>\n<td><code>Zxid</code></td>\n<td>最大事务<code>id</code></td>\n</tr>\n<tr>\n<td><code>Mode</code></td>\n<td>服务器角色</td>\n</tr>\n<tr>\n<td><code>Node count</code></td>\n<td>节点数</td>\n</tr>\n</tbody>\n</table>\n<h4> srst</h4>\n<p><code>echo srst | nc locakhost2181</code>：重置<code>server</code>状态</p>\n<h4> wchs</h4>\n<p><code>echo wchs | nc locakhost2181</code>：列出服务器<code>watches</code>的简洁信息</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>connectsions</td>\n<td>连接数</td>\n</tr>\n<tr>\n<td>watch-paths</td>\n<td>watch 节点数</td>\n</tr>\n<tr>\n<td>watchers</td>\n<td>watcher 数量</td>\n</tr>\n</tbody>\n</table>\n<h4> wchc</h4>\n<p><code>echo wchc | nc locakhost2181</code>：通过<code>session</code>分组，列出<code>watch</code>的所有节点，它的输出是一个与<code>watch</code>相关的会话的节点列表</p>\n<p>问题：</p>\n<p><code>wchc is not executed because it is not in the whitelist</code></p>\n<p>解决办法：</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>每一个客户端的连接的<code>watcher</code>信息都会被收集起来，并且监控的路径都会被展示出来（代价高，消耗性能）</p>\n<div class=\"language-bash line-numbers-mode\" data-ext=\"sh\"><div class=\"line-numbers\" aria-hidden=\"true\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h4> wchp</h4>\n<p><code>echo wchp | nc locakhost2181</code>：通过路径分组，列出所有的<code>watch</code>的<code>session id</code>信息</p>\n<p>配置同<code>wchc</code></p>\n<h4> mntr</h4>\n<p><code>echo mntr | nc locakhost2181</code>：列出服务器的健康状态</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>zk_version</code></td>\n<td>版本</td>\n</tr>\n<tr>\n<td><code>zk_avg_latency</code></td>\n<td>平均延时</td>\n</tr>\n<tr>\n<td><code>zk_max_latency</code></td>\n<td>最大延时</td>\n</tr>\n<tr>\n<td><code>zk_min_latency</code></td>\n<td>最小延时</td>\n</tr>\n<tr>\n<td><code>zk_packets_received</code></td>\n<td>收包数</td>\n</tr>\n<tr>\n<td><code>zk_packets_sent</code></td>\n<td>发包数</td>\n</tr>\n<tr>\n<td><code>zk_num_alive_connections</code></td>\n<td>连接数</td>\n</tr>\n<tr>\n<td><code>zk_outstanding_requests</code></td>\n<td>堆积请求数</td>\n</tr>\n<tr>\n<td><code>zk_server_state</code></td>\n<td><code>leader/follower</code>状态</td>\n</tr>\n<tr>\n<td><code>zk_znode_count</code></td>\n<td><code>znode</code>数量</td>\n</tr>\n<tr>\n<td><code>zk_watch_count</code></td>\n<td><code>watch</code>数量</td>\n</tr>\n<tr>\n<td><code>zk_ephemerals_count</code></td>\n<td>l临时节点<code>(znode)</code></td>\n</tr>\n<tr>\n<td><code>zk_approximate_data_size</code></td>\n<td>数据大小</td>\n</tr>\n<tr>\n<td><code>zk_open_file_descriptor_count</code></td>\n<td>打开的文件描述符数量</td>\n</tr>\n<tr>\n<td><code>zk_max_file_descriptor_count</code></td>\n<td>最大文件描述符数量</td>\n</tr>\n</tbody>\n</table>\n<p>‍</p>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/zookeeper-summary/zookeeper-big-data.png",
      "date_published": "2023-08-10T00:00:00.000Z",
      "date_modified": "2023-08-21T16:04:04.000Z",
      "authors": [],
      "tags": [
        "Zookeeper"
      ]
    },
    {
      "title": "正则表达式总结",
      "url": "https://1coins.github.io/article/text-process/regex-summary.html",
      "id": "https://1coins.github.io/article/text-process/regex-summary.html",
      "summary": "什么是正则表达式？ 正则表达式是一组由字母和符号组成的特殊文本, 它可以用来从文本中找出满足你想要的格式的句子。 一个正则表达式是在一个主体字符串中从左到右匹配字符串时的一种样式。例如Regular expression​是一个完整的句子，但我们常使用缩写的术语regex​或regexp​。 正则表达式可以用来替换文本中的字符串、验证形式、提取字符串等等。 想象你正在写一个应用，然后你想设定一个用户命名的规则，让用户名包含字符、数字、下划线和连字符以及限制字符的个数，好让名字看起来没那么丑。",
      "content_html": "<h1> 什么是正则表达式？</h1>\n<blockquote>\n<p>正则表达式是一组由字母和符号组成的特殊文本, 它可以用来从文本中找出满足你想要的格式的句子。</p>\n</blockquote>\n<p>一个正则表达式是在一个主体字符串中从左到右匹配字符串时的一种样式。例如<code>Regular expression</code>​是一个完整的句子，但我们常使用缩写的术语<code>regex</code>​或<code>regexp</code>​。</p>\n<p>正则表达式可以用来替换文本中的字符串、验证形式、提取字符串等等。</p>\n<p>想象你正在写一个应用，然后你想设定一个用户命名的规则，让用户名包含字符、数字、下划线和连字符以及限制字符的个数，好让名字看起来没那么丑。</p>\n<p>我们使用以下正则表达式来验证一个用户名:</p>\n<figure><img src=\"https://cdn.jsdelivr.net/gh/1coins/assets/regex-summary/regex-validation-username.png\" alt=\"\" tabindex=\"0\" loading=\"lazy\"><figcaption></figcaption></figure>\n<p>以上的正则表达式可以接受 <code>john_doe</code>​, <code>jo-hn_doe</code>​, <code>john12_as</code>​，但不匹配<code>Jo</code>​，因为它包含了大写的字母而且太短了。</p>\n<h1> 基本匹配</h1>\n<p>正则表达式其实就是在执行搜索时的格式，它由一些字母和数字组合而成。</p>\n<p>例如: 一个正则表达式 <code>the</code>​，它表示一个规则：由字母<code>t</code>​开始,接着是<code>h</code>​,再接着是<code>e</code>​.</p>\n<blockquote>\n<p>\"the\" =&gt; The fat cat sat on <strong>the</strong> mat.</p>\n</blockquote>\n<p>正则表达式<code>123</code>​匹配字符串<code>123</code>​。它逐个字符的与输入的正则表达式做比较。</p>\n<p>正则表达式是大小写敏感的，所以<code>The</code>​不会匹配<code>the</code>​</p>\n<blockquote>\n<p>\"The\" =&gt; <strong>The</strong> fat cat sat on the mat.</p>\n</blockquote>\n<h1> 元字符</h1>\n<p>正则表达式主要依赖于元字符。</p>\n<p>元字符不代表他们本身的字面意思，他们都有特殊的含义。</p>\n<p>一些元字符写在方括号中的时候有一些特殊的意思.。</p>\n<p>以下是一些元字符的介绍:</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">元字符</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><code>.</code></td>\n<td style=\"text-align:center\">句号匹配任意单个字符除了换行符</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>[ ]</code></td>\n<td style=\"text-align:center\">字符种类，匹配方括号内的任意字符</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>[^ ]</code></td>\n<td style=\"text-align:center\">否定的字符种类. 匹配除了方括号里的任意字符</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>*</code></td>\n<td style=\"text-align:center\">匹配 &gt;= 0 个重复的在<code>*</code>号之前的字符</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>+</code></td>\n<td style=\"text-align:center\">匹配 &gt; 1 个重复的<code>+</code>号前的字符</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>?</code></td>\n<td style=\"text-align:center\">标记<code>?</code>之前的字符为可选</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>{n,m}</code></td>\n<td style=\"text-align:center\">匹配 num 个中括号之前的字符 (n &lt;= num &lt;= m)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>(xyz)</code></td>\n<td style=\"text-align:center\">字符集，匹配与 xyz 完全相等的字符串</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">​<code>|</code>​</td>\n<td style=\"text-align:center\">或运算符，匹配符号前或后的字符</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">​<code>\\</code>​</td>\n<td style=\"text-align:center\">转义字符，用于匹配一些保留的字符 <code>[ ] ( ) { } . * + ? ^ $ |</code></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>^</code></td>\n<td style=\"text-align:center\">从开始行开始匹配</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>$</code></td>\n<td style=\"text-align:center\">从末端开始匹配</td>\n</tr>\n</tbody>\n</table>\n<h2> 点运算符 <code>.</code>​</h2>\n<p>​<code>.</code>​是元字符中最简单的例子。</p>\n<p>​<code>.</code>​匹配任意单个字符，但不匹配换行符。</p>\n<p>例如，表达式<code>.ar</code>​匹配一个任意字符后面跟着是<code>a</code>​和<code>r</code>​的字符串。</p>\n<blockquote>\n<p>\".ar\" =&gt; The <strong>car par</strong>ked in the <strong>gar</strong>age</p>\n</blockquote>\n<h2> 字符集</h2>\n<p>字符集也叫做字符类。</p>\n<p>方括号用来指定一个字符集，在方括号中使用连字符来指定字符集的范围；在方括号中的字符集不关心顺序。</p>\n<p>例如，表达式<code>[Tt]he</code>​ 匹配 <code>the</code>​ 和 <code>The</code>​。</p>\n<blockquote>\n<p>\"[Tt]he\" =&gt; <strong>The</strong> car parked in <strong>the</strong> garage.</p>\n</blockquote>\n<p>方括号的句号就表示句号。</p>\n<p>表达式 <code>ar[.]</code>​ 匹配 <code>ar.</code>​字符串。</p>\n<blockquote>\n<p>\"ar[.]\" =&gt; A garage is a good place to park a c<strong>ar</strong></p>\n</blockquote>\n<h3> 否定字符集</h3>\n<p>一般来说 <code>^</code>​ 表示一个字符串的开头，但它用在一个方括号的开头的时候表示这个字符集是否定的。</p>\n<p>例如, 表达式<code>[^c]ar</code>​ 匹配一个后面跟着<code>ar</code>​的除了<code>c</code>​的任意字。</p>\n<blockquote>\n<p>\"[^c]ar\" =&gt; The car <strong>par</strong>ked in the <strong>gar</strong>age.</p>\n</blockquote>\n<h2> 重复次数</h2>\n<p>后面跟着元字符<code>+</code>​、<code>*</code>​、<code>?</code>​ 的，用来指定匹配子模式的次数。这些元字符在不同的情况下有着不同的意思。</p>\n<h3> *​ 号</h3>\n<p>​<code>*</code>​号匹配在<code>*</code>​之前的字符出现<code>大于等于0</code>​次。</p>\n<p>例如，表达式<code>a*</code>​匹配以<code>0</code>​或更多个<code>a</code>​开头的字符，因为有<code>0</code>​个这个条件，其实也就匹配了所有的字符。表达式<code>[a-z]*</code>​匹配一个行中所有以小写字母开头的字符串。</p>\n<blockquote>\n<p>\"[a-z]*\" =&gt; T<strong>he car parked in the garage</strong>.</p>\n</blockquote>\n<p>​<code>*</code>​字符和<code>.</code>​字符搭配可以匹配所有的字符<code>.*</code>​。</p>\n<p>​<code>*</code>​和表示匹配空格的符号<code>\\s</code>​连起来用, 如表达式<code>\\s*cat\\s*</code>​匹配<code>0</code>​或更多个空格开头和<code>0</code>​或更多个空格结尾的<code>cat</code>​字符串。</p>\n<blockquote>\n<p>\"\\s<em>cat\\s</em>\" =&gt; The fat <strong>cat</strong> sat on the con<strong>cat</strong>enation</p>\n</blockquote>\n<h3> +` 号</h3>\n<p>​<code>+</code>​号匹配<code>+</code>​号之前的字符出现<code>&gt;=1</code>​次个字符。</p>\n<p>例如，表达式<code>c.+t</code>​ 匹配以首字母<code>c</code>​开头以<code>t</code>​结尾,中间跟着任意个字符的字符串。</p>\n<blockquote>\n<p>\"c.+t\" =&gt; The fat <strong>cat sat  on the mat</strong>.</p>\n</blockquote>\n<h3> ?​ 号</h3>\n<p>在正则表达式中元字符 <code>?</code>​ 标记在符号前面的字符为可选, 即出现<code>0</code>​或<code>1</code>​次。</p>\n<p>例如，表达式<code>[T]?he</code>​匹配字符串<code>he</code>​和<code>The</code>​。</p>\n<blockquote>\n<p>\"[T]he\" =&gt; <strong>The</strong> car is parked in the garage.</p>\n<p>\"[T]?he\" =&gt; <strong>The</strong> car is parked in t<strong>he</strong> garage.</p>\n</blockquote>\n<h2> {}​ 号</h2>\n<p>在正则表达式中 <code>{}</code>​ 是一个量词，常用来一个或一组字符可以重复出现的次数。</p>\n<p>例如，表达式 <code>[0-9]{2,3}</code>​ 匹配<code>2~3</code>​位<code>0~9</code>​的数字.</p>\n<blockquote>\n<p>\"[0-9]{2,3}\" =&gt; The number was 9.<strong>999</strong>7 but we rounded it off to <strong>10</strong>.0.</p>\n</blockquote>\n<p>我们可以省略第二个参数。</p>\n<p>例如，<code>[0-9]{2,}</code>​匹配至少两位<code>0~9</code>​的数字。</p>\n<blockquote>\n<p>\"[0-9]{2,}\" =&gt; The number was 9.<strong>9997</strong> but we rounded it off to <strong>10</strong>.0.</p>\n</blockquote>\n<p>如果逗号也省略掉则表示重复固定的次数。<br>\n例如, <code>[0-9]{3}</code>​ 匹配<code>3</code>​位数字。</p>\n<blockquote>\n<p>\"[0-9]{3}\" =&gt; The number was 9.<strong>999</strong>7 but we rounded it off to 10.0.</p>\n</blockquote>\n<h2> (...)​ 特征标群</h2>\n<p>特征标群是一组写在 <code>(...)</code>​ 中的子模式。</p>\n<p>例如之前说的<code>{}</code>​是用来表示前面一个字符出现指定次数，但如果在<code>{}</code>​前加入特征标群则表示整个标群内的字符重复<code>N</code>​次。</p>\n<p>例如, 表达式<code>(ab)*</code>​匹配连续出现<code>0</code>​或更多个<code>ab</code>​。</p>\n<p>我们还可以在<code>()</code>​中用或字符<code>|</code>​表示或。</p>\n<p>例如，<code>(c|g|p)ar</code>​匹配<code>car</code>​或<code>gar</code>​或<code>par</code>​。</p>\n<blockquote>\n<p>\"(c|g|p)ar\" =&gt; The <strong>car</strong> is <strong>par</strong>ked in the <strong>gar</strong>age.</p>\n</blockquote>\n<h2> |​ 或运算符</h2>\n<p>或运算符就表示或，用作判断条件。</p>\n<p>例如<code>(T|t)he|car</code>​匹配<code>(T|t)he</code>​ 或 <code>car</code>​。</p>\n<blockquote>\n<p>\"(T|t)he|car\" =&gt; <strong>The car</strong> is parked in <strong>the</strong> garage.</p>\n</blockquote>\n<h2> 转码特殊字符</h2>\n<p>反斜线<code>\\</code>​在表达式中用于转码紧跟其后的字符。用于指定<code>{ } [ ] / \\ + * . $ ^ | ?</code>​这些特殊字符，如果想要匹配这些特殊字符则要在其前面加上反斜线<code>\\</code>​。</p>\n<p>例如<code>.</code>​是用来匹配除换行符外的所有字符的，如果想要匹配句子中的<code>.</code>​则要写成<code>\\.</code>​。</p>\n<blockquote>\n<p>\"(f|c|m)at.?\" =&gt; The <strong>fat cat</strong> sat on the <strong>mat</strong>.</p>\n</blockquote>\n<h2> 锚点</h2>\n<p>在正则表达式中, 想要匹配指定开头或结尾的字符串就要使用到锚点. <code>^</code>​ 指定开头, <code>$</code>​ 指定结尾.</p>\n<h3> ^​ 号</h3>\n<p>​<code>^</code>​用来检查匹配的字符串是否在所匹配字符串的开头。</p>\n<p>例如，在<code>abc</code>​中使用表达式<code>^a</code>​会得到结果<code>a</code>​，但如果使用<code>^b</code>​将匹配不到任何结果，因为在字符串<code>abc</code>​中并不是以<code>b</code>​开头。</p>\n<p>例如，<code>^(T|t)he</code>​匹配以<code>The</code>​或<code>the</code>​开头的字符串。</p>\n<blockquote>\n<p>\"(T|t)he\" =&gt; The car is parked in <strong>the</strong> garage.</p>\n<p>\"^(T|t)he\" =&gt; <strong>The</strong> car is parked in the garage.</p>\n</blockquote>\n<h3> $​ 号</h3>\n<p>同理于<code>^</code>​号，<code>$</code>​号用来匹配字符是否是最后一个。</p>\n<p>例如，<code>(at\\.)$</code>​匹配以<code>at.</code>​结尾的字符串。</p>\n<blockquote>\n<p>\"(at.)\" =&gt; The fat c<strong>at.</strong> s<strong>at.</strong> on the mat.</p>\n<p>\"(at.)$\" =&gt; The fat cat. sat. on the m<strong>at.</strong></p>\n</blockquote>\n<h1> 简写字符集</h1>\n<p>正则表达式提供一些常用的字符集简写. 如下:</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">简写</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><code>.</code></td>\n<td>除换行符外的所有字符</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>\\w</code></td>\n<td>匹配所有字母数字, 等同于 <code>[a-zA-Z0-9_]</code>​</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>\\W</code></td>\n<td>匹配所有非字母数字, 即符号, 等同于: <code>[^\\w]</code>​</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>\\d</code></td>\n<td>匹配数字: <code>[0-9]</code>​</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>\\D</code></td>\n<td>匹配非数字: <code>[^\\d]</code>​</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>\\s</code></td>\n<td>匹配所有空格字符, 等同于: <code>[\\t\\n\\f\\r\\p{Z}]</code>​</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>\\S</code></td>\n<td>匹配所有非空格字符: <code>[^\\s]</code>​</td>\n</tr>\n</tbody>\n</table>\n<h1> 前后关联约束（前后预查）</h1>\n<p>前置约束和后置约束都属于<strong>非捕获簇</strong>（用于匹配不在匹配列表中的格式）。</p>\n<p>前置约束用于判断所匹配的格式是否在另一个确定的格式之后。</p>\n<p>例如，我们想要获得所有跟在<code>$</code>​符号后的数字，我们可以使用正向向后约束<code>(?&lt;=\\$)[0-9\\.]*</code>​。这个表达式匹配<code>$</code>​开头，之后跟着<code>0,1,2,3,4,5,6,7,8,9,.</code>​这些字符可以出现大于等于<code>0</code>​次。</p>\n<p>前后关联约束如下：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">符号</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><code>?=</code></td>\n<td>前置约束-存在</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>?!</code></td>\n<td>前置约束-排除</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>?&lt;=</code></td>\n<td>后置约束-存在</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>?&lt;!</code></td>\n<td>后置约束-排除</td>\n</tr>\n</tbody>\n</table>\n<h2> ​?=...​​ 前置约束（存在）</h2>\n<p>​<code>?=...</code>​前置约束（存在），表示第一部分表达式必须跟在<code>?=...</code>​定义的表达式之后。</p>\n<p>返回结果只瞒住第一部分表达式。</p>\n<p>定义一个前置约束（存在）要使用<code>()</code>​，在括号内部使用一个问号和等号：<code>(?=...)</code>​.</p>\n<p>前置约束的内容写在括号中的等号后面。</p>\n<p>例如，表达式<code>[T|t]he(?=\\sfat)</code>​匹配<code>The</code>​和<code>the</code>​，在括号中我们又定义了前置约束（存在）<code>(?=\\sfat)</code>​，即<code>The</code>​和<code>the</code>​后面紧跟着<code>(空格)fat</code>​。</p>\n<blockquote>\n<p>\"[T|t]he(?=\\sfat)\" =&gt; <strong>The</strong> fat cat sat on the mat.</p>\n</blockquote>\n<h2> ​?!...​​ 前置约束-排除</h2>\n<p>前置约束-排除<code>?!</code>​用于筛选所有匹配结果，筛选条件为其后不跟随着定义的格式。</p>\n<p>​<code>前置约束-排除</code>​的定义和<code>前置约束(存在)</code>​一样, 区别就是<code>=</code>​替换成<code>!</code>​也就是<code>(?!...)</code>​。</p>\n<p>表达式<code>[T|t]he(?!\\sfat)</code>​匹配<code>The</code>​和<code>the</code>​，且其后不跟着 <code>(空格)fat</code>​。</p>\n<blockquote>\n<p>\"[T|t]he(?!\\sfat)\" =&gt; The fat cat sat on <strong>the</strong> mat.</p>\n</blockquote>\n<h2> ​?&lt;=...​​ 后置约束-存在</h2>\n<p>后置约束-存在记作<code>(?&lt;=...)</code>​，用于筛选所有匹配结果，筛选条件为 其前跟随着定义的格式。</p>\n<p>例如，表达式<code>(?&lt;=[T|t]he\\s)(fat|mat)</code>​匹配<code>fat</code>​和<code>mat</code>​，且其前跟着<code>The</code>​或<code>the</code>​。</p>\n<blockquote>\n<p>\"(?&lt;=[T|t]he\\s)(fat|mat)\" =&gt; The <strong>fat</strong> cat sat on the <strong>mat</strong>.</p>\n</blockquote>\n<h2> ​?&lt;!...​​ 后置约束-排除</h2>\n<p>后置约束-排除记作<code>(?&lt;!...)</code>​，用于筛选所有匹配结果，筛选条件为其前不跟着定义的格式。</p>\n<p>例如，表达式<code>(?&lt;!(T|t)he\\s)(cat)</code>​匹配<code>cat</code>​，且其前不跟着<code>The</code>​或<code>the</code>​。</p>\n<blockquote>\n<p>\"(?&lt;![T|t]he\\s)(cat)\" =&gt; The cat sat on <strong>cat</strong>.</p>\n</blockquote>\n<h1> 标志</h1>\n<p>标志也叫修饰语，因为它可以用来修改表达式的搜索结果。这些标志可以任意的组合使用，它也是整个正则表达式的一部分。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">标志</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><code>i</code></td>\n<td style=\"text-align:center\">忽略大小写</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>g</code></td>\n<td style=\"text-align:center\">全局搜索</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>m</code></td>\n<td style=\"text-align:center\">多行的: 锚点元字符 <code>^</code>​ <code>$</code>​ 工作范围在每行的起始</td>\n</tr>\n</tbody>\n</table>\n<h2> 忽略大小写（Case Insensitive）</h2>\n<p>修饰语<code>i</code>​用于忽略大小写。</p>\n<p>例如，表达式<code>/The/gi</code>​表示在全局搜索<code>The</code>​，在后面的<code>i</code>​将其条件修改为忽略大小写，则变成搜索<code>the</code>​和 <code>The</code>​，<code>g</code>​表示全局搜索。</p>\n<blockquote>\n<p>\"The\" =&gt; <strong>The</strong> fat cat sat on the mat.</p>\n<p>\"/The/gi\" =&gt; <strong>The</strong> fat cat sat on <strong>the</strong> mat.</p>\n</blockquote>\n<h2> 全局搜索（Global search）</h2>\n<p>修饰符<code>g</code>​常用于执行一个全局搜索匹配，即（不仅仅返回第一个匹配的，而是返回全部）。</p>\n<p>例如，表达式<code>/.(at)/g</code>​表示搜索任意字符（除了换行）+<code>at</code>​，并返回全部结果。</p>\n<blockquote>\n<p>\"/.(at)/\" =&gt; The <strong>fat</strong> cat sat on the mat.</p>\n<p>\"/.(at)/g\" =&gt; The <strong>fat cat sat</strong> ont the <strong>mat</strong>.</p>\n</blockquote>\n<h2> 多行修饰符（Multiline）</h2>\n<p>多行修饰符<code>m</code>​常用于执行一个多行匹配.</p>\n<p>像之前介绍的<code>(^,$)</code>​用于检查格式是否是在待检测字符串的开头或结尾，但我们如果想要它在每行的开头和结尾生效，我们需要用到多行修饰符<code>m</code>​。</p>\n<p>例如，表达式<code>/at(.)?$/gm</code>​表示在待检测字符串每行的末尾搜索<code>at</code>​后跟一个或多个<code>.</code>​的字符串，并返回全部结果。</p>\n<blockquote>\n<p>\"/.at(.)?$/\" =&gt; The fat cat sat on the <strong>mat.</strong></p>\n</blockquote>\n<blockquote>\n<p>\"/.at(.)?$/gm\" =&gt; The fat cat <strong>sat</strong> on the <strong>mat.</strong></p>\n</blockquote>\n<h1> 额外补充</h1>\n<ul>\n<li>正整数：<code>^\\d+$</code>​</li>\n<li>负整数：<code>^-\\d+$</code>​</li>\n<li>手机国家号：<code>^+?[\\d\\s]{3,}$</code>​</li>\n<li>手机号：<code>^+?[\\d\\s]+(?[\\d\\s]{10,}$</code>​</li>\n<li>整数：<code>^-?\\d+$</code>​</li>\n<li>用户名：<code>^[\\w\\d_.]{4,16}$</code>​</li>\n<li>数字和英文字母：<code>^[a-zA-Z0-9]*$</code>​</li>\n<li>数字和应为字母和空格：<code>^[a-zA-Z0-9 ]*$</code>​</li>\n<li>密码：<code>^(?=^.{6,}$)((?=.*[A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z]))^.*$</code>​</li>\n<li>邮箱：<code>^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4})*$</code>​</li>\n<li>IP4 地址：<code>^((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))*$</code>​</li>\n<li>纯小写字母：<code>^([a-z])*$</code>​</li>\n<li>纯大写字母：<code>^([A-Z])*$</code>​</li>\n<li>URL：<code>^(((http|https|ftp):\\/\\/)?([[a-zA-Z0-9]\\-\\.])+(\\.)([[a-zA-Z0-9]]){2,4}([[a-zA-Z0-9]\\/+=%&amp;_\\.~?\\-]*))*$</code>​</li>\n<li>VISA 信用卡号：<code>^(4[0-9]{12}(?:[0-9]{3})?)*$</code>​</li>\n<li>日期 (MM/DD/YYYY)：<code>^(0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])[- /.](19|20)?[0-9]{2}$</code>​</li>\n<li>日期 (YYYY/MM/DD)：<code>^(19|20)?[0-9]{2}[- /.](0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])$</code>​</li>\n<li>MasterCard 信用卡号：<code>^(5[1-5][0-9]{14})*$</code>​</li>\n</ul>\n",
      "image": "https://cdn.jsdelivr.net/gh/1coins/assets/regex-summary/regex-validation-username.png",
      "date_published": "2023-08-01T00:00:00.000Z",
      "date_modified": "2023-08-21T16:04:04.000Z",
      "authors": [],
      "tags": [
        "工具"
      ]
    }
  ]
}